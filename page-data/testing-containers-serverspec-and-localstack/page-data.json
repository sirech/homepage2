{"componentChunkName":"component---src-templates-blog-post-js","path":"/testing-containers-serverspec-and-localstack/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for Meta","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"81298c7f-6e79-5ae5-83d4-b30af263ea5f","html":"<figure class=\"figure figure--right\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 300px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/bd8f606798f32990e9c6c77dcf2c514a/5a46d/localstack.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 52.12765957446809%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABe0lEQVR42lWSXcsBURSF/UGvknHnEpHiQn6BWzJK/oQ7194pIonixvdnIRlifOTbeN45Ma9dc9pn77XOWns3Fl3XVVV1uVzxeDyZTCYSiVQqFYvFotGoLMvpdFoUZSPIgdnt9tFoBNHCN5/PQ6HQ4/HQjVitVo1GYzgccmqaRuX5fH7O2+3m8Xi63a5JDgaDl8uF/Hw+K4oCgny/3xcKhUqlwiuiC/90Ornd7l6v96VM43A4lMvlwWBAcbvdbjab4/F4vV5xUa1W6/X6brfDIOQvZcj3+71UKjE/FXTG4zEiPEcCny7jFItFWl6v1yTPZrNIJAJImBHeptPpcrlcLBZ0mUUMDIBVBQKBTqdjksPhMDhmEzsTOuv1WpxYFWQA2PT7/aYyItgmabVa7XZbfQdeJpPJ50qr2WzyENs2ldH0+XzcscR6c7ncrxGKESKnmM/nAQDjp+j3+39k1pjNZiVJslqtNpvN6XRK73A4HNK/oAXgx4hMJlOr1V4ifNvzm0+PJwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Localstack\" title=\"\" src=\"/static/bd8f606798f32990e9c6c77dcf2c514a/5a46d/localstack.png\" srcset=\"/static/bd8f606798f32990e9c6c77dcf2c514a/4dcb9/localstack.png 188w,\n/static/bd8f606798f32990e9c6c77dcf2c514a/5a46d/localstack.png 300w\" sizes=\"(max-width: 300px) 100vw, 300px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>I recently spoke at a meetup where I talked about <a href=\"https://github.com/sirech/talks/blob/master/2019-01-tw-tdd_containers.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">TDD for containers</a> using <a href=\"https://serverspec.org\" target=\"_blank\" rel=\"noopener noreferrer\">ServerSpec</a>.</p>\n<p>There I showed an example based on my current project. We have some containerized applications that are fetching secrets from <a href=\"https://aws.amazon.com/secrets-manager/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Secrets Manager</a>. Testing that is tricky because of the dependency to <em>ASM</em>. Thanks to <a href=\"https://github.com/localstack/localstack\" target=\"_blank\" rel=\"noopener noreferrer\">localstack</a>, you can write meaningful tests by mocking those dependencies. If you just want the code it can be found <a href=\"https://github.com/sirech/example-serverspec-aws\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>. If you can spare me some minutes Iâ€™ll go over it in more detail.</p>\n<!--more-->\n<h2>The initial image</h2>\n<p>Letâ€™s say you have an existing <em>Node.js</em> application that is being packaged. Following a <em>TDD</em> approach, you could arrive at tests like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">require_relative <span class=\"token string-literal\"><span class=\"token string\">'spec_helper'</span></span>\n\ndescribe <span class=\"token string-literal\"><span class=\"token string\">'Application Container'</span></span> <span class=\"token keyword\">do</span>\n  describe file<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'/etc/alpine-release'</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n    its<span class=\"token punctuation\">(</span><span class=\"token symbol\">:content</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> is_expected<span class=\"token punctuation\">.</span>to match<span class=\"token punctuation\">(</span><span class=\"token regex-literal\"><span class=\"token regex\">/3.8.2/</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">end</span>\n\n  describe <span class=\"token string-literal\"><span class=\"token string\">'node'</span></span> <span class=\"token keyword\">do</span>\n    describe command<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'node --version'</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n      its<span class=\"token punctuation\">(</span><span class=\"token symbol\">:stdout</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> is_expected<span class=\"token punctuation\">.</span>to match<span class=\"token punctuation\">(</span><span class=\"token regex-literal\"><span class=\"token regex\">/11.6/</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">end</span>\n\n    describe process<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'node'</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n      it <span class=\"token punctuation\">{</span> is_expected<span class=\"token punctuation\">.</span>to be_running <span class=\"token punctuation\">}</span>\n      its<span class=\"token punctuation\">(</span><span class=\"token symbol\">:args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> is_expected<span class=\"token punctuation\">.</span>to contain<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'app.js'</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n      its<span class=\"token punctuation\">(</span><span class=\"token symbol\">:user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> is_expected<span class=\"token punctuation\">.</span>to eq<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'runner'</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">end</span>\n\n    describe <span class=\"token string-literal\"><span class=\"token string\">'listens to correct port'</span></span> <span class=\"token keyword\">do</span>\n      it <span class=\"token punctuation\">{</span> wait_for<span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to be_listening<span class=\"token punctuation\">.</span>with<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'tcp'</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n\n\n  describe file<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'app.js'</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n    it <span class=\"token punctuation\">{</span> is_expected<span class=\"token punctuation\">.</span>to be_file <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>which is implemented by the following <code class=\"language-text\">Dockerfile</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node:11.6-alpine</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n\n<span class=\"token comment\"># hadolint ignore=DL3018,DL3013</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apk update --no-cache &amp;&amp; <span class=\"token operator\">\\</span>\n  apk add --no-cache bash jq &amp;&amp; <span class=\"token operator\">\\</span>\n  rm -rf /var/cache/apk/*</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> package.json .</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> yarn</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> app.js .</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> adduser -D runner</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> runner</span>\n<span class=\"token instruction\"><span class=\"token keyword\">SHELL</span> [<span class=\"token string\">\"/bin/bash\"</span>, <span class=\"token string\">\"-o\"</span>, <span class=\"token string\">\"pipefail\"</span>, <span class=\"token string\">\"-c\"</span>]</span>\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"node\"</span>, <span class=\"token string\">\"app.js\"</span>]</span></code></pre></div>\n<p>What if we get extra requirements? Our application is going to make use of some secrets. Namely:</p>\n<ul>\n<li>there will be a secret named <code class=\"language-text\">SECRET</code> with the value <code class=\"language-text\">localstack_secret</code></li>\n<li>our <code class=\"language-text\">GET /secret</code> route will output <code class=\"language-text\">The super secret value is ${SECRET}</code> (this app trusts its callers a bit too much!)</li>\n</ul>\n<p>This changes everything! Our app needs some dependencies, and that influences the tests as well. Letâ€™s see how.</p>\n<h2>Injecting secrets into the container</h2>\n<p>We are going to be injecting the secrets at runtime. You can find the pitfalls of writing them at build time in <a href=\"https://medium.com/@mccode/dont-embed-configuration-or-secrets-in-docker-images-7b2e0f916fdd\" target=\"_blank\" rel=\"noopener noreferrer\">plenty of other posts</a>, so letâ€™s ðŸ‘‹ that.</p>\n<p>A second requirement is that we want to make the secret handling transparent to our existing app. The app will get the secrets injected as environment variables. Weâ€™ll achieve this by adding an <code class=\"language-text\">ENTRYPOINT</code> to our image that takes care of fetching the secrets.</p>\n<p>Weâ€™ll be storing our secrets in <em>ASM</em>. This is how the architecture looks like:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 717px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/27b33952d390a2795b796b39321bde6a/0ad97/arch.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 61.702127659574465%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACQklEQVR42pWTS08TYRSGJ2HhwvgDXPjz1I0rw8INK0QWLjRo4gIVMZElpQRJpYR2ighYRG4t97bTTtvpbaYtbaedSx+/aYtBYkg4kzfnu5x551zekdxul8qFQ96w0IwOhZrd91Ub0+pyW5Pqpks8axFcP2YhvIsvuCX8DnuKiao7IqRP6ogPW10X+wZ0RYxUbboc5mwOBenRwHuIi3XmCuE/5h25A3/tWjIEYUJroZXrpNSSQJFs0UAtNVCKbVzX7QWeNyuE9RSReob1jsamXWbDLrFm5pGrCt8NBd1q9QmVQhNdr5BKqySVDJqmUdQvSBZMGm2zR/jowM/dyDizxSNGV3wMz3/mqX+a97trjOfWkYIjLBZPkGot0UO1zWEeThMJzs5POC3BQcYkq7s0B4SPY/M8iL7FqBmsBkMsBVZZW42S+LnJci3JkPycQOnU66FDomKjXEDmbIdkbJnddAfF6JKpOHRsq9enh/tz3N94jWk2oBDFURZpp5ZAixIoxhmKjPUJTdH32cBPPvkWWDgKMflllmcjL5jxr5AuW73pefYk/pV7oTEm92WmYxE+7gV592uRqW2Z4d9+7oRFhl7JTRvmvm0x5ZvnVWiC0TcTvJz4wOSMn1xVJNe9HIpOxEgh19OEGyqyqSG38oTEPlJL88NID4bScDgvu6ji5e2kRug4LsqFs1K/5P/K5kZhtxxiqtXTYjzXIZbtCD06HKg2qujtX+kJ0bqX4BoG594jeQsvy1LdoXwF3r5tubf+9f4AU09wg8ZJnOgAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Architecture\" title=\"\" src=\"/static/27b33952d390a2795b796b39321bde6a/0ad97/arch.png\" srcset=\"/static/27b33952d390a2795b796b39321bde6a/4dcb9/arch.png 188w,\n/static/27b33952d390a2795b796b39321bde6a/5ff7e/arch.png 375w,\n/static/27b33952d390a2795b796b39321bde6a/0ad97/arch.png 717w\" sizes=\"(max-width: 717px) 100vw, 717px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<h3>Extending the app</h3>\n<p>Given that we are fully TDD compliant, letâ€™s define the test that proves that our app is successfully returning the secret:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">describe <span class=\"token string-literal\"><span class=\"token string\">'fetches a secret from ASM'</span></span> <span class=\"token keyword\">do</span>\n  it <span class=\"token punctuation\">{</span> wait_for<span class=\"token punctuation\">(</span>secret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to match<span class=\"token punctuation\">(</span><span class=\"token regex-literal\"><span class=\"token regex\">/localstack_secret/</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">private</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">secret</span></span>\n  command<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'curl localhost:3000/secret'</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>stdout\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>this is how the route is implemented in the app:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/secret'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">The super secret value is </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SECRET</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>this test will fail because we do not, in fact, provide the secret to the app. But we will!</p>\n<h3>Providing the secret</h3>\n<p>So as I said, there will be an <em>entrypoint</em> for this. We start with the test:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">describe file<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">'/usr/sbin/entrypoint.sh'</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n  it <span class=\"token punctuation\">{</span> is_expected<span class=\"token punctuation\">.</span>to be_file <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>the <em>entrypoint</em> itself will use the <a href=\"https://aws.amazon.com/cli/\" target=\"_blank\" rel=\"noopener noreferrer\">awscli</a> to fetch the secrets. It looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\n<span class=\"token builtin class-name\">set</span> <span class=\"token parameter variable\">-e</span>\n\n<span class=\"token assign-left variable\">secret</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>aws --endpoint-url<span class=\"token operator\">=</span>http://localstack:4584 <span class=\"token parameter variable\">--region</span> <span class=\"token string\">\"<span class=\"token variable\">${AWS_REGION}</span>\"</span> secretsmanager get-secret-value --secret-id <span class=\"token string\">\"<span class=\"token variable\">${SECRET_KEY}</span>\"</span> <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> .SecretString<span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">SECRET</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$secret</span>\"</span>\n\n<span class=\"token builtin class-name\">exec</span> <span class=\"token string\">\"<span class=\"token variable\">$@</span>\"</span></code></pre></div>\n<p>Note that for a production image, you might be better served using something like <a href=\"https://github.com/glassechidna/pstore\" target=\"_blank\" rel=\"noopener noreferrer\">pstore</a> instead.</p>\n<p>Regardless, we need to modify our <code class=\"language-text\">Dockerfile</code> bit to integrate this. There are some things to do. We need to add <code class=\"language-text\">awscli</code> as a dependency and we need to add our <em>entrypoint</em> and make sure it runs:</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token comment\"># hadolint ignore=DL3018,DL3013</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apk update --no-cache &amp;&amp; <span class=\"token operator\">\\</span>\n  apk add --no-cache bash jq python py-pip curl &amp;&amp; <span class=\"token operator\">\\</span>\n  pip --no-cache-dir install --upgrade pip awscli &amp;&amp; <span class=\"token operator\">\\</span>\n  apk -v --purge del py-pip &amp;&amp; <span class=\"token operator\">\\</span>\n  rm -rf /var/cache/apk/*</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">COPY</span> entrypoint.sh /usr/sbin/entrypoint.sh</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [<span class=\"token string\">\"/usr/sbin/entrypoint.sh\"</span>]</span></code></pre></div>\n<p>So everything should be ready! Now we can just run the tests and see that â€¦ they all fail. Including the old ones that were perfectly green before.</p>\n<h2>Introducing dependencies</h2>\n<p>Our container does not work anymore because it is trying to access <em>ASM</em> at runtime and failing. The dreaded dependencies are sabotaging our tests once again. A solution like logging into <em>AWS</em> and fetching the real secret feels unsatisfactory. What else to do?</p>\n<p>Enter <em>localstack</em>.</p>\n<p>Thanks to this <a href=\"https://www.thoughtworks.com/radar/tools/localstack\" target=\"_blank\" rel=\"noopener noreferrer\">awesome project</a> we can mock <em>AWS</em> dependencies and keep our tests running (almost) transparently. First, we need to orchestrate our app so that:</p>\n<ul>\n<li><em>localstack</em> gets started and serves a replica of <em>ASM</em> in port 4584</li>\n<li>an init container gets executed to inject a secret into <em>ASM</em></li>\n<li>our application is booted with <em>localstack</em> as a dependency, so that fetching secrets works</li>\n</ul>\n<p>we do this by using <a href=\"https://docs.docker.com/compose/\" target=\"_blank\" rel=\"noopener noreferrer\">Docker Compose</a>. The full includes the three elements, gracefully orchestrated together:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">localstack</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> localstack\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> localstack/localstack\n\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"4584:4584\"</span>\n\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> DEFAULT_REGION=eu<span class=\"token punctuation\">-</span>central<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n      <span class=\"token punctuation\">-</span> SERVICES=secretsmanager\n\n  <span class=\"token key atrule\">init</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> init\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> ./init\n\n    <span class=\"token key atrule\">env_file</span><span class=\"token punctuation\">:</span> .env\n\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> localstack\n\n    <span class=\"token key atrule\">links</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> localstack\n\n  <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> app\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> ./app\n\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"3000:3000\"</span>\n\n    <span class=\"token key atrule\">env_file</span><span class=\"token punctuation\">:</span> .env\n\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> init\n\n    <span class=\"token key atrule\">links</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> localstack</code></pre></div>\n<p>The <code class=\"language-text\">init</code> container is just ruby alpine executing this script:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">asm <span class=\"token operator\">=</span> Aws<span class=\"token double-colon punctuation\">::</span>SecretsManager<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Client</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token symbol\">region</span><span class=\"token operator\">:</span> <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'AWS_REGION'</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">endpoint</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">'http://localstack:4584'</span></span><span class=\"token punctuation\">)</span>\nasm<span class=\"token punctuation\">.</span>create_secret<span class=\"token punctuation\">(</span><span class=\"token symbol\">name</span><span class=\"token operator\">:</span> <span class=\"token constant\">ENV</span><span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'SECRET_KEY'</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">secret_string</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">'localstack_secret'</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>the <em>entrypoint</em>  from the beginning needs to account for the url, so we change it to <code class=\"language-text\">aws --endpoint-url=http://localstack:4584</code>. We can pick the URL based on the environment for a full example.</p>\n<p>With this we are almost done. We just need to tell <code class=\"language-text\">ServerSpec</code> to use <code class=\"language-text\">docker-compose</code> to start up our container setup, which can be done in the <code class=\"language-text\">rails_helper.rb</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">'serverspec'</span></span>\n<span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">'docker'</span></span>\n<span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">'docker/compose'</span></span>\n<span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">'rspec/wait'</span></span>\n\nset <span class=\"token symbol\">:backend</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:docker</span>\nset <span class=\"token symbol\">:docker_container</span><span class=\"token punctuation\">,</span> <span class=\"token string-literal\"><span class=\"token string\">'app'</span></span>\n\nRSpec<span class=\"token punctuation\">.</span>configure <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>config<span class=\"token operator\">|</span>\n  config<span class=\"token punctuation\">.</span>wait_timeout <span class=\"token operator\">=</span> <span class=\"token number\">15</span> <span class=\"token comment\"># seconds</span>\n\n  compose <span class=\"token operator\">=</span> Docker<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Compose</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span>\n\n  config<span class=\"token punctuation\">.</span>before<span class=\"token punctuation\">(</span><span class=\"token symbol\">:all</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n    compose<span class=\"token punctuation\">.</span>up<span class=\"token punctuation\">(</span><span class=\"token symbol\">detached</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">build</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n\n  config<span class=\"token punctuation\">.</span>after<span class=\"token punctuation\">(</span><span class=\"token symbol\">:all</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n    compose<span class=\"token punctuation\">.</span>kill\n    compose<span class=\"token punctuation\">.</span>rm<span class=\"token punctuation\">(</span><span class=\"token symbol\">force</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>And that is basically it! Now our tests run perfectly fine. We have containers that are interacting with a secret store that have a good test suite to make sure everything runs correctly. It does not get much more <em>TDDâ€™ish</em>.</p>\n<h2>Whatâ€™s next?</h2>\n<p>There is a but (isnâ€™t always one?). As of today, <em>localstack</em> can only store one secret in its implementation, so if your container relies on fetching more than one secret it wonâ€™t be able to find them all. This has been recently patched in <a href=\"https://github.com/spulec/moto/pull/1898\" target=\"_blank\" rel=\"noopener noreferrer\">moto</a>, the library underneath, and it is just waiting for the next release of <em>localstack</em> to be available. After that, no secret will be safe from mocking.</p>","frontmatter":{"layout":"post","title":"Testing containers with dependencies with localstack","path":"/testing-containers-serverspec-and-localstack/","categories":["TDD","ServerSpec","AWS","localstack"],"date":"2019/01/21","draft":false,"description":"Testing containers with ServerSpec can be augmented through localstack to test more complex setups with dependencies","canonical":null,"image":null}},"related":{"nodes":[{"frontmatter":{"title":"Modernizing your build pipelines","path":"/modernizing-your-build-pipelines/","date":"2018/11/02"}},{"frontmatter":{"title":"Dockerizing a JVM app with CircleCI","path":"/dockerizing-a-jvm-app-with-circleci/","date":"2019/07/15"}},{"frontmatter":{"title":"How to automate REST API end-to-end tests in a CI environment with Postman and Newman","path":"/how-to-automate-rest-api-end-to-end-tests/","date":"2019/08/19"}}]},"previous":{"frontmatter":{"title":"Migrating to Gatsby 2","path":"/migrating-to-gatsby2/","date":"2018/10/03"}},"next":{"frontmatter":{"title":"An overview of IAM in AWS","path":"/aws-iam-an-overview/","date":"2019/03/09"}}},"pageContext":{"related":["/dockerizing-a-jvm-app-with-circleci/","/how-to-automate-rest-api-end-to-end-tests/","/modernizing-your-build-pipelines/"],"previous":"/migrating-to-gatsby2/","next":"/aws-iam-an-overview/"}},"staticQueryHashes":[],"slicesMap":{}}