{"componentChunkName":"component---src-templates-blog-post-js","path":"/provisioning-a-network-load-balancer-with-terraform/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for Meta","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"9834a636-ab1a-5545-a1c8-7de2b7739e4e","html":"<figure class=\"figure figure--left\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/e9e42d18a599da2296397c7c01a01c39/0f98f/lb.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 66.48936170212765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAwAE/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAdAuKHZqv//EABwQAAIBBQEAAAAAAAAAAAAAAAECAwQREhMhMf/aAAgBAQABBQIHm1SxxuPOIZ6l1k//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAdEAACAgEFAAAAAAAAAAAAAAAAAQIRAxASMTKB/9oACAEBAAY/AuhtcX4zjJoqRUT/xAAbEAADAAIDAAAAAAAAAAAAAAAAAREhUWGxwf/aAAgBAQABPyGOVPhT0i0t0hLoJDiodwzuSSP/2gAMAwEAAgADAAAAEHcP/8QAFREBAQAAAAAAAAAAAAAAAAAAACH/2gAIAQMBAT8QV//EABcRAQADAAAAAAAAAAAAAAAAAAABITH/2gAIAQIBAT8QjVP/xAAaEAEBAQEBAQEAAAAAAAAAAAABEQAhMbFx/9oACAEBAAE/EEvA/ZiwdXj+WMhBKWn3L67kMAgK9O3DI89LWXf/2Q=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"lb\" title=\"\" src=\"/static/e9e42d18a599da2296397c7c01a01c39/acb04/lb.jpg\" srcset=\"/static/e9e42d18a599da2296397c7c01a01c39/bc01b/lb.jpg 188w,\n/static/e9e42d18a599da2296397c7c01a01c39/bf173/lb.jpg 375w,\n/static/e9e42d18a599da2296397c7c01a01c39/acb04/lb.jpg 750w,\n/static/e9e42d18a599da2296397c7c01a01c39/ec605/lb.jpg 1125w,\n/static/e9e42d18a599da2296397c7c01a01c39/c58a3/lb.jpg 1500w,\n/static/e9e42d18a599da2296397c7c01a01c39/0f98f/lb.jpg 1920w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>Are you using some form of load balancing in your application? Don’t answer. It’s a rhetorical question. <em>You bet I am</em>, you scream defiantly. How else am I going to ensure that traffic is evenly distributed?</p>\n<p>Load Balancers come in all shapes and sizes. In the past, it used to be a concern for the operations folks. As an application developer, you could spend years without having to think about them. That’s not always the case in the cloud. Luckily, AWS makes it <a href=\"https://aws.amazon.com/elasticloadbalancing/\" target=\"_blank\" rel=\"noopener noreferrer\">easy</a> for us to create such resources. More so if you use <a href=\"https://www.hashicorp.com/resources/what-is-infrastructure-as-code\" target=\"_blank\" rel=\"noopener noreferrer\">Infrastructure as Code</a> (which I’m sure you are). I’m going to use <a href=\"https://www.terraform.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform</a> in this article to provision <em>Network Load Balancer</em> instances.</p>\n<h2>It’s AWS. Of course, there are multiple competing options</h2>\n<p>There are three different types of load balancers in AWS.</p>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/introduction.html\" target=\"_blank\" rel=\"noopener noreferrer\">Classic</a></li>\n<li><a href=\"https://docs.aws.amazon.com/elasticloadbalancing/latest/network/introduction.html\" target=\"_blank\" rel=\"noopener noreferrer\">Network Load Balancer (NLB)</a></li>\n<li><a href=\"https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html\" target=\"_blank\" rel=\"noopener noreferrer\">Application Load Balancer (ALB)</a></li>\n</ul>\n<p>Classic load balancers are becoming a relic of the past. Usually, your choice is between an <em>NLB</em> (Layer 4) and an <em>ALB</em> (Layer 7). If you are worried about <a href=\"https://aws.amazon.com/elasticloadbalancing/features/\" target=\"_blank\" rel=\"noopener noreferrer\">the number of features</a>, they got you covered. All three are managed infrastructure. AWS handles the availability and scaling transparently for you.</p>\n<p>Let’s talk about NLBs. Being a Layer 4 means that you don’t know about the application protocol used. Even so, most of your load balancing needs in life can be covered with an NLB. Unless you want routing based on an HTTP path, for instance. In that case, you need an ALB, which I’ll cover in a future post.</p>\n<h2>Setting up a basic load balancer</h2>\n<p>Setting up a load balancer requires provisioning three types of resources.</p>\n<ul>\n<li>The <strong>load balancer</strong> itself</li>\n<li>The <strong>listeners</strong> that will forward the traffic</li>\n<li>The <strong>target groups</strong> that ensure that the traffic reaches its destination</li>\n</ul>\n<p>The most typical setup is a Virtual Private Cloud (VPC) with a public and a private subnet. The load balancer goes in the public subnet. The instances live in the private subnet. To protect ourselves against outages, we deploy everything to multiple Availability Zones (AZ).</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 658px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/2bf09a3aa6fb0b71a30d1092cc4cfc04/889a4/diagram.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 98.93617021276596%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAADZ0lEQVR42q2U2W8bVRSH+2cgIV6JEAKhQoTgseIJeAEkEEhFpRVFiE1iEVtVlgItZU1oVCGaKqJqQQYpD10AkaZNQgFDHKdN7CwGJ7HHM/aMZ1/ssT3zcWM7JU0BCcqVfhqdc+d+955zz7mb+J/Hpss8cecTuC1ykz6/p+pYleiSuX8FjKLOqtlzFu9vX+TQswoTx9wOL7oCYGpU47X70xx4Is93g9X/CoyJu6vkvMfQOxmO7F0g+5PTmY035ma9NgArlkfFC9HrEVrQxGxEQiHVsIbTEj6/STVYp1rrojShRjeyNjASW8teE6kWURJAKYhZNkzmCzly8hKKo6LYKqproHmGsE2KXgvJj9oqehG1RvQnUARKQQ2Zma+TXQgpmDFF3WA+s8JCtoRcLgvgEr8WzpFcPstcOYssQKWuJAGsN7vAtUSf+Fzh7QcW+fhhmVQy5Jekyq67M/TtkPgx4TFWOMnNH/XQ23ctTw0/JtIABbfxV8BO7F8O5Hn5rik+2ZknOREwdkbm+TtSfLA9z8igyfdLw9zafwNbPu1l59fbcJp/C+yc8NthiTd3pBl4IUf6fMDUhTK7Hhpn/+Mpfj6pkC5PsPXYPTx49E4+HH8XI0Tkrnk5cK32qsJRESoFYedH2yRXmiW7PINsS1RsDcPWMV0dw3coik5aceOuNgBX60uybDJyWSRcQ/FcFNcS4ADJ9ZFdB9kxkIMaK7YrKsKl7Og4dQtPSPctccutNWDMKltV5lGmjqLOJNAr02j6IuX0F2izX6Erk2hGHvV8AvVCAlP6gaKlcGJ2gUR6jonf8jRazS4wbrXrXB49iLz7Gqy+GzEnB1Cmh5FfuQqzfzPm2BsocyOUXr0ao7+X2qlHOVvUuG7faXr2jXHfUFJE2boUKJ0epLjndtQ9PWhj+5GnT1HYfQvlt65H++ZFSpkRVl6/DWXvZtzEVkYLVW567wxbDia5VwBb0UVg1DlhZpzc4SfJH9pKJXuc8kqa/NDTLB3e1g61ImfJH3lO2I9gJD8jU1V56XiKZ4ZTHJjIrAN2L8VtNEUP10RfhlhhiObYLFerLGmi1WwbWa8imaawdWTLwfZd6o1AXIaPHwY0W9HG1ybukNuFGRMKqCtAvudQCwKCVXle2xf4XjuqaG1J/E8v9hWOPwDJ8blHR7YHDwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"diagram\" title=\"\" src=\"/static/2bf09a3aa6fb0b71a30d1092cc4cfc04/889a4/diagram.png\" srcset=\"/static/2bf09a3aa6fb0b71a30d1092cc4cfc04/4dcb9/diagram.png 188w,\n/static/2bf09a3aa6fb0b71a30d1092cc4cfc04/5ff7e/diagram.png 375w,\n/static/2bf09a3aa6fb0b71a30d1092cc4cfc04/889a4/diagram.png 658w\" sizes=\"(max-width: 658px) 100vw, 658px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>Assuming that we have an existing VPC (identified by <code class=\"language-text\">vpc_id</code>), this snippet creates the load balancer.</p>\n<!-- lb -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">data <span class=\"token type variable\">\"aws_subnet_ids\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">vpc_id</span> <span class=\"token punctuation\">=</span> var.vpc_id\n\n  <span class=\"token property\">tags</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">Tier</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Public\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_lb\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>               <span class=\"token punctuation\">=</span> <span class=\"token string\">\"basic-load-balancer\"</span>\n  <span class=\"token property\">load_balancer_type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"network\"</span>\n  <span class=\"token property\">subnets</span>            <span class=\"token punctuation\">=</span> data.aws_subnet_ids.this.ids\n\n  <span class=\"token property\">enable_cross_zone_load_balancing</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">aws_lb</code> resource is confusing because it represents both NLBs and ALBs, depending on the <code class=\"language-text\">load_balancer_type</code> argument. Some arguments only apply to one type, so you’ve got to read the documentation carefully.</p>\n<p><code class=\"language-text\">enable_cross_zone_load_balancing</code> is an <a href=\"https://aws.amazon.com/about-aws/whats-new/2018/02/network-load-balancer-now-supports-cross-zone-load-balancing/\" target=\"_blank\" rel=\"noopener noreferrer\">interesting parameter</a>. It’ll help prevent downtimes by sending traffic to other AZs in case of problems. Cross-AZ traffic ain’t free, so make that an exception!</p>\n<h3>Listeners</h3>\n<p>Our load balancer is not being a <em>good listener</em> right now. We’ve got to fix that. Through the <code class=\"language-text\">aws_lb_listener</code> resource, we specify the ports we want to handle and what to do with them. We want to listen to both port 80 and 443, so we’ll set up two different resources using <code class=\"language-text\">for_each</code>. Let’s have a look at the code.</p>\n<!-- listener -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">variable<span class=\"token type variable\"> \"ports\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">type</span>    <span class=\"token punctuation\">=</span> map(number)\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">http</span>  <span class=\"token punctuation\">=</span> <span class=\"token number\">80</span>\n    <span class=\"token property\">https</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">443</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_lb_listener\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">for_each</span> <span class=\"token punctuation\">=</span> var.ports\n\n  <span class=\"token property\">load_balancer_arn</span> <span class=\"token punctuation\">=</span> aws_lb.this.arn\n\n  <span class=\"token property\">protocol</span>          <span class=\"token punctuation\">=</span> <span class=\"token string\">\"TCP\"</span>\n  <span class=\"token property\">port</span>              <span class=\"token punctuation\">=</span> each.value\n\n  <span class=\"token keyword\">default_action</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">type</span>             <span class=\"token punctuation\">=</span> <span class=\"token string\">\"forward\"</span>\n    <span class=\"token property\">target_group_arn</span> <span class=\"token punctuation\">=</span> aws_lb_target_group.this<span class=\"token punctuation\">[</span>each.key<span class=\"token punctuation\">]</span>.arn\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You see the ports defined in the <code class=\"language-text\">ports</code> variable. Next is the <code class=\"language-text\">protocol</code>. If we only want to forward the request, we use TCP or UDP. We can also choose to <a href=\"https://aws.amazon.com/about-aws/whats-new/2019/01/network-load-balancer-now-supports-tls-termination/\" target=\"_blank\" rel=\"noopener noreferrer\">terminate the TLS connection</a> by using TLS as a protocol. For that, we’d need to set up a certificate, though.</p>\n<p>After port and protocol are there, we need the action to perform. The most common action is to forward it to our receiver target group. Additionally, we can do redirects, fixed results, or even authentication. By the way, I showed how to do authentication in <a href=\"../concourse-fly-behind-alb-oidc/\">this article</a>.</p>\n<h3>Target Groups</h3>\n<p>The last step is defining the target group(s) so that the load balancer knows who will receive the requests. We do that with the <code class=\"language-text\">aws_lb_target_group</code> resource. Here we branch again, as there are different possibilities.</p>\n<h4>Instance-based</h4>\n<p>The target group can point to specific instances. That’s the default <code class=\"language-text\">target_type</code>. You don’t want to explicitly specify instances (What if they go down?), but rather create an <a href=\"https://docs.aws.amazon.com/autoscaling/ec2/userguide/AutoScalingGroup.html\" target=\"_blank\" rel=\"noopener noreferrer\">Autoscaling Group (ASG)</a>. We assume an existing ASG in the code.</p>\n<!-- target-group-instance -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_lb_target_group\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">for_each</span> <span class=\"token punctuation\">=</span> var.ports\n\n  <span class=\"token property\">port</span>        <span class=\"token punctuation\">=</span> each.value\n  <span class=\"token property\">protocol</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"TCP\"</span>\n  <span class=\"token property\">vpc_id</span>      <span class=\"token punctuation\">=</span> var.vpc_id\n\n  <span class=\"token property\">stickiness</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n  <span class=\"token property\">depends_on</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>\n    aws_lb.this\n  <span class=\"token punctuation\">]</span>\n\n  <span class=\"token keyword\">lifecycle</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">create_before_destroy</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_autoscaling_attachment\"</span></span> <span class=\"token string\">\"target\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">for_each</span> <span class=\"token punctuation\">=</span> var.ports\n\n  <span class=\"token property\">autoscaling_group_name</span> <span class=\"token punctuation\">=</span> var.autoscaling_group_name\n  <span class=\"token property\">alb_target_group_arn</span>   <span class=\"token punctuation\">=</span> aws_lb_target_group.this<span class=\"token punctuation\">[</span>each.value<span class=\"token punctuation\">]</span>.arn\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We add a <code class=\"language-text\">depends_on</code> block containing the lb resource so that the dependencies are properly modeled. Otherwise, destroying the resource might not work correctly.</p>\n<h4>IP-based</h4>\n<p>We use the <code class=\"language-text\">target_type</code> <code class=\"language-text\">ip</code> when using IPs instead of instance ids. We assume that these IPs are available and readable through a <code class=\"language-text\">data</code> resource. They are connected to the target group through a <code class=\"language-text\">aws_lb_target_group_attachment</code>.</p>\n<!-- target-group-ip -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_lb_target_group\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">for_each</span> <span class=\"token punctuation\">=</span> var.ports\n\n  <span class=\"token property\">port</span>        <span class=\"token punctuation\">=</span> each.value\n  <span class=\"token property\">protocol</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"TCP\"</span>\n  <span class=\"token property\">vpc_id</span>      <span class=\"token punctuation\">=</span> var.vpc_id\n  <span class=\"token property\">target_type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"ip\"</span>\n\n  <span class=\"token property\">depends_on</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>\n    aws_lb.this\n  <span class=\"token punctuation\">]</span>\n\n  <span class=\"token keyword\">lifecycle</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">create_before_destroy</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_lb_target_group_attachment\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">for_each</span> <span class=\"token punctuation\">=</span> local.ports_ips_product\n\n  <span class=\"token property\">target_group_arn</span>  <span class=\"token punctuation\">=</span> aws_lb_target_group.this<span class=\"token punctuation\">[</span>each.value.port<span class=\"token punctuation\">]</span>.arn\n  <span class=\"token property\">target_id</span>         <span class=\"token punctuation\">=</span> each.value.ip\n  <span class=\"token property\">availability_zone</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"all\"</span>\n  <span class=\"token property\">port</span>              <span class=\"token punctuation\">=</span> each.value\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">locals</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">ports_ips_product</span> <span class=\"token punctuation\">=</span> flatten(\n    <span class=\"token punctuation\">[</span>\n      for port in values(var.ports): <span class=\"token punctuation\">[</span>\n        for eni in keys(data.aws_network_interface.this): <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">port</span> <span class=\"token punctuation\">=</span> port\n          <span class=\"token property\">ip</span>   <span class=\"token punctuation\">=</span> data.aws_network_interface.this<span class=\"token punctuation\">[</span>eni<span class=\"token punctuation\">]</span>.private_ip\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">]</span>\n  )\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">data <span class=\"token type variable\">\"aws_network_interfaces\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">filter</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">name</span>   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"description\"</span>\n    <span class=\"token property\">values</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"ENI for target\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">data <span class=\"token type variable\">\"aws_network_interface\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">for_each</span> <span class=\"token punctuation\">=</span> toset(data.aws_network_interfaces.this.ids)\n  <span class=\"token property\">id</span>       <span class=\"token punctuation\">=</span> each.key\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The connections to the <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html\" target=\"_blank\" rel=\"noopener noreferrer\">ENIs</a> are expressed as a list of [port, ip] pairs. That requires some ungainly terraform loops to define everything properly.</p>\n<p>These are two typical examples, but it’s not the only way of doing it. <a href=\"https://aws.amazon.com/ecs/\" target=\"_blank\" rel=\"noopener noreferrer\">ECS</a> supports adding target groups to reach services directly. If you are working with <a href=\"https://aws.amazon.com/lambda/\" target=\"_blank\" rel=\"noopener noreferrer\">Lambda</a>, that needs an ALB.</p>\n<p>I’ve left a bunch of details out to avoid writing a 10k words article. You can customize the health check (<code class=\"language-text\">health_check</code>) associated with each target group, the algorithm used (<code class=\"language-text\">load_balancing_algorithm_type</code>), and a host of other things. The flexibility can be overwhelming. I recommend starting small.</p>\n<h3>Security Groups</h3>\n<p>Oh yes, security groups. Every so often, running <code class=\"language-text\">curl</code> against your shiny, new infrastructure results in timeouts. Inevitably, you forgot the <a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html\" target=\"_blank\" rel=\"noopener noreferrer\">security groups</a>.</p>\n<p>Network load balancers don’t have associated security groups per se. For both instance and IP based target groups, you add a rule that allows traffic from the load balancer to the target IP.</p>\n<!-- security-groups -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_security_group\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Allow connection between NLB and target\"</span>\n  <span class=\"token property\">vpc_id</span>      <span class=\"token punctuation\">=</span> var.vpc_id\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_security_group_rule\"</span></span> <span class=\"token string\">\"ingress\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">for_each</span> <span class=\"token punctuation\">=</span> var.ports\n\n  <span class=\"token property\">security_group_id</span> <span class=\"token punctuation\">=</span> aws_security_group.this.id\n  <span class=\"token property\">from_port</span>         <span class=\"token punctuation\">=</span> each.value\n  <span class=\"token property\">to_port</span>           <span class=\"token punctuation\">=</span> each.value\n  <span class=\"token property\">protocol</span>          <span class=\"token punctuation\">=</span> <span class=\"token string\">\"tcp\"</span>\n  <span class=\"token property\">type</span>              <span class=\"token punctuation\">=</span> <span class=\"token string\">\"ingress\"</span>\n  <span class=\"token property\">cidr_blocks</span>       <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Getting to our load balancer</h2>\n<p>That’s about it. With all these resources, we’ve got ourselves a working load balancer!</p>\n<p>All load balancers are reachable through their automatically assigned DNS entry. We can programmatically find it thanks to the <a href=\"https://aws.amazon.com/cli/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS CLI</a>.</p>\n<!-- curl -->\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">LB_NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"basic-load-balancer\"</span>\n<span class=\"token assign-left variable\">dns</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>aws elb describe-load-balancers --load-balancer-name $LB_NAME <span class=\"token operator\">|</span> jq <span class=\"token parameter variable\">-r</span> <span class=\"token string\">'.LoadBalancerDescriptions[0].DNSName'</span><span class=\"token variable\">)</span></span>\n<span class=\"token function\">nslookup</span> <span class=\"token variable\">$dns</span></code></pre></div>\n<p>Provided there is a registered target, we can query it using the content of <code class=\"language-text\">dns</code> and see that our setup, in fact, works.</p>\n<h3>Internal Load Balancers</h3>\n<p>A load balancer doesn’t always have to be publicly available. Let’s say you use <a href=\"../understanding-vpc-endpoints/\">VPC endpoints</a> to keep your traffic inside AWS’s network. We don’t want to expose our load balancer to the public if it’s going to sit behind a VPC endpoint service. Instead, you set the <code class=\"language-text\">internal</code> parameter to <code class=\"language-text\">true</code>. The LB can live in a private subnet.</p>\n<h2>Operations</h2>\n<p><strong>Operations</strong> is a bit of a strong word. There is not <em>a lot</em> to operate here. Not for us, at least. Still, let’s finish with some thoughts about that.</p>\n<p>Out of the box, a lot of <a href=\"https://aws.amazon.com/cloudwatch/\" target=\"_blank\" rel=\"noopener noreferrer\">CloudWatch</a> metrics are exported for your convenience. The AWS Console has some nice charts to look at. You could use another monitoring tool if you wish.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 675px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/7396067b737b68e4721294892ceb034e/23296/monitoring.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 28.723404255319153%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA6klEQVR42pWQy0oEMRRE+/+/yKU/4MaNK3EhyDT29DPJfSVdU92Dgiu1IBCSqrqc213nDUsW1B0oRfA5zlizQrxBVTEvC+Z1haghoiKlRF+Bu6O1xntGuGLfWUB1jy8DHp57PL1NUGOoVgSNUdsZymLYJJA04BEsDTSGK/+Pwjkb3q8Fr/2GMTu6IorC6eo0th1myonOQD0nRvhZcpxDQn8iSSqKysI1CYYl8xQUC3SmxK1384G4EE+Nhe2OQJYT5wvpN3UfY8FlKhg2g3A3a8rIxMvqfy75UXgZE/opY9zkfDj25mHfiP/VDd0w1f6G3afnAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"monitoring\" title=\"\" src=\"/static/7396067b737b68e4721294892ceb034e/23296/monitoring.png\" srcset=\"/static/7396067b737b68e4721294892ceb034e/4dcb9/monitoring.png 188w,\n/static/7396067b737b68e4721294892ceb034e/5ff7e/monitoring.png 375w,\n/static/7396067b737b68e4721294892ceb034e/23296/monitoring.png 675w\" sizes=\"(max-width: 675px) 100vw, 675px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <figcaption class=\"figure__caption\">\n  Pretty lines make everything better\n  </figcaption>\n</figure>\n<p>What about costs? As you can see on the <a href=\"https://aws.amazon.com/elasticloadbalancing/pricing/\" target=\"_blank\" rel=\"noopener noreferrer\">pricing page</a>, an NLB has a fixed price, plus a fairly arcane operating cost based on <em>Load Balancer Capacity Units (LCU)</em>. Honestly, the easiest way to monitor expenditures is by looking at previous months in the Cost Explorer.</p>\n<p>Lastly, performance. An NLB <em>scales</em> like there is no tomorrow. Each unique target IP can support 55000 simultaneous connections, and the whole thing should be merrily passing along requests long after your applications have collapsed into a smoking pile of ashes. The word <em>managed</em> is genuinely appropriate because you’ll rarely have to do anything past the provisioning.</p>\n<h2>Conclusion</h2>\n<p>Load balancers are an integral part of every cloud setup. It’s a vast topic as well, and thus I could only scratch the surface. However, this is enough to get started with a rock-solid foundation.</p>","frontmatter":{"layout":"post","title":"Provisioning a Network Load Balancer with Terraform","path":"/provisioning-a-network-load-balancer-with-terraform/","categories":["AWS","Terraform","Load Balancing","Networking","Infrastructure as Code"],"date":"2020/11/17","draft":false,"description":"Learn how to provision Network Load Balancers in AWS using Terraform to ensure high availability for your applications","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#a8a8a8","images":{"fallback":{"src":"/static/e9e42d18a599da2296397c7c01a01c39/7284f/lb.jpg","srcSet":"/static/e9e42d18a599da2296397c7c01a01c39/2d550/lb.jpg 188w,\n/static/e9e42d18a599da2296397c7c01a01c39/e4b93/lb.jpg 375w,\n/static/e9e42d18a599da2296397c7c01a01c39/7284f/lb.jpg 750w,\n/static/e9e42d18a599da2296397c7c01a01c39/3564b/lb.jpg 1500w","sizes":"(min-width: 750px) 750px, 100vw"},"sources":[{"srcSet":"/static/e9e42d18a599da2296397c7c01a01c39/99097/lb.webp 188w,\n/static/e9e42d18a599da2296397c7c01a01c39/7dad0/lb.webp 375w,\n/static/e9e42d18a599da2296397c7c01a01c39/57584/lb.webp 750w,\n/static/e9e42d18a599da2296397c7c01a01c39/2b8d7/lb.webp 1500w","type":"image/webp","sizes":"(min-width: 750px) 750px, 100vw"}]},"width":750,"height":500}}}}},"related":{"nodes":[{"frontmatter":{"title":"Testing containers with dependencies with localstack","path":"/testing-containers-serverspec-and-localstack/","date":"2019/01/21"}},{"frontmatter":{"title":"Understanding VPC endpoints","path":"/understanding-vpc-endpoints/","date":"2020/08/20"}},{"frontmatter":{"title":"Provisioning an Application Load Balancer with Terraform","path":"/provisioning-an-application-load-balancer-with-terraform/","date":"2021/01/02"}}]},"previous":{"frontmatter":{"title":"Book Review: The art of leadership","path":"/book-review-the-art-of-leadership/","date":"2020/08/28"}},"next":{"frontmatter":{"title":"Understanding VPC endpoints","path":"/understanding-vpc-endpoints/","date":"2020/08/20"}}},"pageContext":{"related":["/provisioning-an-application-load-balancer-with-terraform/","/understanding-vpc-endpoints/","/testing-containers-serverspec-and-localstack/"],"previous":"/book-review-the-art-of-leadership/","next":"/understanding-vpc-endpoints/"}},"staticQueryHashes":[],"slicesMap":{}}