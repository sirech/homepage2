{"componentChunkName":"component---src-templates-blog-post-js","path":"/applications-instead-of-libraries/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for Meta","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"be0e15e1-69af-56de-a9e3-9c2243884a34","html":"<figure class=\"figure figure--left\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/bde962ad076eb191a1a8127873ceedb5/7f61c/cover.webp\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/webp;base64,UklGRrQAAABXRUJQVlA4WAoAAAAQAAAAEwAADgAAQUxQSB4AAAABF6AgbQOmO64nfjYiIr6CINumGdn92Q4Q0f8IewFWUDggcAAAAPADAJ0BKhQADwA+0VSkS6gko6GwCAEAGglmALsAId9nyVKIvzIqRwAA/u5ncWrG34ByKMWbv6f2BwCmtdAMeJx9cNgczYWvBX1Ew9FmCUl1emJpw/K1zv1eNvyoqkL9P09mJFp2mxbJtwDmV5hwAAA='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Cover\" title=\"\" src=\"/static/bde962ad076eb191a1a8127873ceedb5/7f61c/cover.webp\" srcset=\"/static/bde962ad076eb191a1a8127873ceedb5/7b30e/cover.webp 188w,\n/static/bde962ad076eb191a1a8127873ceedb5/f3a60/cover.webp 375w,\n/static/bde962ad076eb191a1a8127873ceedb5/7f61c/cover.webp 400w\" sizes=\"(max-width: 400px) 100vw, 400px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p><em>Contributors: Ben Barnett, Diego Fiore, Verónica Machado, and Will Conover.</em></p>\n<p>In our <a href=\"https://www.aboutwayfair.com/careers/tech-blog/applications-instead-of-libraries-part-1\" target=\"_blank\" rel=\"noopener noreferrer\">previous post</a>, we talked about the reasons that led us to consider a micro frontend architecture for Partner Home, the supplier portal for Wayfair. Now it’s time to dive into the details.</p>\n<p>In this post, we’re going to talk about how we leveraged Module Federation to implement decoupled applications to improve the experience of our suppliers. An application has a frontend and backend, and it owns a complete flow within our Partner Home portal. We’ll cover how to set up host applications that consume remote ones and how we’ve built micro frontends using this pattern. Lastly, we’ll talk about how we made the setup production-ready.</p>\n<h2>A Start Full of Hope</h2>\n<p>There are multiple ways of implementing <a href=\"https://martinfowler.com/articles/micro-frontends.html\" target=\"_blank\" rel=\"noopener noreferrer\">micro frontends</a>, and each has tradeoffs. We decided to use Webpack’s new <a href=\"https://webpack.js.org/concepts/module-federation/\" target=\"_blank\" rel=\"noopener noreferrer\">Module Federation feature</a>. These are some of our considerations:</p>\n<ul>\n<li>At this point, a good chunk of our traffic still goes to the monolith. We don’t have many decoupled applications to support, yet. Thus, new technology isn’t a huge issue</li>\n<li>We know that every application uses React, which allows us to gear our solution towards it</li>\n<li>Changing the bundling of applications is something that we can control and enforce</li>\n<li>We don’t need to support server-side rendering. React 18 brings <a href=\"https://github.com/reactwg/react-18/discussions/37\" target=\"_blank\" rel=\"noopener noreferrer\">some changes</a> for that</li>\n</ul>\n<p>With these factors in mind, the seamless integration that you get using federated modules becomes very appealing.</p>\n<p>What we aim for is: Two applications, a host and a remote, integrated to provide a unified experience. It’s important to note that these are independent applications. They have their repository and they have their CI/CD pipeline; and two separate teams are likely responsible for them. This <a href=\"https://github.com/sirech/example-applications-instead-of-libraries\" target=\"_blank\" rel=\"noopener noreferrer\">repository</a> presents a scaled-down version of our solution that illustrates the structure that we follow internally.</p>\n<p>Now, on to the code!</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/6914c0ba13799f168521ac23878676be/6f92b/remote-application.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 81.38297872340425%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC0UlEQVR42p2U709SURjH+dt6UVtzteWLtma0Zmv5IrM1qfy91mprKwhCkOsVkTtBUWKVaLqs5dS0EggVULgIqKgp8kOB3XMv3y6EJJmu+ex+7jnnObufPfecnSNJeDwX2NCMZT3+szMWT+l3ksky8rnIxpZ+bWtLvxNPHge9vZswxxKJCkkul2vB7+CEXA5CDhAfFPr4vxAdfLHbJMm/ioMM4bOE49KEI+lSS/gMEYRsAV7IFMZ/A4HP5gU8zzdIeP6gQoELbdrhj/aA3TSD3TAhuGmCL8zA6dPD4e2C228AGzUV5grzG2YsrXUjngoUKuQ4rumQkOcC0X58nGvEyHQ93n+RlRielGFoQoaRKRlGZ+6XyM9NuFqwm/IVhdmmsgoD6wOwjtfANFKN/rGbMIstMyRFj0iXTQqj/Q+M/RoM76pgn7qLxP7yUaEg8BwbHYR7RYXR6YdiRfcw/q0F3ggFL6vDUjAPVcIXzOcpLARViCW9xwg3BuH0y6GzVEJpPIce+1UsuzqRpq3Y7ezHqobBarsRYbUB2zoTspQNoVEK22nPCcKAHHrbFWj7LqJ3rBr+ORoZhQWp5wxSyn7sqa2IqQaQ0AyAqN9gdYg+QRgdgDuoxKfvbfgw24iJ+UdYctAI3GmFs6oa4QdPEa5tRqCuAYO626C1UnwdeoJE+oQ1dLEK6F9LoWYqYRI3ZnGWxnJtKxyiMFj/GKEbdfDfqoWGvozmjjOYHG5Fcj9w/C+7WDlUzCW0vTgLnbUKnlkKaUUfUnIGe6o+JOW9iCsYeKiXcLQ/g8+uRCzt+7cwELUUhJbRGhhs1/H2cx28Kxr4XB1Y+iHu8kErwjpphJzdWPQqsZM6vIbFoycKM+y6lcyvvCKeMEU8ER1ZDOvIQkhLFiJHmV/ViGiJO6Qk8dRytnhSGsouB5wyyi4HQkgFIYJJEAStmKBOgyCgQ/zeSIDzvwBB3Eb6iDfZ2AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Remote application\" title=\"\" src=\"/static/6914c0ba13799f168521ac23878676be/1d69c/remote-application.png\" srcset=\"/static/6914c0ba13799f168521ac23878676be/4dcb9/remote-application.png 188w,\n/static/6914c0ba13799f168521ac23878676be/5ff7e/remote-application.png 375w,\n/static/6914c0ba13799f168521ac23878676be/1d69c/remote-application.png 750w,\n/static/6914c0ba13799f168521ac23878676be/78797/remote-application.png 1125w,\n/static/6914c0ba13799f168521ac23878676be/aa440/remote-application.png 1500w,\n/static/6914c0ba13799f168521ac23878676be/6f92b/remote-application.png 1501w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<h2>Exporting Modules from an Application</h2>\n<p>Let’s start from the beginning. A remote application provides some components. Another team wants to benefit from those. A tale as old as time.</p>\n<p>The first step to export a module is the Webpack configuration. Do you avoid Webpack configurations like the plague? Do you stick to <a href=\"https://reactjs.org/docs/create-a-new-react-app.html\" target=\"_blank\" rel=\"noopener noreferrer\">CRA</a> as much as possible? I don’t blame you, but this time there is no way around some Webpack trickery. Luckily, the configuration to export a component is pretty manageable.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">new</span> <span class=\"token class-name\">ModuleFederationPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'remote'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">filename</span><span class=\"token operator\">:</span> <span class=\"token string\">'remoteEntry.js'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">exposes</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string-property property\">'./Welcome'</span><span class=\"token operator\">:</span> <span class=\"token string\">'./src/Welcome'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">shared</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">react</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">requiredVersion</span><span class=\"token operator\">:</span> deps<span class=\"token punctuation\">.</span>react<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">singleton</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">'react-dom'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">requiredVersion</span><span class=\"token operator\">:</span> deps<span class=\"token punctuation\">[</span><span class=\"token string\">'react-dom'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">singleton</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">'@applications-instead-of-libraries/shared-library'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">import</span><span class=\"token operator\">:</span> <span class=\"token string\">'@applications-instead-of-libraries/shared-library'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">requiredVersion</span><span class=\"token operator\">:</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../shared-library/package.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>version<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">'@material-ui/core'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">requiredVersion</span><span class=\"token operator\">:</span> deps<span class=\"token punctuation\">[</span><span class=\"token string\">'@material-ui/core'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">singleton</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Full configuration is <a href=\"https://github.com/sirech/example-applications-instead-of-libraries/blob/master/remote/webpack.config.js\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>.</p>\n<p>Dependencies are a tricky side of micro frontends. You don’t want to force the users to download React multiple times when loading a page. On the other hand, strong coupling between applications defeats the approach’s purpose.</p>\n<p>In our case, we use shared dependencies. Shared dependencies are a critical bit of configuration to ensure applications work as expected, and are resilient to upgrades in the future.</p>\n<p>Shared dependencies prevent duplication, version mismatching and provide a common internal state. For example, we ensure that React is configured as a singleton, meaning there can be only one instance running at a time. This is true for a bunch of other libraries, such as our component libraries too.</p>\n<p>In a nutshell, we offer all dependencies as potentially shared dependencies. This means that the part of the application to hit the dependency first will load it, and then <a href=\"https://stackoverflow.com/questions/65634232/how-does-module-federation-choose-which-dependency-version-to-use\" target=\"_blank\" rel=\"noopener noreferrer\">make it available</a> for any other components that might need it later. In practice, this has an additional benefit of progressively loading dependencies, thus reducing initial bytes required.</p>\n<h2>Integrating a Remote Module in an Application</h2>\n<p>Our remote application is live and ready to go. Now it’s time to import some components into the host application. Just like in the previous section, it all starts with a Webpack configuration:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">new</span> <span class=\"token class-name\">ModuleFederationPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">'host'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">remotes</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">remote</span><span class=\"token operator\">:</span> <span class=\"token string\">'remote@http://localhost:3002/remoteEntry.js'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">shared</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">react</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">requiredVersion</span><span class=\"token operator\">:</span> deps<span class=\"token punctuation\">.</span>react<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">singleton</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">'react-dom'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">requiredVersion</span><span class=\"token operator\">:</span> deps<span class=\"token punctuation\">[</span><span class=\"token string\">'react-dom'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">singleton</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">'@applications-instead-of-libraries/shared-library'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">import</span><span class=\"token operator\">:</span> <span class=\"token string\">'@applications-instead-of-libraries/shared-library'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">requiredVersion</span><span class=\"token operator\">:</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../shared-library/package.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>version<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">'@material-ui/core'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">requiredVersion</span><span class=\"token operator\">:</span> deps<span class=\"token punctuation\">[</span><span class=\"token string\">'@material-ui/core'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">singleton</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Full configuration is <a href=\"https://github.com/sirech/example-applications-instead-of-libraries/blob/5442b9c4cbb996bcab0ef9a056be896ecfc3d900/host/webpack.config.js\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>.</p>\n<p>Simple enough, yet highly problematic. Can you spot the issue? That pesky, hardcoded URL! Our applications don’t have one source of truth, as we have multiple environments. Moreover, we need to consider other factors like the locale or the branding. All in all, different permutations are pointing to separate URLs.</p>\n<p>To make it even more challenging, the locale is only available at runtime for us. Our solution is a bespoke component that builds the right URL and fetches the correct modules right before using them. Let’s call it a RemoteComponent.</p>\n<p>Loading modules dynamically requires <a href=\"https://github.com/sirech/example-applications-instead-of-libraries/tree/master/shared-library/src/RemoteComponent\" target=\"_blank\" rel=\"noopener noreferrer\">quite a bit of code</a> to find the right bundle through Webpack. There’s a <a href=\"https://www.npmjs.com/package/external-remotes-plugin\" target=\"_blank\" rel=\"noopener noreferrer\">module in the community</a> to enable dynamic loading that looks quite promising.</p>\n<p>Once we have the setup sorted out, it’s time to use a component in our code. We chose to use a dynamic import within a <a href=\"https://reactjs.org/docs/code-splitting.html\" target=\"_blank\" rel=\"noopener noreferrer\">React Suspense</a> wrapper. We have a thin wrapper around Suspense which provides consistent UX patterns for loading and error states.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LazyModule</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">static</span> <span class=\"token function\">getDerivedStateFromError</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> error <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// log error</span>\n  <span class=\"token function\">componentDidCatch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_error<span class=\"token punctuation\">,</span> errorInfo</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>error <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> errorFallback <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>error\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>React<span class=\"token punctuation\">.</span><span class=\"token function\">isValidElement</span><span class=\"token punctuation\">(</span>errorFallback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> errorFallback\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> errorFallback <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">errorFallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>error <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token operator\">&lt;</span>React<span class=\"token punctuation\">.</span>Suspense fallback<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>delayed <span class=\"token operator\">??</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n        <span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">}</span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>React<span class=\"token punctuation\">.</span>Suspense<span class=\"token operator\">></span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>See the full component <a href=\"https://github.com/sirech/example-applications-instead-of-libraries/blob/master/shared-library/src/LazyModule/LazyModule.js\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>.</p>\n<p>The need for all of this abstraction will become apparent shortly.For now, our hard work is paying off because our component loads dynamically in the browser! You can see how remote modules are loaded afterward here:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/ad2fb3d44403abd9fd9c35ecd4a87a11/fad48/remote-loading.webp\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 84.57446808510639%; position: relative; bottom: 0; left: 0; background-image: url('data:image/webp;base64,UklGRlwAAABXRUJQVlA4IFAAAADwAwCdASoUABEAPtFepE6oJSMjKAqpABoJaRLgAACRAgUqXB/2b1KAAP7yUYdPUT4np9NrdtA3GZKIL4o4t6P2th35AkGgtfDaZQe5BUAAAA=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Remote loading\" title=\"\" src=\"/static/ad2fb3d44403abd9fd9c35ecd4a87a11/08b4d/remote-loading.webp\" srcset=\"/static/ad2fb3d44403abd9fd9c35ecd4a87a11/7b30e/remote-loading.webp 188w,\n/static/ad2fb3d44403abd9fd9c35ecd4a87a11/f3a60/remote-loading.webp 375w,\n/static/ad2fb3d44403abd9fd9c35ecd4a87a11/08b4d/remote-loading.webp 750w,\n/static/ad2fb3d44403abd9fd9c35ecd4a87a11/5543b/remote-loading.webp 1125w,\n/static/ad2fb3d44403abd9fd9c35ecd4a87a11/293e0/remote-loading.webp 1500w,\n/static/ad2fb3d44403abd9fd9c35ecd4a87a11/fad48/remote-loading.webp 1600w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<h2>Beyond Single Components: A Frame Application</h2>\n<p>Loading simple components has its value, but it’s not quite micro frontends, is it? There are established ways of sharing UX components (picture <a href=\"https://material-ui.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Material-UI</a>) with, frankly, less overhead.</p>\n<p>The value surfaces as the components evolve toward full-fledged applications. A component that has its state and fetches data from a backend. However, we’ve faced many questions about ownership: If the component needs data, who passes the data? Is the host application responsible? Who owns that backend?</p>\n<p>This is how we ended up with micro frontends. We want to treat a remote application as an entity with its lifecycle. We call them frame applications. It’s a wrapper that encapsulates the remote components until they form a proper application. It looks something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> Context <span class=\"token operator\">=</span> <span class=\"token function\">createContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useContext</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> React<span class=\"token punctuation\">.</span><span class=\"token function\">useContext</span><span class=\"token punctuation\">(</span>Context<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">WelcomeFrame</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>Context<span class=\"token punctuation\">.</span>Provider value<span class=\"token operator\">=</span><span class=\"token string\">\"[private]\"</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>Card variant<span class=\"token operator\">=</span><span class=\"token string\">\"outlined\"</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>CardHeader title<span class=\"token operator\">=</span><span class=\"token string\">\"WelcomeFrame\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>CardHeader<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>CardContent<span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>Welcome <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>CardContent<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Card<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Context<span class=\"token punctuation\">.</span>Provider<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>See the full file <a href=\"https://github.com/sirech/example-applications-instead-of-libraries/blob/master/remote/src/WelcomeFrame.js\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>.</p>\n<p>In our experience, the <a href=\"https://reactjs.org/docs/context.html\" target=\"_blank\" rel=\"noopener noreferrer\">Context API</a> works beautifully to allow frame applications to handle their state in a lightweight way. It’s important to note that this state is hidden from the host application, providing encapsulation.</p>\n<p>A frame application might want to fetch some data. We want to ensure strong encapsulation so that the host application can’t inadvertently influence this. We use <a href=\"https://www.apollographql.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Apollo</a> to connect with our backends, but this applies to any way of interacting with APIs.</p>\n<h2>Testing a Frame Application</h2>\n<p>You might be asking, <em>“All this sounds great, but how do you test it?”</em>  Glad we’re on the same page. Testing is crucial. We’re not distributing it as a library, but rather deploying it immediately as an application. If we break something, the mess propagates rapidly. Nobody wants that.</p>\n<p>We follow the <a href=\"https://kentcdodds.com/blog/the-testing-trophy-and-testing-classifications\" target=\"_blank\" rel=\"noopener noreferrer\">testing trophy</a> for our frontend-based tests. The first layer is composed of unit tests. <a href=\"https://github.com/testing-library/jest-dom\" target=\"_blank\" rel=\"noopener noreferrer\">jest-dom</a> can’t handle remote module loading, so we need to mock it.</p>\n<p>We want to confirm that the remote modules load correctly. To do so, we have a thin layer of end-to-end tests on top, built with <a href=\"https://www.cypress.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Cypress</a>. They enhance our unit tests and increase our peace of mind.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">context</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Integrated Application'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">beforeEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'shows the integrated remote component'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    cy<span class=\"token punctuation\">.</span><span class=\"token function\">visit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://localhost:3001'</span><span class=\"token punctuation\">)</span>\n\n    cy<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Host Application'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">should</span><span class=\"token punctuation\">(</span><span class=\"token string\">'exist'</span><span class=\"token punctuation\">)</span>\n    cy<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">'The selected locale is de-DE'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">should</span><span class=\"token punctuation\">(</span><span class=\"token string\">'exist'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Where do these tests run? This is where we encounter a slight ownership conflict. The host application and the frame application might be developed by two different teams. Without a clear boundary, expensive handovers are unavoidable.</p>\n<p>To mitigate the issue, we configure each Frame Application to consume its modules remotely so that it works as both host and remote at the same time. We deploy it to our test environment and test against that. That provides the independence we’re seeking.</p>\n<p>This setup has another usage: local development. Iteration speed is paramount, and that’s easier to achieve if we strip all the integrations while a developer is working locally. Our <code class=\"language-text\">RemoteComponent</code> handles that.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/8699f404c9d7b0bb549e06065429d573/fad48/remote-application-local.webp\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 81.38297872340425%; position: relative; bottom: 0; left: 0; background-image: url('data:image/webp;base64,UklGRsIAAABXRUJQVlA4WAoAAAAQAAAAEwAADwAAQUxQSCsAAAABL6CQbQQ4dB/W3C4igrAcaiJJYZ5gBSHJAYN/Nd9SR/R/AnKo79H4QA51AFZQOCBwAAAAkAMAnQEqFAAQAD7RVqRLqCSjobAIAQAaCWwAAFvpBEs/ZeGBwAD+ypUOsnKHqzoCOhzC1X1Mf1obvn6PMDqzg/BzXv+GwPX0v+Od9SZ534fQuC79v6h959R6km0335cvGJtC2sEFIRD+fQnawScAAA=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Local development\" title=\"\" src=\"/static/8699f404c9d7b0bb549e06065429d573/08b4d/remote-application-local.webp\" srcset=\"/static/8699f404c9d7b0bb549e06065429d573/7b30e/remote-application-local.webp 188w,\n/static/8699f404c9d7b0bb549e06065429d573/f3a60/remote-application-local.webp 375w,\n/static/8699f404c9d7b0bb549e06065429d573/08b4d/remote-application-local.webp 750w,\n/static/8699f404c9d7b0bb549e06065429d573/5543b/remote-application-local.webp 1125w,\n/static/8699f404c9d7b0bb549e06065429d573/293e0/remote-application-local.webp 1500w,\n/static/8699f404c9d7b0bb549e06065429d573/fad48/remote-application-local.webp 1600w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<h2>Watch Out for Coupling</h2>\n<p>It is important to repeat that this approach is supposed to increase autonomy. Anything that brings coupling back is a significant risk that we have to assess carefully.</p>\n<p>And yet, it seems that there are some natural points of integration. For instance, we have a custom logger that we use throughout every application which ensures that logs make it to our centralized logging system in a consumable format. We don’t want this to be reimplemented per application, as it’s a platform-shared concern.</p>\n<p>So we built a provider (see <a href=\"https://github.com/sirech/example-applications-instead-of-libraries/blob/master/shared-library/src/LanguageProvider.js\" target=\"_blank\" rel=\"noopener noreferrer\">this one</a> as an inspiration). It’s part of the shared dependencies of the host and frame application.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LanguageProvider</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>de-DE<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Box</span></span> <span class=\"token attr-name\">p</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">RemoteComponent</span></span>\n      <span class=\"token attr-name\">component</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>WelcomeFrame<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">delayed</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Loading...</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">}</span></span>\n    <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Box</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">LanguageProvider</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>We expect this provider to be there. Every page renders it at the top, guaranteed. If it’s not, Frame Applications are allowed to bail with a nasty error. This is a contract that we make with all the applications that participate in the ecosystem. It works well because we keep the surface area as small as possible. Still, we’re fully aware that this integration point can easily go awry if we aren’t careful.</p>\n<h2>“It Works” is not the same as “Production-Ready”</h2>\n<p>Our Frame Application started as a proof of concept to test its viability. However, being viable does not  mean“releasable”. Before going to production, we have to ensure it’s solid.</p>\n<p>Testing is the first step. A strong test suite that accounts for the remote loading part is not negotiable. Good start, but not enough.</p>\n<p>Remember our custom <a href=\"https://github.com/sirech/example-applications-instead-of-libraries/blob/master/shared-library/src/LazyModule/LazyModule.js\" target=\"_blank\" rel=\"noopener noreferrer\">LazyModule</a>? Well, we want to monitor these components. If they blow up, it has to be a controlled demolition. And we want to hear about it. For that reason, our LazyModule makes heavy use of <a href=\"https://reactjs.org/docs/error-boundaries.html\" target=\"_blank\" rel=\"noopener noreferrer\">error boundaries</a> to prevent a cascading failure. We attach a logger to the boundary to get detailed telemetry.</p>\n<p>The way you monitor an application is highly dependent on its implementation. It’s harder to set concrete expectations, rather than do it. We have been using <a href=\"https://www.datadoghq.com/\" target=\"_blank\" rel=\"noopener noreferrer\">DataDog</a>, but, to be fair, many monitoring tools provide similar functionality. We particularly like using <a href=\"https://www.datadoghq.com/product/real-user-monitoring/\" target=\"_blank\" rel=\"noopener noreferrer\">RUM</a> to stay on top of everything that happens inside our clients. We like it so much that we initialize it automatically as part of our provider so that every team can benefit from it.</p>\n<h2>The Beginning of a Journey</h2>\n<p>Micro frontends aren’t a silver bullet. As we often say, you can’t solve organizational problems with technology alone.</p>\n<p>However, the early results are promising, and we plan to use module federation to decouple our different applications. This is just the beginning of the journey. Our examples show that there is still much to do and there is no substitute for running things in production to compile valid data. If you’re intrigued, check out the <a href=\"https://github.com/sirech/example-applications-instead-of-libraries\" target=\"_blank\" rel=\"noopener noreferrer\">example repository</a>. Let us know about your experience!</p>\n<p>As for the future, we’re focused on scaling this solution to support multiple remote applications in the most transparent way possible. Stay tuned for follow-up articles!</p>\n<p><em>This post was published initially in <a href=\"https://www.aboutwayfair.com/careers/tech-blog/applications-instead-of-libraries-part-2\" target=\"_blank\" rel=\"noopener noreferrer\">Wayfair</a>.</em></p>","frontmatter":{"layout":"post","title":"Applications Instead of Libraries","path":"/applications-instead-of-libraries/","categories":["Architecture","React","Micro frontends","JavaScript"],"date":"2021/11/20","draft":false,"description":"Using module federation to implement micro frontends","canonical":"https://www.aboutwayfair.com/careers/tech-blog/applications-instead-of-libraries-part-2","image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/bde962ad076eb191a1a8127873ceedb5/f5c71/cover.webp","srcSet":"/static/bde962ad076eb191a1a8127873ceedb5/f6ea0/cover.webp 100w,\n/static/bde962ad076eb191a1a8127873ceedb5/b5535/cover.webp 200w,\n/static/bde962ad076eb191a1a8127873ceedb5/f5c71/cover.webp 400w","sizes":"(min-width: 400px) 400px, 100vw"},"sources":[]},"width":750,"height":562.5}}}}},"related":{"nodes":[{"frontmatter":{"title":"Book Review: Team topologies","path":"/book-review-team-topologies/","date":"2021/02/08"}},{"frontmatter":{"title":"Starting you new React application with Redux? Consider a simpler approach using the Context API","path":"/starting-a-new-app-with-redux-consider-context-api-first/","date":"2021/05/11"}},{"frontmatter":{"title":"Scalable Architecture: A Definition and How-To Guide","path":"/scalable-architecture-a-definition-and-how-to-guide/","date":"2021/05/18"}}]},"previous":{"frontmatter":{"title":"Synthetic Monitoring: A Detailed Introductory Guide","path":"/synthetic-monitoring-a-detailed-introductory-guide/","date":"2021/12/06"}},"next":{"frontmatter":{"title":"The System Design Interview","path":"/the-system-design-interview/","date":"2022/08/08"}}},"pageContext":{"related":["/starting-a-new-app-with-redux-consider-context-api-first/","/scalable-architecture-a-definition-and-how-to-guide/","/book-review-team-topologies/"],"previous":"/synthetic-monitoring-a-detailed-introductory-guide/","next":"/the-system-design-interview/"}},"staticQueryHashes":[],"slicesMap":{}}