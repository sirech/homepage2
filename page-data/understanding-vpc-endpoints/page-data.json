{"componentChunkName":"component---src-templates-blog-post-js","path":"/understanding-vpc-endpoints/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for Meta","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"717fd6e2-860d-5e1a-bd5e-e9f40a55f896","html":"<figure class=\"figure figure--left\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 485px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/ef6a957565cfc675c990047011368726/44c61/private_communication.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 69.68085106382979%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACU0lEQVR42q2Ty2sTURTGs3PhP6E7oShSxI0IpqBQsuhOqi4URLQbV24E0U1FpFiKilYqLloEqcS2pEqjJhobDNEYFdLWamhoOq/MI5lkkplkXp93bkiITRQFL3wwl3Pnd8+55zs+bFuu63bpX5av9dGwHazktpDlZYi6hULNbKragGnbnVf2UAewtdXqFn7INeTUOri6C85wwdRc5DULtYb19xm2gFUC9CA8gW1IJnJEPIXabaBXvljhwBRzYEs5cOomRI2F49rdQO+nTdVC8qOKt1EZMaIPqTLyZQvVhknPrPMZDI7vxfDkIVyYCeDs9ACOP9yPdP4djXvgNlAn75TOVBANS3gxJyA0yyHyUsKXVQ2G08wwkY1haOIgrgTPY2RmCFfnz2F46gAi357RuO3Yv2aYSKoIhwpYDPKYe8wi9bmC1FcVYlGjb7/06TmO3tyHE/cGcPKBH9fmR3DmkR+vVoPdQN2ykUx55SoIPeWo3idKBFhGxWjQM8trb3BktA+n7h/D4eu7cenJaQQm+hBZW+gNXGfqiMeLJEsB4cUClmMKvrMGiTXfMJmNY9fFnfAT6OBYPwK3+rHn8g68XukB1GiXHdrhdEaj2pBNsLpNYk1gWVcxFb2D20s3ML4wisnIGKbjd0nn+bYL2sY2TAtMxQRHAJLlQnEA0SQ2IrbxTL99mgxieMdxfz8pzZQd0noXpVIZLCdAlGQqSZahFItQFAWcwKMgibCJKxxy3ivT7ZgWXy+313QdHM9TeTBBKIAXBLrfYhjwvADLsv48y/9r/QQxJQQeZgSulgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Private communication\" title=\"\" src=\"/static/ef6a957565cfc675c990047011368726/44c61/private_communication.png\" srcset=\"/static/ef6a957565cfc675c990047011368726/4dcb9/private_communication.png 188w,\n/static/ef6a957565cfc675c990047011368726/5ff7e/private_communication.png 375w,\n/static/ef6a957565cfc675c990047011368726/44c61/private_communication.png 485w\" sizes=\"(max-width: 485px) 100vw, 485px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>If you are going to do one thing with your network traffic, it should be using https. But you already do that, don’t you? Once you have that in place, why not use <a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/vpc-endpoints.html\" target=\"_blank\" rel=\"noopener noreferrer\">VPC endpoints</a> to make your data flow through private channels?</p>\n<p>With VPC endpoints, you can connect to most AWS services without ever leaving Amazon’s network. Not only that, but you can connect two of your services in different VPCs, even across accounts. It doesn’t replace the need for <a href=\"https://searchsecurity.techtarget.com/definition/end-to-end-encryption-E2EE\" target=\"_blank\" rel=\"noopener noreferrer\">End-to-End Encryption</a>, but it adds an extra layer of security. Maybe keeping the traffic private can help convince some cloud skeptics along the way.</p>\n<p>You’ll find many guides using the <em>AWS Management Console</em>. Don’t do that. Let’s use <a href=\"https://www.terraform.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform</a> to provision them instead. Code is easier to follow than screenshots.</p>\n<h2>Accessing AWS services</h2>\n<p>A typical setup is having instances in a private subnet and go through a <a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html\" target=\"_blank\" rel=\"noopener noreferrer\">NAT gateway</a> to reach AWS services (i.e., S3).</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/00ef2251e1bc52ac06a58c67e05e0666/ae21e/connecting_to_s3_over_the_internet.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 78.19148936170212%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACdElEQVR42p2Uy2vUUBTG+wf4R7gSd65040J040JwJ7hwoeBCXAlu3NtWi/gExbZS1GpdVEQoCkV0U/quWGecVhjbZiY3mSQzSZqb1+R1P0/T2Fl0lMHAx4V7vvO7J+c++tDD13BkMHuzFyv6/hYQQuRjlLRx9eU5XH5xGnHa3o1B/AewSMqyDCNf7uPR9E1kIuutwjDJ4MYZvC7ySTHFozhFELXhhwG8KOrqE3+AzSBF3c3AvG5KUK7UUS5JaLoqDK5A5SZkT+x5ZJLqpXmbcmArTPNJxd8v5sX4urRF2iDYDpChQUDFFx0PqeH3CFT8BPVWHZK2Acs3EEYcZuDllfUMZFR+RzEUXUfTauGnUcbzpSeYlRZhhMjj3YE7PeQFzI0gO20aY8g8Qt0JsPZNB6sEeFd6g4MDBzDwuR9OAsoJKYdyCbyvhyykxuarCch5pYKMIt+USlVCdYNhTSthdOExZjYXodGRlPM+CmgBSIKOVQHU3RS/NIJyWqlZh2qpUB2LfnWLbokNSVmHxMrQbQPcZGi5FliLPM0aFO6gYliQbN45hx/HGe5cZFidJfPISViTF6DOjcEcOoTWyij0V5ewPX4G6soEtNuHYc7dhTJ5Df7To5j/MY8j92ZxY+p7B/hhooahK1WUlhWwZ+ehEkBZfova4DHoS2Oovb4OZfgstNUpSLeOQ595gNr7fhgPT2BlfRmnhhcw+KnSAZpRggaddDVIUDUM1GwLmu9QCzg0j1PDHSiuC93ntFEcjWKO0ZzhbcMJLNgU2+thFCdop3S9UlEIu8oELO7BcjzYbgCTxjBJi1ihwhun4t+PQ7fnopfn6zdcKaz9swRDuwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Network setup\" title=\"\" src=\"/static/00ef2251e1bc52ac06a58c67e05e0666/1d69c/connecting_to_s3_over_the_internet.png\" srcset=\"/static/00ef2251e1bc52ac06a58c67e05e0666/4dcb9/connecting_to_s3_over_the_internet.png 188w,\n/static/00ef2251e1bc52ac06a58c67e05e0666/5ff7e/connecting_to_s3_over_the_internet.png 375w,\n/static/00ef2251e1bc52ac06a58c67e05e0666/1d69c/connecting_to_s3_over_the_internet.png 750w,\n/static/00ef2251e1bc52ac06a58c67e05e0666/78797/connecting_to_s3_over_the_internet.png 1125w,\n/static/00ef2251e1bc52ac06a58c67e05e0666/aa440/connecting_to_s3_over_the_internet.png 1500w,\n/static/00ef2251e1bc52ac06a58c67e05e0666/ae21e/connecting_to_s3_over_the_internet.png 1537w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>We’ll replace the NAT gateway with a VPC endpoint so that we can reach S3 (or any other AWS service) without connectivity to the outside. There are two types of endpoints, <code class=\"language-text\">Gateway</code> and <code class=\"language-text\">Interface</code>.</p>\n<h3><a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/vpce-gateway.html\" target=\"_blank\" rel=\"noopener noreferrer\">Gateway endpoint</a></h3>\n<p>This type can be used for S3 and DynamoDB (don’t ask me why). I’m assuming that there is an existing VPC.</p>\n<!-- vpc-endpoint-gateway -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">data <span class=\"token type variable\">\"aws_route_table\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">vpc_id</span> <span class=\"token punctuation\">=</span> var.vpc_id\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_vpc_endpoint\"</span></span> <span class=\"token string\">\"s3\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">vpc_id</span>            <span class=\"token punctuation\">=</span> var.vpc_id\n  <span class=\"token property\">vpc_endpoint_type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Gateway\"</span>\n\n  <span class=\"token property\">service_name</span>      <span class=\"token punctuation\">=</span> <span class=\"token string\">\"com.amazonaws.<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">region</span><span class=\"token punctuation\">}</span></span>.s3\"</span>\n\n  <span class=\"token property\">route_table_ids</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>data.aws_route_table.this.id<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There are a bunch of arguments that we can pass. Let’s have a look at the ones that are relevant for us:</p>\n<ul>\n<li><code class=\"language-text\">vpc_id</code>: We always associate an endpoint with a <a href=\"https://aws.amazon.om/vpc/\" target=\"_blank\" rel=\"noopener noreferrer\">VPC</a>.</li>\n<li><code class=\"language-text\">type</code>: In this case, <code class=\"language-text\">Gateway</code>.</li>\n<li><code class=\"language-text\">service_name</code>: The URL associated with the service. I found <a href=\"https://docs.aws.amazon.com/general/latest/gr/aws-general.pdf#aws-service-information\" target=\"_blank\" rel=\"noopener noreferrer\">this list</a> as a reference.</li>\n<li><code class=\"language-text\">route_table_ids</code>: For this type of endpoint, you have to specify a routing table, which will get an entry to route to the service. In our case, the routing table of the VPC.</li>\n</ul>\n<p>And that’s it. S3 is now accessible from our private subnet without needing a NAT gateway. This kind of endpoint is free, by the way. Useful if you need to pull Docker images, for instance.</p>\n<h3><a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/vpce-interface.html\" target=\"_blank\" rel=\"noopener noreferrer\">Interface endpoint</a></h3>\n<p>For other AWS services, we use the <code class=\"language-text\">Interface</code> type. Let’s take accessing CloudWatch as an example. We define our endpoint like this:</p>\n<!-- vpc-endpoint-interface -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">data <span class=\"token type variable\">\"aws_subnet_ids\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">vpc_id</span> <span class=\"token punctuation\">=</span> var.vpc_id\n  <span class=\"token keyword\">filter</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">name</span>   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"tag:Name\"</span>\n    <span class=\"token property\">values</span> <span class=\"token punctuation\">=</span> var.subnet_names\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_vpc_endpoint\"</span></span> <span class=\"token string\">\"log\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">vpc_id</span>              <span class=\"token punctuation\">=</span> var.vpc_id\n  <span class=\"token property\">vpc_endpoint_type</span>   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Interface\"</span>\n\n  <span class=\"token property\">service_name</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"com.amazonaws.<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">region</span><span class=\"token punctuation\">}</span></span>.logs\"</span>\n\n  <span class=\"token property\">subnet_ids</span> <span class=\"token punctuation\">=</span> data.aws_subnet_ids.this.ids\n  <span class=\"token property\">security_group_ids</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>\n    aws_security_group.this.id,\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Both <code class=\"language-text\">vpc_id</code> and <code class=\"language-text\">service_name</code> work as before. <code class=\"language-text\">type</code> is <code class=\"language-text\">Interface</code> this time. Some new arguments are coming  to the party:</p>\n<ul>\n<li><code class=\"language-text\">subnet_ids</code>: Instead of a route table, we need the subnets accessing the endpoint. These are the private subnets where we put our instances.</li>\n<li><code class=\"language-text\">security_group_ids</code>: We need an existing security group as well. This security group must allow inbound traffic on port 443, as well as outbound traffic (in case you want to touch the defaults).</li>\n</ul>\n<p>By default, we can reach the AWS service that we’re connecting through its DNS hostname. It can be disabled with <code class=\"language-text\">private_dns_enabled</code>.</p>\n<h3>Using policies to limit permissions</h3>\n<p>There is an extra argument, <code class=\"language-text\">policy</code>, where you can pass an IAM policy to restrict the permissions allowed by the endpoint. If you need a refresher on IAM, check <a href=\"../aws-iam-an-overview/\">this article I wrote</a>.</p>\n<h2>Accessing our own services</h2>\n<p>We have covered one aspect of endpoints, accessing AWS itself. But we can use it for our infrastructure as well. Consider this:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/c1edef36d56ecf2452f8a9c3627a6221/7fee5/connecting_two_services.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 121.27659574468086%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAAD7klEQVR42q2V7WscVRTG+39UrSAiKqJflBakSsVCKQUrUggWXynESmpbtBQpjU2qGGoak5qmUWMaa5uQqG1KUzRJ8UOVJk1iIS152012dndmd2bf35Pd2dmfZ3ZjTJpFQ/CyD3Pn3LnPnrnPOc9sYHEUFlF+FMrcl9+x4d8ojGiScDpL0oTYgkV8IV9EIoegQCxrkcrmVxMWZLc/HCeUnCc2b5GQTXkLJr0a9zwK0z4fSiSMmjJRYhkmNVWg4QwE0JPp4v4VhHmJzEUy8nAOb8pCn88zn8ujRw08AQez/mmCCRUtuYAWj+M1JOZzooVdhFMRrPsJ7fvOJo2Wwx5aDxn8+n28uNgx0s7O756n4tIu3ujcjTse4ZYnwsutN9ndMcKLZ29yY1otHdFimqUM5S+aPpqi5rUJzh1Q6akPFBdr+4/zbOOj7Lmwk81NTzAb8XF9KsTDJwd4pX2UTScHuTTmKj5rLSe0JMfafWMcfmmYr6qcXKzzFhdrhPCZ05vY/s0Wtpx5EmdE49pkiIdqB9jaPMQDNYNcHC1DaI/u8y4aP56g7TMXg73BYuzavasc7H2XI33vc6L/CB45vzu+KFU/j/DBlTu89+NthhX/isJaeuWgmScq85AgLPfprEksnSBrpkWgFAvZJGpiASOVxDR1FnIBcnKNlhPFVtkt6roTBZR4AS1tMS/1ZaR0jIyCnvLIXBGVM0KaxpcKoSUMmRvoifj9ZVPALk1v3+foF14n3FtJeKgFqWVu/eal7ZiDrjqNX771445a+LRp/OdfJXx5H7HevYSUIdGgpMSyDEH5cgd69YNEGx4n2vNOkbDn3AwfbhvnTKWXr6tUZuS43OMDeI9uJPjF08ROP0Jo/HKJqrCM0LQsXGffQqt+isCnj6G37yEr8R+a7lL1wjANlU6aKh1MqhZzfw6ifPIcet1mjBMbMUa7SoIU8itfeaa7junGvTjqd6BeryvGbvQ5qHn7d+oPjNF5agpX1ER1TzDbVIGzuQJ3w1YCjj9WZ2hPg/OmtFiYOSNKVJo/a1oiRBxPyM+M6paetXs5K4JlcUtswuXAFdIJpDOre7mcRZniDn4xCbsiw7bzWCX1VakGLVOQNeQKetpcarvy9mUvln6MjCTobja40hqhvyuFN2GT2aT5ErnA+E/Cf46Dn9pUjm6/S8Obblr2Gzh9pmS2mOV6CHvaFA5uG6ajWqHjuMaMN4c/W1g/4dUeL4d2DXFq/wStxxRmgyaaGLDtmTaZV6CvhXCpvzNCIKbrCWbxxU0CYrxGWpApQReEpTpYC2Emk8Hv1/H5/QTE6gPBoMx1crnckqH+jTV9pNY7/nfCvwDGnNm/kIxdCQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Connecting two services\" title=\"\" src=\"/static/c1edef36d56ecf2452f8a9c3627a6221/1d69c/connecting_two_services.png\" srcset=\"/static/c1edef36d56ecf2452f8a9c3627a6221/4dcb9/connecting_two_services.png 188w,\n/static/c1edef36d56ecf2452f8a9c3627a6221/5ff7e/connecting_two_services.png 375w,\n/static/c1edef36d56ecf2452f8a9c3627a6221/1d69c/connecting_two_services.png 750w,\n/static/c1edef36d56ecf2452f8a9c3627a6221/7fee5/connecting_two_services.png 781w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>We have two services. Service A wants to reach Service B, which is exposed through an <a href=\"https://aws.amazon.com/elasticloadbalancing/\" target=\"_blank\" rel=\"noopener noreferrer\">ELB</a>. Both services reside in different networks and might even be in different accounts.</p>\n<p>One solution is to make the load balancer publicly reachable. Then, our Service A can use a NAT gateway, as I described before.</p>\n<p>Or we can use endpoints again. To do so, we need a new toy, a <a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/endpoint-service.html\" target=\"_blank\" rel=\"noopener noreferrer\">VPC endpoint service</a>.</p>\n<h3>Endpoint service</h3>\n<p>An endpoint service allows us to expose Service B. Once created, it gets assigned a <code class=\"language-text\">service_name</code>, that we can reference as an attribute.</p>\n<!-- vpc-endpoint-service -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">data <span class=\"token type variable\">\"aws_subnet_ids\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">vpc_id</span> <span class=\"token punctuation\">=</span> var.vpc_id\n  <span class=\"token keyword\">filter</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">name</span>   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"tag:Name\"</span>\n    <span class=\"token property\">values</span> <span class=\"token punctuation\">=</span> var.subnet_names\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_lb\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>               <span class=\"token punctuation\">=</span> <span class=\"token string\">\"internal-lb\"</span>\n  <span class=\"token property\">load_balancer_type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"network\"</span>\n  <span class=\"token property\">subnets</span>            <span class=\"token punctuation\">=</span> data.aws_subnet_ids.this.ids\n  <span class=\"token property\">internal</span>           <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_vpc_endpoint_service\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">network_load_balancer_arns</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>aws_lb.this.arn<span class=\"token punctuation\">]</span>\n\n  <span class=\"token property\">allowed_principals</span> <span class=\"token punctuation\">=</span> var.vpce_allowed_principals\n  <span class=\"token property\">acceptance_required</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We configure it as follows:</p>\n<ul>\n<li><code class=\"language-text\">network_load_balancer_arn</code>: The service has to be attached to an existing (internal) network load balancer. That load balancer determines the VPC and subnets.</li>\n<li><code class=\"language-text\">allowed_principals</code>: The list of actors that can connect to the service, like a list of AWS Accounts.</li>\n<li><code class=\"language-text\">acceptance_required</code>: You can force the connections to be manually accepted. For automation reasons, it’s preferable to use <code class=\"language-text\">allowed_principals</code> to restrict access instead.</li>\n</ul>\n<h3>Connecting to the endpoint Service</h3>\n<p>We use an <em>Interface endpoint</em> to connect to the service that we just created:</p>\n<!-- vpc-endpoint-interface-own-service -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_vpc_endpoint\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">vpc_id</span>            <span class=\"token punctuation\">=</span> var.vpc_id\n  <span class=\"token property\">vpc_endpoint_type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Interface\"</span>\n  <span class=\"token property\">service_name</span>      <span class=\"token punctuation\">=</span> aws_vpc_endpoint_service.this.service_name\n\n  <span class=\"token property\">subnet_ids</span>         <span class=\"token punctuation\">=</span> var.subnet_ids\n  <span class=\"token property\">security_group_ids</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>aws_security_group.this.id<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">output<span class=\"token type variable\"> \"dns_entry\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> aws_vpc_endpoint.this.dns_entry<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>.dns_name\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The configuration is similar to what we did before. We get the <code class=\"language-text\">service_name</code> from the endpoint service directly.</p>\n<p>And now, the connection between the two is complete. Our Service A can reach Service B through the endpoint. That endpoint exports a <code class=\"language-text\">dns_entry</code> attribute so that we know what to use as a URL.</p>\n<h3>A note about availability zones</h3>\n<p>You need to remember one thing. A VPC endpoint can only connect to a VPC endpoint service in the same <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html#concepts-availability-zones\" target=\"_blank\" rel=\"noopener noreferrer\">Availability Zone</a>. That’s more relevant for a zone like <code class=\"language-text\">us-east-1</code>, which has six AZs.</p>\n<p>For the names to be consistent across accounts, you need to identify them with <a href=\"https://docs.aws.amazon.com/ram/latest/userguide/working-with-az-ids.html\" target=\"_blank\" rel=\"noopener noreferrer\">Availability Zone IDs</a>.</p>\n<h2>The end(point) justifies the means</h2>\n<p>I wasn’t a massive fan of endpoints when I started using them in my project, to be honest. But they have grown on me over time.</p>\n<p>Don’t use them to recreate an old-school on-premise setup. This idea of a huge private network where all the connections flow unimpeded doesn’t need to be recreated in the cloud.</p>","frontmatter":{"layout":"post","title":"Understanding VPC endpoints","path":"/understanding-vpc-endpoints/","categories":["AWS","Terraform","VPC","Networking"],"date":"2020/08/20","draft":false,"description":"Using VPC endpoints helps keeping your network traffic away from prying eyes. I'm showing you how to provision them using Terraform","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/ef6a957565cfc675c990047011368726/094c8/private_communication.png","srcSet":"/static/ef6a957565cfc675c990047011368726/81348/private_communication.png 121w,\n/static/ef6a957565cfc675c990047011368726/2666a/private_communication.png 243w,\n/static/ef6a957565cfc675c990047011368726/094c8/private_communication.png 485w","sizes":"(min-width: 485px) 485px, 100vw"},"sources":[{"srcSet":"/static/ef6a957565cfc675c990047011368726/600d0/private_communication.webp 121w,\n/static/ef6a957565cfc675c990047011368726/c5007/private_communication.webp 243w,\n/static/ef6a957565cfc675c990047011368726/a4359/private_communication.webp 485w","type":"image/webp","sizes":"(min-width: 485px) 485px, 100vw"}]},"width":750,"height":521.1340206185566}}}}},"related":{"nodes":[{"frontmatter":{"title":"An overview of IAM in AWS","path":"/aws-iam-an-overview/","date":"2019/03/09"}},{"frontmatter":{"title":"Provisioning a Network Load Balancer with Terraform","path":"/provisioning-a-network-load-balancer-with-terraform/","date":"2020/11/17"}},{"frontmatter":{"title":"Provisioning an Application Load Balancer with Terraform","path":"/provisioning-an-application-load-balancer-with-terraform/","date":"2021/01/02"}}]},"previous":{"frontmatter":{"title":"Book Review: The software architect elevator","path":"/book-review-software-architect-elevator/","date":"2020/07/26"}},"next":{"frontmatter":{"title":"Book Review: The art of leadership","path":"/book-review-the-art-of-leadership/","date":"2020/08/28"}}},"pageContext":{"related":["/provisioning-an-application-load-balancer-with-terraform/","/provisioning-a-network-load-balancer-with-terraform/","/aws-iam-an-overview/"],"previous":"/book-review-software-architect-elevator/","next":"/book-review-the-art-of-leadership/"}},"staticQueryHashes":[],"slicesMap":{}}