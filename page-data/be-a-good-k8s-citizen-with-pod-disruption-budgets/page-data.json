{"componentChunkName":"component---src-templates-blog-post-js","path":"/be-a-good-k8s-citizen-with-pod-disruption-budgets/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for Meta","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"793c8946-cb41-59fe-be10-74a72422029d","html":"<figure class=\"figure figure--left\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/5419b9f2e801717e0bde2acaf0558e4a/0f98f/disruption.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 60.1063829787234%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEAv/EABYBAQEBAAAAAAAAAAAAAAAAAAACA//aAAwDAQACEAMQAAABFVLjTJUH/8QAGxAAAgEFAAAAAAAAAAAAAAAAAAECERITITH/2gAIAQEAAQUCcUjRiHFSLFVc/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAEREv/aAAgBAwEBPwGs0z//xAAXEQADAQAAAAAAAAAAAAAAAAAAARES/9oACAECAQE/AYjKP//EABgQAAMBAQAAAAAAAAAAAAAAAAAhMQEQ/9oACAEBAAY/AqPSj7//xAAcEAEBAQACAwEAAAAAAAAAAAABEQAhMUFRYXH/2gAIAQEAAT8hWKuesUch9nGGlLPzIHppqUJ14c5n/9oADAMBAAIAAwAAABAr3//EABURAQEAAAAAAAAAAAAAAAAAABBh/9oACAEDAQE/ELB//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxAj/8QAGxABAQADAAMAAAAAAAAAAAAAAREAMUFRYaH/2gAIAQEAAT8QERXPbBDa3D6wMJCjiQHsjN4KAAUuzyYpAE4TXM//2Q=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Disruption\" title=\"\" src=\"/static/5419b9f2e801717e0bde2acaf0558e4a/acb04/disruption.jpg\" srcset=\"/static/5419b9f2e801717e0bde2acaf0558e4a/bc01b/disruption.jpg 188w,\n/static/5419b9f2e801717e0bde2acaf0558e4a/bf173/disruption.jpg 375w,\n/static/5419b9f2e801717e0bde2acaf0558e4a/acb04/disruption.jpg 750w,\n/static/5419b9f2e801717e0bde2acaf0558e4a/ec605/disruption.jpg 1125w,\n/static/5419b9f2e801717e0bde2acaf0558e4a/c58a3/disruption.jpg 1500w,\n/static/5419b9f2e801717e0bde2acaf0558e4a/0f98f/disruption.jpg 1920w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <figcaption class=\"figure__caption\">\n  Be careful of the debris\n  </figcaption>\n</figure>\n<p>The appeal behind using <a href=\"https://kubernetes.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes</a> is that you abstract the details of <em>where</em> your applications run and leave it in k8s’s hands. It’ll schedule containers following some given constraints, and restart them if they crash.</p>\n<p>However, a Kubernetes cluster is not a perfect abstraction. That is especially visible as an operator. Even if you use a managed solution like <a href=\"https://aws.amazon.com/eks/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS EKS</a>, you still have to perform some maintenance yourself.</p>\n<p>As an operator, I want this maintenance to happen regularly, to avoid stagnation and prevent failure. As a developer, I avoid unwanted interruptions for my applications. A Pod Disruption Budget (PDB) is a resource in Kubernetes that harmonizes both needs. I want to talk about how to use it in this article.</p>\n<h2>Pod Disruption Budgets to the rescue</h2>\n<p>A classical maintenance scenario in the world of Kubernetes is the replacement of a worker node. There are many reasons: A version upgrade, a new AMI being rolled out, or an adjustment in the instance size. When the old node is replaced, the Pods running there will get evicted and rescheduled. In k8s parlance, this is called a <a href=\"https://kubernetes.io/docs/concepts/workloads/pods/disruptions/#voluntary-and-involuntary-disruptions\" target=\"_blank\" rel=\"noopener noreferrer\">voluntary disruption</a>. If your application gets an unplanned, unwanted downtime you’ll think of it as pretty damn involuntary. Swearing might happen.</p>\n<p>Luckily, somebody has thought of this. With a PDB you define how many Pods have to remain available at all times in a Deployment (or similar). If you replace worker nodes one by one, the scheduler ensures that the application still runs some Pods in the remaining nodes throughout the process, avoiding the dreaded downtime.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/6f9cf940cb70a7e21c63a51b8614b70f/d4c13/node-replacement.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 40.95744680851064%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABmklEQVR42oVS22rbQBD1D/SlhZLH5pf6R/2BUkof+gmBPpa6aYjTS2zHpo5jEhFiN62KA5ECVmRb0t5mRpNZaR8DWRjtrA7nzJnZ7XR/ZB/OF9U5M5yANiMybkqV7jL3n/Wmm4+TeRV5zFo7AoAz2T9xGe8cTLZf5zdqyowja4ULcKGUeteZzc3RSrOsGomZfEaAKV+OX1ze4K8sYBwwQFzkyf/daIl3ueIGpLrB2Tm335HvYfNbacfrAlhZz7q9/jZ7SUQ/uV3Oa/kEEa/iOH4ladKotWIuCHY7bFyvATYlcqGIoRYE0vVw+ByDYCC1DgEWXlCK3YVidcBZxiEOje2FNhGIam4Pxefj/E2auX/NkZA8Ghw+KXgYZuMk6Ha5Jhby96jm64T8WCm9B1ptELTN+O9yfJXn2gs+3jIZe9S4kNJO6Cf7Md9ntjXa+uXhvOZZzKTcHy6qdJEkevcxh+2lbNX72sEZatvHygxUocZYqYN8tX1dVnrPaHNalNWgKMuBcCbieS+Koh1p74vM87fEQKLvn5Q8m7cPXl5RyD5vhw4AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Node Replacement\" title=\"\" src=\"/static/6f9cf940cb70a7e21c63a51b8614b70f/1d69c/node-replacement.png\" srcset=\"/static/6f9cf940cb70a7e21c63a51b8614b70f/4dcb9/node-replacement.png 188w,\n/static/6f9cf940cb70a7e21c63a51b8614b70f/5ff7e/node-replacement.png 375w,\n/static/6f9cf940cb70a7e21c63a51b8614b70f/1d69c/node-replacement.png 750w,\n/static/6f9cf940cb70a7e21c63a51b8614b70f/d4c13/node-replacement.png 825w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>The cool part is that it’s enough to define it as an extra resource and apply it as part of your application release. It’s decoupled from any operational action, which makes it very convenient to use. Here is the <a href=\"https://kubernetes.io/docs/tasks/run-application/configure-pdb/\" target=\"_blank\" rel=\"noopener noreferrer\">official documentation</a>.</p>\n<h2>Do you actually need to use PDBs?</h2>\n<figure class=\"figure figure--right\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 475px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/e69798add9760d2c7729e951aad0e517/55feb/sad-dog.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 71.27659574468085%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAwAB/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQAC/9oADAMBAAIQAxAAAAEkwMr20//EABsQAAIDAAMAAAAAAAAAAAAAAAIDAAEEERIi/9oACAEBAAEFAjaQtV3nuabFZ5zs3Nvg/wD/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAgEBPwFH/8QAHxAAAQMDBQAAAAAAAAAAAAAAAAEhMQIDESJRgZKh/9oACAEBAAY/Alopbcxc4Gz2IhDU6ojE+H//xAAbEAEBAAMBAQEAAAAAAAAAAAABEQAhQTFRgf/aAAgBAQABPyHzxcdxUlqKvG4w7o/Ey1Hdbe4KHQt3MVD4OHP/2gAMAwEAAgADAAAAEG/P/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAEhEf/aAAgBAwEBPxCKmo//xAAXEQEAAwAAAAAAAAAAAAAAAAAAEVFh/9oACAECAQE/EMSt/8QAHxABAAIBAwUAAAAAAAAAAAAAAQARITFBUWFxgZHh/9oACAEBAAE/EAFbUTdVZH1KxRLmzr5+QsDu17NzLANoEMrND4i0NFgqvJ23lNA2JiKC08T/2Q=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Sad Dog\" title=\"\" src=\"/static/e69798add9760d2c7729e951aad0e517/55feb/sad-dog.jpg\" srcset=\"/static/e69798add9760d2c7729e951aad0e517/bc01b/sad-dog.jpg 188w,\n/static/e69798add9760d2c7729e951aad0e517/bf173/sad-dog.jpg 375w,\n/static/e69798add9760d2c7729e951aad0e517/55feb/sad-dog.jpg 475w\" sizes=\"(max-width: 475px) 100vw, 475px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <figcaption class=\"figure__caption\">\n  He wouldn't do it\n  </figcaption>\n</figure>\n<p>This is a fair question. PDBs should be reserved for applications that <strong>need</strong> to remain online.</p>\n<p>If your application can allow some minor downtime, it might be easier to let it happen instead of putting an unfair burden on the operators of your cluster.</p>\n<p>As we’ll see in a bit, if you misconfigure a PDB nodes can’t be drained, making these nameless operators mad at you. Nobody wants to be the blocker. Let’s not do that.</p>\n<h2>Creating a PDB</h2>\n<p>Alright, so let’s get down to basics and create one such PDB. Usually, you’ll have one Deployment that you want to protect from downtimes.</p>\n<h3>A simple deployment</h3>\n<p>Let’s show some <a href=\"https://www.terraform.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform</a> code.</p>\n<!-- deployment --> \n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">locals</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">app</span>   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"hello-world\"</span>\n  <span class=\"token property\">image</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"nginx:1.14.2\"</span>\n  <span class=\"token property\">port</span>  <span class=\"token punctuation\">=</span> <span class=\"token number\">80</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"kubernetes_namespace\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">metadata</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">local</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">app</span><span class=\"token punctuation\">}</span></span>-namespace\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"kubernetes_deployment\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">metadata</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">name</span>      <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">local</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">app</span><span class=\"token punctuation\">}</span></span>-deployment\"</span>\n    <span class=\"token property\">namespace</span> <span class=\"token punctuation\">=</span> kubernetes_namespace.this.metadata.<span class=\"token number\">0.</span>name\n    <span class=\"token property\">labels</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">app</span> <span class=\"token punctuation\">=</span> local.app\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">spec</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">replicas</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">2</span>\n\n    <span class=\"token keyword\">selector</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">match_labels</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">app</span> <span class=\"token punctuation\">=</span> local.app\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">template</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">metadata</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">labels</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">app</span> <span class=\"token punctuation\">=</span> local.app\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">spec</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">container</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> local.app\n          <span class=\"token property\">image</span> <span class=\"token punctuation\">=</span> local.image\n\n          <span class=\"token keyword\">port</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">container_port</span> <span class=\"token punctuation\">=</span> local.port\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is a simplified deployment of an NGINX image. We are running two replicas to ensure availability. Now, let’s create a PDB for this deployment.</p>\n<h3>The PDB</h3>\n<p>The PDB is another resource in Kubernetes. As of the date of this post, its <code class=\"language-text\">apiVersion</code> is still <code class=\"language-text\">policy/v1beta1</code>.</p>\n<p>You need a target. It uses the same <code class=\"language-text\">selector</code> as the deployment, which we reuse. The Pods created by our previous Deployment are subject to this PDB.</p>\n<p>The crucial part of this resource is specifying how many Pods you want to keep up at all times. You have to provide one of <code class=\"language-text\">maxUnavailable</code> or <code class=\"language-text\">minAvailable</code>, but not both. They do what you’d expect. In my example, I want to ensure that there is always at least one instance running.</p>\n<!-- pdb -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"kubernetes_pod_disruption_budget\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">metadata</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">name</span>      <span class=\"token punctuation\">=</span> local.app\n    <span class=\"token property\">namespace</span> <span class=\"token punctuation\">=</span> kubernetes_namespace.this.metadata.<span class=\"token number\">0.</span>name\n    <span class=\"token property\">labels</span>    <span class=\"token punctuation\">=</span> kubernetes_deployment.this.metadata.<span class=\"token number\">0.</span>labels\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">spec</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">min_available</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"1\"</span>\n\n    <span class=\"token keyword\">selector</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">match_labels</span> <span class=\"token punctuation\">=</span> kubernetes_deployment.this.spec.<span class=\"token number\">0.</span>selector.<span class=\"token number\">0.</span>match_labels\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And that’s it. Once I’ve applied this resource, Kubernetes respects the constraint when draining a node. Now we can replace these nodes knowing that my application won’t experience downtime in the process. I mean, as long as we don’t destroy all nodes at once, you know.</p>\n<h2>Don’t block maintenance!</h2>\n<p>When you are using PDBs, you have to be mindful of not creating impossible scenarios. For instance, if you have a Deployment with only one replica, setting <code class=\"language-text\">minAvailable = 1</code> will ensure that the Pod is never voluntarily evicted.</p>\n<p>This is bad! Node maintenance is necessary. Your Pods should be flexible coming in and out of the system. Besides, a PDB doesn’t prevent <em>involuntary</em> evictions. If the EC2 hosting a node goes down, you’re screwed. Don’t do this.</p>\n<h2>Summary</h2>\n<p>By adding a Pod Disruption Budget resource we make sure that our application remains online during maintenance windows. It saves a lot of coordination effort between people operating the system, and people running applications that should remain online.</p>","frontmatter":{"layout":"post","title":"Be a good Kubernetes citizen and use Pod Disruption Budgets","path":"/be-a-good-k8s-citizen-with-pod-disruption-budgets/","categories":["Kubernetes","Operations","DevOps","Terraform"],"date":"2021/02/18","draft":false,"description":"Pod Disruption Budgets offer a way to protect the uptime of an application in Kubernetes during node maintenance, in a decoupled fashion","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#985838","images":{"fallback":{"src":"/static/5419b9f2e801717e0bde2acaf0558e4a/5343e/disruption.jpg","srcSet":"/static/5419b9f2e801717e0bde2acaf0558e4a/110e5/disruption.jpg 188w,\n/static/5419b9f2e801717e0bde2acaf0558e4a/494d9/disruption.jpg 375w,\n/static/5419b9f2e801717e0bde2acaf0558e4a/5343e/disruption.jpg 750w,\n/static/5419b9f2e801717e0bde2acaf0558e4a/bd870/disruption.jpg 1500w","sizes":"(min-width: 750px) 750px, 100vw"},"sources":[{"srcSet":"/static/5419b9f2e801717e0bde2acaf0558e4a/17e41/disruption.webp 188w,\n/static/5419b9f2e801717e0bde2acaf0558e4a/4d6b3/disruption.webp 375w,\n/static/5419b9f2e801717e0bde2acaf0558e4a/80f13/disruption.webp 750w,\n/static/5419b9f2e801717e0bde2acaf0558e4a/8ae71/disruption.webp 1500w","type":"image/webp","sizes":"(min-width: 750px) 750px, 100vw"}]},"width":750,"height":450}}}}},"related":{"nodes":[{"frontmatter":{"title":"Book Review: Securing DevOps","path":"/book-review-securing-devops/","date":"2020/05/26"}},{"frontmatter":{"title":"Understanding VPC endpoints","path":"/understanding-vpc-endpoints/","date":"2020/08/20"}},{"frontmatter":{"title":"So, what does the NGINX ingress controller actually do?","path":"/what-does-the-nginx-ingress-controller-actually-do/","date":"2021/01/30"}}]},"previous":{"frontmatter":{"title":"How not to do a take-home coding assignment","path":"/how-not-to-do-a-take-home-coding-assignment/","date":"2021/04/05"}},"next":{"frontmatter":{"title":"What Is Code Duplication? A Definition and Overview","path":"/what-is-code-duplication-definition-and-overview/","date":"2021/04/18"}}},"pageContext":{"related":["/what-does-the-nginx-ingress-controller-actually-do/","/understanding-vpc-endpoints/","/book-review-securing-devops/"],"previous":"/how-not-to-do-a-take-home-coding-assignment/","next":"/what-is-code-duplication-definition-and-overview/"}},"staticQueryHashes":[],"slicesMap":{}}