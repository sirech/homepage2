{"componentChunkName":"component---src-templates-blog-post-js","path":"/kotlin-either-types-instead-of-exceptions/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for ThoughtWorks","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"733d9b54-f030-5298-bed6-a68ea63d2e6a","html":"<p>Many of the REST APIs I’ve built lately follow the same pattern. A dumb controller calls a service, which in turn calls a 3rd party API. Simple, well tested, and tidy. Everybody is happy. And then, you start dealing with error conditions.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 375px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/43ec9400dd086acca8bce4feb88eb274/5ff7e/exception.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 105.85106382978724%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAABsElEQVR42p2U2y8DQRTGty5tw1KXBlFRqV5c2tX9bdHQiCII4sWbB09eJP7/Zzl8y2S7lU0nOdmZOTPfnu+c74wXhqFnFkWR1+12c2EYfhuQsz3XMg07CJgdAh2gCbSAXSACyvJnA9ThPLAHrABd4ESA28BmEjBeGwvZ757raAMHQKDI9oE+UPoHcMTSNueAJZv3er00vxvRGrATRVFhBNDJ5QKwaoVK0knYBfAGvANPwGIMGF+qi66NU1Hu6QfmX7YfAaHsWin6sCiB+yRgR/nqKIdWoJpADGxd4GUVLVDBPlXUx2QOtySdfX2bmheBSoLuFPAq2i+iHIwrygww76ynHenkBGZzHxgAl6L8J37ncl6Xq7INFaeSUmWT1I0K0499LpgvUdcl6jVRz48BtIKcA1fqrJ8InYMt53BMeV3gpRRAG2fAMXAn6gUXcFcRhpLLrSIMxuhxVk1QUgDFX8oStUlkCDyLblPrVkqHZGq9BnCkCD3pcBB3wCS93JCoH6TJI9H1J3m+PIk4J6Ch9qppr01WwJrzKPgSeFvCngiwIICm6B+Kujcp4P/Jzji+ADgK5iGT/63dAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"When you think everything is flowing nicely...\" title=\"\" src=\"/static/43ec9400dd086acca8bce4feb88eb274/5ff7e/exception.png\" srcset=\"/static/43ec9400dd086acca8bce4feb88eb274/4dcb9/exception.png 188w,\n/static/43ec9400dd086acca8bce4feb88eb274/5ff7e/exception.png 375w\" sizes=\"(max-width: 375px) 100vw, 375px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>If we don’t handle the exception, it will bubble up until our API returns a 500 to the caller. As a state-of-the-art backend, we can’t afford this. We have to <em>do</em> something.</p>\n<h2>Handling failure</h2>\n<p>A typical pattern in the <a href=\"https://spring.io/projects/spring-boot\" target=\"_blank\" rel=\"noopener noreferrer\">SpringBoot</a> ecosystem is using an exception handler. You put this method in the controller, and it catches automagically exceptions that happen in the chain. Our caller then gets the error formatted the way we want.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@ExceptionHandler</span><span class=\"token punctuation\">(</span>JWTVerificationException<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">handleException</span><span class=\"token punctuation\">(</span>exception<span class=\"token operator\">:</span> JWTVerificationException<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ResponseEntity<span class=\"token operator\">&lt;</span>ErrorMessage<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> ResponseEntity\n      <span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span>HttpStatus<span class=\"token punctuation\">.</span>BAD_GATEWAY<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span>ErrorMessage<span class=\"token punctuation\">.</span><span class=\"token function\">fromException</span><span class=\"token punctuation\">(</span>exception<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Do not want</h3>\n<p>I don’t like this way of dealing with error conditions. Error conditions are not something to hide. They happen all the time. They are part of the code. This exception business makes the code difficult to understand. Half of the flow is happening in a way that is partially hidden and easy to miss. It makes the code harder to read.</p>\n<p>Instead, I want to show how to make errors explicit by using <em>Either Types</em>.</p>\n<hr>\n<h2>An example based on JWT</h2>\n<p>Let’s say that our <code class=\"language-text\">Service</code> from the diagram above is going to verify <a href=\"https://jwt.io/\" target=\"_blank\" rel=\"noopener noreferrer\">JSON Web Tokens</a>. The idea is simple. We are getting a <em>JWT</em> as a string, and we want to know if it is a valid token. If so, we want to get certain properties that we will wrap in a <code class=\"language-text\">TokenAuthentication</code>. This interface defines it:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">interface</span> Verifier <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/**\n     * @param jwt a jwt token\n     * @return authentication credentials\n     */</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>jwt<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> TokenAuthentication\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Forged signatures</h3>\n<p>I am using <a href=\"https://github.com/auth0/java-jwt\" target=\"_blank\" rel=\"noopener noreferrer\">auth0’s library to verify tokens</a>. It has a <code class=\"language-text\">JWTVerifier</code> class, which receives the encoded token and returns a <code class=\"language-text\">DecodedJWT</code>. If something goes wrong, it throws a <code class=\"language-text\">JWTVerificationException</code>. There are different reasons for that, such as an expired token, or an invalid signature.</p>\n<p><em>Kotlin</em> does not have <a href=\"https://kotlinlang.org/docs/reference/exceptions.html#checked-exceptions\" target=\"_blank\" rel=\"noopener noreferrer\">checked exceptions</a> for a good reason. As a consequence, however, the signature is lying to us! This method might throw an exception. Only looking at the implementation will reveal the treachery. As I mentioned, the code becomes harder to read. More context is needed to understand how the app behaves.</p>\n<h3>The explicit approach</h3>\n<p>There are two things I want to change in the <code class=\"language-text\">Verifier</code> implementation.</p>\n<ol>\n<li>The <code class=\"language-text\">verify</code> method should not throw an exception.</li>\n<li>The signature of the method should reflect that an error might happen.</li>\n</ol>\n<p>A naive approach would be to use a <a href=\"https://kotlinlang.org/docs/reference/null-safety.html#nullable-types-and-non-null-types\" target=\"_blank\" rel=\"noopener noreferrer\">nullable type</a>. <code class=\"language-text\">verify</code> would return <code class=\"language-text\">TokenAuthentication?</code>. But it has a fatal flaw: We are losing all the context about what actually went wrong. If there are different causes for the error, we want to keep that information.\nEnter <code class=\"language-text\">Either</code> (dum dum dum…).</p>\n<h2>The Either datatype</h2>\n<figure class=\"figure figure--right\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 300px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/01a93f228e105034b17a364c39951f42/5a46d/either.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 64.36170212765958%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABk0lEQVR42l1TXVPCQAw8CghIVUAo+D0+OA4+YLPbPijjX/D//xxn6552eMjkekn3NpskAUgAzgDMAExPbKLYfr9PETF03sR+RLJomibJSHa+OwB4BLAGcC0juQIg2wHYkHwn+QrgTt+OrR2Tr5ybBDY2kM75gWwPJGuS3yQ/ACxt6Xg8irVyBmLqxzpAlbbKQG3bCnSQmZP8IvkG4IXkzsy68k5IVPI6zAEsnDQAUERE4Zf1LSaqYmwmOd7lOE842wxYCvBwOOj8bD0kwda6PETERE0heeO7pXMql1pa2z/AS2u5Mouyp2MVETOxJFm1bVsYdO74PDdJFfUBpz4/AfhUgnUS4LTXvEvH71QiyZJkZvzLkOSFwcqmaUYWfu0ubgQYEboXw/4U5KbuSC7+NCSZS74l2c2hvXS8sYaj3lyqAQLJ87cx8/+m+LWBuze0V0dTXddDdzadTEDh/84zRvLK3fc6l7ckD/EyIrYRUfXvbAKRXLcArjrAuq6TGY1t2tMzkjLtrcqd9PZ7dmLn9t3M/gAh4qUkFc95rwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Either way\" title=\"\" src=\"/static/01a93f228e105034b17a364c39951f42/5a46d/either.png\" srcset=\"/static/01a93f228e105034b17a364c39951f42/4dcb9/either.png 188w,\n/static/01a93f228e105034b17a364c39951f42/5a46d/either.png 300w\" sizes=\"(max-width: 300px) 100vw, 300px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>Originating from the <a href=\"http://hackage.haskell.org/package/base-4.12.0.0/docs/Data-Either.html\" target=\"_blank\" rel=\"noopener noreferrer\">functional community</a>, <code class=\"language-text\">Either</code> is a class whose value can be of two different types, called left and right. By convention, <code class=\"language-text\">Right</code> is for the success case and <code class=\"language-text\">Left</code> for the error one.</p>\n<p>It is essentially an option type that keeps the information about the error in it. Just what we need! You can implement it yourself, but I’m going to use the excellent <a href=\"https://arrow-kt.io/docs/apidocs/arrow-core-data/arrow.core/-either/\" target=\"_blank\" rel=\"noopener noreferrer\">arrow library</a>, which includes an <code class=\"language-text\">Either</code> type, among many other functional goodies.</p>\n<p>With that being said, let’s rewrite our code to make use of <code class=\"language-text\">Either</code>.</p>\n<h3>Adapting the interface</h3>\n<p>The <code class=\"language-text\">Verifier</code> class returns an <code class=\"language-text\">Either</code> type to indicate that the computation might fail.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">interface</span> Verifier <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/**\n     * @param jwt a jwt token\n     * @return authentication credentials, or an error if the validation fails\n     */</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>jwt<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Either<span class=\"token operator\">&lt;</span>JWTVerificationException<span class=\"token punctuation\">,</span> TokenAuthentication<span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Note that we are still using the exception to signal an error, but we are not <em>throwing</em> it anymore.</p>\n<h3>Wrapping the code that throws</h3>\n<p>Inside our implementation of <code class=\"language-text\">Verifier</code>, we are wrapping the problematic code from the library that we use with an extension method called <code class=\"language-text\">unsafeVerify</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> JWTVerifier<span class=\"token punctuation\">.</span><span class=\"token function\">unsafeVerify</span><span class=\"token punctuation\">(</span>jwt<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">right</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> JWTVerificationException<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    e<span class=\"token punctuation\">.</span><span class=\"token function\">left</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><em>Arrow</em> provides a ton of convenience methods to make it simpler to use. Thanks to the <code class=\"language-text\">left</code> and <code class=\"language-text\">right</code> extension methods, this code is quite tight.</p>\n<h3>Using it as a client</h3>\n<p>Implementation is done. How do we use this in our code? Whenever you want to operate on the underlying type, ignoring the error case, you can use <code class=\"language-text\">map</code>. That allows you to chain calls without having to check whether the value is valid or not. There is an equivalent <code class=\"language-text\">mapLeft</code> for the error side.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">verifier\n .unsafeVerify(jwt)\n .map { it.asToken() }</code></pre></div>\n<p>Ultimately, you want to convert the <code class=\"language-text\">Left</code> and <code class=\"language-text\">Right</code> branches into one value. One option is to use the functional <a href=\"https://wiki.haskell.org/Fold\" target=\"_blank\" rel=\"noopener noreferrer\">fold</a> method.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> result <span class=\"token operator\">=</span> verifier<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">)</span>\nresult<span class=\"token punctuation\">.</span><span class=\"token function\">fold</span><span class=\"token punctuation\">(</span>\n    ifLeft <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> ResponseEntity<span class=\"token punctuation\">.</span><span class=\"token function\">badRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    ifRight <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> ResponseEntity<span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"Worked!\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Or we can use a <code class=\"language-text\">when</code> expression because <code class=\"language-text\">Left</code> and <code class=\"language-text\">Right</code> happen to be <a href=\"https://kotlinlang.org/docs/reference/sealed-classes.html\" target=\"_blank\" rel=\"noopener noreferrer\">sealed classes</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> result <span class=\"token operator\">=</span> verifier<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">when</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">is</span> Either<span class=\"token punctuation\">.</span>Left <span class=\"token operator\">-></span> ResponseEntity<span class=\"token punctuation\">.</span><span class=\"token function\">badRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">is</span> Either<span class=\"token punctuation\">.</span>Right <span class=\"token operator\">-></span> ResponseEntity<span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"Worked!\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So that’s pretty much it. The <code class=\"language-text\">Verifier</code> doesn’t throw exceptions anymore. Instead, an <code class=\"language-text\">Either</code> wrapping the token is returned, with additional information about the error in case something goes wrong. We can manipulate the result throughout our application. When we are ready to unwrap the value, we use one of the two methods above to convert it to one value. In our case, the success case returns a 200, and the error a 502. To see the full implementation, check <a href=\"https://github.com/sirech/cookery2-backend/blob/master/src/main/kotlin/com/hceris/cookery2/auth/RemoteVerifier.kt\" target=\"_blank\" rel=\"noopener noreferrer\">this</a>.</p>\n<hr>\n<h2>Appendix: A built-in solution</h2>\n<p>Since <em>Kotlin</em> 1.3, there is a built-in way of dealing with computations that can fail. It is the <code class=\"language-text\">Result</code> class, which is typically used in a <code class=\"language-text\">runCatching</code> block:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">runCatching <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">methodThatMightThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">getOrElse</span> <span class=\"token punctuation\">{</span> ex <span class=\"token operator\">-></span>\n    <span class=\"token function\">dealWithTheException</span><span class=\"token punctuation\">(</span>ex<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This class can’t be used as a return type yet, so we can’t use it for our interface. Moreover, <code class=\"language-text\">Either</code> integrates with all the other <em>arrow</em> library. I plan to write in more detail about other things that you can do with it, such as converting it to an <code class=\"language-text\">Option</code> or chaining multiple calls in more complex examples.</p>\n<h2>Conclusion</h2>\n<p><code class=\"language-text\">Either</code> is a great way to make the error handling in your code more explicit. I’ve been trying to make all my services return it if there are failure conditions. The <a href=\"https://github.com/sirech/cookery2-backend/blob/master/src/main/kotlin/com/hceris/cookery2/recipes/RecipesController.kt#L65-L67\" target=\"_blank\" rel=\"noopener noreferrer\">controller</a> is then responsible for branching based on success/error and deciding what to do.</p>\n<p>I think that the code is a lot clearer this way, and worth trying. It’s one step towards more functional code. I’ll follow up with others, including other parts of <em>arrow</em>, which I like quite a bit.</p>","frontmatter":{"layout":"post","title":"Either Types as an alternative to throwing exceptions in Kotlin","path":"/kotlin-either-types-instead-of-exceptions/","categories":["Kotlin","Functional Programming","Arrow","Exceptions","Either"],"date":"2020/01/09","draft":false,"description":"Using Either is an alternative to exceptions to make your code more explicit about errors. Easy and convenient with Kotlin and Arrow","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/01a93f228e105034b17a364c39951f42/616de/either.png","srcSet":"/static/01a93f228e105034b17a364c39951f42/065ad/either.png 75w,\n/static/01a93f228e105034b17a364c39951f42/c6c68/either.png 150w,\n/static/01a93f228e105034b17a364c39951f42/616de/either.png 300w","sizes":"(min-width: 300px) 300px, 100vw"},"sources":[{"srcSet":"/static/01a93f228e105034b17a364c39951f42/bdd22/either.webp 75w,\n/static/01a93f228e105034b17a364c39951f42/6d886/either.webp 150w,\n/static/01a93f228e105034b17a364c39951f42/89743/either.webp 300w","type":"image/webp","sizes":"(min-width: 300px) 300px, 100vw"}]},"width":750,"height":482.5}}}}},"related":{"nodes":[{"frontmatter":{"title":"Painless JSON with Kotlin and jackson","path":"/painless-json-with-kotlin-and-jackson/","date":"2019/06/16"}},{"frontmatter":{"title":"Descriptive assertions in Kotlin for clearer tests","path":"/descriptive-assertions-in-kotlin/","date":"2019/09/28"}},{"frontmatter":{"title":"Book Review: Kotlin in Action","path":"/book-review-kotlin-in-action/","date":"2020/06/28"}}]},"previous":{"frontmatter":{"title":"Comparing Traefik2 with Traefik","path":"/comparing-traefik2-with-traefik/","date":"2019/12/15"}},"next":{"frontmatter":{"title":"Setting up Auth0 with Terraform","path":"/setting-up-auth0-with-terraform/","date":"2020/02/22"}}},"pageContext":{"related":["/painless-json-with-kotlin-and-jackson/","/descriptive-assertions-in-kotlin/","/book-review-kotlin-in-action/"],"previous":"/comparing-traefik2-with-traefik/","next":"/setting-up-auth0-with-terraform/"}},"staticQueryHashes":[],"slicesMap":{}}