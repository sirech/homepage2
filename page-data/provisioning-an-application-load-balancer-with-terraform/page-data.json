{"componentChunkName":"component---src-templates-blog-post-js","path":"/provisioning-an-application-load-balancer-with-terraform/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for Meta","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"22cad804-bb23-54c0-b7aa-799ab6889829","html":"<figure class=\"figure figure--left\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/dc8fff6512573d444b314e2727d1192c/4b190/lb.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 66.48936170212765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEAf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAFdKNS8nK//xAAZEAACAwEAAAAAAAAAAAAAAAABAgADEiH/2gAIAQEAAQUCqvLl7cKrkriYETi//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGBAAAwEBAAAAAAAAAAAAAAAAAAEhEQL/2gAIAQEABj8CzpIjNRIWmH//xAAdEAEAAgICAwAAAAAAAAAAAAABABEhMUFRYYHR/9oACAEBAAE/IfOcENS5cvF5gKmnuGVr0I/YiqGif//aAAwDAQACAAMAAAAQXA//xAAWEQEBAQAAAAAAAAAAAAAAAAAAESH/2gAIAQMBAT8QjX//xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAgEBPxCn/8QAHBABAAICAwEAAAAAAAAAAAAAAQARITFBUWFx/9oACAEBAAE/EHtGGFdEmMe9DAvVRlKm+Xp5MgZ5CLj9nK/qU6NAdE//2Q=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"lb\" title=\"\" src=\"/static/dc8fff6512573d444b314e2727d1192c/acb04/lb.jpg\" srcset=\"/static/dc8fff6512573d444b314e2727d1192c/bc01b/lb.jpg 188w,\n/static/dc8fff6512573d444b314e2727d1192c/bf173/lb.jpg 375w,\n/static/dc8fff6512573d444b314e2727d1192c/acb04/lb.jpg 750w,\n/static/dc8fff6512573d444b314e2727d1192c/4b190/lb.jpg 800w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>I wrote about <a href=\"../provisioning-a-network-load-balancer-with-terraform/\">Network Load Balancers</a> recently. You get a lot of mileage out of NLB’s, but sometimes you do need Layer 7 features.</p>\n<p>One alternative is keeping the NLB and putting a reverse proxy like <a href=\"../setting-up-traefik/\">Traefik</a> behind it. However, a simpler approach can be replacing both with another offering from AWS, the <a href=\"https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html\" target=\"_blank\" rel=\"noopener noreferrer\">Application Load Balancer (ALB)</a>. In this post, I’ll show how to provision ALBs with help of the old trusty <a href=\"https://www.terraform.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform</a>.</p>\n<h2>Setting up an Application Load Balancer</h2>\n<p>There are three main components to consider: The <strong>load balancer</strong>, the <strong>listeners</strong>, and the <strong>target groups</strong>. I wrote in detail about this in my <a href=\"../provisioning-a-network-load-balancer-with-terraform/\">previous article</a>, so I won’t belabor too much. Most of the concepts are similar.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 520px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/506757965f4b4db28df9dd13a937926e/69902/diagram.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 96.80851063829786%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADp0lEQVR42qWU3W8UZRTG+UNM9MZwQeKNWsX4gR9XBI3GRK69EdFoKImKtGKrDUqilFK0lYhKQ4DWWqSlKDWkxepSjbVdoATZbbvdnZ3ZmdnZ+d6Pdrs/z+6W2NZgNE7y5J336znnPc85ZwPrvkqlPiZv5JkYcpg8H2Imymv2/unbsH5hebl+a7BboWPHLN2vqUwMBPW98v8g7OuY5cCLVzm8c46xU7kVwsp/J6ysEP76Q4ajzVc53hrjxi/+yt6/9NAvlFDtELu4TK5QrsGX5+l+ATMs4sq/VajI+nIdcs6uoVxDTuCXyn8ROoUlEt4S6XCZVLCMImM8k+HaXJyb6RSqa6F5WVSB5lmk3SyKvyjnKrWzKYGerxJW6oTeYp2kSqiJJ+mwjBHo6E5KoGCFKrkgg+VrmF5aRp20X5Rzldqd6l1jNWHGKNLVlOCLJo2T+20y8pwL/Qt8sitOzzsa0Us20+bPbO95mu0nttF4dgcpL4+ap2b8b4QLiZC9z0b59NV5ju3OkJKgnWiP0fr8DEd2phg/7TCqnGHz4Xt45qun2Pr5o8w7HtrtCJPJgJce+ZH3XojSIWmSFkW+/GiGVx6aoOW564yeNhhXz3H/oU088VkD245tIeH6tyfMBUuMXcoydtEiEnFRRcmp6Bx9x39isPc34vEUKSfG2Su9nLlyktHY9yJKNYbU4lgVZw2hW6xayaMEAel8KPEpojgmiWyCZC5F2hERbIus62J5Hlbg1QiTfomkV5IMKaGHi6vSJl8gZhpcVxSSdg7TN8WiS8oXA2JEDx3JyawY8+WpkkJ5mXu65K9BWDIFBnbo1mq97mHoo57fR3ZoF/bFveLJAvpUH3r/y+S+a8SKD2MYf5AZeJ3s8G5yEx+T9VU6x2d4c/B39gxNMq3oqzy0TeZbNmG2P4jTtZmsHiX9zRtorRtxOhvIje9Hi42jNN+FdWQLbs9W9NwsT3Zf5uHOCBs/HOXr6YVVhFaGeMtjZA4IWu4kq06S7G8lta8BrekOjJF3UWOXSchcbbsX/eB96PYCj3dFeOBQhLs/WE/ou8ydO0js1B6Ub9/GsOfRpoeZ7W0m0duIefMChhkjMdDGXN9b6GPtEmeVo5FrtI1EeX9kau2Ti0vVAi9hiAi2FLkdhmRch4RukLSkckRdLSd17DjMy1racSXVfPKlkLBYRSDClNa1r1pvqlQbYm0aBiGekPqeS14MBDLPhwGubeO7VUUrVDvdLdzqlH8CcOpXERFCHSAAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"diagram\" title=\"\" src=\"/static/506757965f4b4db28df9dd13a937926e/69902/diagram.png\" srcset=\"/static/506757965f4b4db28df9dd13a937926e/4dcb9/diagram.png 188w,\n/static/506757965f4b4db28df9dd13a937926e/5ff7e/diagram.png 375w,\n/static/506757965f4b4db28df9dd13a937926e/69902/diagram.png 520w\" sizes=\"(max-width: 520px) 100vw, 520px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>Let’s focus on some concrete aspects. For the <code class=\"language-text\">aws_lb</code>, we use a different <code class=\"language-text\">load_balancer_type</code> (<code class=\"language-text\">application</code>).</p>\n<!-- alb -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">data <span class=\"token type variable\">\"aws_subnet_ids\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">vpc_id</span> <span class=\"token punctuation\">=</span> var.vpc_id\n\n  <span class=\"token property\">tags</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">Tier</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Public\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_lb\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>               <span class=\"token punctuation\">=</span> <span class=\"token string\">\"basic-load-balancer\"</span>\n  <span class=\"token property\">load_balancer_type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"application\"</span>\n  <span class=\"token property\">subnets</span>            <span class=\"token punctuation\">=</span> data.aws_subnet_ids.this.ids\n\n  <span class=\"token property\">enable_cross_zone_load_balancing</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Unlike NLBs, you can’t set static IPs for an ALB.</p>\n<h3>Listeners</h3>\n<p>For an ALB, our listeners have to be either <code class=\"language-text\">HTTPS</code> or <code class=\"language-text\">HTTP</code>. We can choose to do SSL termination at this stage. Let’s see an example.</p>\n<!-- alb-listener -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_lb_listener\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">load_balancer_arn</span> <span class=\"token punctuation\">=</span> aws_lb.this.arn\n\n  <span class=\"token property\">port</span>              <span class=\"token punctuation\">=</span> <span class=\"token number\">443</span>\n  <span class=\"token property\">protocol</span>          <span class=\"token punctuation\">=</span> <span class=\"token string\">\"HTTPS\"</span>\n\n  <span class=\"token property\">ssl_policy</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"ELBSecurityPolicy-2016-08\"</span>\n  <span class=\"token property\">certificate_arn</span>   <span class=\"token punctuation\">=</span> aws_acm_certificate.this.arn\n\n  <span class=\"token keyword\">default_action</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">type</span>             <span class=\"token punctuation\">=</span> <span class=\"token string\">\"forward\"</span>\n    <span class=\"token property\">target_group_arn</span> <span class=\"token punctuation\">=</span> aws_lb_target_group.this.arn\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">data <span class=\"token type variable\">\"aws_acm_certificate\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">domain</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">dns_record_name</span><span class=\"token punctuation\">}</span></span>.<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">dns_zone_name</span><span class=\"token punctuation\">}</span></span>\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can read more about the different <a href=\"https://docs.aws.amazon.com/elasticloadbalancing/latest/application/create-https-listener.html#describe-ssl-policies\" target=\"_blank\" rel=\"noopener noreferrer\">SSL Security policies here</a>. I’m referencing an existing certificate for now. We’ll see how to provision it thanks to <em>Route53</em> later on.</p>\n<h3>Target groups</h3>\n<p>Having carried the SSL termination in the step before, our target group is going to work over <code class=\"language-text\">HTTP</code>.</p>\n<!-- alb-target-group-instance -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_lb_target_group\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">port</span>     <span class=\"token punctuation\">=</span> <span class=\"token number\">80</span>\n  <span class=\"token property\">protocol</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"HTTP\"</span>\n  <span class=\"token property\">vpc_id</span>   <span class=\"token punctuation\">=</span> var.vpc_id\n\n  <span class=\"token property\">load_balancing_algorithm_type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"least_outstanding_requests\"</span>\n\n  <span class=\"token keyword\">stickiness</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">enabled</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token property\">type</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"lb_cookie\"</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">health_check</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">healthy_threshold</span>   <span class=\"token punctuation\">=</span> <span class=\"token number\">2</span>\n    <span class=\"token property\">interval</span>            <span class=\"token punctuation\">=</span> <span class=\"token number\">30</span>\n    <span class=\"token property\">protocol</span>            <span class=\"token punctuation\">=</span> <span class=\"token string\">\"HTTP\"</span>\n    <span class=\"token property\">unhealthy_threshold</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">2</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token property\">depends_on</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>\n    aws_lb.this\n  <span class=\"token punctuation\">]</span>\n\n  <span class=\"token keyword\">lifecycle</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">create_before_destroy</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_autoscaling_attachment\"</span></span> <span class=\"token string\">\"target\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">autoscaling_group_name</span> <span class=\"token punctuation\">=</span> var.autoscaling_group_name\n  <span class=\"token property\">alb_target_group_arn</span>   <span class=\"token punctuation\">=</span> aws_lb_target_group.this.arn\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There are some extra features to show:</p>\n<ul>\n<li>We’re customizing the load balancing <a href=\"https://aws.amazon.com/about-aws/whats-new/2019/11/application-load-balancer-now-supports-least-outstanding-requests-algorithm-for-load-balancing-requests/\" target=\"_blank\" rel=\"noopener noreferrer\">algorithm</a>.</li>\n<li>We’re using sticky sessions through a cookie with the <code class=\"language-text\">stickiness</code> block.</li>\n<li>We’ve got a custom health check with the <code class=\"language-text\">health_check</code> block.</li>\n</ul>\n<h3>Security Groups</h3>\n<p>Just like network load balancers, you need to allow traffic to flow through security groups.</p>\n<!-- security-groups -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_security_group\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Allow connection between ALB and target\"</span>\n  <span class=\"token property\">vpc_id</span>      <span class=\"token punctuation\">=</span> var.vpc_id\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_security_group_rule\"</span></span> <span class=\"token string\">\"ingress\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">for_each</span> <span class=\"token punctuation\">=</span> var.ports\n\n  <span class=\"token property\">security_group_id</span> <span class=\"token punctuation\">=</span> aws_security_group.this.id\n  <span class=\"token property\">from_port</span>         <span class=\"token punctuation\">=</span> <span class=\"token number\">443</span>\n  <span class=\"token property\">to_port</span>           <span class=\"token punctuation\">=</span> <span class=\"token number\">443</span>\n  <span class=\"token property\">protocol</span>          <span class=\"token punctuation\">=</span> <span class=\"token string\">\"tcp\"</span>\n  <span class=\"token property\">type</span>              <span class=\"token punctuation\">=</span> <span class=\"token string\">\"ingress\"</span>\n  <span class=\"token property\">cidr_blocks</span>       <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Path-based routing</h2>\n<p>Our load balancer is aware of the path and headers that we’re requesting, and thus we can make routing decisions based on that. We use extra <code class=\"language-text\">aws_lb_listener_rule</code> resources to enrich the regular listener.</p>\n<!-- listener-rule -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_lb_listener_rule\"</span></span> <span class=\"token string\">\"redirect_based_on_path\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">listener_arn</span> <span class=\"token punctuation\">=</span> aws_lb_listener.this.arn\n\n  <span class=\"token keyword\">action</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">type</span>             <span class=\"token punctuation\">=</span> <span class=\"token string\">\"forward\"</span>\n    <span class=\"token property\">target_group_arn</span> <span class=\"token punctuation\">=</span> aws_lb_target_group.alternative_target.arn\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">condition</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">path_pattern</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">values</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/rest/v2/*\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If the condition matches (in this case, we’re using a new version of the API in the URL), the default listener will be ignored. Instead, traffic is redirected to a different target group. Similarly, we can make other rules based on a specific header, or a hostname.</p>\n<h2>Setting up Route53</h2>\n<p>We’re surely not going to access the load balancer through an autogenerated domain, are we? We want pretty domains, using <a href=\"https://aws.amazon.com/route53/\" target=\"_blank\" rel=\"noopener noreferrer\">Route53</a>. First, we set up a <code class=\"language-text\">CNAME</code> record.</p>\n<!-- route53-lb -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">data <span class=\"token type variable\">\"aws_route53_zone\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> var.dns_zone_name\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_route53_record\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> var.dns_record_name\n  <span class=\"token property\">type</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"CNAME\"</span>\n\n  <span class=\"token property\">records</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>\n    aws_lb.this.dns_name,\n  <span class=\"token punctuation\">]</span>\n\n  <span class=\"token property\">zone_id</span> <span class=\"token punctuation\">=</span> data.aws_route53_zone.this.zone_id\n  <span class=\"token property\">ttl</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"60\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We’re also setting up a certificate for the domain. It’s validated automatically through a DNS challenge.</p>\n<!-- route53-cert -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_acm_certificate\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">domain_name</span>       <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">dns_record_name</span><span class=\"token punctuation\">}</span></span>.<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">dns_zone_name</span><span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">validation_method</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"DNS\"</span>\n\n  <span class=\"token keyword\">lifecycle</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">create_before_destroy</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_acm_certificate_validation\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">certificate_arn</span>         <span class=\"token punctuation\">=</span> aws_acm_certificate.this.arn\n  <span class=\"token property\">validation_record_fqdns</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>aws_route53_record.web_cert_validation.fqdn<span class=\"token punctuation\">]</span>\n\n  <span class=\"token keyword\">lifecycle</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">create_before_destroy</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_route53_record\"</span></span> <span class=\"token string\">\"web_cert_validation\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> aws_acm_certificate.this.domain_validation_options.<span class=\"token number\">0.</span>resource_record_name\n  <span class=\"token property\">type</span> <span class=\"token punctuation\">=</span> aws_acm_certificate.this.domain_validation_options.<span class=\"token number\">0.</span>resource_record_type\n\n  <span class=\"token property\">records</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>aws_acm_certificate.this.domain_validation_options.<span class=\"token number\">0.</span>resource_record_value<span class=\"token punctuation\">]</span>\n\n  <span class=\"token property\">zone_id</span> <span class=\"token punctuation\">=</span> data.aws_route53_zone.zone.id\n  <span class=\"token property\">ttl</span>     <span class=\"token punctuation\">=</span> <span class=\"token number\">60</span>\n\n  <span class=\"token keyword\">lifecycle</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">create_before_destroy</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>A word on pricing</h2>\n<p>As you can see on the <a href=\"https://aws.amazon.com/elasticloadbalancing/pricing/\" target=\"_blank\" rel=\"noopener noreferrer\">pricing page</a>, ALBs have the same fixed costs as NLBs but are more expensive when processing traffic (LCU vs NLCU). The pricing details are a bit arcane. A good rule of thumb is to use an ALB if there is a specific feature that you want to utilize, I guess.</p>\n<h2>Conclusion</h2>\n<p>A combination of <a href=\"../provisioning-a-network-load-balancer-with-terraform/\">NLBs</a> and ALBs will cover most if not all your load balancing needs. The sheer amount of features can be overwhelming. I’ve found it easier to start focusing on the basics and discover the vast array of possibilities one by one.</p>","frontmatter":{"layout":"post","title":"Provisioning an Application Load Balancer with Terraform","path":"/provisioning-an-application-load-balancer-with-terraform/","categories":["AWS","Terraform","Load Balancing","Networking","Infrastructure as Code"],"date":"2021/01/02","draft":false,"description":"Learn how to provision Application Load Balancers in AWS using Terraform to ensure high availability for your applications","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#888888","images":{"fallback":{"src":"/static/dc8fff6512573d444b314e2727d1192c/6cce3/lb.jpg","srcSet":"/static/dc8fff6512573d444b314e2727d1192c/2d550/lb.jpg 188w,\n/static/dc8fff6512573d444b314e2727d1192c/e4b93/lb.jpg 375w,\n/static/dc8fff6512573d444b314e2727d1192c/6cce3/lb.jpg 750w","sizes":"(min-width: 750px) 750px, 100vw"},"sources":[{"srcSet":"/static/dc8fff6512573d444b314e2727d1192c/99097/lb.webp 188w,\n/static/dc8fff6512573d444b314e2727d1192c/7dad0/lb.webp 375w,\n/static/dc8fff6512573d444b314e2727d1192c/d2a19/lb.webp 750w","type":"image/webp","sizes":"(min-width: 750px) 750px, 100vw"}]},"width":750,"height":501}}}}},"related":{"nodes":[{"frontmatter":{"title":"Testing containers with dependencies with localstack","path":"/testing-containers-serverspec-and-localstack/","date":"2019/01/21"}},{"frontmatter":{"title":"Making Concourse's fly tool work behind an authenticated ALB","path":"/concourse-fly-behind-alb-oidc/","date":"2019/04/13"}},{"frontmatter":{"title":"Provisioning a Network Load Balancer with Terraform","path":"/provisioning-a-network-load-balancer-with-terraform/","date":"2020/11/17"}}]},"previous":{"frontmatter":{"title":"Book Review: Prometheus up and running","path":"/book-review-prometheus-up-and-running/","date":"2021/01/08"}},"next":{"frontmatter":{"title":"Setting up OAuth for Grafana with Auth0","path":"/setting-up-oauth-for-grafana-with-auth0/","date":"2021/01/17"}}},"pageContext":{"related":["/provisioning-a-network-load-balancer-with-terraform/","/testing-containers-serverspec-and-localstack/","/concourse-fly-behind-alb-oidc/"],"previous":"/book-review-prometheus-up-and-running/","next":"/setting-up-oauth-for-grafana-with-auth0/"}},"staticQueryHashes":[],"slicesMap":{}}