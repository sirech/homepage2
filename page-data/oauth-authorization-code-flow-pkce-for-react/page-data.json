{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/oauth-authorization-code-flow-pkce-for-react/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for ThoughtWorks","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"0275bea6-e39b-5f87-bec5-3565b857d3d4","html":"<figure class=\"figure figure--left\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/dd0790d7774c3b701ca4d48909e4aa05/c08c5/lock.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 66.48936170212765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAECAwT/xAAVAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAABwJOKtICf/8QAGRABAQADAQAAAAAAAAAAAAAAAQACEBIh/9oACAEBAAEFAjzXQRDOV//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABoQAAICAwAAAAAAAAAAAAAAAAABIWEQETH/2gAIAQEABj8C4KSUneHQno//xAAbEAEAAwADAQAAAAAAAAAAAAABABEhMVFxQf/aAAgBAQABPyGozwvyWAlducRwo9tl2taTSc71zLBA2T//2gAMAwEAAgADAAAAEGgP/8QAFREBAQAAAAAAAAAAAAAAAAAAACH/2gAIAQMBAT8QR//EABURAQEAAAAAAAAAAAAAAAAAAAAh/9oACAECAQE/EFf/xAAcEAEAAQUBAQAAAAAAAAAAAAABEQAhMUFRcZH/2gAIAQEAAT8QSIHQrqOYoUDMvIVOL2dNQMdi5H2mNlYm6cFGyAccnDUjEbiOmvK//9k='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Lock\" title=\"Lock\" src=\"/static/dd0790d7774c3b701ca4d48909e4aa05/c08c5/lock.jpg\" srcset=\"/static/dd0790d7774c3b701ca4d48909e4aa05/bc01b/lock.jpg 188w,\n/static/dd0790d7774c3b701ca4d48909e4aa05/bf173/lock.jpg 375w,\n/static/dd0790d7774c3b701ca4d48909e4aa05/c08c5/lock.jpg 640w\" sizes=\"(max-width: 640px) 100vw, 640px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>I’ve been working with OAuth a lot lately. Just recently, I wrote about setting it up for <a href=\"../setting-up-oauth-for-grafana-with-auth0/\">grafana</a>. Today, I want to talk about the recommended flow for Single Page Applications, <em>Authorization Code Flow with PKCE</em>. I’m going to add authorization to a React application leveraging <a href=\"https://auth0.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Auth0</a> as an Identity Provider.</p>\n<p>I mention Auth0 so often around here, you’d think I’m getting a referral bonus. I promise you I’m not! It’s deserved praise. The UI is easy to navigate, is conveniently provisioned with Terraform, and has powerful libraries for most programming languages. I wrote about verifying JWTs from a <a href=\"../authorize-spring-backend-with-jwt-in-kotlin/\">SpringBoot backend</a> in the past. Now it’s time to talk about the frontend.</p>\n<h2>Choosing the right flow</h2>\n<p>OAuth is not a monolithic entity. There are so many <a href=\"https://nordicapis.com/8-types-of-oauth-flows-and-powers/\" target=\"_blank\" rel=\"noopener noreferrer\">flows</a> it’s no wonder people still succumb to the temptation of Basic Auth. The first step always is <a href=\"https://auth0.com/docs/authorization/which-oauth-2-0-flow-should-i-use\" target=\"_blank\" rel=\"noopener noreferrer\">choosing the right one</a>. Given that an SPA can’t store a secret id (the source code is sent to the browser, you know), we have two possibilities.</p>\n<h3>Implicit Flow</h3>\n<p>Traditionally, SPAs tended to use the <a href=\"https://developer.okta.com/blog/2018/05/24/what-is-the-oauth2-implicit-grant-type\" target=\"_blank\" rel=\"noopener noreferrer\">implicit flow</a>, also known as the implicit grant type. You make a request to the <code class=\"language-text\">authorize</code> endpoint with <code class=\"language-text\">response_type=token id_token</code>. It looks like this:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 683px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/e6cd79dd35e8a7aff9c3e5910c3f071a/bca35/implicit-flow-request.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 45.212765957446805%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABOElEQVQoz31SQW7EIAzky/1M/9Ef9NB7j6tIlfbSVqpCsgY7JCHAVHjJqqm2RRolhrHHHjCeGcyCCxHIWoi1uFgLOwygYYCv/9ZiGAaFbWdj38ONIx5fAh6eJnQfHhM7GPr6hLtYeM+YmCHeQeQqIlWMCCKi8N5jnmcsy4K14fV9w/NbxEgT4sQwgT0mYZRSUABk/RaN1xg1RrnGFXWllLTwYaWIsi4wfW8Rwoyc8y2p5KKFogjSsqiQop1v24Z1XTUn5YwtZRXJW4Q5nU7qS4xRhW5FAbB3YGuRwoQYgna8cw7cxq8w5/MZzHxVS+mAWQSzI+20tL17vJ/QgtXwe8TqrxCBnVNOvYzdwz8Ldl0HIjq230Yi59C3Z9LXZ+KcXkb18Dd/h6mH1b/a4W/ofhtzn6Dy/8v5BgJEvIKKdvYwAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Implicit Flow Request\" title=\"Implicit Flow Request\" src=\"/static/e6cd79dd35e8a7aff9c3e5910c3f071a/bca35/implicit-flow-request.png\" srcset=\"/static/e6cd79dd35e8a7aff9c3e5910c3f071a/4dcb9/implicit-flow-request.png 188w,\n/static/e6cd79dd35e8a7aff9c3e5910c3f071a/5ff7e/implicit-flow-request.png 375w,\n/static/e6cd79dd35e8a7aff9c3e5910c3f071a/bca35/implicit-flow-request.png 683w\" sizes=\"(max-width: 683px) 100vw, 683px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <figcaption class=\"figure__caption\">\n  When using OAuth, it's key to ask things nicely\n  </figcaption>\n</figure>\n<p>Typically, you lack authentication for the first request, so you’ll land in a login screen artfully presented by Auth0. Afterward, the response is a redirect (302) with an <code class=\"language-text\">access_token</code> and an <code class=\"language-text\">id_token</code> appended to the URL as query parameters. The <code class=\"language-text\">access_token</code> is a JWT similar to this:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 583px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/f923392ce8dc4af86278e33143ce0c67/9fc4b/decoded-token.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 87.7659574468085%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAABj0lEQVQ4y61Ui3KbQAz0//9i2iTGdrBxU8CN4V7a7eiUM5CStu4UZkcP0J5esKmqim3bsus69oq+z7hcLgwhUESYUvorxBi50aBYggCmGYGS3YNMSB/JEEkBeR1J5/mvlyaxoQvEriEGRzzsiNeeIAnA5Jq+Yk+EV0dsa2L0hGZYAgpkrosFF38S0+cZon4lnmtifyK2R+KpJnYnojqZ/3A2v9rH78TLmdg3Zqv/W2eEKBmGeDv1j8iBK/aih0luvRAIJcuZLjLZ8uH5bMIan6fcNA27tuMwDHevyeraDMOVzjmGGP4PIeN7A8DFdNWhkySXANZx66E40Ndgli+g3xncIxgaML2B4kEZQITPSSdCT/oDKCPong1+P2H8agfG3g7FgrAMepEhGY6WgWbolOBgwQVW+vzCfFs+EI7MRGkA3ZOVqlnmMp2VnH68480wkeJXQnjSbcF0AcPJSnSVkY5fwHAGYwvGDky9vZc/O37SQyWUgVSpg9SMEUhtheLuv40kYb7L5he9yLSC3+zhTyW8iigCEG3qAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Decoded Token\" title=\"Decoded Token\" src=\"/static/f923392ce8dc4af86278e33143ce0c67/9fc4b/decoded-token.png\" srcset=\"/static/f923392ce8dc4af86278e33143ce0c67/4dcb9/decoded-token.png 188w,\n/static/f923392ce8dc4af86278e33143ce0c67/5ff7e/decoded-token.png 375w,\n/static/f923392ce8dc4af86278e33143ce0c67/9fc4b/decoded-token.png 583w\" sizes=\"(max-width: 583px) 100vw, 583px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>Now that you’ve learned about this flow, you can pretty much forget about it. Implicit flow is no longer considered the best option for SPAs. Instead, if you’re implementing a new application you’re advised to use the <a href=\"https://auth0.com/docs/flows/authorization-code-flow-with-proof-key-for-code-exchange-pkce\" target=\"_blank\" rel=\"noopener noreferrer\">Code Flow with PKCE</a> because it’s more secure. Don’t you love the <em>argument by security</em>?</p>\n<h3>Code Flow with PKCE</h3>\n<p>This is an enhanced version of the Code Flow that doesn’t require a client secret (remember, no secret in SPA code). Like before, we use the <code class=\"language-text\">authorize</code> endpoint, this time with a different <code class=\"language-text\">response_type</code>. We include a <code class=\"language-text\">code_challenge</code> as well.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 683px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/9a477989f159788401bbfc15c7e290fc/bca35/code-flow-pkce-request.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 45.74468085106383%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABQElEQVQoz22Sy27DIBBF+c3+XRf9kq667bZRsokcRQZjzNvG5lYzMVZTBelqeJ7hMojJWkyTxWgMtJRwUmKUElIpaKVgpYQiKcWSe7/vJfyk8f7l8fbh8PljkbyBCFrBGw3vPQLJWYTgEUKAcw7eWu63cc4ZKSUel2VGNxZ8dyvUGFDcBKH6HmbUqLWytj3WCiRrUVJCBR5r2wZqpRTEGHn+aGVGzRGi6zporTHP8wGt2yMuOaNu29NBgjYwxXUXXwSAuFwuuN/vbOUA7nLeIzuHNQZk7449BPq/t82L8/nMj4zd1l8RJA4DsjGIwbPVdrNXwHVdIW63G6y1B7BZYmAIXJRWGCocFWZZlqe9f8+I0+l0WKYMLRs1OqyGgd+YXFAkEfCVIwZer1f+W5T9qTC1ciXpi9A8JWwi669gBPwF5py7Q7S97bYAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Code Flow PKCE Request\" title=\"Code Flow PKCE Request\" src=\"/static/9a477989f159788401bbfc15c7e290fc/bca35/code-flow-pkce-request.png\" srcset=\"/static/9a477989f159788401bbfc15c7e290fc/4dcb9/code-flow-pkce-request.png 188w,\n/static/9a477989f159788401bbfc15c7e290fc/5ff7e/code-flow-pkce-request.png 375w,\n/static/9a477989f159788401bbfc15c7e290fc/bca35/code-flow-pkce-request.png 683w\" sizes=\"(max-width: 683px) 100vw, 683px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <figcaption class=\"figure__caption\">\n  Find the differences\n  </figcaption>\n</figure>\n<p>If you’re authorized, the response is a redirect again. This time, we are getting a <code class=\"language-text\">code</code> appended to the URL as a query parameter. To obtain the token, we need to make another request to the <code class=\"language-text\">oauth/token</code> endpoint (a <em>POST</em> this time) with the <code class=\"language-text\">code</code> we got and the <code class=\"language-text\">code_verifier</code> we used to generate the challenge.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 631px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/d6e020ae13415cc7c35c38416f260f4c/4597d/code-flow-pkce-token.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 29.25531914893617%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA8klEQVQY032ObU7DMAxAeyxOxyG4C2fgEPxEQ7SlSdZ8NonzpmRsGkLC0lPi2H7xtK4rWmv6qeYZM88sy8K6bRhjBr1+5XpXWrMpRbCG59edp5czb++GaDWT954YI9ZaonN4Z7FqY98WYgg450Y9pTTyWusdkYrywocRvItUb5l6Y7gNdGIYg8m78dY5jkSKkZoiIkJr7Q78UAsSA9NRCrkLjaF2mfUc+07pguBJIeFCporQ41HWkY60m5Yp5UK0lvPphP7WnOYzn18GpS3OBayN7K5vmmlN/ggfqaUw5VIoOY8kHVdqlfHb72j/ysa2IlwAZPjRj5isvfEAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Code Flow PKCE Token\" title=\"Code Flow PKCE Token\" src=\"/static/d6e020ae13415cc7c35c38416f260f4c/4597d/code-flow-pkce-token.png\" srcset=\"/static/d6e020ae13415cc7c35c38416f260f4c/4dcb9/code-flow-pkce-token.png 188w,\n/static/d6e020ae13415cc7c35c38416f260f4c/5ff7e/code-flow-pkce-token.png 375w,\n/static/d6e020ae13415cc7c35c38416f260f4c/4597d/code-flow-pkce-token.png 631w\" sizes=\"(max-width: 631px) 100vw, 631px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>This call returns the <code class=\"language-text\">access_token</code> and <code class=\"language-text\">id_token</code> as part of the body, ensuring that we don’t store tokens in our browser history.</p>\n<h2>Using the right library</h2>\n<p>Alright, we’re getting in the <em>flow</em>. Our next step is extending our application to actually use OAuth. Implementing it by hand is error-prone and cumbersome. Spare yourself the trouble and use a library instead. Auth0’s seems to be trying to corner the market, as they have three different JavaScript libraries. I’ve worked with all three in some capacity, but as of today, I endorse <a href=\"https://github.com/auth0/auth0-react\" target=\"_blank\" rel=\"noopener noreferrer\">auth0-react</a> as the most convenient one. Let’s see some code samples.</p>\n<h3>Auth0 provider</h3>\n<p>This library uses the <a href=\"https://reactjs.org/docs/context.html\" target=\"_blank\" rel=\"noopener noreferrer\">Context API</a>. We have to instantiate a component called <code class=\"language-text\">Auth0Provider</code> with the parameters for our connection with Auth0 that we get from the <a href=\"https://auth0.com/docs/applications\" target=\"_blank\" rel=\"noopener noreferrer\">application associated with the UI</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">host</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">REACT_APP_HOST</span> <span class=\"token operator\">||</span> <span class=\"token string\">''</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">redirectUri</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">host</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/callback</span><span class=\"token template-punctuation string\">`</span></span>\n\n<span class=\"token function\">render</span><span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BrowserRouter</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Auth0Provider</span></span>\n      <span class=\"token attr-name\">domain</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>{{auth0_domain}}<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">clientId</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>{{client_id}}<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">scope</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>openid profile create:recipes<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">audience</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>{{application_domain}}<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">redirectUri</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token function\">redirectUri</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n    <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">App</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Auth0Provider</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">BrowserRouter</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">,</span>\n  document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Triggering the login flow</h3>\n<p>In our code, we use a <a href=\"https://reactjs.org/docs/hooks-intro.html\" target=\"_blank\" rel=\"noopener noreferrer\">hook</a> to interact with Auth0. We get a whole bunch of stuff from the hook. For our example, we’re interested in knowing if the user is authenticated. We need login and logout functions as well.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token literal-property property\">Navigation</span><span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">FC</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    loginWithRedirect<span class=\"token punctuation\">,</span>\n    logout<span class=\"token punctuation\">,</span>\n    isAuthenticated<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useAuth0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">AppBar</span></span> <span class=\"token attr-name\">data-testid</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>navigation<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Toolbar</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\n        </span><span class=\"token punctuation\">{</span><span class=\"token operator\">!</span>isAuthenticated <span class=\"token operator\">&amp;&amp;</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Login</span></span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">loginWithRedirect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n        \n        </span><span class=\"token punctuation\">{</span>isAuthenticated <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Logout</span></span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">logout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">localOnly</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Toolbar</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">AppBar</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If you have worked with hooks already, you’ll have seen this pattern. Once we click on the login button, the OAuth dance begins. We land on a form like this:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 422px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/bd3099230b189938fc54bb836db72d20/fa5c1/auth0-screen.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 102.1276595744681%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABYlAAAWJQFJUiTwAAABtklEQVQ4y61TTU/CQBDtj/fgzbM3Yzx49OjFg1djYjwIRtrS3baAlRRDQcp+PTO77QIKBA2bTHfamX3z3sw2wJFXsCtgjPG7Mdraz9ifALcd3Af0B4YaMo+hivwg0GAHGox2EkXnAbPLU1QXJ9DTyf8k275pZf3l4x3mN+eYX59BjZhnfTCgG4LxLInL1+0V6qd767fMd7EMDh3IobFg83qsjBZjHJ1uFynnyLMMScJQVdWv/PX3YF/F8XiM7usr4jhGFMUIwwjlZLKX9QZDKSWUUnYXQkBvKUR5lENxm6vUBksPSEHGUwwGQwyHIzDOEUaxld1PGOJ+gijuI88HyLIcPM2QZjmK4gN6bVDBNrkETgcSxiwgAYxG70izzBYqy3KnbN9DqqGbxlJFki2lgtbunYrQ/tOn+PpwLENBfVjUMEJAyCbZt8KBu4OAagBlY67nzreArX4ePmPwXqIoCrz1enaqbR95mqIXRnjpdDCdTrfK9YBWotL4XM4xo8lJhbqurS0WNerlEkJK61fVzLNdSdZORQtID/potPvVVCPXW3vYOMltDwlk3X7dw2OsjSkfw4jhN85GISmlcAfoAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Auth0 screen\" title=\"Auth0 screen\" src=\"/static/bd3099230b189938fc54bb836db72d20/fa5c1/auth0-screen.png\" srcset=\"/static/bd3099230b189938fc54bb836db72d20/4dcb9/auth0-screen.png 188w,\n/static/bd3099230b189938fc54bb836db72d20/5ff7e/auth0-screen.png 375w,\n/static/bd3099230b189938fc54bb836db72d20/fa5c1/auth0-screen.png 422w\" sizes=\"(max-width: 422px) 100vw, 422px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <figcaption class=\"figure__caption\">\n  Welcome, for the love of God, don't build this yourself\n  </figcaption>\n</figure>\n<p>After the authentication, Auth0 redirects back to the URL defined in the <code class=\"language-text\">redirectUri</code> specified above. I put a <code class=\"language-text\">Callback</code> component under that route that waits for the process to finish. That appears to work better than waiting on the main component directly.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token literal-property property\">Callback</span><span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">FC</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> isLoading <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useAuth0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token punctuation\">{</span><span class=\"token operator\">!</span>isLoading <span class=\"token operator\">&amp;&amp;</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Redirect</span></span> <span class=\"token attr-name\">to</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Waiting for log in to be confirmed</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Subsequently, <code class=\"language-text\">isAuthenticated</code> is true, and we have access to the user data. You can configure the provider to store the token in <code class=\"language-text\">localStorage</code>, but that’s apparently a security risk so forget I mentioned this.</p>\n<h3>Making API calls</h3>\n<p>Displaying the user’s data is nice, but the crucial part is making sure that we include our token when querying the backend. This token is then <a href=\"../authorize-spring-backend-with-jwt-in-kotlin/\">verified</a>, and then actual useful things ensue.</p>\n<p>Again we make use of the <code class=\"language-text\">useAuth0</code> hook. I’m after the <code class=\"language-text\">getAccessTokenSilently</code> method, which returns the token if present or makes a silent request if not.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token literal-property property\">Submitter</span><span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span><span class=\"token constant\">FC</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Props</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> = ({ history }: Props) => </span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> getAccessTokenSilently <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useAuth0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>Formik\n      initialValues<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>initialValues<span class=\"token punctuation\">}</span>\n      validationSchema<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>validationSchema<span class=\"token punctuation\">}</span>\n      onSubmit<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">values</span><span class=\"token operator\">:</span> RecipeForm</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> accessToken <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getAccessTokenSilently</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">newRecipe</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token literal-property property\">Authorization</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Bearer </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>accessToken<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token function\">fold</span><span class=\"token punctuation\">(</span>\n          response<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error happened: '</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> history<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/recipes/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Formik</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The token needs to be included as a bearer token in any API request that requires authorization. We might get fancy by passing different scopes to the <code class=\"language-text\">getAccessTokenSilently</code> method if we need granular permissions. That’s too much for this simple app, though.</p>\n<h2>Summary</h2>\n<p>I’ve seen some nasty, bespoke approaches to handle authz/authn, especially when frontend code is involved. Do not roll your home-cooked solution, it’s likely to be much more complex and probably a lot more insecure. With Auth0 most of the work is already done for you. You might as well use it!</p>","frontmatter":{"layout":"post","title":"Authorization Code Flow with PKCE (OAuth) in a React application","path":"/oauth-authorization-code-flow-pkce-for-react/","categories":["Auth0","OAuth","React"],"date":"2021/03/29","draft":false,"description":"SPAs implementing OAuth should pick Authorization Code Flow with PKCE for maximum security. Let's implement it in React with help of Auth0","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/dd0790d7774c3b701ca4d48909e4aa05/e70fc/lock.jpg","srcSet":"/static/dd0790d7774c3b701ca4d48909e4aa05/da65b/lock.jpg 160w,\n/static/dd0790d7774c3b701ca4d48909e4aa05/f6fcd/lock.jpg 320w,\n/static/dd0790d7774c3b701ca4d48909e4aa05/e70fc/lock.jpg 640w","sizes":"(min-width: 640px) 640px, 100vw"},"sources":[{"srcSet":"/static/dd0790d7774c3b701ca4d48909e4aa05/405d4/lock.webp 160w,\n/static/dd0790d7774c3b701ca4d48909e4aa05/dde70/lock.webp 320w,\n/static/dd0790d7774c3b701ca4d48909e4aa05/62859/lock.webp 640w","type":"image/webp","sizes":"(min-width: 640px) 640px, 100vw"}]},"width":750,"height":500.39062499999994}}}}},"related":{"nodes":[{"frontmatter":{"title":"Fail a test in Jest if an unexpected network request happens","path":"/jest-fail-test-if-unexpected-network-request-happens/","date":"2019/12/08"}},{"frontmatter":{"title":"A directory structure for React projects","path":"/a-directory-structure-for-react-projects/","date":"2020/07/19"}},{"frontmatter":{"title":"Setting up OAuth for Grafana with Auth0","path":"/setting-up-oauth-for-grafana-with-auth0/","date":"2021/01/17"}}]},"previous":{"frontmatter":{"title":"Setting up OAuth for Grafana with Auth0","path":"/setting-up-oauth-for-grafana-with-auth0/","date":"2021/01/17"}},"next":{"frontmatter":{"title":"So, what does the NGINX ingress controller actually do?","path":"/what-does-the-nginx-ingress-controller-actually-do/","date":"2021/01/30"}}},"pageContext":{"related":["/a-directory-structure-for-react-projects/","/setting-up-oauth-for-grafana-with-auth0/","/jest-fail-test-if-unexpected-network-request-happens/"],"previous":"/setting-up-oauth-for-grafana-with-auth0/","next":"/what-does-the-nginx-ingress-controller-actually-do/"}},
    "staticQueryHashes": []}