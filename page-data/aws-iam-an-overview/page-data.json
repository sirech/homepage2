{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/aws-iam-an-overview/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for ThoughtWorks","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"b5c1d0d8-999a-51dd-93ff-3618e08d5e9d","html":"<p>If you use <a href=\"https://aws.amazon.com/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS</a>, you should make sure you have <a href=\"https://www.thoughtworks.com/insights/blog/using-aws-security-first-class-citizen\" target=\"_blank\" rel=\"noopener noreferrer\">the right account structure in place</a>. If you just go ahead and use a root account, you might just lose your <a href=\"https://threatpost.com/hacker-puts-hosting-service-code-spaces-out-of-business/106761/\" target=\"_blank\" rel=\"noopener noreferrer\">whole business</a>.</p>\n<p>Now that I have your attention (and that you are rightfully scared of the bad people out there) I wanted to talk about the tools that <em>AWS</em> offers to manage permissions for its resources, also called <a href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html\" target=\"_blank\" rel=\"noopener noreferrer\">IAM</a>.</p>\n<!--more-->\n<p><em>IAM</em> is extremely powerful, but the sheer amount of things that they throw at you can be scary at first. Just check how big their <a href=\"https://aws.amazon.com/iam/faqs/\" target=\"_blank\" rel=\"noopener noreferrer\">FAQ</a> is. I have been using it extensively in my project to manage access to our resources, but I realized recently that we did not have a very sound understanding of the basic pieces, so I drew all of that on a whiteboard to make it easier to understand.</p>\n<h2>Core principles</h2>\n<p>All our policies are <a href=\"https://en.wikipedia.org/wiki/Infrastructure_as_code\" target=\"_blank\" rel=\"noopener noreferrer\">represented in code</a>. We use <a href=\"https://www.terraform.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform</a> for that. Having the policies represented in code is crucial if you want to maintain them properly over time.</p>\n<p>The roles that we provision should have as <a href=\"https://en.wikipedia.org/wiki/Principle_of_least_privilege\" target=\"_blank\" rel=\"noopener noreferrer\">little rights</a> as possible. The fewer permissions that you grant the better. That protects you against attacks, but also against bugs.</p>\n<h2>Our starting point</h2>\n<p>This picture should give you an idea of where we are:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/a7810e2c061e0ea8256d1c97efed87a4/b4294/iam-basic-components.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 107.4468085106383%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAVABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDAf/EABYBAQEBAAAAAAAAAAAAAAAAAAEAAv/aAAwDAQACEAMQAAAB3qWW3FZBNBl//8QAFxAAAwEAAAAAAAAAAAAAAAAAABARIP/aAAgBAQABBQLVKv/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CH//EABkQAAIDAQAAAAAAAAAAAAAAAAABEBExcf/aAAgBAQABPyEstiyeY6j/2gAMAwEAAgADAAAAELgnwf/EABYRAQEBAAAAAAAAAAAAAAAAABEAEP/aAAgBAwEBPxBnC//EABcRAAMBAAAAAAAAAAAAAAAAAAABERD/2gAIAQIBAT8QhMrP/8QAHBABAAIDAAMAAAAAAAAAAAAAAQARITFRcZGh/9oACAEBAAE/EBaKoxyC3dQ7QFPEC5ZDEOK3MTX2FA0+5//Z'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"IAM Basic components\" title=\"IAM Basic components\" src=\"/static/a7810e2c061e0ea8256d1c97efed87a4/b4294/iam-basic-components.jpg\" srcset=\"/static/a7810e2c061e0ea8256d1c97efed87a4/bc01b/iam-basic-components.jpg 188w,\n/static/a7810e2c061e0ea8256d1c97efed87a4/bf173/iam-basic-components.jpg 375w,\n/static/a7810e2c061e0ea8256d1c97efed87a4/b4294/iam-basic-components.jpg 600w\" sizes=\"(max-width: 600px) 100vw, 600px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<ul>\n<li>We have our infrastructure that we want to operate. There are a ton of services that you might be using from <em>AWS</em>, from places to put data such as <code class=\"language-text\">S3</code> or <code class=\"language-text\">RDS</code>, to something like <code class=\"language-text\">ECS</code> to run your containerized applications, but also everything that surrounds it, like networks, security groups, DNS and whatnot.</li>\n<li>Then there are the actors interacting with the infrastructure. They can be human actors, such as the developers building and operating the platform. They can also be machine actors, like the CI/CD tool that you might use to provision your infrastructure, or the applications that you run themselves.</li>\n<li>These actors will want to perform certain operations. We might want to get data out of our stores, launch services or create new resources.</li>\n<li>And you need authorization to perform those operations. At the end, you will need to log in into <em>AWS</em> and use the credentials, one way or the other.</li>\n</ul>\n<p>At this point you could say fuck it, Iâ€™m just going to pass these credentials around. But there are a ton of things that can go wrong. What happens if those credentials are leaked, for instance? Thankfully, <em>AWS</em> offers a way to deal with this. We will be using <a href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html\" target=\"_blank\" rel=\"noopener noreferrer\">roles</a> to group the permissions that we want to create.</p>\n<h2>Role</h2>\n<p>What is a role? Quoting the official documentation:</p>\n<blockquote>\n<p>An IAM role is an IAM identity that you can create in your account that has specific permissions.</p>\n</blockquote>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/5cfe232cea145a5e6d00c8638100e81f/b4294/iam-role.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEE/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAdBYIP/EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAT8hX//aAAwDAQACAAMAAAAQJP8A/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8QiP/EABkQAQEBAQEBAAAAAAAAAAAAAAERADFREP/aAAgBAQABPxBKsZMDOuOfB91Pd//Z'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"IAM Role\" title=\"IAM Role\" src=\"/static/5cfe232cea145a5e6d00c8638100e81f/b4294/iam-role.jpg\" srcset=\"/static/5cfe232cea145a5e6d00c8638100e81f/bc01b/iam-role.jpg 188w,\n/static/5cfe232cea145a5e6d00c8638100e81f/bf173/iam-role.jpg 375w,\n/static/5cfe232cea145a5e6d00c8638100e81f/b4294/iam-role.jpg 600w\" sizes=\"(max-width: 600px) 100vw, 600px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>This means that we are going to create different roles that will be assumed by some of our actors (<code class=\"language-text\">ci-web</code> for example, or a specific role for each application that we want to deploy). They are defined using <a href=\"https://www.terraform.io/docs/providers/aws/r/iam_role.html\" target=\"_blank\" rel=\"noopener noreferrer\">aws_iam_role</a>. It looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_iam_role\"</span></span> <span class=\"token string\">\"ci-web\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>               <span class=\"token punctuation\">=</span> <span class=\"token string\">\"ci-web\"</span>\n  <span class=\"token property\">assume_role_policy</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">aws_iam_policy_document</span><span class=\"token punctuation\">.</span>assume_role_policy_ec2<span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">}</span></span>\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If this <em>role</em> is going to be assumed, we need to grant permissions for that as well. In this case, we want an <a href=\"https://aws.amazon.com/ec2/\" target=\"_blank\" rel=\"noopener noreferrer\">EC2</a> instance to be able to assume it, as our <em>CI</em> will be running there. We can do that with a <a href=\"https://www.terraform.io/docs/providers/aws/d/iam_policy_document.html\" target=\"_blank\" rel=\"noopener noreferrer\">aws_iam_policy_document</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">data <span class=\"token type variable\">\"aws_iam_policy_document\"</span></span> <span class=\"token string\">\"assume_role_policy_ec2\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">statement</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">effect</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Allow\"</span>\n    <span class=\"token property\">actions</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"sts:AssumeRole\"</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">principals</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Service\"</span>\n      <span class=\"token property\">identifiers</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"ec2.amazonaws.com\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The last part of the puzzle is defining an <a href=\"https://www.terraform.io/docs/providers/aws/r/iam_instance_profile.html\" target=\"_blank\" rel=\"noopener noreferrer\">aws_iam_instance_profile</a>, and using it in the <a href=\"https://www.terraform.io/docs/providers/aws/r/launch_configuration.html\" target=\"_blank\" rel=\"noopener noreferrer\">aws_launch_configuration</a> of said instance.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_iam_instance_profile\"</span></span> <span class=\"token string\">\"ci-web\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>aws_iam_role<span class=\"token punctuation\">.</span>ci-web<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">role</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>aws_iam_role<span class=\"token punctuation\">.</span>ci-web<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span></span>\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_launch_configuration\"</span></span> <span class=\"token string\">\"web\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">iam_instance_profile</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"ci-web\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Defining policies</h2>\n<p>Thus far, we have set up our roles, but those roles are not actually allowed to do anything, yet. We need to create some policies that allow access to the resources we want to use, through <a href=\"https://www.terraform.io/docs/providers/aws/r/iam_policy.html\" target=\"_blank\" rel=\"noopener noreferrer\">aws_iam_policy</a>:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/5503210dd0c47debfcc6e148e0b281c6/b4294/iam-policy.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 123.40425531914893%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAZABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEE/8QAFgEBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAHXJc2gg1II/8QAFhABAQEAAAAAAAAAAAAAAAAAESAA/9oACAEBAAEFAnMN/wD/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAUEAEAAAAAAAAAAAAAAAAAAAAw/9oACAEBAAY/Ak//xAAZEAEAAwEBAAAAAAAAAAAAAAABABARITH/2gAIAQEAAT8h3QNPLEHG9hGv/9oADAMBAAIAAwAAABCoETH/xAAWEQEBAQAAAAAAAAAAAAAAAAARABD/2gAIAQMBAT8QZ3//xAAWEQEBAQAAAAAAAAAAAAAAAAARABD/2gAIAQIBAT8QI3//xAAfEAEAAQMEAwAAAAAAAAAAAAABABExYRAhQYFRkeH/2gAIAQEAAT8QzPuLS0aoB6gK3iSlEDEq+Q6jyw2fNRvP/9k='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"IAM Policy\" title=\"IAM Policy\" src=\"/static/5503210dd0c47debfcc6e148e0b281c6/b4294/iam-policy.jpg\" srcset=\"/static/5503210dd0c47debfcc6e148e0b281c6/bc01b/iam-policy.jpg 188w,\n/static/5503210dd0c47debfcc6e148e0b281c6/bf173/iam-policy.jpg 375w,\n/static/5503210dd0c47debfcc6e148e0b281c6/b4294/iam-policy.jpg 600w\" sizes=\"(max-width: 600px) 100vw, 600px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>I already wrote about how to use these policies to grant <a href=\"../using-asm-in-concourse/\">access to the <em>AWS Secrets Manager</em> from Concourse</a>. In the end, we always follow a similar structure. Each <em>policy</em> contains a of <em>statements</em> that define the access we want to give. Donâ€™t forget to use a <a href=\"https://www.terraform.io/docs/providers/aws/r/iam_role_policy_attachment.html\" target=\"_blank\" rel=\"noopener noreferrer\">aws_iam_role_policy_attachment</a> to bind the policies to the role.</p>\n<h3>Making a statement</h3>\n<p>Statements are quite flexible and have a bunch of configuration options. I am going to focus on three of their arguments, <code class=\"language-text\">effect</code>, <code class=\"language-text\">actions</code> and <code class=\"language-text\">resources</code>.</p>\n<p><code class=\"language-text\">effect</code> can be either <em>Allow</em> or <em>Deny</em>. We actually always set them to <code class=\"language-text\">Allow</code>. Why? As mentioned, we want to give the least possible amount of privileges, so our policies should only be granting what a role absolutely needs. That means there should never be necessary to revoke a particular permission in a different part of the code.</p>\n<p><code class=\"language-text\">actions</code> are what we want to be able to do in <em>AWS</em>. They basically map to single API calls, and they are really granular. What you should really avoid is giving blanket permissions such as:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\">  <span class=\"token keyword\">statement</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">effect</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Allow\"</span>\n\n    <span class=\"token property\">actions</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"ec2:*\"</span>,\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>This not only goes against the principle of least privilege, but it also will create a maintainability mess, as you will have a very hard time afterwards reducing permissions without something breaking. Trust me on this one, invest the time upfront and make sure you only give permissions that are needed. There is an excellent <a href=\"https://iam.cloudonaut.io/\" target=\"_blank\" rel=\"noopener noreferrer\">reference guide</a> that I find extremely useful when giving permissions incrementally.</p>\n<p>Lastly, <code class=\"language-text\">resources</code> are the <a href=\"https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html\" target=\"_blank\" rel=\"noopener noreferrer\">ARNâ€™s</a> that this statement applies to. As with the <code class=\"language-text\">actions</code>, it is a very good idea to avoid using wildcards.</p>\n<p>There are more things you can do, such as using <code class=\"language-text\">principals</code> or <code class=\"language-text\">conditions</code>, which are out of the scope of this article. However, you can get a lot of mileage out of just <code class=\"language-text\">actions</code> and <code class=\"language-text\">resources</code>.</p>\n<h2>Wrapping it up</h2>\n<p>This is it, you donâ€™t really need anything else to build a solid and secure foundation in which to run your applications. Using different roles and giving them the access they need through policies step by step is all there is to it, really.</p>\n<p>Testing this still remains a challenge, as <em>IAM</em> failures tend to manifest only when you actually try to run the whole thing in your environment. Donâ€™t succumb to the temptation to take the easy route, though. Fixing a bad permission setup is hard, and you will regret it.</p>","frontmatter":{"layout":"post","title":"An overview of IAM in AWS","path":"/aws-iam-an-overview/","categories":["AWS","IAM","Terraform","Security"],"date":"2019/03/09","draft":false,"description":"IAM in AWS can be scary. I wrote a small guide to understand the basic concepts so that you can get started with it","canonical":null,"image":null}},"related":{"nodes":[]},"previous":{"frontmatter":{"title":"Testing containers with dependencies with localstack","path":"/testing-containers-serverspec-and-localstack/","date":"2019/01/21"}},"next":{"frontmatter":{"title":"Making Concourse's fly tool work behind an authenticated ALB","path":"/concourse-fly-behind-alb-oidc/","date":"2019/04/13"}}},"pageContext":{"related":[],"previous":"/testing-containers-serverspec-and-localstack/","next":"/concourse-fly-behind-alb-oidc/"}},
    "staticQueryHashes": []}