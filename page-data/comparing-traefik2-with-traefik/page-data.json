{"componentChunkName":"component---src-templates-blog-post-js","path":"/comparing-traefik2-with-traefik/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for Meta","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"ff6c3221-9b5d-5c8c-8058-019c0c58acba","html":"<figure class=\"figure figure--left\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/403a439d1e6839e167e9e5a3f54044d0/0a47e/traefik2.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAD/UlEQVR42o2Ua1CUVRjH/7vgDSgmHcFAGNAwcWFZ3nfffVkusa5JiHITiItcFsgaJIYamO5FOgyCIggFFrfYgCVZCKVgAQ1nDGg3WnAJk8y8oBJDGB8cPywte5rdhvoQu/mfeWbOOfN/fuec55lzACtiGOY/IRQKzfHYkkqlCJZIzGHv5QXKywOmdMYW8PPeAThtQUBwCMSBgZBIJNZhx52dkenhgWQeD4iJxd6wcNuMuGiHBDfHda/zXNYfit7/BPPsLhtERELk6wu/rVutA0udnJC0fTtSdu4E9kWs4/vx+QBcXUPDvTm0hAf7p3YwgWI+ARDs4gKRuztOOjpaBhYCWH9rjAOVBklhYRW5kZHTFRe1Z6MGp6bztTM/NbR296SHvfBrulSaLTqYhhcPJ3M3WoJNzmSirOgg52RpNADCSduz+/ZXp8qJSeOzf5Cf780R8ucSOf1SNkl6XtqVKgsBEIW2pnhz7qrAX+Zl6BvJsSMkeUNIxMu5758fJWOPiP781x3LAwPdBtWi0XCktnPZxyNUSEipff9Ilt2PMzLoVgfKMHFThv4fcp68/zBl35nuDzOy2j8n/q1DhqLhK8b3vtUZmZZB8soXn+nHLmT5XpuXxV2+krVh4pYMk3csnFAznc5VLL6NngeFghuNVMvDqm3kdo1w+eOmQmNDY57xbo2APKry0OtagsvP3cn1OXszF6NX07i6GdnqdQzy8VsZ2pQURPUs1PCIvmKT8Xq1wDhT5W3UV25e/q16FzmWf6CekE9AiAqAm+Uu68d7oRv41FY30IipwaZjdy/Xkd+Hypa0A5XGqYFy4/zQiSXT2vSllje/667FyJfVtoQQy8D7NzSYUzfbzKrlmNUqix9omolhQrHUO6wyfjPaZzRMKPQLGjmZ0yo/WNAqsDiusJlQ91sGJoa4Q9beyo1rVyKhWU692lq3dFxRSWKUg4Y4pcpQ3FZJXmupvVdWk7fpnYajONpYxLH6UhghBdlHDeg6nmeeZ6uGtT7KcUJ1qImg43tCnZs0FFxSn0mrr0N0Uxv3lLXrmkTTNIA15qacKDjkRq7Xhx9o72PEXZpUkfxCcsyRnHhNXX5CZmqsQ0l+Et46HGv95zEBGaEQIkb4NF9ApQN2Poz8Ip/tvRoheqPkOT9P9xRnT+/9FEVlsIzQVsyKQFGUdaDJ4C9i7WiBIDFob9hutncqke3UvMtUKgJonncQKw6Ip2k6i6IoB5P371tZkMlgNoVKTca19DOeHLZHt4bt1KxlCos51JaNHKd/N+au+B9L5iS+L1jVNbBKNUSn20G5bgYtDsLKyVbif0E0Kwbl7w86KARs7xTYTg2Ycjkor22gGdE/pVkN9hcvEa2WDvPlDgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Directing traefik\" title=\"\" src=\"/static/403a439d1e6839e167e9e5a3f54044d0/0a47e/traefik2.png\" srcset=\"/static/403a439d1e6839e167e9e5a3f54044d0/4dcb9/traefik2.png 188w,\n/static/403a439d1e6839e167e9e5a3f54044d0/5ff7e/traefik2.png 375w,\n/static/403a439d1e6839e167e9e5a3f54044d0/0a47e/traefik2.png 600w\" sizes=\"(max-width: 600px) 100vw, 600px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>One year ago I experimented with <a href=\"https://traefik.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Traefik</a> and wrote <a href=\"../setting-up-traefik/\">about the experience</a>. We ended up using it as a reverse proxy in my project at the time. It was remarkably unremarkable, in that it didn’t give us much trouble. That is a good thing! I kind of forgot about it, other than the occasional update.</p>\n<p>Anyways, in my current project, we need a reverse proxy with automatic discovery again. Thus, <em>Traefik</em> is back on the menu. Version 2 has been released since I last touched it. It brings quite a few changes. I decided to adapt my sample setup and compare both.</p>\n<p>I took the old repository and made a <a href=\"https://github.com/sirech/traefik2-test\" target=\"_blank\" rel=\"noopener noreferrer\">new one using version 2</a>. Let’s see how things have changed.</p>\n<!--more-->\n<h2>Plumbing</h2>\n<h3>TOML vs YAML</h3>\n<p>Right of the bat, <a href=\"https://github.com/toml-lang/toml\" target=\"_blank\" rel=\"noopener noreferrer\">TOML</a> is no longer the only supported configuration mechanism. <a href=\"https://yaml.org/\" target=\"_blank\" rel=\"noopener noreferrer\">YAML</a> support has been added. I don’t have a strong opinion on the matter, though <em>YAML</em> seems to be more of a standard these days.</p>\n<h3>New concepts</h3>\n<p>Core notions have <a href=\"https://docs.traefik.io/migration/v1-to-v2/\" target=\"_blank\" rel=\"noopener noreferrer\">changed significantly</a>. Before, we had <em>entrypoint</em>, <em>frontend</em> and <em>backend</em>. Now we’ve got <em>entrypoint</em>, <em>router</em>, and <em>service</em>. Modifications of the request happen through <em>middleware</em>.</p>\n<p>In terms of functionality, not a lot has changed. The format is not compatible, so you’ll have to migrate quite a few things.</p>\n<p>The configuration for entrypoints and providers goes in a static configuration file. The rest is dynamic, which can be extra YAML/TOML files, or directly as labels for the containers.</p>\n<h2>Service Discovery and Load Balancing</h2>\n<p>Mostly works the same. Support for ECS is gone, <a href=\"https://github.com/containous/traefik/issues/4674\" target=\"_blank\" rel=\"noopener noreferrer\">pending to be re-added</a>.</p>\n<p>As for load balancing, I had an example with two separate services in <em>docker-compose</em> <a href=\"https://github.com/sirech/traefik-test/blob/master/docker-compose.app1.yml\" target=\"_blank\" rel=\"noopener noreferrer\">running the same container in version 1</a>. It was solved by using the same backend. Now you’ll want to define the same service for both, which couldn’t be done directly, as far as I could tell. I went around this by defining a healthcheck:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.http.services.web.loadBalancer.healthCheck.path=/\"</span></code></pre></div>\n<p><a href=\"https://github.com/sirech/traefik2-test/blob/master/docker-compose.app1.yml\" target=\"_blank\" rel=\"noopener noreferrer\">Feels a bit hacky</a>, but production services will have a healthcheck anyways, so it’s not too bad.</p>\n<h2>Routing</h2>\n<p>Routing goes from <em>frontend</em> to <em>routers</em>. The syntax is slightly different. Other than that it remains unchanged.</p>\n<h2>TLS</h2>\n<p>Setting TLS was a lot harder than expected. In the past, you would <a href=\"https://github.com/sirech/traefik-test/blob/master/traefik/traefik.toml#L17-L22\" target=\"_blank\" rel=\"noopener noreferrer\">associate your certificates with the entrypoint</a>. That would work automatically for a frontend using the entrypoint.</p>\n<p>Now the certificates are defined as part of a store, which can look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">stores</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">default</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">defaultCertificate</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">certFile</span><span class=\"token punctuation\">:</span> /certs/cert.crt\n        <span class=\"token key atrule\">keyFile</span><span class=\"token punctuation\">:</span> /certs/cert.key</code></pre></div>\n<p>Then, we activate <code class=\"language-text\">tls</code> for a route with labels (full compose file <a href=\"https://github.com/sirech/traefik2-test/blob/master/docker-compose.app2.yml\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.http.routers.web-secure.entrypoints=https\"</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.http.routers.web-secure.tls=true\"</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.http.routers.web-secure.rule=Host(`echo.testing.com`) &amp;&amp; Path(`/standard`)\"</span></code></pre></div>\n<p>In theory, you can use multiple stores, but I only managed to get my certificate delivered by making it the default one.</p>\n<p>I found the whole thing quite confusing. I was getting errors about self-signed certificates in the logs all the time. I was thinking that self-signed certificates were not supported. But then they did. Confusing logs have been a theme during this whole ordeal.</p>\n<h2>Mutual TLS</h2>\n<p>This was a hard requirement I had when I first tried <em>Traefik</em>. To get <em>mTLS</em>, you have to add a configuration block that is applied to the <em>TLS</em> connection:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">options</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enforceClientCert</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">clientAuth</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">caFiles</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> /certs/client.crt\n        <span class=\"token key atrule\">clientAuthType</span><span class=\"token punctuation\">:</span> RequireAndVerifyClientCert</code></pre></div>\n<p>I think this has to be a dynamic configuration, although I’m not sure. Then it’s a matter of activating that configuration for your router (full compose file <a href=\"https://github.com/sirech/traefik2-test/blob/master/docker-compose.app3.yml#L4-L12\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.http.routers.web-secure-mtls.entrypoints=mTLS\"</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token string\">\"traefik.http.routers.web-secure-mtls.tls.options=enforceClientCert@file\"</span></code></pre></div>\n<p>Somehow my https router from the previous example stopped working without client certificates. I only managed to separate them by using two entrypoints running two different ports, much like in old <em>Traefik</em>. My understanding from the documentation is that this shouldn’t be the case, but I couldn’t make it work otherwise.</p>\n<h2>Middleware</h2>\n<p>The biggest change I’ve seen so far is that <em>Traefik</em> supports manipulating requests before sending them to a service and before returning them to the caller. It is called <a href=\"https://docs.traefik.io/middlewares/overview/\" target=\"_blank\" rel=\"noopener noreferrer\">middleware</a>.</p>\n<p>Operations on the path of the request, like stripping parts or adding a prefix, are now expressed as middleware. Authentication has become middleware as well. I thought for a second this was new functionality. It turns out you could do most of it before, although it is a lot more consistent and organized now.</p>\n<p>I like the idea. It is potentially pretty powerful, especially if custom middleware becomes a thing.</p>\n<h2>The dashboard</h2>\n<p>The dashboard has gotten quite a facelift. This is how it looks like now:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/def444d13de58dcb32d0cd4fff68d0b5/74d4a/dashboard.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.85106382978723%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACP0lEQVR42nWRO08UURiG5694wUQFjSGx0EqRxlgZf4GX0oSGwoRYSam1hYW/wBBqgoVxdwmXZWGEBbJhFxeWxZ1hZufMucztMXOwwNtJ3pzv/r3nPc6tO08Yv/uYm7cfMTr+kCs3JhkZe2Bx8dp9Lly991+U+bL+8ugEI2OTXLo+gdM56LLfPqB3fIJ3GjLwAgvPDxn45R3YuHfO9s/hT985DUKGkSCOJUoZsiynKEBKTZYXpGmGVBqTpOQFKG0QsSQS/4ajtcZ1N/F9nzwv6HTauK5rB3U6HbrdLuXp9/vU19Yo60WsCEJBOPwbjpSSWq1mG5IkZWNjg5WVVYxJrN1s7ljW7c6BrYuEsAzL5vJlwyj+DU6p31DIX1sjtElJ0sw2mCRDmsTGY6lJ0pxIxGfDhCSMzuzgPMPDox4qGJKZBKU0UioioaweQRCSxwqtDVpphFCIWFsmUTAksUQkptRVaptzQt9nftulG0dWK2FSYpWRmoTvxz0+NV1MnpMUEKuUWGdkSlPdaTL3rUGWpKi8QKoMpVOcj3tbTNUrTK1W+Nxt0jpqo+XZ1teby0yv15hpLNHo7dI7OaYwCftBwMu1r0yvL/F+r8H24S5hENgPc2ZWK7zbqvOiXqVRXUS1dhHaEEaCp9VFPrS2eV5ZQC1/wR8MKLRhpd/jWXWRt7sus5UFqC/hC4GMYxxPCN40lpk/bEM/RHkhOkvJdcKm94NXa1W2vQF0PauxMobcpMx1Wsy6q0RhRNodYLLM5n8C/ZkIjVyZZxEAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Traefik's Dashboard Revisited\" title=\"\" src=\"/static/def444d13de58dcb32d0cd4fff68d0b5/1d69c/dashboard.png\" srcset=\"/static/def444d13de58dcb32d0cd4fff68d0b5/4dcb9/dashboard.png 188w,\n/static/def444d13de58dcb32d0cd4fff68d0b5/5ff7e/dashboard.png 375w,\n/static/def444d13de58dcb32d0cd4fff68d0b5/1d69c/dashboard.png 750w,\n/static/def444d13de58dcb32d0cd4fff68d0b5/78797/dashboard.png 1125w,\n/static/def444d13de58dcb32d0cd4fff68d0b5/aa440/dashboard.png 1500w,\n/static/def444d13de58dcb32d0cd4fff68d0b5/74d4a/dashboard.png 2422w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>Fancy! I found the dashboard really useful in the beginning, although I didn’t check it as much once <em>Traefik</em> was up and running. Setting basic auth for it <a href=\"https://github.com/sirech/traefik2-test/blob/master/docker-compose.base.yml#L18-L22\" target=\"_blank\" rel=\"noopener noreferrer\">was surprisingly tricky</a>.</p>\n<h2>Conclusion</h2>\n<p>It is a mixed bag for me, to be honest. I’m not sure if I just got used to the old stuff, but I’ve struggled to wrap my head around how things work now. Where does the config go? In a dynamic file? In labels? Who knows. The debug output could be a lot more helpful with that.</p>\n<p>Maybe doing a direct translation of an existing setup is not the way to go? From my short experience, you have to dig deep into the documentation and assume that what you knew before no longer applies.</p>\n<p>My favorite new part is middleware. For the rest, it feels a bit of a lateral move.</p>","frontmatter":{"layout":"post","title":"Comparing Traefik2 with Traefik","path":"/comparing-traefik2-with-traefik/","categories":["Traefik","DevOps","Load Balancing","SSL Termination","mTLS","Smart Routing"],"date":"2019/12/15","draft":false,"description":"Traefik2 is a significant change from Traefik. How do the both compare? I have ported an old setup to the new format","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/403a439d1e6839e167e9e5a3f54044d0/c7240/traefik2.png","srcSet":"/static/403a439d1e6839e167e9e5a3f54044d0/de3a1/traefik2.png 150w,\n/static/403a439d1e6839e167e9e5a3f54044d0/30cdc/traefik2.png 300w,\n/static/403a439d1e6839e167e9e5a3f54044d0/c7240/traefik2.png 600w","sizes":"(min-width: 600px) 600px, 100vw"},"sources":[{"srcSet":"/static/403a439d1e6839e167e9e5a3f54044d0/c65bc/traefik2.webp 150w,\n/static/403a439d1e6839e167e9e5a3f54044d0/078c3/traefik2.webp 300w,\n/static/403a439d1e6839e167e9e5a3f54044d0/6d09e/traefik2.webp 600w","type":"image/webp","sizes":"(min-width: 600px) 600px, 100vw"}]},"width":750,"height":750}}}}},"related":{"nodes":[{"frontmatter":{"title":"Testing containers with dependencies with localstack","path":"/testing-containers-serverspec-and-localstack/","date":"2019/01/21"}},{"frontmatter":{"title":"Understanding VPC endpoints","path":"/understanding-vpc-endpoints/","date":"2020/08/20"}},{"frontmatter":{"title":"Provisioning an Application Load Balancer with Terraform","path":"/provisioning-an-application-load-balancer-with-terraform/","date":"2021/01/02"}}]},"previous":{"frontmatter":{"title":"Fail a test in Jest if an unexpected network request happens","path":"/jest-fail-test-if-unexpected-network-request-happens/","date":"2019/12/08"}},"next":{"frontmatter":{"title":"Either Types as an alternative to throwing exceptions in Kotlin","path":"/kotlin-either-types-instead-of-exceptions/","date":"2020/01/09"}}},"pageContext":{"related":["/provisioning-an-application-load-balancer-with-terraform/","/understanding-vpc-endpoints/","/testing-containers-serverspec-and-localstack/"],"previous":"/jest-fail-test-if-unexpected-network-request-happens/","next":"/kotlin-either-types-instead-of-exceptions/"}},"staticQueryHashes":[],"slicesMap":{}}