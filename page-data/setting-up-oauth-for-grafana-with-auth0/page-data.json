{"componentChunkName":"component---src-templates-blog-post-js","path":"/setting-up-oauth-for-grafana-with-auth0/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for Meta","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"f29746fb-f3e5-50b7-ad34-8f6ec1e12c3d","html":"<figure class=\"figure figure--left\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 633px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/a9230025dba16af901f0de8912fdc6e9/bce72/dashboard.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 67.5531914893617%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAADPElEQVR42h2TS28cRRSFe/pR1dXv50xPj2fGmfHg8TuJY4fYTmI7iYVtHJwEFmyRkNfAD2DPLhJrloCQ2GSFBOIHZMFf+rgzi6suVanPPefcc6212YyqrbGNSzGoOHp6zGg+4tGTQ06eP+P09IzzFy85v7jgxdU1r25uuHj9BZe3b7h685brt+/4/N1XfPb6lm++vcPa3t2lPx4xnq0x29igWOmzsbfH6vo6Thhg2Z1ldUKfTp5hJTFWJPe+xgrkawKcOCYdDSlXBlh5ryEbDAgHY5ysxEtz/DhChRGuAObdmjDPydqGslvRbu/Q3dohGt/D7/bw8gLT6zEQpZPdHWk43cWaHbA2X+fX335nMp9jWRZaQN0oJEgStJQt7PSXX6PbFnvRsNdF9xuUgDpVRdy0DDc3sOLDa5zLO+6tNPzw3fdMp1PCJKWoa5KiWJYvgJ4wVX/+hX99g+/ZIjsUoBKn7mILYD4csbK5iRUeXFH8+AEjUhfMXOXhLPzRHpbnLsF0GOKOVzEf/iX75Q/KQUu2sEOAqqZP2W8p2gHN2kQabZ1QvP+Pzt17vL3n2L2hmF/hLCrNMOKfI8Dh0Qnp3x/x//mI89PPeA8e4fQHS3Z+WVIIW9cYGWBSoGcPcXefkR5fkj84pt5+SDT5RGT28eKEjlZy7uJ9ekT09JT85pbw7BXp4yfoyRS7qGSIYoHviypB9QMfLb54HUuqg+vYKGEViaykyJbTzpoa13Ww5S3SDpHvEhiFo1xMFhPWBbZSWO5wA1U1OAI8KIfM+3Ns7bM5W+f88RFlWRGInIPbSxKJjkpC9s/uM95aFfYh7f6cenNC0q9w/YVkZVBSWgcyEIMbJBLagChKieOMOMkklzFBU+FJqB2Zrp9GSwKWp9B5ip8lwlD8TiIZrJYHE9MRIBUVAhZK50KYyNmERHGKJ5LdTHIpE1cSI5WmWI4rmxSRDBvSYU9sMcvMWo4A+LI+JkzIZVO6UnVeExeSOxnIgqGSIJtuTjnuko3kbdQnHPYJehWp7L8lFu0f3qethIQtnQKt8ZWmY9vYrktHypc7I7KU7Ku7KPHLljsVGzwZhm3knARylszKf3mvRhvD/7kNaImHaZhAAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Dashboard\" title=\"\" src=\"/static/a9230025dba16af901f0de8912fdc6e9/bce72/dashboard.png\" srcset=\"/static/a9230025dba16af901f0de8912fdc6e9/4dcb9/dashboard.png 188w,\n/static/a9230025dba16af901f0de8912fdc6e9/5ff7e/dashboard.png 375w,\n/static/a9230025dba16af901f0de8912fdc6e9/bce72/dashboard.png 633w\" sizes=\"(max-width: 633px) 100vw, 633px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>If I say <em>monitoring</em>, the first thing that comes to mind is <a href=\"https://prometheus.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Prometheus</a>. And its trusty sidekick, <a href=\"https://grafana.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Grafana</a>. Is it software engineering if you’re not continuously checking some dashboards? However, we don’t want to expose those dashboards on the public internet. That would be bad! In this post, I’m showing how to set up authentication for Grafana. I’m using <a href=\"https://auth0.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Auth0</a> as an identity provider.</p>\n<p>I wrote some time ago about <a href=\"../setting-up-auth0-with-terraform/\">setting up Auth0 with Terraform</a>. Auth0 is an excellent product and a convenient way to set up authentication and authorization without handling the gory details. OAuth is the last thing you want to implement yourself.</p>\n<p>I hadn’t checked my Auth0 account in a while, and honestly, I had forgotten many of the details. That’s one of the huge benefits of having the whole thing set up with <a href=\"https://www.terraform.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform</a>. It is a lot easier to jump back, check the code, and understand what you need to add extra functionality. I don’t think the same can be said if you use the UI directly.</p>\n<h2>The flow</h2>\n<p>I’m going to configure Grafana to allow login through Auth0. I’m too lazy to handle user management, so in fact, I’m going to use Google users.</p>\n<p>My Grafana instance is available under a domain such as <a href=\"https://grafana.mydomain.com\" target=\"_blank\" rel=\"noopener noreferrer\">https://grafana.mydomain.com</a>. Technically, it sits behind an nginx acting as a reverse proxy. But that’s not relevant for our purposes.</p>\n<h2>Client and connection</h2>\n<p>As mentioned, I’m leveraging Google accounts through the <code class=\"language-text\">auth0_connection</code> resource. Additionally, I’m defining a new client (<code class=\"language-text\">auth0_client</code>) pointing to Grafana. The application type I need is a <a href=\"https://auth0.com/docs/applications\" target=\"_blank\" rel=\"noopener noreferrer\">regular web application</a>.</p>\n<!-- auth0-client -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"auth0_client\"</span></span> <span class=\"token string\">\"grafana-frontend\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"grafana\"</span>\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Grafana - Terraform generated\"</span>\n  <span class=\"token property\">app_type</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"regular_web\"</span>\n  <span class=\"token property\">callbacks</span>   <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"https://<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">local</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">grafana_host</span><span class=\"token punctuation\">}</span></span>/login/generic_oauth\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token property\">web_origins</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"https://<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">local</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">grafana_host</span><span class=\"token punctuation\">}</span></span>\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"auth0_connection\"</span></span> <span class=\"token string\">\"google\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"google\"</span>\n  <span class=\"token property\">strategy</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"google-oauth2\"</span>\n\n  <span class=\"token property\">enabled_clients</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>\n    auth0_client.grafana-frontend.id\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">output<span class=\"token type variable\"> \"grafana-client-id\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> auth0_client.grafana-frontend.client_id\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">output<span class=\"token type variable\"> \"grafana-client-secret\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> auth0_client.grafana-frontend.client_secret\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Provisioning this client generates a <code class=\"language-text\">client_id</code> and <code class=\"language-text\">client_secret</code> that I’ll pass to Grafana. We don’t have a custom backend, so there is no need to set up an <a href=\"https://auth0.com/docs/authorization/apis\" target=\"_blank\" rel=\"noopener noreferrer\">API</a> on Auth0’s side.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/49462f34d991892ca122138e45663f71/41870/client-output.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 13.829787234042554%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAkklEQVR42jXGWw6CMBRFUWaFtFB6gdLbBy1QQVFi44eJcf4DECTunJysxPjG9o2yte0F6lrquhuEkJWy0CreyBINlxoYK9iv4kC5XyIk7N5iJVQc+E4Anv9LU5KdKMkoITklOSGUHshoMl5xWnW423Exc3TxM6yv7vF22y7RLE8bbtr4dpiVn5QL6M/oRnTbB/wCGQExtDTKUMcAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Client Settings\" title=\"\" src=\"/static/49462f34d991892ca122138e45663f71/1d69c/client-output.png\" srcset=\"/static/49462f34d991892ca122138e45663f71/4dcb9/client-output.png 188w,\n/static/49462f34d991892ca122138e45663f71/5ff7e/client-output.png 375w,\n/static/49462f34d991892ca122138e45663f71/1d69c/client-output.png 750w,\n/static/49462f34d991892ca122138e45663f71/78797/client-output.png 1125w,\n/static/49462f34d991892ca122138e45663f71/aa440/client-output.png 1500w,\n/static/49462f34d991892ca122138e45663f71/41870/client-output.png 1788w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <figcaption class=\"figure__caption\">\n  Let's not go through the trouble of setting up OAuth to then print the client secret\n  </figcaption>\n</figure>\n<h2>Configuring Grafana</h2>\n<p>We’re connecting the client with Grafana using what’s called <a href=\"https://grafana.com/docs/grafana/latest/auth/generic-oauth/\" target=\"_blank\" rel=\"noopener noreferrer\">generic OAuth authentication</a>. There are a few endpoints based on the domain, plus the <code class=\"language-text\">client_id</code> and the <code class=\"language-text\">client_secret</code> that I got before.</p>\n<!-- grafana-config -->\n<div class=\"gatsby-highlight\" data-language=\"toml\"><pre class=\"language-toml\"><code class=\"language-toml\"><span class=\"token punctuation\">[</span><span class=\"token table class-name\">server</span><span class=\"token punctuation\">]</span>\n<span class=\"token key property\">domain</span> <span class=\"token punctuation\">=</span> grafana<span class=\"token punctuation\">.</span>$__env<span class=\"token punctuation\">{</span>HOST<span class=\"token punctuation\">}</span>\n<span class=\"token key property\">root_url</span> <span class=\"token punctuation\">=</span> https://grafana<span class=\"token punctuation\">.</span>$__env<span class=\"token punctuation\">{</span>HOST<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token table class-name\">auth</span><span class=\"token punctuation\">]</span>\n<span class=\"token key property\">disable_login_form</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token table class-name\">auth.generic_oauth</span><span class=\"token punctuation\">]</span>\n<span class=\"token key property\">enabled</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token key property\">allow_sign_up</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token key property\">team_ids</span> <span class=\"token punctuation\">=</span>\n<span class=\"token key property\">allowed_organizations</span> <span class=\"token punctuation\">=</span>\n<span class=\"token key property\">name</span> <span class=\"token punctuation\">=</span> Auth0\n<span class=\"token key property\">client_id</span> <span class=\"token punctuation\">=</span> $__env<span class=\"token punctuation\">{</span>GRAFANA_CLIENT_ID<span class=\"token punctuation\">}</span>\n<span class=\"token key property\">client_secret</span> <span class=\"token punctuation\">=</span> $__env<span class=\"token punctuation\">{</span>GRAFANA_CLIENT_SECRET<span class=\"token punctuation\">}</span>\n<span class=\"token key property\">scopes</span> <span class=\"token punctuation\">=</span> openid profile email\n<span class=\"token key property\">auth_url</span> <span class=\"token punctuation\">=</span> $__env<span class=\"token punctuation\">{</span>AUTH0_HOST<span class=\"token punctuation\">}</span>/authorize\n<span class=\"token key property\">token_url</span> <span class=\"token punctuation\">=</span> $__env<span class=\"token punctuation\">{</span>AUTH0_HOST<span class=\"token punctuation\">}</span>/oauth/token\n<span class=\"token key property\">api_url</span> <span class=\"token punctuation\">=</span> $__env<span class=\"token punctuation\">{</span>AUTH0_HOST<span class=\"token punctuation\">}</span>/userinfo</code></pre></div>\n<p>I <strong>definitely</strong> don’t want to store the credentials in the code. Luckily, we can use <a href=\"https://grafana.com/docs/grafana/latest/administration/configuration/#env-provider\" target=\"_blank\" rel=\"noopener noreferrer\">variable expansion</a> to inject those values from the outside. That spares us from templating the configuration. Nicely done, Grafana. Let’s orchestrate it with <code class=\"language-text\">docker-compose</code>:</p>\n<!-- grafana-docker-compose -->\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">grafana</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> grafana\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> grafana/grafana\n\n  <span class=\"token key atrule\">env_file</span><span class=\"token punctuation\">:</span> .env\n\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"./prometheus/grafana/dashboards:/etc/grafana/provisioning/dashboards\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"./prometheus/grafana/datasources:/etc/grafana/provisioning/datasources\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"./prometheus/grafana/grafana.ini:/etc/grafana/grafana.ini\"</span>\n\n  <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> web\n    <span class=\"token punctuation\">-</span> backend</code></pre></div>\n<p>Keep in mind that Grafana needs internet access to communicate directly with Auth0 and fetch the access token.</p>\n<p>After all this work, Grafana rewards us with a welcoming screen.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 570px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/19024db7e887aaf89d9b80e7f2c6722b/432e7/grafana-login.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACFUlEQVR42p2Ty27TQBSGI0pViHNrEUmcxHFcx6FxEtvjW9xcSYuhaSWkUIGKhCgbWLBhxxMgHoENW97z58w4NClIbeji09gzc/5z5j8zqUzNxW3sVF3cr9y+T6r5SN20IUs8JDpNhmnboQBXcCfBnOLinuzixLTx87iLb5MeYtPBdiVJdCfBVNHD94WJz7Me5szBx6MetilJVvkPQanKCB7EsFVyMR/38Ourjh9fdLyJO9gq8grZZoJcqKAG2NVCFBqB+JaUEG5g40VsIaeGtNYX6znF+6fSa4JZ2vBAttFkz7B4+wln5x8wnV8gfvkO7uQc/uwCo+evcfrqEieL95gvLqF0piKGx97oYa7uQTEnQnzfPoLuHBMzNKwZDBZDPhiJ6nNLoY2awrPmVZ/EfRGYry+/Cb7Gvd64y9zLpDls7U56V75lxeiJ67N+hSTlL8E8HXVPC/C4GaFoRMjWA/LIQZrunlRhNDJqVohya4gSIbdGeKRFFMePzysPEkHxImQGtd3HYExe6W1ohgmjbSMcPIXrD+FHY4SHUxgHFrSmiX2ji2ari6LGyJoQe2qfkh2uKuTZK60IXX+KcqMLWbNQ1R202QSGNUDLHuIJUdVtscapELt1bktiR0G9EmQ0QUciz3bKlniv6aqb/JdsmluRzP/BE2IZcdH5W/eQSlNnMnR+aZ3aigz5ss61NSK9hItJSoTfzzGokx9LMLIAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Grafana Login\" title=\"\" src=\"/static/19024db7e887aaf89d9b80e7f2c6722b/432e7/grafana-login.png\" srcset=\"/static/19024db7e887aaf89d9b80e7f2c6722b/4dcb9/grafana-login.png 188w,\n/static/19024db7e887aaf89d9b80e7f2c6722b/5ff7e/grafana-login.png 375w,\n/static/19024db7e887aaf89d9b80e7f2c6722b/432e7/grafana-login.png 570w\" sizes=\"(max-width: 570px) 100vw, 570px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <figcaption class=\"figure__caption\">\n  Don't tell me whether I can get in the way of the data or not!\n  </figcaption>\n</figure>\n<h2>An unforeseen problem</h2>\n<figure class=\"figure figure--right\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 437px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/bba3524fa8aa74da236fca4e4af324ed/fca8a/koala.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 151.06382978723406%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAeABQDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAECBAUD/8QAFwEAAwEAAAAAAAAAAAAAAAAAAQIDAP/aAAwDAQACEAMQAAABqPOtq0iIwq7GYhu4ydP/xAAcEAACAgIDAAAAAAAAAAAAAAABAgADEhMRIzH/2gAIAQEAAQUCFghAeYWCexFdKy5E5xZe6vSWLAa0fEFkE//EABgRAAIDAAAAAAAAAAAAAAAAAAABAhAR/9oACAEDAQE/AaizEf/EABcRAAMBAAAAAAAAAAAAAAAAAAABERD/2gAIAQIBAT8BmMrP/8QAHhAAAgIBBQEAAAAAAAAAAAAAAAERITECECJCcZH/2gAIAQEABj8C24uvShsVkomlGRuTQxp4O30//8QAGhABAQEAAwEAAAAAAAAAAAAAAREAITFRYf/aAAgBAQABPyHQ2y6xJ+MBUCvzdA/D7uWAUqYQdg3TGBXpuYy70g7nOMg1zxmCnW8Z/9oADAMBAAIAAwAAABDEwQz/xAAYEQADAQEAAAAAAAAAAAAAAAAAASERUf/aAAgBAwEBPxBPYMpDuj//xAAYEQEBAQEBAAAAAAAAAAAAAAABABEhQf/aAAgBAgEBPxBx2EyOnY8W/8QAIBABAAMBAAEEAwAAAAAAAAAAAQARITFBUWFxgZHB8P/aAAgBAQABPxBxlJAZfgJF+bbMKhxg4C1iSKtWOg3nxDKF0HH8xoKrH3GPDGB/heTvwQW9rIYBLj0O2fuOGqa02X5+4OMXgVs//9k='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Koala\" title=\"\" src=\"/static/bba3524fa8aa74da236fca4e4af324ed/fca8a/koala.jpg\" srcset=\"/static/bba3524fa8aa74da236fca4e4af324ed/bc01b/koala.jpg 188w,\n/static/bba3524fa8aa74da236fca4e4af324ed/bf173/koala.jpg 375w,\n/static/bba3524fa8aa74da236fca4e4af324ed/fca8a/koala.jpg 437w\" sizes=\"(max-width: 437px) 100vw, 437px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <figcaption class=\"figure__caption\">\n  Did somebody say dashboards?\n  </figcaption>\n</figure>\n<p>Looking good! No unauthorized user will access our dashboards. Right? Well, turns out, anybody with a Google account can log in. No as secure as I had hoped.</p>\n<p>In my previous article, I added a custom <a href=\"https://auth0.com/docs/scopes\" target=\"_blank\" rel=\"noopener noreferrer\">scope</a> to the JWT and verified it on the backend side. Grafana offers no such functionality, sadly. It’s a known issue, and it doesn’t look like it’s going to be fixed <a href=\"https://github.com/grafana/grafana/issues/6809\" target=\"_blank\" rel=\"noopener noreferrer\">anytime soon</a>.</p>\n<p>You can specify an expected organization or team id, but that’s not standard OAuth. It seems like it’s a straight copy-paste based on Github’s interpretation of OAuth. The documentation for those two parameters is pretty awful, by the way. I spent a lot of time reading the source code until I understood that you need some endpoints that Auth0 doesn’t implement.</p>\n<p>Anyways, there is an alternative. Instead, we’re going to use a <a href=\"https://auth0.com/docs/rules\" target=\"_blank\" rel=\"noopener noreferrer\">rule</a> that checks if the user has a specific role. We’ll drop the requests done by users without the role, never sending them to Grafana. Rule and role are defined like this:</p>\n<!-- provision-rule -->\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"auth0_role\"</span></span> <span class=\"token string\">\"grafana-user\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Grafana - User\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"auth0_rule\"</span></span> <span class=\"token string\">\"grafana-drop-unauthorized\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"grafana-drop-unauthorized\"</span>\n  <span class=\"token property\">script</span> <span class=\"token punctuation\">=</span> templatefile(<span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">path</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">module</span><span class=\"token punctuation\">}</span></span>/drop-unauthorized-grafana.js\"</span>, <span class=\"token punctuation\">{</span>\n    application : auth0_client.grafana-frontend.name,\n    role : auth0_role.grafana-user.name\n  <span class=\"token punctuation\">}</span>)\n\n  <span class=\"token property\">enabled</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The rule is implemented in JavaScript. The file is templated, so the values for <code class=\"language-text\">application</code> and <code class=\"language-text\">role</code> are interpolated and won’t be present in the final file that is uploaded to Auth0.</p>\n<!-- rule-definition -->\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">dropUnauthorizedGrafana</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>clientName <span class=\"token operator\">!==</span> <span class=\"token string\">\"${application}\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> auth <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>authorization <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> roles <span class=\"token operator\">=</span> auth<span class=\"token punctuation\">.</span>roles <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>roles<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${role}\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Access denied'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Rules run for <em>every</em> application, so make sure you only process the correct application.</p>\n<h2>Summary</h2>\n<p>The temptation to do some half-assed measure to protect internal tools like Grafana is always there. Many of these tools end up behind a VPN or (God forbid) using something like Basic Auth. Thanks to providers like Auth0, the right thing is easier than ever. With infrastructure as code, you can ensure that the installation is repeatable. Moreover, you’ll be able to come back and still understand it.</p>\n<p><em>EDIT 25/01/2021:</em> Corrected mixed usage of API and Application for Auth0</p>","frontmatter":{"layout":"post","title":"Setting up OAuth for Grafana with Auth0","path":"/setting-up-oauth-for-grafana-with-auth0/","categories":["Auth0","OAuth","Infrastructure as Code","Terraform","Grafana"],"date":"2021/01/17","draft":false,"description":"Set up secure access for Grafana based on OAuth thanks to Auth0, nicely provisioned with Terraform using Infrastructure as Code","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/a9230025dba16af901f0de8912fdc6e9/5b5fd/dashboard.png","srcSet":"/static/a9230025dba16af901f0de8912fdc6e9/9cacf/dashboard.png 158w,\n/static/a9230025dba16af901f0de8912fdc6e9/cb71d/dashboard.png 317w,\n/static/a9230025dba16af901f0de8912fdc6e9/5b5fd/dashboard.png 633w","sizes":"(min-width: 633px) 633px, 100vw"},"sources":[{"srcSet":"/static/a9230025dba16af901f0de8912fdc6e9/e0fee/dashboard.webp 158w,\n/static/a9230025dba16af901f0de8912fdc6e9/81fe7/dashboard.webp 317w,\n/static/a9230025dba16af901f0de8912fdc6e9/e01eb/dashboard.webp 633w","type":"image/webp","sizes":"(min-width: 633px) 633px, 100vw"}]},"width":750,"height":504.73933649289097}}}}},"related":{"nodes":[{"frontmatter":{"title":"Setting up Auth0 with Terraform","path":"/setting-up-auth0-with-terraform/","date":"2020/02/22"}},{"frontmatter":{"title":"Authorization for a Kotlin Spring backend, using JSON Web Tokens","path":"/authorize-spring-backend-with-jwt-in-kotlin/","date":"2020/03/19"}},{"frontmatter":{"title":"Book Review: Prometheus up and running","path":"/book-review-prometheus-up-and-running/","date":"2021/01/08"}}]},"previous":{"frontmatter":{"title":"Book Review: Team topologies","path":"/book-review-team-topologies/","date":"2021/02/08"}},"next":{"frontmatter":{"title":"Authorization Code Flow with PKCE (OAuth) in a React application","path":"/oauth-authorization-code-flow-pkce-for-react/","date":"2021/03/29"}}},"pageContext":{"related":["/setting-up-auth0-with-terraform/","/authorize-spring-backend-with-jwt-in-kotlin/","/book-review-prometheus-up-and-running/"],"previous":"/book-review-team-topologies/","next":"/oauth-authorization-code-flow-pkce-for-react/"}},"staticQueryHashes":[],"slicesMap":{}}