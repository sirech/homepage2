{"componentChunkName":"component---src-templates-blog-post-js","path":"/authorize-spring-backend-with-jwt-in-kotlin/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for Meta","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"8feb225b-044a-5c48-9527-f6c341961d0a","html":"<p>In my previous article, I wrote about <a href=\"../setting-up-auth0-with-terraform/\">setting up Auth0 using Terraform</a>. In this article, I want to put that setup to work to authorize requests to a backend API written in <em>Kotlin</em>, using <a href=\"https://spring.io/\" target=\"_blank\" rel=\"noopener noreferrer\">SpringBoot</a>.</p>\n<p>This API is used  to upload recipes. It is consumed through a frontend application. Login is optional for viewing them. I want to authorize requests to create new ones, however. That’s what we’ll be doing now, thanks to <a href=\"https://en.wikipedia.org/wiki/JSON_Web_Token\" target=\"_blank\" rel=\"noopener noreferrer\">JSON Web Tokens</a>.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/a2bd97f48810308dce1184cdd574b395/d7abb/jwt-concept.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 39.361702127659576%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABUElEQVR42o1RO07DUBDcOA6GyHZIDESicWPJjpP4g+WPLEuhQr6ACyiREFVKaksUHIZL0HECxEUoKCjMjuVnEULBSqv32X2zM/OIuthsNrJt25rrugf0j6jrWkJvFEUjPkq/64M4jo2yLJUsy2Y7oA0tOa85K04ZVwwyQTIJdb1eT8MwPM/zXNtBREOSJDrWdmJDA9xPXscX6rtyp74p9/RCck21BIAgCE7Ry8NVvMO5BbIsSymKYtpNPcEKlmCLum3cagY9aBZtdSiBNb7vH6dpOu962sFg2u5RhA+dFwS5pmkedkyZKI0bjYxGp5moQ14nWRYKe0AU4J/wABJwvnLdFuCD6PKL6OmT6JHBR/wbUsGPwZCVHCEBBtn974Kl4zgGLler1RyAPWOW78fx8maxMAWbqqqGnuedCQ9/Mt37beGJiGei4ZZ9BsgfvXvxDZhaS6Ym9kHXAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"authorizing backend requests\" title=\"\" src=\"/static/a2bd97f48810308dce1184cdd574b395/1d69c/jwt-concept.png\" srcset=\"/static/a2bd97f48810308dce1184cdd574b395/4dcb9/jwt-concept.png 188w,\n/static/a2bd97f48810308dce1184cdd574b395/5ff7e/jwt-concept.png 375w,\n/static/a2bd97f48810308dce1184cdd574b395/1d69c/jwt-concept.png 750w,\n/static/a2bd97f48810308dce1184cdd574b395/d7abb/jwt-concept.png 959w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<h2>JSON Web Tokens</h2>\n<p>I’m delegating the user management to <em>Auth0</em>. Our frontend communicates with it using <a href=\"https://auth0.com/docs/api-auth/which-oauth-flow-to-use\" target=\"_blank\" rel=\"noopener noreferrer\">OAuth</a> to obtain a <a href=\"https://tools.ietf.org/html/rfc6750\" target=\"_blank\" rel=\"noopener noreferrer\">bearer token</a>, but that is outside the purpose of this article. We’ll assume that this step happened already and that the requests to our backend come with an <em>Authorization</em> header.</p>\n<p>The token is encoded in base64, which can be conveniently decoded using <a href=\"https://jwt.io/\" target=\"_blank\" rel=\"noopener noreferrer\">jwt.io</a>. Once decoded, we can have a look at the payload, which is just a JSON object:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"iss\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://{{auth0_tenant}}.eu.auth0.com/\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"sub\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"google-oauth2|{{user_id}}\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"aud\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"{{our_domain}}\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"https://{{auth0_tenant}}.eu.auth0.com/userinfo\"</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"iat\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1584296421</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"exp\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1584303621</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scope\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"openid profile create:recipes\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So we have an Issuer (<code class=\"language-text\">iss</code>), an Audience (<code class=\"language-text\">aud</code>), an Expiration Time (<code class=\"language-text\">exp</code>), and the scopes granted (<code class=\"language-text\">scope</code>). All those are fields that we can verify. How will that work? Here’s a diagram:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/b7ed50bf14720008280a3c00b3ddd8bf/33e10/jwt-overview.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 80.31914893617021%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB5klEQVR42q1Ty07bUBAdA4E0UF7Ng0ptIyVA08iO7Ti246jVFa+SVggQqoWAZbeQfkK/sLsu20UXlVpWrLtxzwm2dAmggspIo7HvzD0zc2auSCqe5xWazeYMtdVqTd9HlVJ50aXT6ewC8Nh13chxHIXvtXa7vU6Ls43bFLGbiHuDuI+0OuCnIAhsVLcIZwNZV2lt255PQ8aghqZjmmV3b33fPxGt3bMwDFsAriErfD6MY2uAhoxIHMfjKGAyLWgTGEdXAKHtfr8/lZ2h4llVBTeJjEN1QMM0zQqSLqHtKjlk+2j55Bpgt9t9BFt0XjulqBKV81/yVTkXJT+kpmZU0QqsZ71e7zEqeom4FwTjHYBtcwY64CADJH9mZDZUQS3lvucs+SV78k06YTV8hZgQVJQQU87o4IRRYX8UcFghnMOVsSxrgZdwlpMLWZSvQq4M8kZLHxNHUVTOOBxteYCMDncRw6kg4DkvwTUxDPg8nOaVyXKA5JHf11rm2uDASsFzrFLuJtnabI2uzQcup+v7G4Hn7Yeue4gA8vL+NgWX72jTlTnlI9AzGZweV6XmeXONhv+EfPL/XwqguRs7StLlvYjry3/iuif/K8kl8fL7oL59Hq8M5KEkUTLxc+dpQR5Skhve7l3lLysZkAoSvw6iAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"the general overview of our backend\" title=\"\" src=\"/static/b7ed50bf14720008280a3c00b3ddd8bf/1d69c/jwt-overview.png\" srcset=\"/static/b7ed50bf14720008280a3c00b3ddd8bf/4dcb9/jwt-overview.png 188w,\n/static/b7ed50bf14720008280a3c00b3ddd8bf/5ff7e/jwt-overview.png 375w,\n/static/b7ed50bf14720008280a3c00b3ddd8bf/1d69c/jwt-overview.png 750w,\n/static/b7ed50bf14720008280a3c00b3ddd8bf/33e10/jwt-overview.png 844w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>In order to authorize requests, we need three components:</p>\n<ul>\n<li>A <em>Verifier</em> that checks if the token is valid, and extract information from it if so</li>\n<li>A <em>JwtAuthorizationFilter</em> that runs before every request to the backend, and run the <em>Verifier</em></li>\n<li>A connection to <em>Spring Security</em>, which rejects the request if it is invalid</li>\n</ul>\n<p>Let’s have a look at each separately.</p>\n<h2>Verifying the token</h2>\n<p>So, our backend has received a request that includes a <em>JWT</em>, what do we do now? We can picture it as two distinct steps. Checking the signature and verifying the token itself. We combine both steps into an interface (<code class=\"language-text\">Verifier</code>), which defines one method:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">interface</span> Verifier <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/**\n     * @param jwt a jwt token\n     * @return whether the token is valid or not\n     */</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>jwt<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Either<span class=\"token operator\">&lt;</span>JWTVerificationException<span class=\"token punctuation\">,</span> TokenAuthentication<span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I’m using an <code class=\"language-text\">Either</code> type for the return type. I wrote <a href=\"../kotlin-either-types-instead-of-exceptions/\">about them</a> recently. Essentially, we’ll get a <code class=\"language-text\">TokenAuthentication</code> if <code class=\"language-text\">verify</code> succeeds and an instance of <code class=\"language-text\">JWTVerificationException</code> if not.</p>\n<h3>The signature</h3>\n<p>The token is signed by the issuer (in our case <em>Auth0</em>). The signature ensures that the token comes from the issuer, and that hasn’t been tampered with.</p>\n<p>To avoid having to share a secret key, we prefer to use a public/private key combination. That’s where <code class=\"language-text\">JWKS</code> comes in. <em>Auth0</em> publishes the key for your tenant under https://{{auth0_tenant}}.eu.auth0.com/.well-known/jwks.json. I am injecting that key into our <code class=\"language-text\">RemoteVerifier</code>, which implements the interface I defined above. We provide it as a <code class=\"language-text\">Bean</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Configuration</span>\n<span class=\"token keyword\">class</span> JWTConfiguration <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation builtin\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"\\${auth.jwks}\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">lateinit</span> <span class=\"token keyword\">var</span> jwks<span class=\"token operator\">:</span> String\n\n    <span class=\"token annotation builtin\">@ConditionalOnProperty</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"auth.enabled\"</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> havingValue <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"true\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation builtin\">@Bean</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">verifier</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Verifier <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> keySet <span class=\"token operator\">=</span> JWKSet<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>jwks<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">RemoteVerifier</span><span class=\"token punctuation\">(</span>keySet<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">Bean</code> is conditional so that we can provide an alternate implementation for our tests, thus avoiding network requests.</p>\n<h3>Setting up the verifier</h3>\n<p>For the verification itself, we are going to use <a href=\"https://github.com/auth0/java-jwt\" target=\"_blank\" rel=\"noopener noreferrer\">auth0’s own library</a>. First, we initialize a <code class=\"language-text\">JWTVerifier</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">RemoteVerifier</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> keySet<span class=\"token operator\">:</span> JWKSet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> leeway<span class=\"token operator\">:</span> Long <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> Verifier <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">key</span><span class=\"token punctuation\">(</span>keySet<span class=\"token operator\">:</span> JWKSet<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> keySet<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">.</span><span class=\"token function\">first</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> RSAKey\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">algorithm</span><span class=\"token punctuation\">(</span>key<span class=\"token operator\">:</span> RSAKey<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> Algorithm<span class=\"token punctuation\">.</span><span class=\"token function\">RSA256</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">toRSAPublicKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">verifier</span><span class=\"token punctuation\">(</span>algorithm<span class=\"token operator\">:</span> Algorithm<span class=\"token punctuation\">,</span> leeway<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> JWT\n                <span class=\"token punctuation\">.</span><span class=\"token function\">require</span><span class=\"token punctuation\">(</span>algorithm<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">acceptExpiresAt</span><span class=\"token punctuation\">(</span>leeway<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">verifier</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> JWTVerifier <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> key <span class=\"token operator\">=</span> <span class=\"token function\">key</span><span class=\"token punctuation\">(</span>keySet<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> algorithm <span class=\"token operator\">=</span> <span class=\"token function\">algorithm</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">verifier</span><span class=\"token punctuation\">(</span>algorithm<span class=\"token punctuation\">,</span> leeway<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can see we include the key we got before, plus a leeway limit for the expiration time of the token. If you want to test for the issuer and the audience explicitly, you can use the <code class=\"language-text\">withIssuer</code> and <code class=\"language-text\">withAudience</code> methods, before calling <code class=\"language-text\">build()</code>. In my case,  checking that my tenant signs the token feels safe enough.</p>\n<p>We trigger the actual verification by calling the <code class=\"language-text\">verify</code> method of the <code class=\"language-text\">JWTVerifier</code> we just created, wrapping it so that it does not throw exceptions into the wild.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>jwt<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Either<span class=\"token operator\">&lt;</span>JWTVerificationException<span class=\"token punctuation\">,</span> TokenAuthentication<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">verifier</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">unsafeVerify</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">map</span> <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">.</span><span class=\"token function\">asToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Wait, what is that <code class=\"language-text\">asToken</code> method doing there? As I mentioned, we want to extract information from the token. We need the list of scopes in the token for later, which we fetch and include in our <code class=\"language-text\">TokenAuthentication</code></p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> DecodedJWT<span class=\"token punctuation\">.</span><span class=\"token function\">asToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n        <span class=\"token function\">TokenAuthentication</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> <span class=\"token function\">User</span><span class=\"token punctuation\">(</span>subject<span class=\"token punctuation\">,</span> <span class=\"token function\">scopes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> DecodedJWT<span class=\"token punctuation\">.</span><span class=\"token function\">scopes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">getClaim</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"scope\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">asString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\" \"</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>The authorization filter</h2>\n<p>The verifier runs inside a filter, which inherits from <code class=\"language-text\">OncePerRequestFilter</code>. As you probably guessed, it runs before every request, but only once. Let’s call it <code class=\"language-text\">JwtAuthorizationFilter</code>. It does the following steps:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 659px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/006cb062ab62134b34584bec769116fa/6db71/jwt-flow.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 98.40425531914893%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACJElEQVR42r2U607CQBCFKYo3VLxfsN5REblDKVS0qJDwAsToy/DoeD6yNVVbNf5wk8nutrOzM+ec2UTi+2HJkqPRaKbRaKRyudx8oVCYM9/jh+M4m6VSyS6Xyzvdbne7Wq1uK8AW3zH2+Xx+s91ub7Cu1WpZLokMpiDpTqez02w2D+v1+p0C3Gt+VEBX1lMAX3PJ7B/0f4+Ltc6Eqvgwkq7r7ur2AwU9k+O5MsiZ+VoBL1qt1imz/l/J94Sgvu/PxpY8Ho+TOFAGxh6sFPRFdtTv9zOal+SzAJaTycRK/GWo9PZgMEhzmTBeV6armOd5K7EYhgdEkBGgQwalViqVA8hgDzRkqP0ivsPhcD6E49esOaxSN4SVjynDhrBzIInMYFg+a0EQLiZ4bIYc0EFbjscQRIbsDVlHkEEgVFEsFnfF9iXkyfZhPipm0mBjgZsCPRNIWS+DIRYoANnovwP78p8xckpHdcb7Gh2CHQxTMgdt2140ksoqmIe0yBYdfyEKfCgXQ5faTzUHrnQKpRnyUgTHz3RVKpJ1yqNszXU5PynYjda3ut1Dg2QR+JJxqFuihw6BlQ3bATGh9SFkgBNZgeuPj8QnTYHhKyQAhSktg9Cp4rfNYYVFyoMQYs76bUZTuaiEPVNeFvAhAx0Ga2b+6YLTUIfEtlwGJk3b3WtuGXPN08W6x2tj/GKfrumAcm4nI8llKlxldYmBIeINugJyzKv9P+MNWBuf6stBvSYAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"the flow that I use to authorize requests\" title=\"\" src=\"/static/006cb062ab62134b34584bec769116fa/6db71/jwt-flow.png\" srcset=\"/static/006cb062ab62134b34584bec769116fa/4dcb9/jwt-flow.png 188w,\n/static/006cb062ab62134b34584bec769116fa/5ff7e/jwt-flow.png 375w,\n/static/006cb062ab62134b34584bec769116fa/6db71/jwt-flow.png 659w\" sizes=\"(max-width: 659px) 100vw, 659px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>We covered the <em>Verify Token</em> step in the previous section. Before that, we have to extract the token from the header. If the verification succeeds, we set the <code class=\"language-text\">SecurityContext</code>, which is relevant for <em>Spring Security</em>. The code looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Component</span>\n<span class=\"token keyword\">class</span> <span class=\"token function\">JwtAuthorizationFilter</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> verifier<span class=\"token operator\">:</span> Verifier<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">OncePerRequestFilter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">extractToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"Bearer \"</span></span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">maybe</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\" \"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">last</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">doFilterInternal</span><span class=\"token punctuation\">(</span>\n            request<span class=\"token operator\">:</span> HttpServletRequest<span class=\"token punctuation\">,</span>\n            response<span class=\"token operator\">:</span> HttpServletResponse<span class=\"token punctuation\">,</span>\n            filterChain<span class=\"token operator\">:</span> FilterChain<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">val</span> token <span class=\"token operator\">=</span> Option<span class=\"token punctuation\">.</span><span class=\"token function\">fx</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">val</span> <span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span>Headers<span class=\"token punctuation\">.</span>AUTHORIZATION<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toOption</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">val</span> <span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> header<span class=\"token punctuation\">.</span><span class=\"token function\">extractToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">val</span> <span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> verifier<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toOption</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            SecurityContextHolder<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>authentication <span class=\"token operator\">=</span> token\n        <span class=\"token punctuation\">}</span>\n\n        filterChain<span class=\"token punctuation\">.</span><span class=\"token function\">doFilter</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It is fairly straightforward … wait, what is that <code class=\"language-text\">Option.fx</code> thing? And the parentheses? Also, according to the diagram, ever step could have an empty answer, where are we handling that?</p>\n<p>The long explanation is an article on its own. The short version is that thanks to <em>Arrow</em>, we can use <a href=\"https://arrow-kt.io/docs/patterns/monad_comprehensions/\" target=\"_blank\" rel=\"noopener noreferrer\">monad comprehensions</a> to flatten our code and make a collection of operations on an <code class=\"language-text\">Option</code> look like a regular block of code.</p>\n<h2>Binding Spring Security</h2>\n<p>I am using <a href=\"https://spring.io/projects/spring-security\" target=\"_blank\" rel=\"noopener noreferrer\">Spring Security</a> to integrate my filter into my application. The easiest way to get started is to use this dependency:</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\">implementation <span class=\"token string\">'org.springframework.boot:spring-boot-starter-security'</span></code></pre></div>\n<p>In the configuration, I’m specifying the following:</p>\n<ul>\n<li>My <code class=\"language-text\">JwtAuthorizationFilter</code> will run before every request</li>\n<li><code class=\"language-text\">GET</code> requests don’t need authorization</li>\n<li>For mutating requests (such as a <code class=\"language-text\">POST</code>), we expect the <code class=\"language-text\">create:recipes</code> scope there. Remember that we mapped that into our <code class=\"language-text\">TokenAuthentication</code> as part of the verification.</li>\n</ul>\n<p>There is a fluent interface to configure this in code, which looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@EnableWebSecurity</span>\n<span class=\"token annotation builtin\">@EnableGlobalMethodSecurity</span><span class=\"token punctuation\">(</span>securedEnabled <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> SecurityConfiguration <span class=\"token operator\">:</span> <span class=\"token function\">WebSecurityConfigurerAdapter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation builtin\">@Autowired</span>\n    <span class=\"token keyword\">lateinit</span> <span class=\"token keyword\">var</span> filter<span class=\"token operator\">:</span> JwtAuthorizationFilter\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>http<span class=\"token operator\">:</span> HttpSecurity<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        http<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">let</span> <span class=\"token punctuation\">{</span>\n            it<span class=\"token punctuation\">.</span><span class=\"token function\">cors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">and</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">csrf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">disable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">authorizeRequests</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">antMatchers</span><span class=\"token punctuation\">(</span>HttpMethod<span class=\"token punctuation\">.</span>GET<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">permitAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">anyRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">hasAuthority</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"create:recipes\"</span></span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">and</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">addFilterBefore</span><span class=\"token punctuation\">(</span>filter<span class=\"token punctuation\">,</span> BasicAuthenticationFilter<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">sessionManagement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">sessionCreationPolicy</span><span class=\"token punctuation\">(</span>SessionCreationPolicy<span class=\"token punctuation\">.</span>STATELESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So now all three parts are finally connected. We defined which requests we want to authorize. The filter parses and verifies the token. If that token fulfills all our requirements, the request goes through. Otherwise, it fails with an unauthorized response. If you want deeper into <em>Spring Security</em>, you can check <a href=\"https://www.toptal.com/spring/spring-security-tutorial\" target=\"_blank\" rel=\"noopener noreferrer\">this tutorial</a>.</p>\n<h2>Summary</h2>\n<p>Building authorization into your API is something you <strong>need</strong> to do if you want to make sure that your backend is properly ensuring only the right parties are allowed to do certain things. I rolled a custom solution for a project that I worked on, but if you use standard tools and libraries, it is a lot more convenient and a lot easier for other people to understand.</p>","frontmatter":{"layout":"post","title":"Authorization for a Kotlin Spring backend, using JSON Web Tokens","path":"/authorize-spring-backend-with-jwt-in-kotlin/","categories":["Auth0","OAuth","Kotlin","SpringBoot","Security"],"date":"2020/03/19","draft":false,"description":"Build authorization into your Kotlin backend by combining Auth0, JWTs and Spring Security to ensure only the right parties can execute operations","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/a2bd97f48810308dce1184cdd574b395/57dec/jwt-concept.png","srcSet":"/static/a2bd97f48810308dce1184cdd574b395/9194e/jwt-concept.png 188w,\n/static/a2bd97f48810308dce1184cdd574b395/c00ef/jwt-concept.png 375w,\n/static/a2bd97f48810308dce1184cdd574b395/57dec/jwt-concept.png 750w","sizes":"(min-width: 750px) 750px, 100vw"},"sources":[{"srcSet":"/static/a2bd97f48810308dce1184cdd574b395/96374/jwt-concept.webp 188w,\n/static/a2bd97f48810308dce1184cdd574b395/86972/jwt-concept.webp 375w,\n/static/a2bd97f48810308dce1184cdd574b395/d3b9b/jwt-concept.webp 750w","type":"image/webp","sizes":"(min-width: 750px) 750px, 100vw"}]},"width":750,"height":297}}}}},"related":{"nodes":[{"frontmatter":{"title":"Either Types as an alternative to throwing exceptions in Kotlin","path":"/kotlin-either-types-instead-of-exceptions/","date":"2020/01/09"}},{"frontmatter":{"title":"Setting up Auth0 with Terraform","path":"/setting-up-auth0-with-terraform/","date":"2020/02/22"}},{"frontmatter":{"title":"Book Review: Kotlin in Action","path":"/book-review-kotlin-in-action/","date":"2020/06/28"}}]},"previous":{"frontmatter":{"title":"Setting up Auth0 with Terraform","path":"/setting-up-auth0-with-terraform/","date":"2020/02/22"}},"next":{"frontmatter":{"title":"Useful commands to work with certificates","path":"/useful-commands-to-work-with-certificates/","date":"2020/04/08"}}},"pageContext":{"related":["/kotlin-either-types-instead-of-exceptions/","/setting-up-auth0-with-terraform/","/book-review-kotlin-in-action/"],"previous":"/setting-up-auth0-with-terraform/","next":"/useful-commands-to-work-with-certificates/"}},"staticQueryHashes":[],"slicesMap":{}}