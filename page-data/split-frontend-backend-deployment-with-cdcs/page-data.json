{"componentChunkName":"component---src-templates-blog-post-js","path":"/split-frontend-backend-deployment-with-cdcs/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for Meta","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"ba803a61-e4e7-59b9-b6f5-ace653e325d3","html":"<p><a href=\"https://www.thoughtworks.com/de/radar/techniques/consumer-driven-contract-testing\" target=\"_blank\" rel=\"noopener noreferrer\">Consumer driven contract testing</a> is a great way to improve the reliability of interconnected systems. Integration testing becomes way easier and more self contained. It opens the door for independent deployments. It leads to faster iterations and more granular feedback. Unlike your insurance, they don’t have any fine print. This article is about setting them up in a delivery pipeline, in the context of doing <a href=\"https://continuousdelivery.com/\" target=\"_blank\" rel=\"noopener noreferrer\">continuous delivery</a>.</p>\n<p>I want to show how <em>Contract Tests</em> help splitting the deployment of the front end and the back end of a small application. I have a React client and a Spring Boot backend written in Kotlin.</p>\n<!--more-->\n<h2>What is a Contract Test?</h2>\n<p>I am not talking about <a href=\"https://en.wikipedia.org/wiki/Smart_contract\" target=\"_blank\" rel=\"noopener noreferrer\">smart contracts</a>. There is no blockchain whatsoever in this article. Sorry for that (Contract Tests for Smart Contracts sounds like a conference talk that the world badly needs, though!).</p>\n<p>In a nutshell, a Contract Test is a specification of the interactions between a consumer and a provider. In our case, the communication happens using REST. The consumer defines the actions sent to the provider and the responses that will be returned. In our case, the frontend is the consumer and the backend is the provider. A <em>contract</em> is generated. Both sides test against this contract.</p>\n<p>It is not really about any particular technology. There are a bunch of different frameworks, but some simple scripts could do the trick.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 450px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/c8503db2bd616288d804d97c55d725ca/fc2a6/simple-cdc.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 36.17021276595745%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABE0lEQVR42mVQy04CQRCcwd0EWSDgG4N4EIkXl+2qWhIuegFvRj/JTzeNvQnqoTKZnq7HVNpsNglAH8DwCCdm5vNE8h/+zv3ukJR8UAC4A3AJ4ALAAsAkloogLUm+kHwIgeJI8AzATcdJTdP4QgPgGcAyzrmZjcNgRPKd5BfJTwCnAK7MrHJzko8AqghUJjPLIeTJzgFcA7glOQ3nIcmG5AfJt0g3i0QzknMAAw9gZsUhPoBxXdd5vV73IkEVHebdbuffWpF89TRt2+a6rn2WoxYX8/3SOYciSS4kkaRFmrIrXlImOZI0kTSV1AuOoy9pKelJ0v1+v/8RlFS2beuksSTvw6vo3jrhX/dAljQIs2q73aZv37Bb///QjKgAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Basic contract test\" title=\"\" src=\"/static/c8503db2bd616288d804d97c55d725ca/fc2a6/simple-cdc.png\" srcset=\"/static/c8503db2bd616288d804d97c55d725ca/4dcb9/simple-cdc.png 188w,\n/static/c8503db2bd616288d804d97c55d725ca/5ff7e/simple-cdc.png 375w,\n/static/c8503db2bd616288d804d97c55d725ca/fc2a6/simple-cdc.png 450w\" sizes=\"(max-width: 450px) 100vw, 450px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<h3>Why have it as part of the delivery pipeline?</h3>\n<p>First of all, running these tests continuously ensures that they keep working at all times. The big benefit, however, is that we can separate the deployment of frontend and backend. If both sides are fulfilling the contract, it is likely that they work together correctly. Thus, we can consider avoiding expensive integrated tests. They tend to work pretty badly anyways.</p>\n<h2>Setting up some contracts</h2>\n<p>There are two sides to set up, consumer and provider. The tests will run in the pipelines that build the frontend and the backend, respectively. We are going to use the <a href=\"https://docs.pact.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Pact framework</a> for our examples, which is the tool that I am most familiar with. Because of that, I tend to use pact and contract interchangeably. Our pipelines are written for <a href=\"https://circleci.com/\" target=\"_blank\" rel=\"noopener noreferrer\">CircleCI</a>, but they should be fairly easy to port to other CI Tools.</p>\n<h3>The consumer side</h3>\n<p>As mentioned, the consumer leads the creation of the contract. Having the client driving this might sound counterintuitive. Often, APIs are created before the clients that will use them. Flipping it around is a nice habit to get into. It forces you to really think in terms of what the client will actually do, instead of bikeshedding a super generic API that will never need most of its features. You should give it a try!</p>\n<p>The pact is defined through interactions specified in unit tests. We specify what we expect to be sent to the backend, and then use the client code to trigger requests. Why? We can compare expectations against actual requests, and fail the tests if they don’t match. Let’s have a look at an example. We are using <a href=\"https://jestjs.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Jest</a> to run the tests. We’ll start with some initialization code:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> path <span class=\"token keyword\">from</span> <span class=\"token string\">'path'</span>\n<span class=\"token keyword\">import</span> Pact <span class=\"token keyword\">from</span> <span class=\"token string\">'pact'</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">provider</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n  <span class=\"token function\">Pact</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    port<span class=\"token operator\">:</span> <span class=\"token number\">8990</span><span class=\"token punctuation\">,</span>\n    log<span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span><span class=\"token function\">cwd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'logs'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'pact.log'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    dir<span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span><span class=\"token function\">cwd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'pacts'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    spec<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n    consumer<span class=\"token operator\">:</span> <span class=\"token string\">'frontend'</span><span class=\"token punctuation\">,</span>\n    provider<span class=\"token operator\">:</span> <span class=\"token string\">'backend'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> provider</code></pre></div>\n<p>Then we have the code for an actual test. The test consists of two parts. First we define the expected interaction. This is not very different from mocking an http library, with something like <a href=\"https://github.com/ctimmerm/axios-mock-adapter\" target=\"_blank\" rel=\"noopener noreferrer\">axios</a>. It specifies the request that we will send (URL, headers, body and so forth), and the response that we will get.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> interaction<span class=\"token operator\">:</span> InteractionObject <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  state<span class=\"token operator\">:</span> <span class=\"token string\">'i have a list of recipes'</span><span class=\"token punctuation\">,</span>\n  uponReceiving<span class=\"token operator\">:</span> <span class=\"token string\">'a request to get recipes'</span><span class=\"token punctuation\">,</span>\n  withRequest<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    method<span class=\"token operator\">:</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span>\n    path<span class=\"token operator\">:</span> <span class=\"token string\">'/rest/recipes'</span><span class=\"token punctuation\">,</span>\n    headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      Accept<span class=\"token operator\">:</span> <span class=\"token string\">'application/json'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">'X-Requested-With'</span><span class=\"token operator\">:</span> <span class=\"token string\">'XMLHttpRequest'</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  willRespondWith<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    status<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n    headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'application/json; charset=utf-8'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    body<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        name<span class=\"token operator\">:</span> <span class=\"token string\">'pasta carbonara'</span><span class=\"token punctuation\">,</span>\n        servings<span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n        duration<span class=\"token operator\">:</span> <span class=\"token number\">35</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then we have the test itself, where we call the actual client code that will trigger the request. I like to encapsulate these requests in services that convert the raw response into the domain model that will be used by the rest of the app. Through some assertions, we make sure that the data that we are delivering from the service is exactly what we expect.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'works'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">recipeList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBeGreaterThan</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toEqual</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">:</span> <span class=\"token string\">'pasta carbonara'</span><span class=\"token punctuation\">,</span>\n    servings<span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n    duration<span class=\"token operator\">:</span> <span class=\"token number\">35</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Note that even if <code class=\"language-text\">recipeList</code> is properly typed with <code class=\"language-text\">TypeScript</code>, that won’t help us here. Types disappear at runtime, so if the method is returning an invalid <code class=\"language-text\">Recipe</code> we won’t realize it, unless we explicitly test for it.</p>\n<p>Finally we need to define some extra methods that will ensure that the interactions are verified. If there are interactions missing, or they don’t look like they should, the test will fail here. After that, all that remains is writing the pact to disk.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token function\">beforeAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> provider<span class=\"token punctuation\">.</span><span class=\"token function\">setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">afterEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> provider<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">afterAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> provider<span class=\"token punctuation\">.</span><span class=\"token function\">finalize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>In the end, the pact gets generated as a JSON file, reflecting all the interactions that we have defined throughout all our tests.</p>\n<h4>Flexible matching</h4>\n<p>Our pact thus far is specifying the exact values that it will get from the backend. That won’t be maintainable in the long run. Certain things are inherently harder to pin down to exact values (for example, dates). A pact that breaks constantly will lead to frustration. We are going through this whole process to make our life easier, not harder. We’ll avoid that by using <a href=\"https://docs.pact.io/getting_started/matching\" target=\"_blank\" rel=\"noopener noreferrer\">matchers</a>. We can be more flexible and define how things will look like, without having to provide exact values. Let’s rewrite our previous body:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\">willRespondWith<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  status<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n  headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'application/json; charset=utf-8'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  body<span class=\"token operator\">:</span> Matchers<span class=\"token punctuation\">.</span><span class=\"token function\">eachLike</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    id<span class=\"token operator\">:</span> Matchers<span class=\"token punctuation\">.</span><span class=\"token function\">somethingLike</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">:</span> Matchers<span class=\"token punctuation\">.</span><span class=\"token function\">somethingLike</span><span class=\"token punctuation\">(</span><span class=\"token string\">'pasta carbonara'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    servings<span class=\"token operator\">:</span> Matchers<span class=\"token punctuation\">.</span><span class=\"token function\">somethingLike</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    duration<span class=\"token operator\">:</span> Matchers<span class=\"token punctuation\">.</span><span class=\"token function\">somethingLike</span><span class=\"token punctuation\">(</span><span class=\"token number\">35</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can be more specific. You can set the expected length of a list, use regexes and a bunch of other things.</p>\n<h4>Integrating it in the pipeline</h4>\n<p>The pact tests rely on an external process, and having multiple tests hitting it can lead to non deterministic behavior. One solution is to run all the tests sequentially:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token builtin class-name\">test</span> <span class=\"token parameter variable\">--coverage</span> <span class=\"token parameter variable\">--runInBand</span></code></pre></div>\n<p>If you want to run the pact tests independently, we can build our own task to run them separately:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"pact\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"jest --transform '{\\\"^.+\\\\\\\\.ts$\\\": \\\"ts-jest\\\"}' --testRegex '.test.pact.ts$' --runInBand\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Which will become an extra step in our pipeline:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">check</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">working_directory</span><span class=\"token punctuation\">:</span> ~/app\n\n    <span class=\"token key atrule\">docker</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> circleci/node<span class=\"token punctuation\">:</span><span class=\"token number\">12.4</span>\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> checkout\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run linter<span class=\"token punctuation\">:</span>js\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm test <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>coverage <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>runInBand\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm pact</code></pre></div>\n<h4>Storing the pact</h4>\n<p>Our pact is a json file that we are going to commit directly in the frontend repository, after running the tests locally. I’ve found that this tends to work well enough. Making the pipeline itself commit the pact to <code class=\"language-text\">git</code> does not seem to be necessary.\nWe’ll get to extending the pact and in a second.</p>\n<h3>The provider side</h3>\n<p>At this point we have a working pact, that is being verified by the consumer. But that is only half of the equation. Without a verification from the provider side, we haven’t accomplished anything. Maybe even less than that, because we might get a false sense of security!</p>\n<p>To do this, we are going to start the backend as a development server and run the pact against it. There is a <code class=\"language-text\">gradle</code> provider that takes care of this. We need to configure it and provide a way of finding the pact (which is stored in the frontend repository). You can fetch the pact from the internet, or from a local file, whichever is more convenient.</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\">buildscript <span class=\"token punctuation\">{</span>\n    dependencies <span class=\"token punctuation\">{</span>\n        classpath <span class=\"token string\">'au.com.dius:pact-jvm-provider-gradle_2.12:3.6.14'</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\napply plugin<span class=\"token punctuation\">:</span> <span class=\"token string\">'au.com.dius.pact'</span>\n\npact <span class=\"token punctuation\">{</span>\n    serviceProviders <span class=\"token punctuation\">{</span>\n        api <span class=\"token punctuation\">{</span>\n            port <span class=\"token operator\">=</span> <span class=\"token number\">4003</span>\n\n            <span class=\"token function\">hasPactWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'frontend'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                pactSource <span class=\"token operator\">=</span> <span class=\"token function\">url</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://path-to-the-pact/frontend-backend.json'</span><span class=\"token punctuation\">)</span>\n                stateChangeUrl <span class=\"token operator\">=</span> <span class=\"token function\">url</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">\"http://localhost:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">port</span></span><span class=\"token string\">/pact\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>What remains is starting the server and running the pact against it, which we do with a small script:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function-name function\">goal_test-pact</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token builtin class-name\">trap</span> <span class=\"token string\">\"stop_server\"</span> EXIT\n\n  goal_build\n  start_server\n\n  ./gradlew pactVerify\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function-name function\">start_server</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token assign-left variable\">artifact</span><span class=\"token operator\">=</span>app.jar\n  <span class=\"token assign-left variable\">port</span><span class=\"token operator\">=</span><span class=\"token number\">4003</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token function\">lsof</span> <span class=\"token parameter variable\">-i</span> <span class=\"token parameter variable\">-P</span> <span class=\"token parameter variable\">-n</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> LISTEN <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token builtin class-name\">:</span><span class=\"token variable\">$port</span> <span class=\"token operator\">></span> /dev/null <span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Port[<span class=\"token variable\">${port}</span>] is busy. Server won't be able to start\"</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n  <span class=\"token keyword\">fi</span>\n\n  <span class=\"token function\">nohup</span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">-Dspring.profiles.active</span><span class=\"token operator\">=</span>pact <span class=\"token parameter variable\">-jar</span> ./build/libs/<span class=\"token variable\">${artifact}</span> <span class=\"token operator\">></span>/dev/null <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span><span class=\"token file-descriptor important\">&amp;1</span> <span class=\"token operator\">&amp;</span>\n\n  <span class=\"token comment\"># Wait for server to answer requests</span>\n  <span class=\"token keyword\">until</span> <span class=\"token function\">curl</span> <span class=\"token parameter variable\">--output</span> /dev/null <span class=\"token parameter variable\">--silent</span> <span class=\"token parameter variable\">--fail</span> http://localhost:<span class=\"token variable\">$port</span>/actuator/health<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n    <span class=\"token builtin class-name\">printf</span> <span class=\"token string\">'.'</span>\n    <span class=\"token function\">sleep</span> <span class=\"token number\">3</span>\n  <span class=\"token keyword\">done</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function-name function\">stop_server</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">pkill</span> <span class=\"token parameter variable\">-f</span> <span class=\"token string\">'java -Dspring.profiles.active=pact -jar'</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Fixtures</h4>\n<p>If you are running your backend in development mode, it will have to deliver some data, so that the contract is fulfilled. Even if we are not using exact matching, we have to return something, otherwise it won’t be possible to verify it.</p>\n<p>You can use mocks, but I’ve found that avoiding them as much as possible leads to more trustworthy results. Your app is closer to what will happen in production. So what other options are there? Remember that when we were defining interactions, we had a <code class=\"language-text\">state</code>. That’s the cue for the provider. One way of using it is the <code class=\"language-text\">stateChangeUrl</code>. We can provide a special controller to initialize our backend based on the <code class=\"language-text\">state</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">val</span> PATH <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"/pact\"</span></span>\n\n<span class=\"token keyword\">data</span> <span class=\"token keyword\">class</span> <span class=\"token function\">Pact</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> state<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span>\n\n<span class=\"token annotation builtin\">@RestController</span>\n<span class=\"token annotation builtin\">@RequestMapping</span><span class=\"token punctuation\">(</span>PATH<span class=\"token punctuation\">,</span> consumes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>MediaType<span class=\"token punctuation\">.</span>APPLICATION_JSON_VALUE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation builtin\">@ConditionalOnExpression</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"\\${pact.enabled:true}\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token function\">PactController</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> repository<span class=\"token operator\">:</span> RecipeRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation builtin\">@PostMapping</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">setup</span><span class=\"token punctuation\">(</span><span class=\"token annotation builtin\">@RequestBody</span> body<span class=\"token operator\">:</span> Pact<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ResponseEntity<span class=\"token operator\">&lt;</span>Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span>String<span class=\"token operator\">></span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">when</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string-literal singleline\"><span class=\"token string\">\"i have a list of recipes\"</span></span> <span class=\"token operator\">-></span> <span class=\"token function\">initialRecipes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">else</span> <span class=\"token operator\">-></span> <span class=\"token function\">doNothing</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> ResponseEntity<span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token function\">mapOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Note that this controller is only active for a specific profile, and won’t exist outside of it.</p>\n<h4>Integrating it in the pipeline</h4>\n<p>As with the provider, we will run the check as part of our pipeline</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n\n    <span class=\"token key atrule\">working_directory</span><span class=\"token punctuation\">:</span> ~/app\n\n    <span class=\"token key atrule\">docker</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> circleci/openjdk<span class=\"token punctuation\">:</span>8<span class=\"token punctuation\">-</span>jdk\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n\n      <span class=\"token punctuation\">-</span> checkout\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> ./go linter<span class=\"token punctuation\">-</span>kt\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> ./go test<span class=\"token punctuation\">-</span>unit\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> ./go test<span class=\"token punctuation\">-</span>pact</code></pre></div>\n<p>There is a slight difference, though. Our contract gets generated by the consumer. That means that a change in the frontend could lead to a pact that does not verify properly anymore, even though no code was changed in the backend. So ideally, a change in the pact should trigger the backend pipeline as well. I haven’t found a way to represent this elegantly in <em>CircleCI</em>, unlike say <a href=\"https://concourse-ci.org/\" target=\"_blank\" rel=\"noopener noreferrer\">ConcourseCI</a>.</p>\n<h2>How the contract influences the relationship between frontend and backend</h2>\n<p>It’s nice that we got this set up. <a href=\"https://en.wiktionary.org/wiki/never_change_a_running_system\" target=\"_blank\" rel=\"noopener noreferrer\">Never touch a running system</a>, right? Well, we might! After all, quick change is why we invest in all this tooling. How would you introduce a change that requires extending the API?</p>\n<ol>\n<li>We start with the client. We want to define what the client will get that is not there yet. As we learned, we do that through a test in the frontend that defines the expectation for the new route, or the new fields. That will create a new version of the pact.</li>\n<li>Note that at this point the backend <em>does not</em> fulfill the pact. A new deployment of the backend will fail. But also, the <em>existing</em> backend does not fulfill the pact either right now. The change you introduced has to be backwards compatible. The frontend should not be relying on the changes, either.</li>\n<li>Now it’s time to fulfill the new pact from the backend side. If this takes a long time, you will block your deployment process, which is not good. Consider doing smaller increments in that case. Anyways, you’ve got to implement the new functionality. The pact test will verify that your change is what’s actually expected.</li>\n<li>Now that the backend is providing the new functionality, you can freely integrate it in your frontend.</li>\n</ol>\n<p>This flow can get a bit awkward in the beginning. It is really important to work with the smallest quantum of functionality. You don’t want to block your deployment process.</p>\n<h2>Next steps</h2>\n<p>For the integration between your own frontend and backend I have found this setup to be sufficient in practice. However, as complexity grows, versioning will become important. You’ll want to help multiple teams collaborate more easily. For that, we can use a <a href=\"https://docs.pact.io/pact_broker\" target=\"_blank\" rel=\"noopener noreferrer\">broker</a>. This is a lot harder to implement, so you should ask yourself if you really need it. Don’t fix problems that you don’t have yet.</p>\n<h2>Conclusion</h2>\n<p>To summarize, this is the setup we arrived at:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 715px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/4af6bc4800ac62b28269735fdf6f7c2c/d0c0e/pipelines-full.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 44.148936170212764%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABkklEQVR42k2S3UsbURDFr41ZE01EJfGrBVt0C9vAfpzfbGISSpvQpvgWqIjgW0t96kv/xfxlZeJdcGGYe2fP3HvOuROAE+AdMKyqqj2fz0NZlrtlWbZjJFVV7fk6y7KdxWIRhsNhWC6XocF4n2MkJQE4AErgIeYZcAh0gX0zS1arVYj7G+ALYMC0wUgaSLqQ1A91XTt4AjwBH4DfwGczK+q6rs3sh19qZn7AI/ALWAB/zawys1rSlaRrSYdOuwX0gQr4FHMynU6DmTXszwG/+IyXL/O6pB2gJcnldiUdOOgUuHTqfvhoNHLQkSSPfszHwLE3rNfrLYk0Tb336BX2RFLPi+dRzjfgI3DlbMbjcZDk/vSyLAuRYTeqeA+kwBtJrqQNOMtO4+ESWAM58Ay8NTOTdCnpdDabOWYc4x9wC/xxL83sGvgK3G82m9B46J7cmZkDv8fXHURf9ieTibMYRC9/RkV3rsbMetGyVFJ7K8tnLc5btygKn8HEs89WjE6e59vZjPWOr/M8bxVFsa35fyfwH0wDftgSb5wjAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Full setup\" title=\"\" src=\"/static/4af6bc4800ac62b28269735fdf6f7c2c/d0c0e/pipelines-full.png\" srcset=\"/static/4af6bc4800ac62b28269735fdf6f7c2c/4dcb9/pipelines-full.png 188w,\n/static/4af6bc4800ac62b28269735fdf6f7c2c/5ff7e/pipelines-full.png 375w,\n/static/4af6bc4800ac62b28269735fdf6f7c2c/d0c0e/pipelines-full.png 715w\" sizes=\"(max-width: 715px) 100vw, 715px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>Think about all the time you have spent writing tests to check that your backend is sending the right data. That is a lot more convenient to do with a contract. Moreover, releasing frontend and backend independently means being faster, releasing smaller pieces of functionality. It might feel scary at first, but you will realize that you actually are much more aware of what’s going out that way.</p>\n<p>Once you have adopted this for one service, there is no reason not to do it for all of them. I really don’t miss running costly end to end test suites just to verify that my backend is working. Here is the code that I used in the examples for the <a href=\"https://github.com/sirech/cookery2-frontend\" target=\"_blank\" rel=\"noopener noreferrer\">frontend</a> and the <a href=\"https://github.com/sirech/cookery2-backend\" target=\"_blank\" rel=\"noopener noreferrer\">backend</a>. It is a full running (albeit small) application. Good luck with your contracts!</p>","frontmatter":{"layout":"post","title":"How to split the deployment of your front end and back end with the help of Consumer Driven Contract Testing","path":"/split-frontend-backend-deployment-with-cdcs/","categories":["Testing","Contract Testing","Pact","Continuous Delivery","Jest","CircleCI"],"date":"2019/11/12","draft":false,"description":"By using contract tests, you can build more independent frontend and backends that can be deployed separately. That way, you can get faster feedback","canonical":"https://www.freecodecamp.org/news/split-frontend-backend-deployment-with-cdcs/","image":null}},"related":{"nodes":[{"frontmatter":{"title":"Authorization for a Kotlin Spring backend, using JSON Web Tokens","path":"/authorize-spring-backend-with-jwt-in-kotlin/","date":"2020/03/19"}},{"frontmatter":{"title":"Book Review: The software architect elevator","path":"/book-review-software-architect-elevator/","date":"2020/07/26"}}]},"previous":{"frontmatter":{"title":"Kotlin tapas: Get a taste of Kotlin","path":"/kotlin-tapas-a-taste-of-kotlin/","date":"2019/10/27"}},"next":{"frontmatter":{"title":"Fail a test in Jest if an unexpected network request happens","path":"/jest-fail-test-if-unexpected-network-request-happens/","date":"2019/12/08"}}},"pageContext":{"related":["/book-review-software-architect-elevator/","/authorize-spring-backend-with-jwt-in-kotlin/"],"previous":"/kotlin-tapas-a-taste-of-kotlin/","next":"/jest-fail-test-if-unexpected-network-request-happens/"}},"staticQueryHashes":[],"slicesMap":{}}