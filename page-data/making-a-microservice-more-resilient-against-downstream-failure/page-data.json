{"componentChunkName":"component---src-templates-blog-post-js","path":"/making-a-microservice-more-resilient-against-downstream-failure/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for ThoughtWorks","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"dc781423-968e-5c74-958e-ac322875e47d","html":"<figure class=\"figure figure--right\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/bac49ffc53ee0d99335d4d22563fc285/c6da0/cover.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 46.27659574468085%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAMC/8QAFgEBAQEAAAAAAAAAAAAAAAAAAAME/9oADAMBAAIQAxAAAAG+WclrJj//xAAWEAEBAQAAAAAAAAAAAAAAAAABABD/2gAIAQEAAQUCcIwv/8QAFhEAAwAAAAAAAAAAAAAAAAAAAAES/9oACAEDAQE/AZRKP//EABYRAAMAAAAAAAAAAAAAAAAAAAACE//aAAgBAgEBPwGjFGP/xAAYEAADAQEAAAAAAAAAAAAAAAAAATEgQf/aAAgBAQAGPwLpWV4//8QAGRAAAgMBAAAAAAAAAAAAAAAAABEBEDFR/9oACAEBAAE/IW7QZFiSTB//2gAMAwEAAgADAAAAEHjf/8QAFREBAQAAAAAAAAAAAAAAAAAAAGH/2gAIAQMBAT8Qgg//xAAYEQACAwAAAAAAAAAAAAAAAAAAEQEhUf/aAAgBAgEBPxCxMnQ//8QAHBAAAgEFAQAAAAAAAAAAAAAAAAERECExYaHR/9oACAEBAAE/EFnNrTG2T+odxnT/AP/Z'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Resilience\" title=\"\" src=\"/static/bac49ffc53ee0d99335d4d22563fc285/acb04/cover.jpg\" srcset=\"/static/bac49ffc53ee0d99335d4d22563fc285/bc01b/cover.jpg 188w,\n/static/bac49ffc53ee0d99335d4d22563fc285/bf173/cover.jpg 375w,\n/static/bac49ffc53ee0d99335d4d22563fc285/acb04/cover.jpg 750w,\n/static/bac49ffc53ee0d99335d4d22563fc285/ec605/cover.jpg 1125w,\n/static/bac49ffc53ee0d99335d4d22563fc285/c58a3/cover.jpg 1500w,\n/static/bac49ffc53ee0d99335d4d22563fc285/c6da0/cover.jpg 5231w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>I like thinking about monitoring and <a href=\"../monitoring-alerts-that-dont-suck/\">alerting</a> a lot. <a href=\"../multiwindow-multi-burn-rate-alerts-in-datadog/\">SLOs</a> have been one of my latest obsessions over the past few months.</p>\n<p>However, all these metrics are worthless if left unattended! Worse than worthless. If you have comprehensive alerts that don’t get fixed, you’ll get swamped by a barrage of alerts.</p>\n<p>That’s precisely what I want to talk about. This post covers making services more tolerant against downstream failures, using the wonderful <a href=\"https://resilience4j.readme.io/\" target=\"_blank\" rel=\"noopener noreferrer\">resilience4j</a>.</p>\n<h2>Instability Can Ruin Your Day</h2>\n<p>In my last project, I maintained a service with high visibility. The service didn’t own any data, relying instead on several downstream dependencies. Sadly, these dependencies were very unstable and experienced frequent downtime. The issues propagated to our service, causing errors. It made us look bad. Check these error spikes:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/7f3bcb3cae324c2e4659cb809e83ecb3/e67a8/errors.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 61.170212765957444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAABYlAAAWJQFJUiTwAAABxklEQVR42lWS22sTQRTG9/9/ERF8bxGRWvSpD30RQQXthTRJ20iMoWlis9kkzV6yczuXT2c3KfVjGM5tZs78OIkPYZPnRVFa57wP221dG2OsA6CK53trAAghOOeZOWFm65w0UlXZSQNr9OMJJWaS6MYInuJIiNg5H+9GrAus/QWuM1xmGCz111qHa71ZUDfT26X+XKmnWNYsJBAaZfa+gCXUQR8qfdPHYR8fvq8Pu/J+gIMujm7x9qx6d60HPZyMMMm19EqCBJBhWl9Mw2Buhyu9frC9P743LiZnV1fj4vLe9u/KzqQeDmadu21/5s/uTDfVzsxVThJR2EBSbsjZBkzbkvy3VPZB3dkqUE2IKC/K2jrvfSACINpUNVBElSMqNDRjShXOe9vSFhHvvTxRftLeBkBEz1Ot2dKmEAJ2T+2TQBiPwDy5n/246KTZUleZcAN6r3g4BKKm253aUXB18fIFrBn+Hn8+PZ2nc/r2RSOU9v87JSpqqpJNbvOVeOMeU/a1Of+6ef3KZVP2VXVz/un4aPTxmNZz3izcJlVbufJRhBOQlovSmdwus2BN7DmOU2xAmIXJGDedzsqqiikRYYKwEP2j/RdI867i/q8ZugAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Error Rate\" title=\"\" src=\"/static/7f3bcb3cae324c2e4659cb809e83ecb3/1d69c/errors.png\" srcset=\"/static/7f3bcb3cae324c2e4659cb809e83ecb3/4dcb9/errors.png 188w,\n/static/7f3bcb3cae324c2e4659cb809e83ecb3/5ff7e/errors.png 375w,\n/static/7f3bcb3cae324c2e4659cb809e83ecb3/1d69c/errors.png 750w,\n/static/7f3bcb3cae324c2e4659cb809e83ecb3/78797/errors.png 1125w,\n/static/7f3bcb3cae324c2e4659cb809e83ecb3/aa440/errors.png 1500w,\n/static/7f3bcb3cae324c2e4659cb809e83ecb3/e67a8/errors.png 1740w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <figcaption class=\"figure__caption\">\n  Shit is hitting the fan\n  </figcaption>\n</figure>\n<p>Not only were our users getting a mediocre experience, but our <a href=\"https://github.com/sirech/talks/blob/master/2021-11-devoxx-humane_on_call_alerting_doesnt_have_to_be_painful.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">On-Call</a> rotations were becoming a shitshow. We <em>had</em> to do something about it. It was leading to a dangerous spiral that could only end in burn-out.</p>\n<h2>Enter Resilience4j</h2>\n<p>Our service is written in Java. That makes <code class=\"language-text\">resilience4j</code> a natural fit. In case you don’t know, it’s a library written by Netflix focused on fault tolerance. As a bonus, it’s based on <a href=\"https://www.vavr.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Vavr</a>. Thus, it benefits from things like the <a href=\"../kotlin-either-types-instead-of-exceptions/\">Either type</a> and all that good stuff. It’s right up my alley.</p>\n<p>To prevent the nasty error spikes I showed above, we’re focusing on two things:</p>\n<ul>\n<li>Using resilience operators to make our microservice a better-behaved citizen</li>\n<li>Building a fallback cache to prevent downstream errors from affecting our users</li>\n</ul>\n<h2>Using Resilience Operators</h2>\n<p><code class=\"language-text\">resilience4j</code> provides a bunch of <a href=\"https://resilience4j.readme.io/docs\" target=\"_blank\" rel=\"noopener noreferrer\">operators</a> out of the box that increases the fault tolerance of your remote calls. One big plus of this library is its composability. There’s little difference between using a <a href=\"https://resilience4j.readme.io/docs/retry\" target=\"_blank\" rel=\"noopener noreferrer\">Retry</a> alone or piping other operators like a <a href=\"https://resilience4j.readme.io/docs/circuitbreaker\" target=\"_blank\" rel=\"noopener noreferrer\">CircuitBreaker</a>. I’m not getting into the details of how they work, head over the documentation to get more details.</p>\n<p>If you use <a href=\"https://spring.io/projects/spring-boot\" target=\"_blank\" rel=\"noopener noreferrer\">Spring Boot</a>, there’s support for using annotations. There’s always support for annotations if SpringBoot is involved. Interestingly enough, I feel the annotations create a bit too much duplication. See, I wanted to apply a common set of operators to six or seven remote calls. Annotating the methods and adding the fallbacks led to a messy solution.</p>\n<p>Instead, I built a small abstraction, a <em>FallbackCache</em>. Before we consider the caching part, let’s focus on instantiating these operators. The code is quite declarative:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Retry</span> <span class=\"token function\">getRetry</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MeterRegistry</span> meterRegistry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">RetryRegistry</span> retryRegistry <span class=\"token operator\">=</span> <span class=\"token class-name\">RetryRegistry</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofDefaults</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">TaggedRetryMetrics</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofRetryRegistry</span><span class=\"token punctuation\">(</span>retryRegistry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">bindTo</span><span class=\"token punctuation\">(</span>meterRegistry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> retryRegistry<span class=\"token punctuation\">.</span><span class=\"token function\">retry</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">CircuitBreaker</span> <span class=\"token function\">getCircuitBreaker</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MeterRegistry</span> meterRegistry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">CircuitBreakerRegistry</span> circuitBreakerRegistry <span class=\"token operator\">=</span> <span class=\"token class-name\">CircuitBreakerRegistry</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">ofDefaults</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">TaggedCircuitBreakerMetrics</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">ofCircuitBreakerRegistry</span><span class=\"token punctuation\">(</span>circuitBreakerRegistry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">bindTo</span><span class=\"token punctuation\">(</span>meterRegistry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> circuitBreakerRegistry<span class=\"token punctuation\">.</span><span class=\"token function\">circuitBreaker</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There are a vast amount of settings that you can configure. The default settings work well to get started. On top of that, I’m adding metrics for <a href=\"https://micrometer.io/\" target=\"_blank\" rel=\"noopener noreferrer\">micrometer</a>.</p>\n<h2>Building a Fallback Cache</h2>\n<p>Building resilience operators is only one part of the equation. Yes, we’re retrying failed requests automatically. Thanks to the circuit breaker we won’t <a href=\"https://en.wikipedia.org/wiki/Denial-of-service_attack\" target=\"_blank\" rel=\"noopener noreferrer\">DDOS</a> downstream services. But the user won’t care. As it is, the errors propagate back to them.</p>\n<p>My answer is a fallback cache. The flow is as follows:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/fd7c91df342709089cd09900c79b04a6/7db30/degradation.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 76.59574468085107%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACPklEQVR42oVTa3PaMBDM//9VTafpx0LSdKalkFKMjZFfkvWwrNd2dAECnT40s5blk9a63bs7AAghoVMBVauw2R3xY9+iZCPaMcDYkLcgpQRtJsQYL+trnL/dnRdEHCMhxkQHhRBo2xbGGPR9j311gHMefxpnnrv8mKyFMfbmz0opIslk8zyDc4FD1YALAeccWtXiIA4E69/OEmHXc7wUWzBTUsB5D845+n7AMAxEmvHSfIXSEtM04XH/hIf1R3zYPIBbfk2YMAqJihU4ij28c7CTgVbyBAU7WUg9ohy2sNYS4agEuOQEqSRlQSln1hAC2DBh/bPBaltjvWPY7BjNQjnEEBBCRHARs3Pw3sP7gHBCXmeOi4Z5+JhgZ4fZBYIPCQMfwZoWWmvSNJuSnf7buGh4vuVVCCnFiylIiYyrmg5cjK86RwcbJoKP/pYwb/6+2aIzDAkxn6eSYYyRKVmz2VqMu4LeU0hYsRXefbvH/eo9Cl7cEhozoW5q7PiKbpZiwDQZqJMpWbfZGHTLJyLO+nHNUfOaICeJFFPO69WUnJYYDbpO4dgOYBkdR9uPEFKThhlzirQ362m0gTWWKkArTe7fmCJMwO7QYl/3KJmguWpG6Pmt1YaB023/acp1L/4+3GwJuSyyLGVVQyr9/9bLB2rWIp0CuY9zWnVdU8fkos2ETdejHzjV3p6X+Fw+47n8gkY1t6boyeJltUb/aXEJSCmJbBxHasVgLfhiieB9rioUQ4FFscSyeMRRHi+EvwB7pImi2u/ZFQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Fallback flow\" title=\"\" src=\"/static/fd7c91df342709089cd09900c79b04a6/1d69c/degradation.png\" srcset=\"/static/fd7c91df342709089cd09900c79b04a6/4dcb9/degradation.png 188w,\n/static/fd7c91df342709089cd09900c79b04a6/5ff7e/degradation.png 375w,\n/static/fd7c91df342709089cd09900c79b04a6/1d69c/degradation.png 750w,\n/static/fd7c91df342709089cd09900c79b04a6/78797/degradation.png 1125w,\n/static/fd7c91df342709089cd09900c79b04a6/7db30/degradation.png 1494w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <figcaption class=\"figure__caption\">\n  That's a happy user\n  </figcaption>\n</figure>\n<p>This boils down to three steps:</p>\n<ul>\n<li>Make a call to the downstream service with retries and a circuit breaker</li>\n<li>If the call works, store the result in a cache and return it</li>\n<li>If the call fails, use the cache to serve a fallback so that the user experience isn’t compromised</li>\n</ul>\n<p>Before you ask, caching proactively wasn’t an option as we didn’t have a way to invalidate the cache when the underlying data changed. Anyhow, these three steps map nicely to a class with the following methods:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SyncFallbackCache</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">R</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Cacheable</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractFallbackCache</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">R</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">T</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Supplier</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> keySupplier<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Supplier</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">></span></span> valueSupplier<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">T</span> <span class=\"token function\">getAndCache</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Supplier</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">></span></span> valueSupplier<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">T</span> <span class=\"token function\">getFromCacheOrThrow</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">RuntimeException</span> exception<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Let’s go one by one.</p>\n<h3>Making the Call</h3>\n<p>The fallback cache doesn’t do anything on its own, as it’s rather a wrapper. We use a <a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/function/Supplier.html\" target=\"_blank\" rel=\"noopener noreferrer\">Supplier</a> to pass the operation to perform. We need a key to identify the element in the cache, which uses another supplier for extra flexibility.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">T</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Supplier</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> keySupplier<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Supplier</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">></span></span> valueSupplier<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">Supplier</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> decoratedSupplier <span class=\"token operator\">=</span> <span class=\"token class-name\">Decorators</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofSupplier</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">getAndCache</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> valueSupplier<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">withRetry</span><span class=\"token punctuation\">(</span>retry<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">withCircuitBreaker</span><span class=\"token punctuation\">(</span>cb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decorate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">var</span> key <span class=\"token operator\">=</span> keySupplier<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token class-name\">Try</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofSupplier</span><span class=\"token punctuation\">(</span>decoratedSupplier<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">recover</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>exception<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">getFromCacheOrThrow</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> exception<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We decorate the supplier with our operators. If the call works, we return the result. If not, there’s a <a href=\"https://www.javadoc.io/doc/io.vavr/vavr/0.9.2/io/vavr/control/Try.html\" target=\"_blank\" rel=\"noopener noreferrer\">Try</a> wrapping it that looks for something to serve from the cache. An empty cache means we’re out of options, and we can only propagate the error upstream.</p>\n<h3>Store the Result</h3>\n<p>Whenever we get a valid result, we store it in the cache. Let’s assume that <code class=\"language-text\">valueSupplier.get()</code> returns without any errors:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">T</span> <span class=\"token function\">getAndCache</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Supplier</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">></span></span> valueSupplier<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/*\n    This has the disadvantage that the [get result, cache it] is not atomic. So if two requests try to update the same key at the same time, it might create an undetermined result.\n\n    However, two calls to the same service should return the same value, so we should be able to live with that.\n\n    This is not happening inside the compute method anymore due to problems acquiring the lock that led to significant timeouts.\n   */</span>\n  <span class=\"token keyword\">var</span> result <span class=\"token operator\">=</span> valueSupplier<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token class-name\">Try</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n    cache<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">recover</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> e <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Could not save result to cache\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Cacheable</span><span class=\"token operator\">::</span><span class=\"token function\">data</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This action should be as seamless as possible. We want to avoid blocking anything while we save the data. Moreover, we swallow any error that happens while saving. Failing to save to the cache shouldn’t result in a failed request.</p>\n<h3>Use the Fallback</h3>\n<p>If the supplier didn’t work, our last hope is to find some content in the cache for the associated key. We can show valid, albeit possibly outdated, information to the user. A cache miss ends up with the original exception.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">T</span> <span class=\"token function\">getFromCacheOrThrow</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">RuntimeException</span> exception<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> value <span class=\"token operator\">=</span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  value<span class=\"token punctuation\">.</span><span class=\"token function\">ifPresent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"FallbackCache[%s] got cached value\"</span><span class=\"token punctuation\">,</span> cb<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> value\n      <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Cacheable</span><span class=\"token operator\">::</span><span class=\"token function\">data</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>\n                <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"FallbackCache[%s] got an error without a cached value\"</span><span class=\"token punctuation\">,</span> cb<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                exception\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">throw</span> exception<span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>The Caller’s Perspective</h3>\n<p>As a user, I need to instantiate a <code class=\"language-text\">SyncFallbackCache</code> and call the public method with the operation I want to safeguard.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">SyncFallbackCache</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Collection</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SupplierUserPermission</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> permissions<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token class-name\">Collection</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SupplierUserPermission</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getPermissions</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">int</span> userId<span class=\"token punctuation\">,</span> \n    <span class=\"token keyword\">int</span> supplierId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> permissions<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>\n      <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id:%s;suId:%s\"</span><span class=\"token punctuation\">,</span> userId<span class=\"token punctuation\">,</span> supplierId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> client<span class=\"token punctuation\">.</span><span class=\"token function\">getUserPermissions</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">,</span> supplierId<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">getSupplierUserMyInformation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">getPermissions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As you can see, we don’t need to know about what’s happening underneath. It’s pretty nifty. You could argue that the return type isn’t explicit enough, as the method may throw an exception that’s not part of the signature. An alternative is to model it with an <a href=\"https://www.javadoc.io/doc/io.vavr/vavr/0.10.0/io/vavr/control/Either.html\" target=\"_blank\" rel=\"noopener noreferrer\">Either</a>.</p>\n<h2>Where’s the Cache?</h2>\n<p>I haven’t spoken about the cache. The easiest alternative is using an in-memory cache like <a href=\"https://github.com/ben-manes/caffeine\" target=\"_blank\" rel=\"noopener noreferrer\">Caffeine</a>. Something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">R</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">Cache</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">R</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">cache</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MeterRegistry</span> meterRegistry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">Cache</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">R</span><span class=\"token punctuation\">></span></span> cache <span class=\"token operator\">=</span> <span class=\"token class-name\">Caffeine</span><span class=\"token punctuation\">.</span><span class=\"token function\">newBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">recordStats</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">expireAfterWrite</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Duration</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofHours</span><span class=\"token punctuation\">(</span><span class=\"token number\">24</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">maximumSize</span><span class=\"token punctuation\">(</span><span class=\"token number\">6000</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">CaffeineCacheMetrics</span><span class=\"token punctuation\">.</span><span class=\"token function\">monitor</span><span class=\"token punctuation\">(</span>meterRegistry<span class=\"token punctuation\">,</span> cache<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> cache<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This approach is convenient yet flawed. Our application runs as a container. Every time it’s restarted, the cache is wiped out. It leads to a bad hit rate percentage, which hovered around 65-70%. That’s not great for a cache and still propagates way too many failures to the end-user.</p>\n<p>We switched to a persistent cache based on <a href=\"https://aerospike.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Aerospike</a> to mitigate the problem. <em>SpringBoot</em> has some integrations to make this easier:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">NavigationRepository</span> <span class=\"token keyword\">extends</span>\n    <span class=\"token class-name\">AerospikeRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CachedNavigation</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Value</span>\n<span class=\"token annotation punctuation\">@Document</span><span class=\"token punctuation\">(</span>collection <span class=\"token operator\">=</span> <span class=\"token string\">\"navigation_CachedNavigationMenu\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CachedNavigation</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Cacheable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LegacyNavMenuItem</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token annotation punctuation\">@Id</span>\n  <span class=\"token class-name\">String</span> id<span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LegacyNavMenuItem</span><span class=\"token punctuation\">></span></span> navigation<span class=\"token punctuation\">;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">LegacyNavMenuItem</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> navigation<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Using the cache for failure scenarios means invalidation isn’t that relevant. The persistent cache made a tangible difference that brought our hit rate percentage to the high 90s. That’s a lot better, isn’t it?</p>\n<h2>A Journey With a Happy Ending</h2>\n<p>Was all this effort <em>worth it</em>? Hell, yes. Our error rate went from 2% to 0.03%. We’ve set an SLO for the service’s availability of 99,95%. Our rotations became significantly smoother. I had so much time available that I could write blog posts about it!</p>","frontmatter":{"layout":"post","title":"Making a Microservice More Resilient Against Downstream Failure","path":"/making-a-microservice-more-resilient-against-downstream-failure/","categories":["Software Engineering","Monitoring","DataDog","Netflix","resilience4j"],"date":"2022/05/08","draft":false,"description":"With the help of resilience4j, I've built a fallback cache to significantly increase the fault tolerance of a service with multiple downstream dependencies","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#b88838","images":{"fallback":{"src":"/static/bac49ffc53ee0d99335d4d22563fc285/94b55/cover.jpg","srcSet":"/static/bac49ffc53ee0d99335d4d22563fc285/90f75/cover.jpg 188w,\n/static/bac49ffc53ee0d99335d4d22563fc285/0180d/cover.jpg 375w,\n/static/bac49ffc53ee0d99335d4d22563fc285/94b55/cover.jpg 750w,\n/static/bac49ffc53ee0d99335d4d22563fc285/be5f1/cover.jpg 1500w","sizes":"(min-width: 750px) 750px, 100vw"},"sources":[{"srcSet":"/static/bac49ffc53ee0d99335d4d22563fc285/31934/cover.webp 188w,\n/static/bac49ffc53ee0d99335d4d22563fc285/2ac6c/cover.webp 375w,\n/static/bac49ffc53ee0d99335d4d22563fc285/4179d/cover.webp 750w,\n/static/bac49ffc53ee0d99335d4d22563fc285/f732a/cover.webp 1500w","type":"image/webp","sizes":"(min-width: 750px) 750px, 100vw"}]},"width":750,"height":347.99999999999994}}}}},"related":{"nodes":[{"frontmatter":{"title":"Monitoring Alerts That Don't Suck","path":"/monitoring-alerts-that-dont-suck/","date":"2021/07/02"}},{"frontmatter":{"title":"Synthetic Transactions and Monitoring in Testing","path":"/synthetic-transactions/","date":"2021/09/26"}},{"frontmatter":{"title":"Multiwindow, Multi-Burn-Rate Alerts in DataDog","path":"/multiwindow-multi-burn-rate-alerts-in-datadog/","date":"2022/01/03"}}]},"previous":{"frontmatter":{"title":"Book Review: Site Reliability Workbook","path":"/book-review-site-reliability-workbook/","date":"2022/05/23"}},"next":null},"pageContext":{"related":["/monitoring-alerts-that-dont-suck/","/synthetic-transactions/","/multiwindow-multi-burn-rate-alerts-in-datadog/"],"previous":"/book-review-site-reliability-workbook/","next":null}},"staticQueryHashes":[],"slicesMap":{}}