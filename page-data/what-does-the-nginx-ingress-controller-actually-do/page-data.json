{"componentChunkName":"component---src-templates-blog-post-js","path":"/what-does-the-nginx-ingress-controller-actually-do/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for ThoughtWorks","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"83e77fb1-001a-5d34-8ac9-f9e2092bb0d6","html":"<figure class=\"figure figure--left\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/e1f4332eef160aade85d75fa5de6a3c5/eea4a/traffic-control.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 57.97872340425532%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAABQAB/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQD/2gAMAwEAAhADEAAAAVsMhUiaP//EABsQAAICAwEAAAAAAAAAAAAAAAECAxIAERMh/9oACAEBAAEFAu6X7DUUl0qMZRpfB//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABsQAAIDAAMAAAAAAAAAAAAAAAABAhExEGKB/9oACAEBAAY/AlG9Wk+rotiPeP/EABoQAQADAQEBAAAAAAAAAAAAAAEAESExUZH/2gAIAQEAAT8h4RVgmb3Pom9BsEbbRRHrPUAIT//aAAwDAQACAAMAAAAQZ/8A/8QAGBEAAgMAAAAAAAAAAAAAAAAAACEBETH/2gAIAQMBAT8QVk6j/8QAFxEBAQEBAAAAAAAAAAAAAAAAEQEAIf/aAAgBAgEBPxDoaQhv/8QAHhABAQABAwUAAAAAAAAAAAAAAREAITFBUYGR8PH/2gAIAQEAAT8QEiFSAyaeHGh1qa2uE94wKAom33Gcu7NYdMvfN3JMMohn/9k='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Traffic Control\" title=\"Traffic Control\" src=\"/static/e1f4332eef160aade85d75fa5de6a3c5/acb04/traffic-control.jpg\" srcset=\"/static/e1f4332eef160aade85d75fa5de6a3c5/bc01b/traffic-control.jpg 188w,\n/static/e1f4332eef160aade85d75fa5de6a3c5/bf173/traffic-control.jpg 375w,\n/static/e1f4332eef160aade85d75fa5de6a3c5/acb04/traffic-control.jpg 750w,\n/static/e1f4332eef160aade85d75fa5de6a3c5/ec605/traffic-control.jpg 1125w,\n/static/e1f4332eef160aade85d75fa5de6a3c5/eea4a/traffic-control.jpg 1280w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <figcaption class=\"figure__caption\">\n  The ingress police is watching\n  </figcaption>\n</figure>\n<p>It seems hard to believe, but I had never written about <a href=\"https://kubernetes.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes</a> before. It feels impossible to hold a conversation about technology for more than five minutes without coming to the topic of <em>k8s</em>. Let’s fix that. I have to publish a couple of articles centered around Kubernetes to catch up.</p>\n<p>If you operate a Kubernetes cluster with any significant usage, chances are you’re using <a href=\"https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/\" target=\"_blank\" rel=\"noopener noreferrer\">an Ingress Controller</a>. It just seems the thing to do. I’ve had a thing for <a href=\"/setting-up-traefik/\">Traefik</a> for a while. However, the path of least resistance is to use the <a href=\"https://kubernetes.github.io/ingress-nginx/\" target=\"_blank\" rel=\"noopener noreferrer\">NGINX Ingress Controller</a>. That’s the one I’m familiar with and the one I will be deconstructing in this post.</p>\n<h2>An introduction</h2>\n<p>What is an Ingress Controller? Essentially, it makes connectivity for applications easier. You can have one entrypoint into the cluster and let different applications define the URLs they serve. Moreover, you don’t need to change the controller when you add new applications, keeping the whole thing nicely decoupled.</p>\n<p>It’s pretty easy. For the applications, I mean. The complexity doesn’t disappear, it just moves somewhere else.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/dafa0f8b4370f7ceb57399a19fe1718e/906b5/basics.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.91489361702128%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACxklEQVQoz5WQT0gUARTGv9m2gqAiqCiKyCKpSNc/LGraP2tNzRLbnd2dnVnHmVnX1W3W9U+uO6amRVEUonVI6BJBXTqECFGHIMhLhyKiiAh2Z2ZX61AQYRRUL0alQ3SoBx/v8Hi/930P+KO8ijknLpyGV9HhCxnlvpCheRXjmD+UAisb8Crz+qeyYKxi2BaWoqysk7tJJ6t7FWPcp+hg5fT/AA3GgvIRc5VH0t8H20w6eXrmm3jC/OmRdPKFDOfCMdtfARmx47emeobAyibDylZkc5NHMmabVPPHqXPvvoc7M1/d88Bqa87Kho3L0yAU9VliFjqQnYfZTLHDlm2M28TOlyh2EeqDVqz0JBc2SIyaJERM8iq6HmjRV8rqKzT3TTMBh8YECnvnQHyhNgfFp+ExmLwKw9uKrBADgcGKcsLzKf+ScPz5ereUvuGWUm/dTen7wcibAqLF9kjPi7m4lsPK1c1o3jO82rO9G6KzHzB4FaYQU0xencgI7a4sr+Lm6OjyyyO3lrbEX2O/7zaIyF52fBx85CkGzt5ZfHXkykrgIPy7kms5R/KBb1fiA+dIXg9VDNst2N5sc4Km46cpI3d9fBLTtoIITbZ1zLa6Kuw4Inl31gUf76gT27EbuHf3IaLuM3bLYdDZN6bsHqJYzcWfUtkgBRzJRmQa45XTaj/NdJ+lbCQ5mxJiG6ktCZTWIcfl31Tii3yrCfdQiS9CuTV8RW6tANeBTntr5TmEKoauqdUXKMGOfYm6zpPo7A9D507A5GNdJq8+yggxT0qM4xIfXZRT5ceWKm7DvsbY5/qoRoekDnI0yKVONoza2k47X6SBy0vmcPm9z/x5CeLykxNCUd8yzIR6YPjbkKqXYQZUvBHjoPYBOBpkpqBBxrbqQO32I8HJ3BpeqeCjONqaAK0hCMUaw+X1Qj18cYlUNrjZegFfqOEX4mxBIdO8DfIAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Basic parts\" title=\"Basic parts\" src=\"/static/dafa0f8b4370f7ceb57399a19fe1718e/1d69c/basics.png\" srcset=\"/static/dafa0f8b4370f7ceb57399a19fe1718e/4dcb9/basics.png 188w,\n/static/dafa0f8b4370f7ceb57399a19fe1718e/5ff7e/basics.png 375w,\n/static/dafa0f8b4370f7ceb57399a19fe1718e/1d69c/basics.png 750w,\n/static/dafa0f8b4370f7ceb57399a19fe1718e/906b5/basics.png 950w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <figcaption class=\"figure__caption\">\n  You'll notice that the sum of the three smaller circles is bigger than the original one\n  </figcaption>\n</figure>\n<p>There are three somewhat distinct components involved:</p>\n<ul>\n<li><a href=\"https://www.nginx.com/\" target=\"_blank\" rel=\"noopener noreferrer\">NGINX</a>: Proxies requests to the right application.</li>\n<li><a href=\"https://kubernetes.io/docs/concepts/cluster-administration/networking/\" target=\"_blank\" rel=\"noopener noreferrer\">Ingress</a>: Allows defining endpoints for applications.</li>\n<li><a href=\"https://kubernetes.io/docs/concepts/architecture/controller/\" target=\"_blank\" rel=\"noopener noreferrer\">Controller</a>: Ensures that the ingresses we defined end up configured in NGINX.</li>\n</ul>\n<p>Even though they only make sense together, I find it easier to understand if we consider each part separately.</p>\n<h3>A quick word on tooling</h3>\n<p>There is a <a href=\"https://github.com/kubernetes-sigs/krew\" target=\"_blank\" rel=\"noopener noreferrer\">krew</a> plugin for <code class=\"language-text\">kubectl</code>, called <a href=\"https://kubernetes.github.io/ingress-nginx/kubectl-plugin/\" target=\"_blank\" rel=\"noopener noreferrer\">ingress-nginx</a>. It simplifies interactions significantly. Go get it.</p>\n<h2>NGINX</h2>\n<p>NGINX is the Swiss Army Knife of delivering content. It serves static assets. It works as a reverse proxy. It can be modded with <a href=\"https://blog.cloudflare.com/pushing-nginx-to-its-limit-with-lua/\" target=\"_blank\" rel=\"noopener noreferrer\">Lua</a>. It can probably run on toasters.</p>\n<p>Naturally, there are a million different configuration options. Let’s focus on what we need. We’re using NGINX as a reverse proxy. This means we want to route an HTTP request to an application, based on the domain and the path. We need an entrypoint (a <code class=\"language-text\">server</code>) that can specify URLs, a way of defining downstream applications (an <code class=\"language-text\">upstream</code>), and a connection between the two of them (the <code class=\"language-text\">proxy_pass</code>). A simplified configuration looks like this:</p>\n<!-- nginx-config -->\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token comment\"># The target service</span>\n<span class=\"token directive\"><span class=\"token keyword\">upstream</span> upstream_target</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token directive\"><span class=\"token keyword\">server</span> upstream:4003 max_fails=1 fail_timeout=15s</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\"># Domain under which the service is reachable</span>\n    <span class=\"token directive\"><span class=\"token keyword\">server_name</span> upstream.domain.io</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token comment\"># https is used</span>\n    <span class=\"token directive\"><span class=\"token keyword\">listen</span> <span class=\"token number\">443</span> ssl http2</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">listen</span> [::]:443 ssl http2</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\"># we need a certificate to terminate https</span>\n    <span class=\"token directive\"><span class=\"token keyword\">ssl_certificate</span>           /cert/live/upstream.domain.io/fullchain.pem</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">ssl_certificate_key</span>       /cert/live/upstream.domain.io/privkey.pem</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">ssl_trusted_certificate</span>   /cert/live/upstream.domain.io/chain.pem</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">include</span> /etc/nginx/includes/ssl-settings.conf</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\"># Proxy to the target service</span>\n    <span class=\"token directive\"><span class=\"token keyword\">location</span> ^~ /rest/</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://upstream_target</span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span></span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> Host <span class=\"token variable\">$http_host</span></span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_redirect</span> <span class=\"token boolean\">off</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is not quite the configuration that the Ingress Controller uses. A real one for one of the clusters in my project is 12K lines long. And a lot of calls to Lua functions. For your sanity, start with the simpler example.</p>\n<h3>Checking the actual configuration</h3>\n<p>If you still want to check that monstrous config file, use the plugin I mentioned above:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl ingress-nginx conf --namespace $NAMESPACE --pod $POD > /tmp/nginx.conf</code></pre></div>\n<p>Inspect the dynamically handled backends:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kubectl ingress-nginx backends --namespace $NAMESPACE --pod $POD</code></pre></div>\n<h2>Ingress</h2>\n<p>The <a href=\"https://kubernetes.io/docs/concepts/services-networking/ingress/\" target=\"_blank\" rel=\"noopener noreferrer\">Ingress</a> resource is a way of declaratively defining how to reach an application. On its own, it does nothing. The controller ensures it’s reachable by creating an appropriate NGINX configuration. That configuration points to the <a href=\"https://kubernetes.io/docs/concepts/services-networking/service/\" target=\"_blank\" rel=\"noopener noreferrer\">Service</a> associated with the ingress. I prefer using <a href=\"https://www.terraform.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform</a> for that, though it’s not a requirement.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">variable<span class=\"token type variable\"> \"host\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">default</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"upstream.domain.io\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"kubernetes_ingress\"</span></span> <span class=\"token string\">\"this\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">metadata</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">name</span>      <span class=\"token punctuation\">=</span> var.name\n    <span class=\"token property\">namespace</span> <span class=\"token punctuation\">=</span> var.namespace\n\n    <span class=\"token property\">annotations</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"kubernetes.io/ingress.class\"</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"nginx\"</span>\n      <span class=\"token property\">\"cert-manager.io/cluster-issuer\"</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"letsencrypt\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">spec</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">tls</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">hosts</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span> var.host <span class=\"token punctuation\">]</span>\n      <span class=\"token property\">secret_name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">name</span><span class=\"token punctuation\">}</span></span>-tls\"</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">rule</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">host</span> <span class=\"token punctuation\">=</span> var.host\n\n      <span class=\"token keyword\">http</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">path</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">path</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"/\"</span>\n\n          <span class=\"token keyword\">backend</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">service_name</span> <span class=\"token punctuation\">=</span> var.service_name\n            <span class=\"token property\">service_port</span> <span class=\"token punctuation\">=</span> var.service_port\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Certificates are handled by another controller, the <a href=\"https://cert-manager.io/docs/tutorials/acme/ingress/\" target=\"_blank\" rel=\"noopener noreferrer\">cert-manager</a>.</p>\n<h3>How is the application getting the requests?</h3>\n<p>An Ingress is a nice abstraction, but it looks a bit like magic, doesn’t it? What’s the journey of a request from the beginning until it reaches the application? Let’s go down the rabbit hole.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/3bcd958f569b5d750a3a63a9e1c2dd81/906b5/request-flow.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 87.7659574468085%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD6ElEQVQ4y3WUW2gcZRTHzyRWHwStiqWi0DxUqSAhL6IB86BVKVgExUhpwaYJ2Wiy7cbURo2axKDSCyHbVNekWw1YEks31BZtS9MGTM2lxi6tpCZN1r0kuzuZnd2dvXwz31x3jsxuEhGzB35wGJg/5/+dC8A6gYjQfynLDFwl0DWU2t7zU/oQbB25F3iEyh0NTEVFxX8oLy9nKisrGSgWluDJy9nS70cIfDQg/Og8n8aFsBTCnBKgshJUlP/hVxSFJ4QMryvodruh9vAsAzAIUDX2iHeBziIimhYmYs5K1glN07xwcIcXOnZegY4Xh+AsAMy/u6lkoenx0jvNZQwiMiYiIBpjq/8gYm4V0zRXsb6jqqoTsHdLBBr3n4OvOrvg8+6vwWd7GObfewwiNQyM/uIrseyfHRNuDP0qoq4bxohXwjNjBE2zUKZZwFipcAocTyPY98zA4S/boeOIExZsD1XdbXh0z2LdfZvhCpaMHtm2saWPvWnrFTAuSIbr5xQ6+gWUNRMlQpCkBCSplCGmMyhJdApatt/Z9uHr40+5Jqs3dLa2bpx1PLkQ+PQ5/OuD8hrI20WIJzO/cQliFaHHEsQML6fyhSWXOXP42jJ+ez5mhAIsUpFMwoE3zpS9//bpJwAQOuyNG+7at/zgO/QMO+fY+qr/+ULHdU2ZKjwboqpQVGQpn2fiPDo9MdPRlzD8fg4VKk5D3YGdD9Tuf+3+j4/WQLPdDm27X3qw5a2qMlwZHwsiKtcQUTZNM6aqWkJV9QQi8kmO13xzAfzzts9IsBxmM9kRqG1+BWodL4OjfRe82dAEmz77nbnnEjKuW1jimVCgczDV1ncxGbg6FbIn+UhtKPh3Y3TJ37QUDr8TDUX8fJjFJBsx2CUWQ4HgPrDZbNCwgpXDPgTYi+DyLJYe8wjQ3J/o6ruYRT6t61Yj4wLVY0lq5XqSi5uLQQ5nZjmDj3JIsmQcqqur89TX169hCb+w67hll8lbltTJwhjmcm0DSazr4ZFQDRNsGN0XomZ9r2DcmuHQUMUbRVdv8NTRNUFN08atMUHU9NHbknlugphWpGKcOToZweMe1ggFl1GWyGRRwd4T38CzJ5HZ/AXCJwPxiYNuAeNp1UCUEXUxX2+Ci2M0GMSwb97go8tIiDhV9EC4XC5ovY7Mbg/Cd5fjEycuCChS1WCTOvpZtbCHqoaKrKIsq0Y+V5Tigj09PWuWqZQdV2Rq9UE7NpzOtZ9O5UQ5V9jnwoD+u8vFwul0rgnquvHH6kXx+ihenxGLXZubRQW7u7vXBDOZjJtSOkdleVrKJrximvPKsuKlVPJSSi2mKaWzmUzm1D/OjYohJF/WZQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Request Flow\" title=\"Request Flow\" src=\"/static/3bcd958f569b5d750a3a63a9e1c2dd81/1d69c/request-flow.png\" srcset=\"/static/3bcd958f569b5d750a3a63a9e1c2dd81/4dcb9/request-flow.png 188w,\n/static/3bcd958f569b5d750a3a63a9e1c2dd81/5ff7e/request-flow.png 375w,\n/static/3bcd958f569b5d750a3a63a9e1c2dd81/1d69c/request-flow.png 750w,\n/static/3bcd958f569b5d750a3a63a9e1c2dd81/906b5/request-flow.png 950w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>This is the setup: We have a cluster with a bunch of nodes, with a <em>Load Balancer</em> in front. The NGINX Controller runs as a <em>DaemonSet</em> in every node. Our application is configured as a <em>Deployment</em>. To reach it, there is a <em>Service</em> and an <em>Ingress</em>.</p>\n<p>Let’s assume we start our request from a <a href=\"../understanding-vpc-endpoints/\">VPC Endpoint</a>. What happens next?</p>\n<ul>\n<li>We reach the Load Balancer. As I explained in my article about <a href=\"../provisioning-a-network-load-balancer-with-terraform/\">NLBs</a>, a target group points to individual instances. In this case, the worker nodes of the cluster.</li>\n<li><em>(1st Load Balancing)</em> The Load Balancer picks one of the nodes.</li>\n<li>The request reaches a Node. Through a Service of type <code class=\"language-text\">NodePort</code>, there are <code class=\"language-text\">iptables</code> set up so that the request goes to the right place.</li>\n<li><em>(2nd Load Balancing)</em> <a href=\"https://kubernetes.io/docs/concepts/services-networking/service/#proxy-mode-iptables\" target=\"_blank\" rel=\"noopener noreferrer\">kube-proxy</a> selects one of the instances of the NGINX controller.</li>\n<li>NGINX does its magic, and it forwards the request to the correct Service.</li>\n<li>The Service for the application is of type <code class=\"language-text\">ClusterIP</code>. All the Pods in the Deployment appear as targets.</li>\n<li><em>(3rd Load Balancing)</em> One of the Pods is chosen.</li>\n<li>The application Pod finally receives the request.</li>\n</ul>\n<p>Whew! That was a perilous trip! I got tired by typing all this, and you can argue that I missed many details. Isn’t Kubernetes wonderful? What’s interesting is that will all these routing decisions, you can never guarantee who is going to process or receive a particular request.</p>\n<h2>Controller</h2>\n<p>The <a href=\"https://kubernetes.io/docs/concepts/architecture/controller/\" target=\"_blank\" rel=\"noopener noreferrer\">controller</a> pattern is widely used in the Kubernetes ecosystem. It’s based on the idea of a <em>control loop</em>.</p>\n<ol>\n<li>Figure out the target state, as defined by some resources defined in the cluster</li>\n<li>Determine the current situation</li>\n<li>If 1 and 2 diverge, change the system so that they match</li>\n<li>Repeat the loop</li>\n</ol>\n<p>Coming back to networking, the Ingress Controller handles the relationship between Ingress resources and the NGINX configuration. You declare what you expect to have, and the controller goes to work to morph that into a functioning reverse proxy.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/d560c7be466042e541f880b40979721e/906b5/controller.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 64.36170212765958%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAADd0lEQVQ4y3WSXUybVRjHn0LjzHTKbpALE70z8UITb4w3u/Rmupg4YrwZxAtxCWqimC0gYw1FvjddsTI+VFAGqxGGQYYN0JZ1Gw7aWjvo25a1m+v63b7nvJ/t2/Z9zPvqcDf+kyfn5H+e55fnOecA/CtleBgQEQqIUKpU9P3DGBgaeqKrq+ugyWR6rK/HDNG1RbD9EYVOB1Pb5QoZO52M0exiarTcfSnnzmnFuomUfsjncptcNuspp1JNmjc9NfV4d3f3U6e/6AeYdMGFa27odAXhc2cIOhwMfLLih1ecwiPA3t7/gIS0Fim1Kzy/giz7DpfP652azeYnRxBhFFU4Y3ccancET7SvMy3t60zrx1f9r7ZuZh4BDgzoRSlEAydJ++OyyST4C4UaLWd8bKwOVQlQZl+Ppik7un0XJ3z38MKtGK7upRAlvgOWmj6F5aY2WGlug/ii6yGoJk6pxtA73ohE4Kbfb/hmdLzuXjwDeZZrtC4RHF4gsliqKFWsiipWUSlJY5B0/G6oztiNeNlhxLl1I94I1GqQqCQdYRKJk6FU6oM/RfH5inaPP84e1s7iiXTjd7+xOLPOKYiormxJit0jYoEIFvjryipUJ5cAFzYAZ9cg0HZe7zJfLDoJzyMvyxgThBbN8/q8dQBQu3Pb/54sy5hjRQ1YNV0ipV4bwQdp3gKxHxaf4Sy2PnnylwFpdN6SG7n8FrruQITQl/dyuaPhTOYNDyENRUSYmp4+rCoUsMwfz5AyDs1TddUnY4FK6oOMgGqlaAUST1rE5esozNhR/tmBgjcoUsRnBYHbf5hoOKyvY+PjTyPKoCrkWDxbxM8mctl5N88iVrLlsoIczw9CCdHKeSO483a3EP9qUVUR2baOzhfSstyfIWSvIAjBECHHNODXVmvd7E+/wtzC2oH8/e2G0+cd9dtbm/Uer6/efdPT4L62cUgDWritEN5+86yUvHgVq4jsifdbXkxL0kiO0hgrSXd2M5l3NeCczXbgyGsvwZrbD2IuBCf7NuHGrQDcvxuG3SADPp8PQJblCbWqYjaRwlKxiKqqlmRRfA4pBUwk/hk7lYLG5mb4cnBQ/7PB4C4EGcbQ+63PsOzcMcSiYQPDhAyBQAAgm8028YJwJU/Y7ynHXeIovej1eeuv+/2ATqdBB0Yi8NGpU9Df0wMmk0mP/9PfNGelD4qKAUkAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Controller Loop\" title=\"Controller Loop\" src=\"/static/d560c7be466042e541f880b40979721e/1d69c/controller.png\" srcset=\"/static/d560c7be466042e541f880b40979721e/4dcb9/controller.png 188w,\n/static/d560c7be466042e541f880b40979721e/5ff7e/controller.png 375w,\n/static/d560c7be466042e541f880b40979721e/1d69c/controller.png 750w,\n/static/d560c7be466042e541f880b40979721e/906b5/controller.png 950w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>As mentioned, the output is a gigantic config file. The controller gets notified when an ingress is created, deleted, or changed through a <a href=\"https://pkg.go.dev/k8s.io/client-go/informers#NewFilteredSharedInformerFactory\" target=\"_blank\" rel=\"noopener noreferrer\">Kubernetes informer</a>.</p>\n<h2>What did we learn?</h2>\n<p>The NGINX Ingress Controller is a surprisingly complicated piece of software. <a href=\"https://docs.nginx.com/nginx-ingress-controller/installation/installation-with-helm/#configuration\" target=\"_blank\" rel=\"noopener noreferrer\">Look</a> at all the configuration parameters of the helm chart. And it’s no surprise. It’s a complex NGINX proxy, a control loop written in golang, and a connector of all these different networking pieces. I’ve used it for a while without really understanding what it does. It’s definitely worth spending some time on the details.</p>\n<p><em>Thanks to Donald for the feedback.</em></p>","frontmatter":{"layout":"post","title":"So, what does the NGINX ingress controller actually do?","path":"/what-does-the-nginx-ingress-controller-actually-do/","categories":["Kubernetes","Ingress","NGINX"],"date":"2021/01/30","draft":false,"description":"If you run a lot of applications in a Kubernetes cluster, you probably use an Ingress controller. Let's dive into how it actually works","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/e1f4332eef160aade85d75fa5de6a3c5/bd8e5/traffic-control.jpg","srcSet":"/static/e1f4332eef160aade85d75fa5de6a3c5/f7322/traffic-control.jpg 188w,\n/static/e1f4332eef160aade85d75fa5de6a3c5/86c15/traffic-control.jpg 375w,\n/static/e1f4332eef160aade85d75fa5de6a3c5/bd8e5/traffic-control.jpg 750w","sizes":"(min-width: 750px) 750px, 100vw"},"sources":[{"srcSet":"/static/e1f4332eef160aade85d75fa5de6a3c5/fb511/traffic-control.webp 188w,\n/static/e1f4332eef160aade85d75fa5de6a3c5/b7848/traffic-control.webp 375w,\n/static/e1f4332eef160aade85d75fa5de6a3c5/bf0cd/traffic-control.webp 750w","type":"image/webp","sizes":"(min-width: 750px) 750px, 100vw"}]},"width":750,"height":435}}}}},"related":{"nodes":[{"frontmatter":{"title":"Setting up Traefik","path":"/setting-up-traefik/","date":"2018/08/16"}},{"frontmatter":{"title":"Provisioning a Network Load Balancer with Terraform","path":"/provisioning-a-network-load-balancer-with-terraform/","date":"2020/11/17"}},{"frontmatter":{"title":"Provisioning an Application Load Balancer with Terraform","path":"/provisioning-an-application-load-balancer-with-terraform/","date":"2021/01/02"}}]},"previous":{"frontmatter":{"title":"Book Review: Designing Data-Intensive Applications","path":"/book-review-designing-data-intensive-applications/","date":"2022/03/07"}},"next":{"frontmatter":{"title":"Be a good Kubernetes citizen and use Pod Disruption Budgets","path":"/be-a-good-k8s-citizen-with-pod-disruption-budgets/","date":"2021/02/18"}}},"pageContext":{"related":["/provisioning-a-network-load-balancer-with-terraform/","/setting-up-traefik/","/provisioning-an-application-load-balancer-with-terraform/"],"previous":"/book-review-designing-data-intensive-applications/","next":"/be-a-good-k8s-citizen-with-pod-disruption-budgets/"}},"staticQueryHashes":[]}