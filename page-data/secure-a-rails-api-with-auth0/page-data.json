{"componentChunkName":"component---src-templates-blog-post-js","path":"/secure-a-rails-api-with-auth0/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for ThoughtWorks","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"bf654b7b-3c1e-5e9c-be4d-c94a08143497","html":"<figure class=\"figure figure--left\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 588px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/bcba8b98d6e5a2b4686f581e1e16e388/9bbaf/cover.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 89.89361702127661%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsTAAALEwEAmpwYAAACdklEQVR42p2QT0zTUBzHe5on06HrNvq6tX2DrRqxxXWSre2vbwkw2NqxItw9qeGA8aQmHoweNMZ4M8YEEq4ejBhj1AiKAaPESDRRI8qYgv8OxMSTfy41qwxEnBo/+R7e+73v9/1++VEAYJr/LnPlDABU3TAA8WTCX8JrIKaZhep7mkC6mq5ezVp0hV87gwnEq6rEyAL0ZUhfhmQNSBEDlkf4w9gAhlc9vT33iC8ucE456kw1FY8rnQBggPd1vTCYoAOMNue/BJylxt5FtlQO5Oc2d1fY4vDWLh2Mup2zYCaJfqql8zPjLHBOJWTPoZ5Kx/4X+QMPY85Tzj7c2pEiBoHfhavzGDATtZcaeyvhYpnf9fHcpa+vP7w9NvwY9kyz+YvxghdZt20CZtqE/jSZ50qLnPMyZL0bPOO67uKR8/c2mnd5a5K3rwmFnjTJmECgtm1N03RdNzR9p55x2ozZSKnClZ6x9qcb067rPukanGK77+CeW1HrslAotOltumboVTRNo1RVTXmoKTWVTE6K1nzYniUD394vua77fN+JiVDnTdEei1gjOJdKJlf9qkrJsqx47JCVJnnboYQxj0oPmntfnRx5MzQ603/wemPuCl8Yi1p7pUxCaWldtiuyLFOSJG2pIUmJuJQ4i7OzkdL9Te0T/ux4ODcetW9Hi0cxxBPxtWaJwhjHYjVhzGNREMUBQb2Ac1exNcrnh/j23UJSEAVeFGM/mTHGFGIRh7gfQoiLII5FiGZDiGUVJCpIRCzbgMIsWrXVzIhiGCa4jlAwGGAYPxPwM4EAw4S8IhNc42QYhqJp2l+HBk/1oGma8vl8G/4Ln8/3HfcXCp9RghyoAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Ruby on Rails\" title=\"\" src=\"/static/bcba8b98d6e5a2b4686f581e1e16e388/9bbaf/cover.png\" srcset=\"/static/bcba8b98d6e5a2b4686f581e1e16e388/4dcb9/cover.png 188w,\n/static/bcba8b98d6e5a2b4686f581e1e16e388/5ff7e/cover.png 375w,\n/static/bcba8b98d6e5a2b4686f581e1e16e388/9bbaf/cover.png 588w\" sizes=\"(max-width: 588px) 100vw, 588px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>If you want to expose an API publicly on the Internet, authorization will be a requirement for you sooner or later. You want to verify that the client consuming the API has the appropriate permissions.</p>\n<p>This guide is exactly about that. We’ll be securing an API written using <a href=\"https://rubyonrails.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Ruby On Rails</a>, with <a href=\"https://auth0.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Auth0</a> as the authorization server.</p>\n<p>There’s a repository with the code so that you can follow along in <a href=\"https://github.com/sirech/example-jwt-validation-rails\" target=\"_blank\" rel=\"noopener noreferrer\">Github</a>.</p>\n<h2>Securing an API</h2>\n<p>I didn’t explain what I mean by securing an API yet. Essentially, we’re ensuring that protected routes are accessible only for the users with enough rights.</p>\n<p>When it comes to security, it’s generally considered a bad idea to roll your own bespoke implementation. Instead, I’m using <a href=\"https://auth0.com/docs/protocols/protocol-oauth2\" target=\"_blank\" rel=\"noopener noreferrer\">OAuth</a>, a battle-tested and widely used authorization framework for web applications.</p>\n<p>In this context, Auth0 fulfills the role of the <em>Authorization Server</em> and abstracts a significant part of the work away from us. That way, we can focus on delivering value to our users.</p>\n<p>Without getting into too many details on how OAuth works, we assume that calls to our API will include a bearer token, using the industry-standard <a href=\"https://jwt.io/\" target=\"_blank\" rel=\"noopener noreferrer\">JWT</a> format. The token contains a series of claims regarding the its issuer, how long is it valid, and what rights are granted by it. Let’s have a look at a sample token:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"iss\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://yourTenant.eu.auth0.com/\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"sub\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"zHwnsh0j2sTj4u3ss6YedSFrzyb2\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"aud\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://targetAudience.com\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"iat\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1621369130</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"exp\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1791455530</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"azp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ThEkgdG1NndLlWoNMcEdEr2KJIs9vKad\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scope\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"openid profile read:admin-messages\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"permissions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"read:admin-messages\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We’re going to implement verification for that token, and reject requests that don’t have the required permissions.</p>\n<h2>Getting Started</h2>\n<p>We’re getting started with our base application, bootstrapped with Rails 6. This <a href=\"https://github.com/sirech/example-jwt-validation-rails/tree/starter\" target=\"_blank\" rel=\"noopener noreferrer\">branch</a> is a good starting point. You can download it by running the following command in a terminal window:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">git</span> clone <span class=\"token parameter variable\">-b</span> starter --single-branch https://github.com/sirech/example-jwt-validation-rails.git</code></pre></div>\n<p>The API has three endpoints with different levels of protection:</p>\n<ul>\n<li><code class=\"language-text\">/api/messages/public</code>: Public route.</li>\n<li><code class=\"language-text\">/api/messages/protected</code>: Requires a valid access token.</li>\n<li><code class=\"language-text\">/api/messages/admin</code>: Requires a valid access token. Since Auth0 uses JWT as its access token format, we can inspect it and make sure it has a <code class=\"language-text\">permissions</code> claim that contains the scope <code class=\"language-text\">read:admin-messages</code>.</li>\n</ul>\n<h3>Running the Application</h3>\n<p>To run the application, we first need the correct ruby version. The easiest way to do so is to use a version manager like <a href=\"https://github.com/rbenv/rbenv\" target=\"_blank\" rel=\"noopener noreferrer\">rbenv</a>. Once you install it, run this command inside the repository to install the right version of ruby:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">rbenv <span class=\"token function\">install</span></code></pre></div>\n<p>Install the dependencies for the application:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">bundle <span class=\"token function\">install</span></code></pre></div>\n<p>And finally, run the application:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">bin/rails s</code></pre></div>\n<p>You can verify that the application is working correctly with <code class=\"language-text\">curl</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">curl</span> localhost:6060/api/messages/public</code></pre></div>\n<p>The command will return a 200 code, plus the message:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span><span class=\"token property\">\"message\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"The API doesn't require an access token to share this message.\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Creating an API on Auth0</h3>\n<p>To secure the API with Auth0, you need an Auth0 account. If you haven’t one, you can <a href=\"https://auth0.com/signup\" data-amp-replace=\"CLIENT_ID\" data-amp-addparams=\"anonId=CLIENT_ID(cid-scope-cookie-fallback-name)\">sign up for free</a> right now. In the <em>APIs</em> section of the <a href=\"https://manage.auth0.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Auth0 dashboard</a>, click <em>Create API</em>. Provide a name and an identifier for your API. You will use the identifier as an <code class=\"language-text\">audience</code> later, when you are configuring the access token verification. Leave the <em>Signing Algorithm</em> as RS256.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/2e8975e4dc9a1ac72728fdb559f9af02/baae1/create-api.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 71.27659574468085%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACNElEQVR42p2Sy08UMRjAe+JPMPFgIicTDxAf/yNeTThMSIhZkHgzPFYPcpaAxAPsDGx0d0ZDgF12Hu10pu1MH5/56spD2Yud/NJO2+/3fW1KPm28fxAef17uD7+t/Dw7C84vzoMfSRJEURQMh8MgTpIgjuOZJEkS9Pv9lYODg9e7u7sPydu19cWr0SVkeQYZzSHNUrgaj2E8GgEtCuBleU3J2O/xtPf/jAGjFEYXF/Ch231J1jqdhTLPpeDc1KxsZV1rZ60G57S1VjvntBTCg/PWGA9+oqp0xVgrq8rQLCt3NjefkfVOZ4HmeVuXJVSMOVnXDgCctdZjjHFaaz/+u+FenqWuzjPIx2Oxs7393AtZlt0WAjajNTRNAyXOVxUYY8Bae4NzgHt5kTtBKRSTK7GztTUV3q3QC6WUXog9Ctu2BefcHSnuxRjBORRpeiOk91SIDSVFUXgopcAY83LOuU+mUEipF+aTyWwhHk+3LWitfYVKNSCV8glmVZjfrvD6yJQ6zIrBWIlSyt+hUdKjplegpvKZwllHxotvmwbOSuVxt6rz9zxLWKRpgwucUiM4t0ZrqzU+N2PREsTSLg+lBWf83B9wL8ZgMflkUvl3+G5jYxEztFJ6GiFAIXV9jRE1GCn82n1gXFkU5mO3+4K8Wlp6sr+3d/Jlfz/+eng4iHq9QXh87Dnp9QanYTg4CUPfn0bRv4Th934UxeHRUe/N6upTQgiZI4Q8IoTME0Ie/yfzU8fcL7YkrQflDKgOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Create the API\" title=\"\" src=\"/static/2e8975e4dc9a1ac72728fdb559f9af02/1d69c/create-api.png\" srcset=\"/static/2e8975e4dc9a1ac72728fdb559f9af02/4dcb9/create-api.png 188w,\n/static/2e8975e4dc9a1ac72728fdb559f9af02/5ff7e/create-api.png 375w,\n/static/2e8975e4dc9a1ac72728fdb559f9af02/1d69c/create-api.png 750w,\n/static/2e8975e4dc9a1ac72728fdb559f9af02/78797/create-api.png 1125w,\n/static/2e8975e4dc9a1ac72728fdb559f9af02/aa440/create-api.png 1500w,\n/static/2e8975e4dc9a1ac72728fdb559f9af02/baae1/create-api.png 2424w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>Once you’ve created the API. Go to the <em>Permissions</em> tab in the API details and add a permission called <code class=\"language-text\">read:admin-messages</code>.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/41c5d99a5b694e1fc3473ca02464396c/e8649/configure-permissions.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.85106382978723%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABgklEQVR42o1Sa2/CMAzsLx7jORCwCe1fsk8UGBv0QRKapG2Sm2ygFLRJs2Q1je3zneNoOl9g/vaO6WyBzvOI/akz5G+vP0FvMEG3N25i5N3+GMOXGUbjOQajKQbDKfqDCUbjV0RSWpyUQ9uqqoa1FlVVQWuDEAL+a5HWVFTBe4cQPJxzSLMc3997rFYxlssPrOIYQiqcTgUKreG95ybeB/gQbmfvEQkhkSQJpKREcJCYXYucA7stLaRU0MZwrHZnVeECePUoy3JkWYI4LqALToG1JcqyhDEWSpF0z8X0TwqY0QNQAyiEQJpmDEBGBfF6gzheY7PZsuf5kePEjPwvY8A0TUEs2/RpViTPudtjERDdKaVQ13UzEvKyrBpCDLjbfTUXlEgN9ocD9vuzkwICp8Ffc9oy28wjKtxuP7nrNfl4FDgKASkln2ksWmue4aPk9kqx5DzPURTFXVAqBXr9ur7fT2MM7+Xj6/KrXwhF1JkAXWsNCMhYy2NoF7aZ/CaZGP4AUzI+vaq5qWcAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Configure Permissions\" title=\"\" src=\"/static/41c5d99a5b694e1fc3473ca02464396c/1d69c/configure-permissions.png\" srcset=\"/static/41c5d99a5b694e1fc3473ca02464396c/4dcb9/configure-permissions.png 188w,\n/static/41c5d99a5b694e1fc3473ca02464396c/5ff7e/configure-permissions.png 375w,\n/static/41c5d99a5b694e1fc3473ca02464396c/1d69c/configure-permissions.png 750w,\n/static/41c5d99a5b694e1fc3473ca02464396c/78797/configure-permissions.png 1125w,\n/static/41c5d99a5b694e1fc3473ca02464396c/aa440/configure-permissions.png 1500w,\n/static/41c5d99a5b694e1fc3473ca02464396c/e8649/configure-permissions.png 2968w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<blockquote>\n<p><strong>Note</strong>: While you are in the Auth0 Dashboard, take note of your Auth0 domain. You will need it soon. This is a string in the form <code class=\"language-text\">YOUR-TENANT-NAME.auth0.com</code> where <code class=\"language-text\">YOUR-TENANT-NAME</code> is the name you provided when you created your account with Auth0. For more information, <a href=\"https://auth0.com/docs/getting-started/the-basics#domains\" target=\"_blank\" rel=\"noopener noreferrer\">check the documentation</a>.</p>\n</blockquote>\n<h2>Preparing the Application for Validation</h2>\n<p>Alright, our application is ready to go and in dire need of some <em>security</em>. Before that, we need to add some configuration.</p>\n<p>You dutifully stored the <code class=\"language-text\">domain</code> and the <code class=\"language-text\">audience</code> after creating the API, right? Let’s use them. In the <em>Rails</em> world, the convention is to add this in the <code class=\"language-text\">config</code> folder, using <a href=\"https://yaml.org/\" target=\"_blank\" rel=\"noopener noreferrer\">YAML</a>. The file is called <code class=\"language-text\">config/auth0.yml</code>.</p>\n<p>We don’t want to store credentials in our code, so we’ll export the values as environment variables, named <code class=\"language-text\">AUTH0_DOMAIN</code> and <code class=\"language-text\">AUTH0_AUDIENCE</code>. The configuration uses those values, and keeps them safely away from source control!</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">development</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">issuerUri</span><span class=\"token punctuation\">:</span> &lt;%= ENV<span class=\"token punctuation\">[</span><span class=\"token string\">\"AUTH0_DOMAIN\"</span><span class=\"token punctuation\">]</span> %<span class=\"token punctuation\">></span>\n  <span class=\"token key atrule\">audience</span><span class=\"token punctuation\">:</span> &lt;%= ENV<span class=\"token punctuation\">[</span><span class=\"token string\">\"AUTH0_AUDIENCE\"</span><span class=\"token punctuation\">]</span> %<span class=\"token punctuation\">></span></code></pre></div>\n<p>Now, set <code class=\"language-text\">AUTH0_DOMAIN</code> and <code class=\"language-text\">AUTH0_AUDIENCE</code> environment variables to the <code class=\"language-text\">domain</code> and <code class=\"language-text\">audience</code> values for your API.</p>\n<p>With this, the application is ready to connect with Auth0. Let’s move on to the implementation.</p>\n<h2>Validating the Access Token</h2>\n<p>Before we get started, let’s talk for a second about authentication frameworks for rails. There are a bunch of alternatives in the ecosystem, such as <a href=\"https://github.com/CanCanCommunity/cancancan\" target=\"_blank\" rel=\"noopener noreferrer\">CanCanCan</a>, or <a href=\"https://github.com/heartcombo/devise\" target=\"_blank\" rel=\"noopener noreferrer\">devise</a>.</p>\n<p>However, our case is an awkward fit for those. We don’t want to take over user management. We only want to validate tokens issued by the authorization server. In this case, using a framework won’t bring us as much benefit as something like, say, <a href=\"https://spring.io/projects/spring-security\" target=\"_blank\" rel=\"noopener noreferrer\">Spring Security</a>. That’s why we only rely on an extra gem, <a href=\"https://github.com/jwt/ruby-jwt\" target=\"_blank\" rel=\"noopener noreferrer\">jwt</a>.</p>\n<p>The code implementing the authorization check lives in the <a href=\"https://github.com/sirech/example-jwt-validation-rails/tree/add-authorization\" target=\"_blank\" rel=\"noopener noreferrer\">add-authorization</a> branch. Let’s see how it works!</p>\n<h3>Utilizing the JWT Library</h3>\n<p>The <code class=\"language-text\">jwt</code> library brings a whole lot of functionality to make our API able to validate and manage tokens in JWT formats as the ones issued by Auth0. We need to do three things:</p>\n<ul>\n<li>We need to fetch the <a href=\"https://auth0.com/docs/tokens/json-web-tokens/json-web-key-sets\" target=\"_blank\" rel=\"noopener noreferrer\">JWKS</a> configuration from <em>Auth0</em>, so that we know what is the public key to verify the access token signature</li>\n<li>With the public key, the issuer, and the audience, we want to verify the token</li>\n<li>After verifying the token, we’re decoding it to access the <code class=\"language-text\">permissions</code> claim (or any other information contained in the token, really)</li>\n</ul>\n<h3>Decoding the Token</h3>\n<p>Let’s get down to business. We’re implementing the verification/decoding logic in the <code class=\"language-text\">lib</code> folder, in a file called <code class=\"language-text\">json_web_token.rb</code>. We’re starting by fetching the <em>JWKS</em> data:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># lib/json_web_token.rb</span>\n<span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">'jwt'</span></span>\n<span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">'net/http'</span></span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">JsonWebToken</span>\n  <span class=\"token keyword\">class</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token keyword\">self</span>\n    <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">algorithm</span></span>\n      <span class=\"token string-literal\"><span class=\"token string\">'RS256'</span></span>\n    <span class=\"token keyword\">end</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">key</span></span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">)</span>\n      jwks_hash<span class=\"token punctuation\">[</span>header<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'kid'</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">end</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">jwks_hash</span></span>\n      jwks_raw <span class=\"token operator\">=</span> Net<span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">HTTP</span><span class=\"token punctuation\">.</span>get <span class=\"token constant\">URI</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"</span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">issuer</span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">.well-known/jwks.json\"</span></span><span class=\"token punctuation\">)</span>\n      jwks_keys <span class=\"token operator\">=</span> <span class=\"token builtin\">Array</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span>parse<span class=\"token punctuation\">(</span>jwks_raw<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'keys'</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n      jwks_keys<span class=\"token punctuation\">.</span>map <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>k<span class=\"token operator\">|</span>\n        <span class=\"token punctuation\">[</span>\n          k<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'kid'</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n          OpenSSL<span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">X509</span><span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Certificate</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span>Base64<span class=\"token punctuation\">.</span>decode64<span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'x5c'</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>public_key\n        <span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">end</span><span class=\"token punctuation\">.</span>to_h\n    <span class=\"token keyword\">end</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">issuer</span></span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"https://</span><span class=\"token interpolation\"><span class=\"token delimiter punctuation\">#{</span><span class=\"token content\">Rails<span class=\"token punctuation\">.</span>application<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">.</span>auth0<span class=\"token punctuation\">.</span>issuerUri</span><span class=\"token delimiter punctuation\">}</span></span><span class=\"token string\">/\"</span></span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>As you can see, through the <code class=\"language-text\">issuerUri</code> we know where to look for the data. Then, we parse the key so that we can consume it in the library.</p>\n<p>The next step is to add an extra method to the class, <code class=\"language-text\">verify</code>, that verifies and decodes the token at the same time:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># lib/json_web_token.rb</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">JsonWebToken</span>\n  <span class=\"token keyword\">class</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token keyword\">self</span>\n    <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">verify</span></span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span>\n      <span class=\"token constant\">JWT</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nil</span><span class=\"token punctuation\">,</span>\n                 <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># Verify the signature of this token</span>\n                 <span class=\"token symbol\">algorithm</span><span class=\"token operator\">:</span> algorithm<span class=\"token punctuation\">,</span>\n                 <span class=\"token symbol\">iss</span><span class=\"token operator\">:</span> Rails<span class=\"token punctuation\">.</span>application<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">.</span>auth0<span class=\"token punctuation\">.</span>issuerUri<span class=\"token punctuation\">,</span>\n                 <span class=\"token symbol\">verify_iss</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n                 <span class=\"token symbol\">aud</span><span class=\"token operator\">:</span> Rails<span class=\"token punctuation\">.</span>application<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">.</span>auth0<span class=\"token punctuation\">.</span>audience<span class=\"token punctuation\">,</span>\n                 <span class=\"token symbol\">verify_aud</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>header<span class=\"token operator\">|</span>\n        key<span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">end</span>\n    <span class=\"token keyword\">end</span>\n    \n    <span class=\"token comment\"># ... existing code ...</span>\n    \n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>This is all the code that we need for the actual verification. Neat, isn’t it? But our controllers are still insecure. Not for long, though.</p>\n<h2>Protecting the Endpoints</h2>\n<p>To make it as convenient as possible, we’re creating a hook that we’re going to run before any route that needs authentication. To make it available for every controller, it lives in the <code class=\"language-text\">app/controllers/application_controller.rb</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># app/controllers/application_controller.rb</span>\n<span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">'json_web_token'</span></span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ApplicationController</span> <span class=\"token operator\">&lt;</span> ActionController<span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">API</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">authorize</span></span><span class=\"token operator\">!</span>\n    valid<span class=\"token punctuation\">,</span> result <span class=\"token operator\">=</span> verify<span class=\"token punctuation\">(</span>raw_token<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    head <span class=\"token symbol\">:unauthorized</span> <span class=\"token keyword\">unless</span> valid\n\n    <span class=\"token variable\">@token</span> <span class=\"token operator\">||=</span> result\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">private</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">verify</span></span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span>\n    payload<span class=\"token punctuation\">,</span> <span class=\"token operator\">=</span> JsonWebToken<span class=\"token punctuation\">.</span>verify<span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">[</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> payload<span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">rescue</span> <span class=\"token constant\">JWT</span><span class=\"token double-colon punctuation\">::</span>DecodeError <span class=\"token operator\">=></span> e\n    <span class=\"token punctuation\">[</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">raw_token</span></span><span class=\"token punctuation\">(</span>headers<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> headers<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'Authorization'</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">.</span>last <span class=\"token keyword\">if</span> headers<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'Authorization'</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>present<span class=\"token operator\">?</span>\n\n    <span class=\"token keyword\">nil</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>We take the token from the standard <em>Authorization</em> header. Then, we verify it with the code from the previous section. There are two possible paths after running <code class=\"language-text\">authorize!</code>:</p>\n<ul>\n<li>If the token isn’t there, or it’s invalid for any reason, the processing stops right there, and the call returns a 401</li>\n<li>If the token is valid, we continue the execution and store the token in <code class=\"language-text\">@token</code> so that it’s available</li>\n</ul>\n<p>We’re protecting both the <code class=\"language-text\">protected</code> and the <code class=\"language-text\">admin</code> routes with this hook, thanks to <a href=\"https://api.rubyonrails.org/v6.1.4/classes/AbstractController/Callbacks/ClassMethods.html#method-i-before_action\" target=\"_blank\" rel=\"noopener noreferrer\">before_action</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># app/controllers/api/messages_controller.rb</span>\n<span class=\"token keyword\">module</span> <span class=\"token class-name\">Api</span>\n  <span class=\"token keyword\">class</span> <span class=\"token class-name\">MessagesController</span> <span class=\"token operator\">&lt;</span> ApplicationController\n    before_action <span class=\"token symbol\">:authorize!</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">except</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">%i[public]</span></span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<h3>Custom Error Messages</h3>\n<p>Don’t you feel better knowing that the application is not exposing private stuff anymore? I definitely do. But we got to help our users. A blank 401 message might not give them enough information to debug the issue. Let’s extend the hook to return something more explicit:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># app/controllers/application_controller.rb</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ApplicationController</span> <span class=\"token operator\">&lt;</span> ActionController<span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">API</span>\n   <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">authorize</span></span><span class=\"token operator\">!</span>\n     valid<span class=\"token punctuation\">,</span> result <span class=\"token operator\">=</span> verify<span class=\"token punctuation\">(</span>raw_token<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n     <span class=\"token comment\"># 👇 old code</span>\n     <span class=\"token comment\"># head :unauthorized unless valid</span>\n     <span class=\"token comment\"># 👇 new code</span>\n     render json<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token symbol\">message</span><span class=\"token operator\">:</span> result <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span>to_json<span class=\"token punctuation\">,</span> <span class=\"token symbol\">status</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:unauthorized</span> <span class=\"token keyword\">unless</span> valid\n\n     <span class=\"token variable\">@token</span> <span class=\"token operator\">||=</span> result\n   <span class=\"token keyword\">end</span></code></pre></div>\n<p>Now we get a message that’s more helpful than an HTTP code without a body.</p>\n<h2>Testing the Protected Endpoints</h2>\n<p>Let’s test the protected endpoint:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">curl</span> localhost:6060/api/messages/protected</code></pre></div>\n<p>The command will return a 401, because we’re not authorized. We need to get a valid token from Auth0.</p>\n<p>The simplest way is to access the <a href=\"https://manage.auth0.com/#/apis\" target=\"_blank\" rel=\"noopener noreferrer\">API section of your Auth0 Dashboard</a> again, select the API that you created before and click the <em>Test</em> tab. In this section, you can get a temporary token to test your Web API by clicking the <em>Copy Token</em> icon as shown in the following picture:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/36856b8a44f677802262d5736ff93d42/89896/copy-token.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.85106382978723%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB1klEQVR42o1S20obURQ9/9N3UxQpVqYoiL/QPjWNgjWNfRCh1TSUaKuoRXMx3t58qIL4BwULYsyk9q0t1BtmZmLG1MzFuWXJ2WPURCtuWOw5s9dZe2avzVLpJcwm5pFIZuowNZ3A+MQXwuTUDJKpG5yEn9Nzi8jML2Mus4RUeoEycxz8N2zbhqZp0HUdDw2mqqcolcowTQeu68JxXDiuS2L87HkewTRNVCoa1W2bcxx65pybYKpagiSp0DWPOlSrVcq8UaEgQZJkSLJMZ1lWoJ6W4bp+Ey5Q4/PMwYrFExiGXveSh2EYKJf/wbIswn1Ru0O/rChFnJ1Vbgn++v0HW9kcdvK72BZ/YGtHvEI2JyIn5pHf/YmSqtaJMkVRaPCNgoPvRxB4KuBJVzdaO7vQLHQg0CagqU3A4/ZnaBE68SjQjNX1DeI7l+4yTdNpFo2CfF5/9/ZxcHSE/YNDwvFxAbKi0Ewl2c+6btR/YaNYrTA9m8SLYA9C4QEEX4fxsq8fwf43CIUjeBWOoCfyFs9Dvfi2+Z34NYMYX4+7BFe+rmFoJIbhj3G8i8URjX9GND52hQ+jnzAUjSEr5n1Bz98SxpfWsmxUG9zizpqGSbXz8/td9rzrlbsAEcEO73fz9JAAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Test Token\" title=\"\" src=\"/static/36856b8a44f677802262d5736ff93d42/1d69c/copy-token.png\" srcset=\"/static/36856b8a44f677802262d5736ff93d42/4dcb9/copy-token.png 188w,\n/static/36856b8a44f677802262d5736ff93d42/5ff7e/copy-token.png 375w,\n/static/36856b8a44f677802262d5736ff93d42/1d69c/copy-token.png 750w,\n/static/36856b8a44f677802262d5736ff93d42/78797/copy-token.png 1125w,\n/static/36856b8a44f677802262d5736ff93d42/aa440/copy-token.png 1500w,\n/static/36856b8a44f677802262d5736ff93d42/89896/copy-token.png 2966w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>Let’s attach the token to the request:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">TOKEN</span><span class=\"token operator\">=</span>the-test-token\n<span class=\"token function\">curl</span> localhost:6060/api/messages/protected <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$TOKEN</span>\"</span></code></pre></div>\n<p>The request works now!</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span><span class=\"token property\">\"message\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"The API successfully validated your access token.\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Checking for permissions</h2>\n<p>There’s one requirement pending. As you might recall, for <code class=\"language-text\">/api/messages/admin</code> a valid token isn’t enough. Rather, we expect the correct permission in the <code class=\"language-text\">permissions</code> claim. This extra check allows us to define more granular access criteria for our endpoints. This functionality is implemented in the <a href=\"https://github.com/sirech/example-jwt-validation-rails/tree/add-rbac\" target=\"_blank\" rel=\"noopener noreferrer\">add-rbac</a> branch.</p>\n<p>We’re adding a new method in the <code class=\"language-text\">application_controller</code>, <code class=\"language-text\">check_permissions</code>. It takes the decoded token and looks for a given permission:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># app/controllers/application_controller.rb</span>\n<span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">'json_web_token'</span></span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ApplicationController</span> <span class=\"token operator\">&lt;</span> ActionController<span class=\"token double-colon punctuation\">::</span><span class=\"token constant\">API</span>\n  <span class=\"token comment\"># ... existing code ...</span>\n  \n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">can_read_admin_messages</span></span><span class=\"token operator\">!</span>\n    check_permissions<span class=\"token punctuation\">(</span><span class=\"token variable\">@token</span><span class=\"token punctuation\">,</span> <span class=\"token string-literal\"><span class=\"token string\">'read:admin-messages'</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n  \n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">check_permissions</span></span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> permission<span class=\"token punctuation\">)</span>\n    permissions <span class=\"token operator\">=</span> token<span class=\"token punctuation\">[</span><span class=\"token string-literal\"><span class=\"token string\">'permissions'</span></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    permissions <span class=\"token operator\">=</span> permissions<span class=\"token punctuation\">.</span>split <span class=\"token keyword\">if</span> permissions<span class=\"token punctuation\">.</span>is_a<span class=\"token operator\">?</span> <span class=\"token builtin\">String</span>\n\n    <span class=\"token keyword\">unless</span> permissions<span class=\"token punctuation\">.</span><span class=\"token keyword\">include</span><span class=\"token operator\">?</span><span class=\"token punctuation\">(</span>permission<span class=\"token punctuation\">)</span>\n      render json<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token symbol\">message</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">'Access is denied'</span></span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span>to_json<span class=\"token punctuation\">,</span>\n             <span class=\"token symbol\">status</span><span class=\"token operator\">:</span> <span class=\"token symbol\">:unauthorized</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n  \n  <span class=\"token comment\"># ... existing code ...</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>We use a <code class=\"language-text\">before_action</code> again to protect the <code class=\"language-text\">admin</code> endpoint:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># app/controllers/api/messages_controller.rb</span>\n<span class=\"token keyword\">module</span> <span class=\"token class-name\">Api</span>\n  <span class=\"token keyword\">class</span> <span class=\"token class-name\">MessagesController</span> <span class=\"token operator\">&lt;</span> ApplicationController\n    before_action <span class=\"token symbol\">:can_read_admin_messages!</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">only</span><span class=\"token operator\">:</span> <span class=\"token string-literal\"><span class=\"token string\">%i[admin]</span></span>\n    \n    <span class=\"token comment\"># ... existing code ...</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>With this, each route in our sample application is safe the way we wanted.</p>\n<h3>Testing Permissions</h3>\n<p>If you try to call the <code class=\"language-text\">/api/messages/admin</code> endpoint with the token we generated before, it will return a 401. Our token is valid, but doesn’t have the necessary permissions. Let’s create a new one!</p>\n<p>Back in your <a href=\"https://manage.auth0.com/#/apis\" target=\"_blank\" rel=\"noopener noreferrer\">API configuration page on the Auth0 Dashboard</a>, select the <em>Machine to Machine Applications</em> tab. You’ll get a list of applications, some of them with the <em>(Test Application)</em> label in the name. These applications are automatically created by Auth0 when you create an API there. They are meant as test clients from your API. One of them should have the <em>Authorized</em> switch on. Click the dropdown next to it and check the <code class=\"language-text\">read:admin-messages</code> permission:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/503da7b19db94a2eae6705ad50ee4fee/e8649/assign-writing-permissions.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.85106382978723%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABcUlEQVR42o2S2W4bMQxF5//RJnVtxwuSflZQoCjQt8Z2pNFop7ZbSErczLgPJXBBQBIPSZHDbv+E9eaI9WY/0/1qi0+fV7i73+DL6gFf1ztstoem9ze7/SMOx2/YH56wfTg2PwTCPy3GBGMsJimhlIa1Dv9jA+ccjAl4F5FSQkyp+QqwzsFaAlGA9x7eU1MI4U095qMGxhlefnNonVuGUkrzxloIIaC1aUCiDqv+XYEIJZdrXNVwubzCWjs7rFaDtbat0gqM8a2D2EUhQHmHlPMceD5fIKW6ASrlwJjEOApwLtqb+qc1gXMek1T4xV9BMd4Ca1tLoJQSp9MZjI3gowDj3dcBKW169doihgVQa91aWQLHccLL6QKpNLSxfeKTghAaSpl2XsFxWeES1nkFziVMgiAlIaWeJOfSh1D+rkle/mEd/7K6GkGUEUNpAQ1UbtXv5tsxGNPXolyhHfj9OeHnj4CcCc7RdQfn8h++q8f/AStuRv9iqYj0AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Adding Permissions\" title=\"\" src=\"/static/503da7b19db94a2eae6705ad50ee4fee/1d69c/assign-writing-permissions.png\" srcset=\"/static/503da7b19db94a2eae6705ad50ee4fee/4dcb9/assign-writing-permissions.png 188w,\n/static/503da7b19db94a2eae6705ad50ee4fee/5ff7e/assign-writing-permissions.png 375w,\n/static/503da7b19db94a2eae6705ad50ee4fee/1d69c/assign-writing-permissions.png 750w,\n/static/503da7b19db94a2eae6705ad50ee4fee/78797/assign-writing-permissions.png 1125w,\n/static/503da7b19db94a2eae6705ad50ee4fee/aa440/assign-writing-permissions.png 1500w,\n/static/503da7b19db94a2eae6705ad50ee4fee/e8649/assign-writing-permissions.png 2968w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>Then, click the <em>Update</em> button, move again to the <em>Test</em> tab, and copy the new token that has been generated for you. Let’s try again:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">TOKEN</span><span class=\"token operator\">=</span>the-new-test-token\n<span class=\"token function\">curl</span> localhost:6060/api/messages/admin <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Authorization: Bearer <span class=\"token variable\">$TOKEN</span>\"</span></code></pre></div>\n<p>The request works now!</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span><span class=\"token property\">\"message\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"The API successfully recognized you as an admin.\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Conclusion</h2>\n<p>In this guide, we’ve added authorization to a Rails API by using Auth0 as an authorization server. Thanks to the <code class=\"language-text\">jwt</code> gem, we don’t have to invest much effort. We use the library to decode the bearer token that the API receives. After that, it’s a matter of checking the relevant routes before each request.</p>\n<p><em>This post was published initially in <a href=\"https://auth0.com/blog/secure-rails-api/\" target=\"_blank\" rel=\"noopener noreferrer\">Auth0</a>.</em></p>","frontmatter":{"layout":"post","title":"Secure a Rails API with Auth0","path":"/secure-a-rails-api-with-auth0/","categories":["Ruby","Rails","OAuth","Security","Auth0"],"date":"2021/10/09","draft":false,"description":"Learn how to secure an API written using Ruby On Rails","canonical":"https://auth0.com/blog/secure-rails-api/","image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#383838","images":{"fallback":{"src":"/static/bcba8b98d6e5a2b4686f581e1e16e388/975ed/cover.png","srcSet":"/static/bcba8b98d6e5a2b4686f581e1e16e388/4f8fd/cover.png 147w,\n/static/bcba8b98d6e5a2b4686f581e1e16e388/f1396/cover.png 294w,\n/static/bcba8b98d6e5a2b4686f581e1e16e388/975ed/cover.png 588w","sizes":"(min-width: 588px) 588px, 100vw"},"sources":[{"srcSet":"/static/bcba8b98d6e5a2b4686f581e1e16e388/2d74c/cover.webp 147w,\n/static/bcba8b98d6e5a2b4686f581e1e16e388/be373/cover.webp 294w,\n/static/bcba8b98d6e5a2b4686f581e1e16e388/aab28/cover.webp 588w","type":"image/webp","sizes":"(min-width: 588px) 588px, 100vw"}]},"width":750,"height":673.469387755102}}}}},"related":{"nodes":[{"frontmatter":{"title":"Setting up Auth0 with Terraform","path":"/setting-up-auth0-with-terraform/","date":"2020/02/22"}},{"frontmatter":{"title":"Authorization for a Kotlin Spring backend, using JSON Web Tokens","path":"/authorize-spring-backend-with-jwt-in-kotlin/","date":"2020/03/19"}},{"frontmatter":{"title":"Authorization Code Flow with PKCE (OAuth) in a React application","path":"/oauth-authorization-code-flow-pkce-for-react/","date":"2021/03/29"}}]},"previous":{"frontmatter":{"title":"Book Review: Staff Engineer","path":"/book-review-staff-engineer/","date":"2021/11/16"}},"next":{"frontmatter":{"title":"Applications Instead of Libraries","path":"/applications-instead-of-libraries/","date":"2021/11/20"}}},"pageContext":{"related":["/authorize-spring-backend-with-jwt-in-kotlin/","/setting-up-auth0-with-terraform/","/oauth-authorization-code-flow-pkce-for-react/"],"previous":"/book-review-staff-engineer/","next":"/applications-instead-of-libraries/"}},"staticQueryHashes":[],"slicesMap":{}}