{"componentChunkName":"component---src-templates-blog-post-js","path":"/jest-fail-test-if-unexpected-network-request-happens/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for ThoughtWorks","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"7afdc6f0-7628-58f8-a31d-782685950a8f","html":"<p>A <a href=\"https://martinfowler.com/bliki/UnitTest.html\" target=\"_blank\" rel=\"noopener noreferrer\">unit test</a> should not trigger network requests, such as calls to a REST API. It breaks the isolation and will make the tests flaky and unreliable.</p>\n<p>Instead, we should be mocking these requests. <a href=\"https://reactjs.org/\" target=\"_blank\" rel=\"noopener noreferrer\">React</a> and <a href=\"https://jestjs.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Jest</a> provide a convenient way of doing so. What if you forget to mock some requests, though? We are going to set up <em>Jest</em> in such a way that tests fail automatically if a network request was attempted.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 512px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/c27d1d36445964592105f2fa4eb92bfa/01e7c/jest.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 49.46808510638298%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/ElEQVQoz22SwWoTURSGb9ImbWKmTRqTNrGt1Viboklmzv/fO85Q3Cj4Dl250JULH8AncOED2J0gKAoiYu1GpEU3oruCxFKrC10UhD6AaOSEmVKsF37uMDN85/znP8Zaa0geSkRyJEdV1trRbrer77MARlQkR47+f+woMIWGYWgALABoikgDwCkAEYBzAOZIqvR7DsD/gc65DMkCSc9aq92dBnABgAAIAKwAqIvIGIAigLOJgyEwBR92LBAvdG7u2pWrFUtOi0iV5DTJWZIzJOsAJkRkPAiCPIAayby6EpHjwFvXb2Qv9rpNY0xtvr2Yc85VrbPabZlkIwzDonNuEoAnIh6AKoCMgoIgSIGldLbm49NXZnd9a2n7ycbLzxtbTZPPVuJLUSsIAu1WrZ4E0AKwJCJtAMsAfABnOp1OluQiyZYWV7j5PfhT2nv74d6nF69/ba+/WTbGlC6vrGgICyLSJFkDMKvpi4haLidhTfV6PU2/TXKeZDmOY2N+7nybeb/2+N3m3bX7X/o75XxhfCKO4gbJ80miHsnqEXs6DgUNZygi+lxPVsqY/c2+2e/vFR+s3jaDwcBEUVTzfb8gIpUkjBMiUtBVsdbqLk4BGEtgwyKphsCD3R/m4Ot38/zmneyzh48yvu8Phy8ipeRW6KSIaEgqLwVo0v8C/wL/faHO80P7ZAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Test it like you mean it\" title=\"Test it like you mean it\" src=\"/static/c27d1d36445964592105f2fa4eb92bfa/01e7c/jest.png\" srcset=\"/static/c27d1d36445964592105f2fa4eb92bfa/4dcb9/jest.png 188w,\n/static/c27d1d36445964592105f2fa4eb92bfa/5ff7e/jest.png 375w,\n/static/c27d1d36445964592105f2fa4eb92bfa/01e7c/jest.png 512w\" sizes=\"(max-width: 512px) 100vw, 512px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<!--more-->\n<p>I have been using <a href=\"https://testing-library.com/\" target=\"_blank\" rel=\"noopener noreferrer\">react-testing-library</a> a lot lately to test <em>React</em> applications. Its core design principle is described like this:</p>\n<blockquote>\n<p>The more your tests resemble the way your software is used,</p>\n</blockquote>\n<p>the more confidence they can give you.</p>\n<p>This is a good thing! In my experience, you write stronger tests once you get used to it. However, if you use this library you probably have seen this error message multiple times:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token number\">1</span>: \"Warning: An update to %s inside a <span class=\"token builtin class-name\">test</span> was not wrapped <span class=\"token keyword\">in</span> act<span class=\"token punctuation\">(</span><span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">)</span>.·\nWhen testing, code that causes React state updates should be wrapped into act<span class=\"token punctuation\">(</span><span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">)</span>:·\nact<span class=\"token punctuation\">((</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  /* fire events that update state */\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>It usually means that there were pending asynchronous requests when the test finished.</p>\n<h2>Our first attempt at catching errors</h2>\n<p>We have this starting configuration in the <code class=\"language-text\">setupTests.js</code> that is loaded automatically if you are using <a href=\"https://create-react-app.dev/\" target=\"_blank\" rel=\"noopener noreferrer\">Create React App</a>. It is pretty standard.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token string\">'@testing-library/jest-dom/extend-expect'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> cleanup <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@testing-library/react'</span>\n\nconsole<span class=\"token punctuation\">.</span>error <span class=\"token operator\">=</span> jest<span class=\"token punctuation\">.</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token function\">afterEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>console<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>not<span class=\"token punctuation\">.</span><span class=\"token function\">toHaveBeenCalled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">afterEach</span><span class=\"token punctuation\">(</span>cleanup<span class=\"token punctuation\">)</span></code></pre></div>\n<p>It is very useful to fail on <code class=\"language-text\">console.error</code>, because that will show that there were pending requests. However, that output can be fairly confusing. We had a test in my project that was failing because we added a new section to a component. It wasn’t obvious that the new section was fetching data from an endpoint. We ended up “fixing” it by adding <code class=\"language-text\">await wait()</code> statements all over the place.</p>\n<p>That didn’t address the underlying issue, though. I had to spend quite a bit of time digging into it before I figured out what was going on. We want clearer feedback.</p>\n<h2>A more targeted approach</h2>\n<p>We use <a href=\"https://github.com/axios/axios\" target=\"_blank\" rel=\"noopener noreferrer\">axios</a> to build our API requests. <em>Any</em> test that does a request that is not mocked should fail. It still should be possible to add explicit mocks for things like service tests as well. We also use <a href=\"https://pact.io/\" target=\"_blank\" rel=\"noopener noreferrer\">pact</a> for <em>Contract Testing</em>. These tests go against a local server, no mock should be active when they run. I extended the <code class=\"language-text\">setupTests.js</code> file to mock <code class=\"language-text\">axios</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span>\n\n<span class=\"token keyword\">const</span> spies <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">get</span><span class=\"token operator\">:</span> jest<span class=\"token punctuation\">.</span><span class=\"token function\">spyOn</span><span class=\"token punctuation\">(</span>axios<span class=\"token punctuation\">,</span> <span class=\"token string\">'get'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">patch</span><span class=\"token operator\">:</span> jest<span class=\"token punctuation\">.</span><span class=\"token function\">spyOn</span><span class=\"token punctuation\">(</span>axios<span class=\"token punctuation\">,</span> <span class=\"token string\">'patch'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">post</span><span class=\"token operator\">:</span> jest<span class=\"token punctuation\">.</span><span class=\"token function\">spyOn</span><span class=\"token punctuation\">(</span>axios<span class=\"token punctuation\">,</span> <span class=\"token string\">'post'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">beforeEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  jest<span class=\"token punctuation\">.</span><span class=\"token function\">resetAllMocks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token function\">afterEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>spies<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>not<span class=\"token punctuation\">.</span><span class=\"token function\">toHaveBeenCalled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>spies<span class=\"token punctuation\">.</span>patch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>not<span class=\"token punctuation\">.</span><span class=\"token function\">toHaveBeenCalled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>spies<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>not<span class=\"token punctuation\">.</span><span class=\"token function\">toHaveBeenCalled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>That’s it. With this, any attempt at doing an unexpected request will trigger a nice and explicit failed assertion. We still need to deal with <em>expected</em> requests.</p>\n<h3>Mocking services</h3>\n<p>This setup does not define any return for the requests. You need to take care of that if you are building integrated tests for your components.</p>\n<p>I tend to deal with that at the service level. My requests are usually encapsulated in a file that gets imported by the components that need them. I use Jest’s <a href=\"https://jestjs.io/docs/en/manual-mocks\" target=\"_blank\" rel=\"noopener noreferrer\">manual mocks</a> for that, which sit one level higher than <code class=\"language-text\">axios</code>. A service could be as simple as this:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// src/recipe-list/recipeList.service.ts</span>\n<span class=\"token keyword\">import</span> axios<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> AxiosResponse <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Recipe <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'components/recipe/types'</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> recipeList <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>AxiosResponse<span class=\"token operator\">&lt;</span>Recipe<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">>></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">axios</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/rest/recipes'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Which can be replaced with a manual mock like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// src/recipe-list/__mocks__/recipeList.service.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> AxiosResponse <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> recipes <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@testing/__fixtures__'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Recipe <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'components/recipe/types'</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> recipeList <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>AxiosResponse<span class=\"token operator\">&lt;</span>Recipe<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">>></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token builtin\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    status<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n    statusText<span class=\"token operator\">:</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">,</span>\n    data<span class=\"token operator\">:</span> <span class=\"token function\">recipes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    config<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Mocking axios directly</h3>\n<p>Another alternative is to mock <em>axios</em> directly and add your behavior, which will replace the mock that we defined initially.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\">jest<span class=\"token punctuation\">.</span><span class=\"token function\">mock</span><span class=\"token punctuation\">(</span><span class=\"token string\">'axios'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'service'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">beforeEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span>axios<span class=\"token punctuation\">.</span>get <span class=\"token keyword\">as</span> jest<span class=\"token punctuation\">.</span>Mock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mockResolvedValue</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Resetting the mocks</h3>\n<p>If you need <code class=\"language-text\">axios</code> to work normally, like in the case of Contract Tests, you can restore the original behavior.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token function\">beforeAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  jest<span class=\"token punctuation\">.</span><span class=\"token function\">restoreAllMocks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>Summary: Make your errors explicit</h2>\n<p>That all there is to it. A simple solution, if a bit hacky, to make sure that errors surface as quickly as possible and don’t get hidden.</p>\n<p><em>EDIT 25/12/2019:</em> Grammar review\n<em>EDIT 15/04/2020:</em> Fix broken code snippet</p>","frontmatter":{"layout":"post","title":"Fail a test in Jest if an unexpected network request happens","path":"/jest-fail-test-if-unexpected-network-request-happens/","categories":["React","Jest","Testing","react-testing-library","create-react-app","axios"],"date":"2019/12/08","draft":false,"description":"Automatically failing unit tests with Jest in React when network requests are made will make your tests more reliable and easier to maintain","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/c27d1d36445964592105f2fa4eb92bfa/9e629/jest.png","srcSet":"/static/c27d1d36445964592105f2fa4eb92bfa/c98a7/jest.png 128w,\n/static/c27d1d36445964592105f2fa4eb92bfa/6a2be/jest.png 256w,\n/static/c27d1d36445964592105f2fa4eb92bfa/9e629/jest.png 512w","sizes":"(min-width: 512px) 512px, 100vw"},"sources":[{"srcSet":"/static/c27d1d36445964592105f2fa4eb92bfa/b32c3/jest.webp 128w,\n/static/c27d1d36445964592105f2fa4eb92bfa/1215c/jest.webp 256w,\n/static/c27d1d36445964592105f2fa4eb92bfa/c2cba/jest.webp 512w","type":"image/webp","sizes":"(min-width: 512px) 512px, 100vw"}]},"width":750,"height":372.0703125}}}}},"related":{"nodes":[{"frontmatter":{"title":"Custom Components in Formik","path":"/custom-components-in-formik/","date":"2019/08/15"}},{"frontmatter":{"title":"How to split the deployment of your front end and back end with the help of Consumer Driven Contract Testing","path":"/split-frontend-backend-deployment-with-cdcs/","date":"2019/11/12"}},{"frontmatter":{"title":"A directory structure for React projects","path":"/a-directory-structure-for-react-projects/","date":"2020/07/19"}}]},"previous":{"frontmatter":{"title":"Kotlin tapas: Get a taste of Kotlin","path":"/kotlin-tapas-a-taste-of-kotlin/","date":"2019/10/27"}},"next":{"frontmatter":{"title":"How to split the deployment of your front end and back end with the help of Consumer Driven Contract Testing","path":"/split-frontend-backend-deployment-with-cdcs/","date":"2019/11/12"}}},"pageContext":{"related":["/a-directory-structure-for-react-projects/","/custom-components-in-formik/","/split-frontend-backend-deployment-with-cdcs/"],"previous":"/kotlin-tapas-a-taste-of-kotlin/","next":"/split-frontend-backend-deployment-with-cdcs/"}},"staticQueryHashes":[]}