{"componentChunkName":"component---src-templates-blog-post-js","path":"/using-asm-in-concourse/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for Meta","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"ef7ab727-0d2b-51bf-8838-8918137a1978","html":"<figure class=\"figure figure--right\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/10dbb304c8c5ad37269239e7a1855de6/fc83b/lock.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 77.12765957446808%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQCAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAGLDqppFIf/xAAbEAADAAMBAQAAAAAAAAAAAAABAgMEERIAIf/aAAgBAQABBQLMrTvHu+h9DS69p0M0Kj//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAcEAACAgIDAAAAAAAAAAAAAAAAARExAiESI1H/2gAIAQEABj8C44aSO2vYJRZEJj3bk//EABsQAQACAwEBAAAAAAAAAAAAAAEAIRExQVFx/9oACAEBAAE/IQWu47G4FpWyIJBHpDS9cmMvvXXyZ2voT//aAAwDAQACAAMAAAAQsM//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAdEAEAAgICAwAAAAAAAAAAAAABABEhUTFhscHR/9oACAEBAAE/EL/MBei03ohjdCy7rzMsJhLGAShyV+oNhcCwe6gowxGILXyf/9k='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Keeping it secret\" title=\"\" src=\"/static/10dbb304c8c5ad37269239e7a1855de6/acb04/lock.jpg\" srcset=\"/static/10dbb304c8c5ad37269239e7a1855de6/bc01b/lock.jpg 188w,\n/static/10dbb304c8c5ad37269239e7a1855de6/bf173/lock.jpg 375w,\n/static/10dbb304c8c5ad37269239e7a1855de6/acb04/lock.jpg 750w,\n/static/10dbb304c8c5ad37269239e7a1855de6/ec605/lock.jpg 1125w,\n/static/10dbb304c8c5ad37269239e7a1855de6/c58a3/lock.jpg 1500w,\n/static/10dbb304c8c5ad37269239e7a1855de6/fc83b/lock.jpg 1556w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n  <figcaption class=\"figure__caption\">\n    <small class=\"figure__attribution\">\n      <span class=\"figure__attribution-link\">\n        by FreeImages.com/Braden Hays\n      </span>\n    </small>\n  </figcaption>\n</figure>\n<p>When I wrote about <a href=\"../modernizing-your-build-pipelines\">modernizing build pipelines</a> I had a ton of content left that did not quite fit the article. I am going to dump some of that here as small articles. I believe they could be useful as a starting point to go towards a better <em>CI</em> setup.</p>\n<p>The first thing I want to talk about is connecting <a href=\"https://concourse-ci.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Concourse CI</a> with <a href=\"https://aws.amazon.com/secrets-manager/\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Secrets Manager</a>. Why would you want to do that, I picture you asking?</p>\n<p>Well, if you have pipelines building stuff, they will probably want to access some secrets at some point. It could be a deploy key to access <em>Github</em>, or credentials for <code class=\"language-text\">npm</code> or something else. You don’t want to store this in plaintext. If you have had to maintain credentials manually for something like <a href=\"https://jenkins.io/doc/book/using/using-credentials/\" target=\"_blank\" rel=\"noopener noreferrer\">Jenkins</a> you know that can really suck. But it does not have to. An alternative is to connect <code class=\"language-text\">Concourse</code> and the <code class=\"language-text\">AWS Secrets Manager</code>, using <a href=\"https://www.terraform.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform</a> to keep everything as code.</p>\n<!--more-->\n<p><em>Concourse</em> supports a bunch of <a href=\"https://concourse-ci.org/creds.html\" target=\"_blank\" rel=\"noopener noreferrer\">credentials managers</a> out of the box. Once you have it configured, your jobs and tasks can access secrets in a very convenient way. It looks as simple as this</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">platform</span><span class=\"token punctuation\">:</span> linux\n<span class=\"token key atrule\">inputs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> git\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> shared<span class=\"token punctuation\">-</span>tasks\n<span class=\"token key atrule\">params</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">NPM_TOKEN</span><span class=\"token punctuation\">:</span> ((npm_auth_token))\n<span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> sh\n  <span class=\"token key atrule\">dir</span><span class=\"token punctuation\">:</span> git\n  <span class=\"token key atrule\">args</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span>ec\n  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n    ../shared-tasks/scripts/install-yarn-packages.sh\n    ./go linter-js</span></code></pre></div>\n<p>with that, the <em>linter</em> task will have access to the <code class=\"language-text\">NPM_TOKEN</code>, which is needed to pull from a private <code class=\"language-text\">npm</code> repository, in a safe manner. But with a lot of convenience for whoever is writing this pipeline and doesn’t want to do a lot of plumbing.</p>\n<h3>I gotta get me some of this</h3>\n<p>First, concourse needs to be started with the right settings, so that it will know to use <code class=\"language-text\">ASM</code> with the right region, and the right path</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">/usr/local/bin/concourse web <span class=\"token punctuation\">\\</span>\n  --aws-secretsmanager-region<span class=\"token operator\">=</span>us-east-1 <span class=\"token punctuation\">\\</span>\n  --aws-secretsmanager-team-secret-template<span class=\"token operator\">=</span>/concourse-ci/<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>.Secret<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">\\</span>\n  --aws-secretsmanager-pipeline-secret-template<span class=\"token operator\">=</span>/concourse-ci/<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>.Secret<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can use a lot more granularity, and have a <code class=\"language-text\">{{.Team}}</code> or <code class=\"language-text\">{{.Pipeline}}</code> in there, but for this case we want just simple secrets. With this, the instance will be able to find the secrets under the given path with the syntax mentioned above.</p>\n<h3>Give me the rights</h3>\n<p>We are not yet there, though. <em>Concourse</em> needs to be able to access those secrets. You can pass it credentials, but a more secure method is to define an <em>IAM Role</em>, as the documentation mentions. This example will work if you are running your CI on EC2. First, the policy</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_iam_policy\"</span></span> <span class=\"token string\">\"concourse-ci-web\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>aws_iam_role<span class=\"token punctuation\">.</span>concourse-ci-web<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">policy</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">aws_iam_policy_document</span><span class=\"token punctuation\">.</span>concourse-ci<span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">}</span></span>\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">data <span class=\"token type variable\">\"aws_iam_policy_document\"</span></span> <span class=\"token string\">\"concourse-ci\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">statement</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">effect</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Allow\"</span>\n\n    <span class=\"token property\">actions</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"secretsmanager:DescribeSecret\"</span>,\n      <span class=\"token string\">\"secretsmanager:GetSecretValue\"</span>,\n      <span class=\"token string\">\"kms:Decrypt\"</span>,\n    <span class=\"token punctuation\">]</span>\n\n    <span class=\"token property\">resources</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"arn:aws:secretsmanager:*:*:secret:concourse-ci/*\"</span>,\n      <span class=\"token string\">\"arn:aws:secretsmanager:*:*:secret:/concourse-ci/*\"</span>,\n      <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token function\">formatlist</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"arn:aws:kms:*:*:key/%s\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">asm_key_ids</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\"</span>,\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>then that policy gets connected to a role that is assumed by EC2</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_iam_role\"</span></span> <span class=\"token string\">\"concourse-ci-web\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>               <span class=\"token punctuation\">=</span> <span class=\"token string\">\"concourse-ci-web\"</span>\n  <span class=\"token property\">assume_role_policy</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">aws_iam_policy_document</span><span class=\"token punctuation\">.</span>assume_role_policy_ec2<span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">}</span></span>\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_iam_instance_profile\"</span></span> <span class=\"token string\">\"concourse-ci-web\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>aws_iam_role<span class=\"token punctuation\">.</span>concourse-ci-web<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">role</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>aws_iam_role<span class=\"token punctuation\">.</span>concourse-ci-web<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span></span>\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_iam_role_policy_attachment\"</span></span> <span class=\"token string\">\"concourse-ci-web\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">policy_arn</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>aws_iam_policy<span class=\"token punctuation\">.</span>concourse-ci-web<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">role</span>       <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>aws_iam_role<span class=\"token punctuation\">.</span>concourse-ci-web<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span></span>\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>and finally the policy for assuming the role</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">data <span class=\"token type variable\">\"aws_iam_policy_document\"</span></span> <span class=\"token string\">\"assume_role_policy_ec2\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">statement</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">effect</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Allow\"</span>\n    <span class=\"token property\">actions</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"sts:AssumeRole\"</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">principals</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Service\"</span>\n      <span class=\"token property\">identifiers</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"ec2.amazonaws.com\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>That’s it?</h3>\n<p>Well, mostly. The example is not complete, and there will be some more code needed to make it work, but this is the gist of it. The best part is that you set it up once, and then you can access the secrets that you define in that namespace, just like that.</p>","frontmatter":{"layout":"post","title":"Using AWS Secrets Manager in Concourse","path":"/using-asm-in-concourse/","categories":["Continuous integration","Terraform","AWS Secrets Manager","Concourse CI"],"date":"2018/11/26","draft":false,"description":"Connecting Concourse CI with AWS Secrets Manager offers you a way of conveniently using secrets in a safe manner","canonical":null,"image":null}},"related":{"nodes":[]},"previous":{"frontmatter":{"title":"Migrating to Gatsby 2","path":"/migrating-to-gatsby2/","date":"2018/10/03"}},"next":{"frontmatter":{"title":"Checking the validity of a certificate in Concourse","path":"/check-certificate-validity-concourse/","date":"2019/02/14"}}},"pageContext":{"related":[],"previous":"/migrating-to-gatsby2/","next":"/check-certificate-validity-concourse/"}},"staticQueryHashes":[],"slicesMap":{}}