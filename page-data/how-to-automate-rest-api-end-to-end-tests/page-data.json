{"componentChunkName":"component---src-templates-blog-post-js","path":"/how-to-automate-rest-api-end-to-end-tests/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for ThoughtWorks","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"667cac58-429a-5441-9aef-d747fa134f00","html":"<p><a href=\"https://learning.getpostman.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Postman</a> is a great tool to explore REST APIs. You can build requests and try them out to get quick feedback. Then you can persist them as collections to make sure that the knowledge doesn’t get lost.</p>\n<p><a href=\"https://github.com/postmanlabs/newman\" target=\"_blank\" rel=\"noopener noreferrer\">Newman</a>, the CLI version of Postman, allows you to take it to the next level and transform a collection into a suite of automated end-to-end tests. This suite will run then in your CI tool of choice. In this article I will explore the benefits of doing so and show you how to set it up.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 110.10638297872339%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAWABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAMEBQL/xAAXAQADAQAAAAAAAAAAAAAAAAAAAQID/9oADAMBAAIQAxAAAAHqecV8tMSgOdUcxCr/xAAZEAADAQEBAAAAAAAAAAAAAAAAAQIhEwP/2gAIAQEAAQUCkvU/LYsdY6FR0zoz/8QAFhEAAwAAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/ASv/xAAWEQADAAAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8BI//EABYQAAMAAAAAAAAAAAAAAAAAABAgMv/aAAgBAQAGPwI03//EABoQAQEBAQEBAQAAAAAAAAAAAAEAESFBMaH/2gAIAQEAAT8hRhDcPSf0XwH8XAbt1s7RxKN//9oADAMBAAIAAwAAABAI6ML/xAAWEQEBAQAAAAAAAAAAAAAAAAAAEQH/2gAIAQMBAT8QsWxMf//EABcRAAMBAAAAAAAAAAAAAAAAAAABESH/2gAIAQIBAT8QW4SMrP/EAB0QAQEBAAEFAQAAAAAAAAAAAAERADEhQVFhwdH/2gAIAQEAAT8Qmu0x+jDr/wB8yI1PDCQUHKfmK4meOcy66GvIb//Z'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"You got to test it\" title=\"You got to test it\" src=\"/static/18e1df9e3dd453fdf54be4301cdc255b/acb04/introduction.jpg\" srcset=\"/static/18e1df9e3dd453fdf54be4301cdc255b/bc01b/introduction.jpg 188w,\n/static/18e1df9e3dd453fdf54be4301cdc255b/bf173/introduction.jpg 375w,\n/static/18e1df9e3dd453fdf54be4301cdc255b/acb04/introduction.jpg 750w,\n/static/18e1df9e3dd453fdf54be4301cdc255b/e6e7b/introduction.jpg 770w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</figure>\n<!--more-->\n<h2>What is an End-to-End test in the context of an API?</h2>\n<p>Testing nomenclature is a tricky thing. Keeping the <a href=\"https://martinfowler.com/bliki/TestPyramid.html\" target=\"_blank\" rel=\"noopener noreferrer\">testing pyramid in mind</a>, we can picture them as very high level tests. These tests confirm that a particular REST API works as intended, treating the internals as a black box. We don’t involve any UI in the process, which helps reduce the flakiness.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 603px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 119.14893617021276%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAAAsTAAALEwEAmpwYAAADdUlEQVQ4y3WU32/aVhTH8+ftH9g/sPc9TNoe1pdqU16maCitqrbZlkpEKUEhhQQHEgMztinF2PhiDMUkxAbbECD8MCEeirHNmYjbkEbk+3B9fK3P/Z57zr1egwdyXdf5VrZte6PrugBgWZZpml48n8/XvAcAtNttDMMoikp/FUEQJLkIaJqORCIkRXU6nWazqShKq9VyHGfNMwSAYrEoiqK3/MyyrNtbx3Wv/5su3G5uKpWKIsv5fF4olUiSury8rNfrS7hcLp+dnd0nsggAmgx9OxmfX1yMRqMEntjbC57i+I5/pypJmqYtYVEUJUkCANtxap8/CyVRr5Y//fNCLgt5rnBRXyh2HEvgCRzHFaUhy/ISrlQqRYT0druaiqHdrXOBt2Yz4jCcjx8DQKPRwDBM0/RarVav19utlm3bS7harUajUZqmh53LTOi9KvIA8CkT+3PzR9t1ut1uKpUCAMdxvmzqUbUDgcD6+vrO+0B4L/Bu660giDvBv373/UQQqXQ6zfP8vZOHrN03ud/vx+4UPTo6ikaPY7FwOIwdYacxHMOwYDDoVcSDPS2dk8kkTdPT6dQwjPF4bBjGZDIZT24Mw5hOp7Ise2mvhjN0pigIy1bdjVfy+fWg7+VF0/STcCqVQgh5s1dXfUXVBnqT979WxOLdzBVFUU/C2Ww2l8tdTya1XIYJbOeptDHoI/y4lDwFgG6nQ5Lkk3Cr1cIwjOW4Xl3iw4GRXAMARRJ2t9fnAMPhcLWz997r9Xw+37Nfn+0dfAhs//1q4w9JOt965/vh5+/ipxiZpk5OTlY7m6apqipCqFAoMLkcy7K5fB4hxPMFxPMI8SzL9nq9hyf/C6xpmqI0ptPFBWIYBsdxhBDHsgzDcCzLcRzLstlsNpFIPCQXsGEYuq53ux2CIBAqmqbp3VXvszVb/A48Q4IgLMv6Bh6Px6qqNhpKNptlGGY4HDYaTW9jjuuqDNltXADAbDZbAQOAruuqqo5Go8FgUCqVOI5rKRfpdLqnKpntlxLzcbGQba+GAcA0TV3Xjw4Pi2K5QiaF3beaUAAAtVzisciiyI5DkuQK2CuDbdt+vz8UCp3Xah9PjtOREAAw+X9/ef691mrOLDsej692nt9pf39/Y2Pj1es3Hw4OXmxukiQdCPp9b34LRw5SyZR3wlbAj/SoJU/pf++G+2faN4FJAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"All to real\" title=\"All to real\" src=\"/static/76e69979abd0fbfdb82c1914aa6fa4a7/9128f/poke-e2e.png\" srcset=\"/static/76e69979abd0fbfdb82c1914aa6fa4a7/4dcb9/poke-e2e.png 188w,\n/static/76e69979abd0fbfdb82c1914aa6fa4a7/5ff7e/poke-e2e.png 375w,\n/static/76e69979abd0fbfdb82c1914aa6fa4a7/9128f/poke-e2e.png 603w\" sizes=\"(max-width: 603px) 100vw, 603px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n  <figcaption class=\"figure__caption\">\n    <small class=\"figure__attribution\">\n      <span class=\"figure__attribution-link\">\n        by geek &amp; poke / <a href=\"https://creativecommons.org/licenses/by/3.0/\">CC BY</a>\n      </span>\n    </small>\n  </figcaption>\n</figure>\n<p>Flaky tests are extremely annoying, as every developer has experienced at some point. Instead of banging our head against the wall trying to fix the unfixable, we can mitigate the problem by using lower level tests.</p>\n<h2>Why should I have these tests?</h2>\n<p>There are two different scenarios I’d like to cover:</p>\n<p>The first is testing your own REST APIs. These tests add an extra layer of confidence. Surely, you are using a healthy mix of different tests (unit, integration, functional, …). End-to-end tests can be the final confirmation that everything looks fine.</p>\n<p>The second case is testing APIs that you don’t control. In my last projects most of the data we consumed came from APIs served by other teams. More than once I spent half a day debugging an error in my app, only to notice that a downstream API was borked all along. Automated tests cover that integration, and help isolate issues.</p>\n<h3>Living documentation</h3>\n<p>A collection of tests that are being regularly executed serve as the best documentation for an API. Have you searched for something in any corporate wiki lately? If you find anything at all you should be happy. It will be probably incomplete. Or just flat out wrong. Fun times.</p>\n<h3>Monitoring</h3>\n<p>In both cases, these tests can morph from a gateway in the building process to an active monitoring tool. By constantly running them, you make sure that the API is still behaving as you expect. Otherwise, the right alarms will be raised. You don’t want to realize something is wrong just when a customer complains.</p>\n<h3>Why not use consumer driven contract tests instead?</h3>\n<p>Great question, if I may say so myself. <a href=\"https://www.thoughtworks.com/de/radar/techniques/consumer-driven-contract-testing\" target=\"_blank\" rel=\"noopener noreferrer\">CDCs</a> are an excellent way to ensure that an API conforms to what a client expects from it. If you can set them up properly, they will replace end-to-end tests almost completely. Remember, keep pushing the tests to a lower level whenever you can.</p>\n<p>They don’t work in every situation, though. If you don’t control both the provider and the consumer, you have to rely on another party. If they don’t fulfill their part of the contract the tests will be useless. Some teams are just not in the position of continuously running tests against a contract. Running your own tests could be your best bet.</p>\n<p>Anyways, having laid out the rationale, it’s time for some <strong>code</strong>.</p>\n<h2>Creating a Postman collection</h2>\n<h3>The collection</h3>\n<p>We are defining a number of calls that will be executed sequentially inside our CI. Each call executes a request against the API. Then it runs some tests to check that the request was successful, checking the status code and the body as well.</p>\n<p>In order to create the collection, I tend to use the Postman app. I like to extract things like URLs and parameters to an <a href=\"https://learning.getpostman.com/docs/postman/environments_and_globals/manage_environments/\" target=\"_blank\" rel=\"noopener noreferrer\">environment</a>. Then configuring it becomes easier, and you don’t have any sensitive information in the collection itself. Your history is a <a href=\"https://learning.getpostman.com/docs/postman/collections/creating_collections/#saving-to-a-collection-from-history\" target=\"_blank\" rel=\"noopener noreferrer\">convenient place to start building this collection</a>.</p>\n<p>Once you are satisfied with the collection, you can export it as a JSON file. That file can be committed in source control to serve as a base for the pipeline that will run the tests. There is a Pro and Enterprise version that helps managing collections, which I haven’t really tried. Still, a good ol’ <code class=\"language-text\">git</code> repository is more than enough to get rolling.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 582px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 118.08510638297874%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAIAAAB1KUohAAAACXBIWXMAABYlAAAWJQFJUiTwAAADGElEQVQ4y32US2+jVhiG/fu76HTTTTurSq3UTRuNNEnvqdSRZyZVXDmZyAYbA7aBw8EcOPc7VIbGSjLTPCsWPJyX9+Nj0jQN51wIoZSSUgoh+LMwxgghnPM4jidwoCzLm5ubNE0BABjj5x+BEMIYJ0kySdP0+voaQphlWVEUAIC2bZ+RKaXxQBiGE4SQEAJjnOd5MlBVlRCCMfZ/8nw+n81mQRBMmqbBGHPOpZSUUiGElPL0eqeLE5TSw8DxZMZYURS3H24ppYQQhNCpNqXUaJrHOOe01qvVaqKU8t73Xee9r+s6iiIhRJqmd3d32+02SZLVaqWUeuJLKY8ne20KSd7inbZGSTnep+8xxlhrzUf8JyulnPdd31lnOedt2yqlDocDhLAZgBDWdf1p2WlTKTojubZm7Exrba0dIzjnxiCflrXWylveWe89Qmg6nRJClstlGIbBQBRFH8uMseVyeWwbQrher+kA59wYowZO036oaa2dcxDCxWIxkVJqqQQ5pq3rerPZcM6DIFiv10mSBEFAKX3Y2SgDAIqimFhtkBGhrI21SkrBuZKKMSY4l0JQQpV8NCdr7SgDACbWGO5t6aXzHjH605+/EynjfB/tt1G2zZuD6zpzPzMp5W63E0JACI8yY6yp62KXcaX4q2n52Xf6m9/4ywv+8px+9Zp8eWbzg+n86GutCSHGmLIsj7IQgmBcFkAyLr74IXo/Uw2JPyyS2wVCqD97q9/c6r7X9+HdwH1sbbg3uePGWfPix+rrV/b8b/z9H/W3v6qLq/7zs36+6fq+c36s7VTYUXbatFZuVGu8E9Ee/vxOXy3352/AL++Ki+nhr3/SVbTb7/M8F0JYax/Jx2FSSlAjpZRGM29N35ekKWkLGcZKgBKUA1LKpzLnvD4c4mgz/hLCMBRClGUJIUQIAQDG7T1tyCP5WGPnRe+tc4wxAIBSKsuyPM+rqtoPgbMsGzM/lb2xpaJX7d44SwmZz+eEEIxxVVXjVmGMvfenj+yRXFUVxVhRTghpmuby8hJjnGVZEAS73W673cZx/HAxHsr/Ap1HQE8L9548AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Postman export\" title=\"Postman export\" src=\"/static/d2bf1c564dd734894c569366134220ac/7c1cd/export-postman.png\" srcset=\"/static/d2bf1c564dd734894c569366134220ac/4dcb9/export-postman.png 188w,\n/static/d2bf1c564dd734894c569366134220ac/5ff7e/export-postman.png 375w,\n/static/d2bf1c564dd734894c569366134220ac/7c1cd/export-postman.png 582w\" sizes=\"(max-width: 582px) 100vw, 582px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</figure>\n<h3>Running the collection</h3>\n<p>Until now we have been using regular Postman and nothing else. Now it’s the time for newman to shine. What am I talking about, anyways? I’ll quote the <a href=\"https://learning.getpostman.com/docs/postman/collection_runs/command_line_integration_with_newman/\" target=\"_blank\" rel=\"noopener noreferrer\">official docs</a> directly:</p>\n<blockquote>\n<p>Newman is a command line Collection Runner for Postman. It allows you to run and test a Postman Collection directly from the command line.</p>\n</blockquote>\n<p>Good that we clarified that! It is installed as a npm package, which can result in a <code class=\"language-text\">package.json</code> as simple as this:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"postman-utils\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0.0.1\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"private\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Postman utilities\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"newman\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"node_modules/.bin/newman run\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"dependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"newman\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^4.4.1\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>as mentioned before, you don’t want to hardcode variables like URLs, parameters or, God forbid, passwords in that collection. It’s not flexible, and it’s not safe. Instead, I like to use a configuration file which includes all these values. But if we want to commit that file, we still need to figure out a way to avoid putting secrets in there. I use it as a template and replace values at runtime with envsubst. The configuration file looks like this</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n\t\"id\": \"425cf4df-d994-4d91-9efb-41eba1ead456\",\n\t\"name\": \"echo\",\n\t\"values\": [\n\t\t{\n\t\t\t\"key\": \"host\",\n\t\t\t\"value\": \"${HOST}\",\n\t\t\t\"enabled\": true\n\t\t}\n\t]\n}</code></pre></div>\n<p>You can orchestrate this with a simple bash script. The script injects the variables into the template, runs newman, and deletes the files to avoid leaks. It goes very well with <a href=\"https://hceris.com/storing-passwords-with-gopass/\" target=\"_blank\" rel=\"noopener noreferrer\">gopass</a>, where you can safely store your secrets and fetch them through the script.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function-name function\">setup-newman</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token assign-left variable\">settings</span><span class=\"token operator\">=</span>/tmp/settings.json.<span class=\"token variable\">$$</span>\n  <span class=\"token assign-left variable\">result</span><span class=\"token operator\">=</span>/tmp/variables.json.<span class=\"token variable\">$$</span>\n\n  <span class=\"token comment\"># shellcheck disable=SC2064</span>\n  <span class=\"token builtin class-name\">trap</span> <span class=\"token string\">\"rm -f <span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$settings</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span> <span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$result</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>\"</span> EXIT\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function-name function\">run-newman</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token builtin class-name\">local</span> <span class=\"token assign-left variable\">service</span><span class=\"token operator\">=</span><span class=\"token variable\">${1?You need to provide the service to check}</span>\n\n  envsubst <span class=\"token operator\">&lt;</span> <span class=\"token string\">\"<span class=\"token variable\">$service</span>.environment.json.template\"</span> <span class=\"token operator\">></span> <span class=\"token string\">\"<span class=\"token variable\">$settings</span>\"</span>\n\n  npx newman run <span class=\"token string\">\"<span class=\"token variable\">$service</span>.json\"</span> <span class=\"token punctuation\">\\</span>\n      <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"<span class=\"token variable\">${settings}</span>\"</span> <span class=\"token punctuation\">\\</span>\n      --export-environment <span class=\"token string\">\"<span class=\"token variable\">${result}</span>\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>that helper can be called with the collection that you want to test. Exported variables will be picked by <code class=\"language-text\">envsubst</code>. <a href=\"https://www.npmjs.com/package/npx\" target=\"_blank\" rel=\"noopener noreferrer\">npx</a> gives us a little bit more of flexibility finding the <code class=\"language-text\">newman</code> binary, in case you don’t want to use a <code class=\"language-text\">package.json</code> but have it globally installed.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function-name function\">goal_check-service</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  setup\n\n  <span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">SERVICE_PASSWORD</span><span class=\"token operator\">=</span><span class=\"token variable\">${SERVICE_PASSWORD<span class=\"token operator\">:-</span>$(gopass store<span class=\"token operator\">/</span>service<span class=\"token operator\">/</span>password)}</span>\n\n  run_newman <span class=\"token function\">service</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Tests</h3>\n<p>Doing a request is but the first step. Remember, we aim to build a test suite. We have a convenient test tab in Postman that we can use to write our tests.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 8.51063829787234%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAaklEQVQI1y3IsQrCUBBE0fz/f1jaWUbQLoWgjaiVCCnsNG9mdtddETF4q8PtIkISAJJ/Ew9DRAAzPEiyARlxvHq/b7tzrQ95u3eZaWaay0w3Azm5VZWkyX9TEhv0qddw8sXq2W9quX1fxi8BZm/ueA6e7wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"The test tab is on me\" title=\"The test tab is on me\" src=\"/static/ba9c632166d1582f8eafb0adf6b627c7/1d69c/test-tab.png\" srcset=\"/static/ba9c632166d1582f8eafb0adf6b627c7/4dcb9/test-tab.png 188w,\n/static/ba9c632166d1582f8eafb0adf6b627c7/5ff7e/test-tab.png 375w,\n/static/ba9c632166d1582f8eafb0adf6b627c7/1d69c/test-tab.png 750w,\n/static/ba9c632166d1582f8eafb0adf6b627c7/78797/test-tab.png 1125w,\n/static/ba9c632166d1582f8eafb0adf6b627c7/f8836/test-tab.png 1214w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</figure>\n<p>Our tests are written in <em>JavaScript</em>, using <a href=\"https://www.chaijs.com/api/bdd/\" target=\"_blank\" rel=\"noopener noreferrer\">Chai</a>. Let’s say I want to test that my call delivered a list of results, I could do it like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> <span class=\"token function-variable function\">getResults</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> jsonData <span class=\"token operator\">=</span> pm<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> jsonData<span class=\"token punctuation\">[</span><span class=\"token string\">'results'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\npm<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Request was successful\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    pm<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>have<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\npm<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"There are results\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    pm<span class=\"token punctuation\">.</span><span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token function\">getResults</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token function\">above</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>More details can be found <a href=\"https://blog.getpostman.com/2017/10/25/writing-tests-in-postman/\" target=\"_blank\" rel=\"noopener noreferrer\">here</a></p>\n<h3>Building flows</h3>\n<p>All the calls in a collection get executed sequentially. This offers us the opportunity to test whole flows instead of just single calls. One such a flow for a <code class=\"language-text\">/posts</code> resource is:</p>\n<ul>\n<li>Get a list of all <code class=\"language-text\">posts</code></li>\n<li>Fetch the first <code class=\"language-text\">post</code> in the list</li>\n<li>Update the <code class=\"language-text\">post</code></li>\n</ul>\n<p>We’ll build a suite of parametrized tests that will continue to work over time, not just the first time that you ran it. An important part of this is modifying the environment in a request. That is our way of transmitting parameters between requests. Let’s say our first request was successful, as corroborated by our tests. Then we store the id on a variable that will be used to fetch a particular entity.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// First result in the list</span>\n<span class=\"token keyword\">var</span> post <span class=\"token operator\">=</span> <span class=\"token function\">getResults</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Pass variables to other stages</span>\npm<span class=\"token punctuation\">.</span>environment<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">,</span> post<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span></code></pre></div>\n<p>The next request can use that parameter as any that we set manually.</p>\n<h4>Ignoring calls based on a condition</h4>\n<p>Flows might need also need some logic to skip certain requests. Let’s say you have a request that is creating a new entity through a <code class=\"language-text\">POST</code>. You want to have that request, but you may not want to run it on every commit. Maybe you just want do it once per day. In that case, we’ll skip the test based on a certain variable.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Do not run create request in sequence, unless executeCreate is set to true</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>pm<span class=\"token punctuation\">.</span>environment<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"executeCreate\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    postman<span class=\"token punctuation\">.</span><span class=\"token function\">setNextRequest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Get other posts'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The variable goes into the configuration file, and is set to a environment variable that gets injected through our script, as I showed above.</p>\n<h2>Time for some continuous integration</h2>\n<p>At this point you should have a collection that runs locally. Running this once is fine, but why not run it for every commit? Or maybe every hour, if you want to check an API that you don’t control?</p>\n<p>Your CI pipeline is a perfect place to do this. I’m going to use <a href=\"https://circleci.com\" target=\"_blank\" rel=\"noopener noreferrer\">CircleCI</a> for my example, but any CI will do. I run the tests inside a <a href=\"https://cloud.docker.com/repository/docker/sirech/newman-executor\" target=\"_blank\" rel=\"noopener noreferrer\">docker image</a> that I built which includes all the required dependencies. There is an official Docker image provided by Postman already. However, it does not contain <code class=\"language-text\">envsubst</code> and it uses an older <em>NodeJS</em> version.</p>\n<p>The helper script that we built in the step before will work without any changes inside CircleCI. We just have to provide the required secrets <a href=\"https://circleci.com/docs/2.0/env-vars/\" target=\"_blank\" rel=\"noopener noreferrer\">as variables</a>. This is the job:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">  <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>\n\n    <span class=\"token key atrule\">docker</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> sirech/newman<span class=\"token punctuation\">-</span>executor<span class=\"token punctuation\">:</span><span class=\"token number\">12.6</span>\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> checkout\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> ./go test<span class=\"token punctuation\">-</span>e2e</code></pre></div>\n<p>which will produce a report similar to this:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB1UlEQVQ4y52UaZKCQAyFOYiAC/umgIiD9z9Xpr50RRxh1JkfqXSH7peXlzRe0zQyjqNM0yRt28owDOq3263sdrs/m1eWpYzjRbquE9aHw0Ht34BFUUgURbLZbCQMQwV6BfYukVcUuSRJ/AOM9ZoZ2CtQDw1vty9pmlpLhW2appIkiaRpInEcq8+yVPb7/XuGXLheLzJNX2rX66hNybJMyrJQjyxVhb4fAMKKsquqkrqulJ3v+xIEgfh+oN7Wn5Tt5Xkuw3DWLrftSbqulbquteMwhBkJLSmSPII9AytDQAC9XAZdW+fjOFJvo8SaS8/T8AiqgHme3RlQMuIbyJoBjK01yUN0QOik62yqDCmX9Tz4rSa1GI1kD9tfAdGO0vu+E7QlZiOElhZjDyj7FcBUzCj9fO4fAF0cTzKLAWoJFoAcYBYxhvx4xI4KxAuyAbeRIsZZwDgThk8acoGyT6ejjg1MWD8mwtB1jkViUi2a4kpwjYAZJQM8a+vKhjmSmKZOw2xZMt3kMAfQzmaSEYKJA5yf4Uwg1/2CIeJaZ2FngH3fr5YOO2fup7EARGxeCGAA4TF+EnhAzUjKX4k7fIPhoilkoRwbZnu3NmdzvLiPCto5SeIFw2+S2EPqUBz9vAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Output\" title=\"Output\" src=\"/static/4ada27bc72a0a092f1ca972a5ed21cf2/1d69c/output.png\" srcset=\"/static/4ada27bc72a0a092f1ca972a5ed21cf2/4dcb9/output.png 188w,\n/static/4ada27bc72a0a092f1ca972a5ed21cf2/5ff7e/output.png 375w,\n/static/4ada27bc72a0a092f1ca972a5ed21cf2/1d69c/output.png 750w,\n/static/4ada27bc72a0a092f1ca972a5ed21cf2/78797/output.png 1125w,\n/static/4ada27bc72a0a092f1ca972a5ed21cf2/e515d/output.png 1430w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</figure>\n<h3>What about the alternatives?</h3>\n<p>Many frameworks provide their own way of running tests against a running API. In <a href=\"https://spring.io/projects/spring-boot\" target=\"_blank\" rel=\"noopener noreferrer\">Spring Boot</a>, for instance, you can use <a href=\"https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/test/web/servlet/MockMvc.html\" target=\"_blank\" rel=\"noopener noreferrer\">MockMvc</a> to test controllers. You can use both, in my view. First the native tests, so to speak, and then layer Postman Tests on top.</p>\n<p>And let’s not forget about good ol’ <a href=\"https://curl.haxx.se\" target=\"_blank\" rel=\"noopener noreferrer\">curl</a>. I had a huge collection of curl commands with which I tested an API that was needed for my last project. However, managing that becomes more and more tedious over time. If you want to use send complex requests, like certificates or cookies, Postman is way more convenient to use. Moreover, you can use JavaScript instead of bash, which can make things a bit easier to read and maintain.</p>\n<h2>What else?</h2>\n<p>This is already quite a lot and it’s just the beginning. Anything that you do with an API you can also automate. For instance, in my previous project we had a collection that ran an <a href=\"https://auth0.com/docs/api-auth/which-oauth-flow-to-use\" target=\"_blank\" rel=\"noopener noreferrer\">OAuth Flow</a>. That got us a token that we could use to make requests against an authorized endpoint.</p>\n<h2>A repo to use as an example</h2>\n<p><a href=\"https://github.com/sirech/echo/blob/master/echo.json\" target=\"_blank\" rel=\"noopener noreferrer\">Here</a> is a repository for a Kotlin application that runs a Postman collection as an e2e test. It can serve as a starter kit to get going with high quality End-to-End API Tests.</p>","frontmatter":{"layout":"post","title":"How to automate REST API end-to-end tests in a CI environment with Postman and Newman","path":"/how-to-automate-rest-api-end-to-end-tests/","categories":["REST","e2e","Postman","newman"],"date":"2019/08/19","draft":false,"description":"Postman is a great tool to explore REST APIs. You can build requests and try them out to get quick feedback. Then you can persist them as collections to make sure that the knowledge doesn't get lost.","canonical":"https://www.freecodecamp.org/news/how-to-automate-rest-api-end-to-end-tests/","image":null}},"related":{"nodes":[]},"previous":{"frontmatter":{"title":"Custom Components in Formik","path":"/custom-components-in-formik/","date":"2019/08/15"}},"next":{"frontmatter":{"title":"Descriptive assertions in Kotlin for clearer tests","path":"/descriptive-assertions-in-kotlin/","date":"2019/09/28"}}},"pageContext":{"related":[],"previous":"/custom-components-in-formik/","next":"/descriptive-assertions-in-kotlin/"}},"staticQueryHashes":[]}