{"componentChunkName":"component---src-templates-blog-post-js","path":"/setting-up-auth0-with-terraform/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for Meta","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"a6452631-a144-5958-89a9-3cee7c8a0ab1","html":"<p>Let’s imagine you have an application divided into two components, a frontend, and a backend. The frontend is a Single Page Application written in <em>React</em>, and the backend is a REST API written in, say, <em>Kotlin</em>. You want to implement some functionality that requires authorization. You naturally gravitate toward <a href=\"https://oauth.net/2/\" target=\"_blank\" rel=\"noopener noreferrer\">OAuth</a>. But then you realize that implementing it by yourself implies much effort. And you still need to manage users. Maybe use an <a href=\"https://en.wikipedia.org/wiki/List_of_OAuth_providers\" target=\"_blank\" rel=\"noopener noreferrer\">OAuth provider</a>? It all seems kind of overkill for protecting your homemade recipes manager.</p>\n<p>That’s where an <em>Identity Platform</em> like <a href=\"https://auth0.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Auth0</a> comes in. Why reinvent the wheel when you can use an existing solution?</p>\n<h2>The authorization flow</h2>\n<p>There is so much material about <a href=\"https://auth0.com/docs/flows\" target=\"_blank\" rel=\"noopener noreferrer\">authorization/authentication</a> already out there, what else can be said at this point? Maybe we can have a look at a simple diagram that shows the position of <em>Auth0</em> between my frontend and backend:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 633px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/9ba2c30ca85c9e15451abd04b934756a/bce72/flow.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 72.87234042553192%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAABoUlEQVR42qVUy07CUBBtQZSHCBIFFwgaipjaUtqSUooGFy5YGBNsGlduXLD3A0x/wE/zK1xj/AQ9x7RJ0QskOMnkvuaemTPntpK0xr5CKUWX/mnyhmeLFgRBejKZ7HB+53lFjh9+x/v0W9cEUlV1NwEqr63Itu0Dy7LcXq93OLLtBvfnQXs695UnpEvjvDEej8vwLUVRmDi9skLXdXO4dI4L2XjvbSZl3oN6LsnCcZw64kaIryxrw8+GYRhlgnLOKki/jnW8B0tFTPL9fr8TVbnUUgSMwTVNq2F9MRgMaglqcjJ5GIZi9ZGxhL4ZcA9znbRIm1XAiqLkEOgI58dCcdCTUwA9I8CHP3LNyihOs9nMRr3N0znHvgrxrjjqur7/p4/dbreK4Bf4KwKnzMyqeZlPBXML3mLPEFsAUBtrJ7pXEgEWSJXKMZiUkwzQrxMAV5IikgGY7AkpUwCAnrEy0zSVqILMLyHkWGUC4fySPRYCEgRUZxjvMd4i8EEAuCAKkt6gCFP4DkFnezgcVvkU6FFfVn5a/KoS/Vv70cub/la+AW59XM95kny7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"the flow to authorize the frontend to access the backend\" title=\"\" src=\"/static/9ba2c30ca85c9e15451abd04b934756a/bce72/flow.png\" srcset=\"/static/9ba2c30ca85c9e15451abd04b934756a/4dcb9/flow.png 188w,\n/static/9ba2c30ca85c9e15451abd04b934756a/5ff7e/flow.png 375w,\n/static/9ba2c30ca85c9e15451abd04b934756a/bce72/flow.png 633w\" sizes=\"(max-width: 633px) 100vw, 633px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>Until now, everything might sound familiar. Fetch a token in the frontend using a flow, include it in the request to the API with a header. Then verify the token in the backend to ensure its validity. Got it.</p>\n<h2>Setting up Auth0</h2>\n<p>You still need to set up the whole thing in <em>Auth0</em> itself, however. Most guides you’ll find on the internet show you how to do that by clicking through the UI. Which works, more or less. But what about the second time you want to do it? You’ll start from scratch, assuming you still remember how to do it, of course.</p>\n<p>The whole point of this article is that you are much better off using <a href=\"https://www.thoughtworks.com/de/insights/blog/infrastructure-code-reason-smile\" target=\"_blank\" rel=\"noopener noreferrer\">Infrastructure as Code</a> instead. I am going to show you how to deal with the previously mentioned setup by using <a href=\"https://www.terraform.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform</a>, a tool to provision infrastructure declaratively. It is definitely worth <a href=\"https://www.terraform.io/intro/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">learning</a>.</p>\n<h3>Auth0 + Terraform</h3>\n<p>There is an excellent <a href=\"https://www.terraform.io/docs/providers/auth0/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">terraform provider</a> for <em>Auth0</em>, which will make our life massively easier. We’ll declare our stuff, provision it, and store the code in <code class=\"language-text\">git</code>. That way, you can quickly check what you did, and adapt it for further applications without much effort. Or even write a blog post about it.</p>\n<p>Let’s assume we already have an account served under a domain (<code class=\"language-text\">auth0_domain</code>). If we want to work with <em>Auth0</em> programmatically, we need to create an application with access to the <em>Auth0 Management API</em>. We have to do this step manually, <a href=\"https://auth0.com/docs/api/management/v2/create-m2m-app\" target=\"_blank\" rel=\"noopener noreferrer\">following these steps</a>. After this, we’ll have a <code class=\"language-text\">client_id</code> and a <code class=\"language-text\">client_secret</code> that we can use throughout the rest of the process. On to the code.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/4816781576f3c83e2935ccd97e42c18a/e7aec/management-api.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 60.1063829787234%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAABYlAAAWJQFJUiTwAAABRklEQVR42o2SXUvDMBSG8/9/jnghXoneDGQMJqiIK2xzrf3ITJOm+ehJ4kmCOJGVPS0hOeXNm7ynhLP+UNZCiH2iqqq6roui4JyHELz34TyE7revxU4qhbKyLNu27boOJ6zvORfjqObEuHsy8CGZ+AROnHPTNOE4J5Zm4toacMKA1sZaGy6GWABtLYqUsUpHUG9M3GUePCChlDZNIxPjOA7DgOFhWuIELGIlf8rgEm9E8GLohiMA4Dgf7ylR7L1zSRelaQuXCqfkivsBDfKSaIAvbVnKDJ9zvtECw0+n00rl1hB95Kw+8pb1n1SyPov9P/BIymCYZrIgpXKpSIa7dXW9aG4e2e0SDt0U/GTtn/bmFHat25RhT+n2vXxbhw/qY6u0RkPJBb6DxLQlpoqt+jUFF3+j1UYtnmG9fVndLx+uwtMOQvgGikC5ZZnY1sUAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"you need a test app with the management API active\" title=\"\" src=\"/static/4816781576f3c83e2935ccd97e42c18a/1d69c/management-api.png\" srcset=\"/static/4816781576f3c83e2935ccd97e42c18a/4dcb9/management-api.png 188w,\n/static/4816781576f3c83e2935ccd97e42c18a/5ff7e/management-api.png 375w,\n/static/4816781576f3c83e2935ccd97e42c18a/1d69c/management-api.png 750w,\n/static/4816781576f3c83e2935ccd97e42c18a/78797/management-api.png 1125w,\n/static/4816781576f3c83e2935ccd97e42c18a/aa440/management-api.png 1500w,\n/static/4816781576f3c83e2935ccd97e42c18a/e7aec/management-api.png 1726w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<h3>The provider</h3>\n<p>The first thing we need to do is set up the provider.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">provider<span class=\"token type variable\"> \"auth0\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">domain</span>        <span class=\"token punctuation\">=</span> var.auth0_domain\n  <span class=\"token property\">client_id</span>     <span class=\"token punctuation\">=</span> var.auth0_client_id\n  <span class=\"token property\">client_secret</span> <span class=\"token punctuation\">=</span> var.auth0_client_secret\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This provider requires the credentials we manually obtained in the step before. Store them securely in something like <a href=\"../storing-passwords-with-gopass/\">gopass</a>. You can export these credentials as environment variables, and they will be picked up by <code class=\"language-text\">terraform</code> automatically. You only need to follow this specific syntax:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">TF_VAR_auth0_domain</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>gopass auth0/domain<span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">TF_VAR_auth0_client_id</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>gopass auth0/client_id<span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">TF_VAR_auth0_client_secret</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>gopass auth0/client_secret<span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">TF_VAR_auth0_my_host</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>gopass auth0/my_host<span class=\"token variable\">)</span></span></code></pre></div>\n<h2>Let’s set up our application</h2>\n<h3>The identity provider</h3>\n<p>We can provision our users, but what about using an existing solution like Google? Then we don’t need to do any account management. For that, we need to define a connection.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"auth0_connection\"</span></span> <span class=\"token string\">\"google\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"google\"</span>\n  <span class=\"token property\">strategy</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"google-oauth2\"</span>\n\n  <span class=\"token property\">enabled_clients</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>\n    auth0_client.cookery2-frontend.id,\n    auth0_client.shelf2-frontend.id\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This connection means that anybody with a Google account can log in. We’ll get to defining permissions in a bit.</p>\n<h3>The application</h3>\n<p>For our frontend, we need to define an <a href=\"https://auth0.com/docs/dashboard/reference/settings-application\" target=\"_blank\" rel=\"noopener noreferrer\">application</a>. We’ll use this application to get an access token to connect to our API.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"auth0_client\"</span></span> <span class=\"token string\">\"cookery2-frontend\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"cookery2-frontend\"</span>\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Cookery2 Application - Terraform generated\"</span>\n  <span class=\"token property\">app_type</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"spa\"</span>\n  <span class=\"token property\">callbacks</span>   <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"http://localhost:3003/callback\"</span>, <span class=\"token string\">\"https://<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">local</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">cookery2_host</span><span class=\"token punctuation\">}</span></span>/callback\"</span><span class=\"token punctuation\">]</span>\n\n  <span class=\"token property\">oidc_conformant</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n\n  <span class=\"token keyword\">jwt_configuration</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">alg</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"RS256\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I am using the <a href=\"https://oauth.net/2/grant-types/implicit/\" target=\"_blank\" rel=\"noopener noreferrer\">implicit flow</a>, which is not recommended anymore from a security standpoint. That is a topic for a future article. My list of recipes doesn’t have strong security requirements, so I can live with it!</p>\n<p>I’m enabling two callbacks, the actual domain, and localhost so that we can test things locally as well.</p>\n<h3>The API</h3>\n<p>Our application is now able to fetch a token. But it still needs to access something. That something is the API, which is conveniently called an <a href=\"https://auth0.com/docs/dashboard/reference/settings-api\" target=\"_blank\" rel=\"noopener noreferrer\">API</a> in <em>Auth0</em>.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"auth0_resource_server\"</span></span> <span class=\"token string\">\"cookery2-backend\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>             <span class=\"token punctuation\">=</span> <span class=\"token string\">\"cookery2-backend\"</span>\n  <span class=\"token property\">identifier</span>       <span class=\"token punctuation\">=</span> local.cookery2_host\n  <span class=\"token property\">signing_alg</span>      <span class=\"token punctuation\">=</span> <span class=\"token string\">\"RS256\"</span>\n  <span class=\"token property\">enforce_policies</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n\n  <span class=\"token property\">token_lifetime</span>         <span class=\"token punctuation\">=</span> <span class=\"token number\">86400</span>\n  <span class=\"token property\">token_lifetime_for_web</span> <span class=\"token punctuation\">=</span> <span class=\"token number\">7200</span>\n\n  <span class=\"token property\">skip_consent_for_verifiable_first_party_clients</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n\n  <span class=\"token keyword\">scopes</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">value</span>       <span class=\"token punctuation\">=</span> <span class=\"token string\">\"create:recipes\"</span>\n    <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Can create a recipe\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">enforce_policies</code> flag activates the <a href=\"https://auth0.com/docs/authorization/concepts/rbac\" target=\"_blank\" rel=\"noopener noreferrer\">Role-Based Access Control</a> that is required to enforce anything. We are defining a scope (<code class=\"language-text\">create:recipes</code>), which is the only operation that we want to restrict.</p>\n<h2>RBAC</h2>\n<p>There are two ways of implementing <em>RBAC</em> in <em>Auth0</em>, <a href=\"https://auth0.com/docs/authorization/guides/how-to\" target=\"_blank\" rel=\"noopener noreferrer\">Authorization Core</a>, and <a href=\"https://auth0.com/docs/extensions/authorization-extension\" target=\"_blank\" rel=\"noopener noreferrer\">Authorization Extension</a>. We are going to use the Core one, which is a bit newer and more integrated into <em>Auth0</em>.</p>\n<p>The idea is to create a role with a permission associated with it for a concrete API. In our case, the <code class=\"language-text\">create:recipes</code> scope we provisioned before.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"auth0_role\"</span></span> <span class=\"token string\">\"cookery2-editor\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Cookery2 - Editor\"</span>\n\n  <span class=\"token keyword\">permissions</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">name</span>                       <span class=\"token punctuation\">=</span> <span class=\"token string\">\"create:recipes\"</span>\n    <span class=\"token property\">resource_server_identifier</span> <span class=\"token punctuation\">=</span> auth0_resource_server.cookery2-backend.identifier\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>When we authenticate with our client, we include a list of requested scopes, let’s say <code class=\"language-text\">profile create:recipes</code>. <em>Auth0</em> checks our user, and if that user is assigned the <code class=\"language-text\">cookery2-editor</code> role, then the scope is included in the <code class=\"language-text\">access_token</code> that gets returned. The API then knows that the user is allowed to create recipes.</p>\n<h3>Assigning the role to a user</h3>\n<p>The way to assign roles to users at scale is by associating <a href=\"https://auth0.com/docs/users/concepts/overview-user-metadata\" target=\"_blank\" rel=\"noopener noreferrer\">metadata</a> to them with a <a href=\"https://auth0.com/docs/rules\" target=\"_blank\" rel=\"noopener noreferrer\">rule</a>. A rule is a <em>JavaScript</em> snippet where you can apply your business logic. This is an example taken directly from the official documentation:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  user<span class=\"token punctuation\">.</span>app_metadata <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>app_metadata <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// update the app_metadata that will be part of the response</span>\n  user<span class=\"token punctuation\">.</span>app_metadata<span class=\"token punctuation\">.</span>roles <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>app_metadata<span class=\"token punctuation\">.</span>roles <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  user<span class=\"token punctuation\">.</span>app_metadata<span class=\"token punctuation\">.</span>roles<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">'administrator'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// persist the app_metadata update</span>\n  auth0<span class=\"token punctuation\">.</span>users<span class=\"token punctuation\">.</span><span class=\"token function\">updateAppMetadata</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>user_id<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">.</span>app_metadata<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>For my tiny little app, I’m assigning the role to my user manually, in the UI.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/596f761649471620a7203e636aa0dbe0/b4904/user-role.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 45.74468085106383%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAABYlAAAWJQFJUiTwAAABGElEQVR42oVRPU/EMAzNX2VlYOEnMPIvEAsrE0hsDDfAgASI4yRuqNLjrqBr2iRNYjsp7odOlVDhybFeHNt5iYUxJssyKWVd123bppTaOaTIDlZP1fmxOjvy99fCWrvd7fJ8UxRfWptaa0SaKe76xiJ3d1fNzSWuX8QYTvGAvy7n1AkXHqkBapA8RfaBonIQMOqATEoXOGICaiDnnPe+r6LekmCRHOQwWwgQBw0pIUU26jl7Nuz29GHoscSHEjcuCgDoHlrz0tz7X8EXEk9f/cmzuy1QACJLm3zKCKVUVVVpAj7l7mq/R4DxzfguzeLNLpaw/kzdOOKQij1+FxtrmZjG+QAiym+3yv1Sxm15mMccho5MAgtG+gEyagkYpbqShwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"the user with the correct role assigned\" title=\"\" src=\"/static/596f761649471620a7203e636aa0dbe0/1d69c/user-role.png\" srcset=\"/static/596f761649471620a7203e636aa0dbe0/4dcb9/user-role.png 188w,\n/static/596f761649471620a7203e636aa0dbe0/5ff7e/user-role.png 375w,\n/static/596f761649471620a7203e636aa0dbe0/1d69c/user-role.png 750w,\n/static/596f761649471620a7203e636aa0dbe0/78797/user-role.png 1125w,\n/static/596f761649471620a7203e636aa0dbe0/aa440/user-role.png 1500w,\n/static/596f761649471620a7203e636aa0dbe0/b4904/user-role.png 1768w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<h2>A test application</h2>\n<p>Lastly, we want an extra application for testing purposes. If we want to test that the connection to the API works, we can create one that uses machine-to-machine authentication, which makes obtaining a token easier.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"auth0_client\"</span></span> <span class=\"token string\">\"cookery2-frontend-test\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"cookery2-frontend-test\"</span>\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Cookery2 Application (Test) - Terraform generated\"</span>\n  <span class=\"token property\">app_type</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"non_interactive\"</span>\n\n  <span class=\"token property\">token_endpoint_auth_method</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"client_secret_post\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"auth0_client_grant\"</span></span> <span class=\"token string\">\"cookery2-frontend-test\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">client_id</span> <span class=\"token punctuation\">=</span> auth0_client.cookery2-frontend-test.id\n  <span class=\"token property\">audience</span>  <span class=\"token punctuation\">=</span> auth0_resource_server.cookery2-backend.identifier\n  <span class=\"token property\">scope</span>     <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There is a tab on the API page that has the code to generate a token for it using the test app we just created.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/53cb58422f2a28eb7726b59d1c1dfc5d/f69df/testing-api.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 53.191489361702125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB0ElEQVR42nWRS2/TQBSF/UvYIjWCQhJBashLIaVpWqpuKrVuJRYVahM78OeQEBVbpLKAFTTQJrHHqVHiUFy/52Vzx2aBInHm0/XRzJy5I4/kxYQwHmCKGYMaEYop8zEVxMRjnMwd8vFrYsxTUJKk/0iKGedJQlhCuYDwhPEEJsFgxqM0pYvb+NOQmzbkErH3r0TYMHTLskzT/JnLsmazmW3bCCHTRDDBGE//IymKIoxxGIau64IHE2TyfT/OxKEbDDiDL58i5R/IO45DMoWZIJYv5ZeklDLGlsN5H7Fb9I8C0Tzy/EAMuI7ve0Hgej5sgPxy+GL4fWSgK934MdYvJ+hirIP/NppcTowrAw3HxkhH4M3pNTC9tnLQdArHSauVWrPzotXZaaxvVWrP1uptqHJjvVJvl582BU8EJblRzABTrrburj56d/ZBWinLra3d4vPNUne7uLH5sLv9oNMtbXTLzXahUl0B5DqYwlqt8BhqFfx9uXHnXvHt+zNp/+XxsfrmoKcpfU3paQfqQOkPhDlVD3saoGivD09VRdWUk/6ROjjqacDeq5Pzz18keNXFwv796wa4AQdvPJu7zi2OYhxnZCbOnpFgDERBSIn4eX8Ark8C6RLPYwIAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Testing the API page\" title=\"\" src=\"/static/53cb58422f2a28eb7726b59d1c1dfc5d/1d69c/testing-api.png\" srcset=\"/static/53cb58422f2a28eb7726b59d1c1dfc5d/4dcb9/testing-api.png 188w,\n/static/53cb58422f2a28eb7726b59d1c1dfc5d/5ff7e/testing-api.png 375w,\n/static/53cb58422f2a28eb7726b59d1c1dfc5d/1d69c/testing-api.png 750w,\n/static/53cb58422f2a28eb7726b59d1c1dfc5d/78797/testing-api.png 1125w,\n/static/53cb58422f2a28eb7726b59d1c1dfc5d/aa440/testing-api.png 1500w,\n/static/53cb58422f2a28eb7726b59d1c1dfc5d/f69df/testing-api.png 1762w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<h2>Storing the state</h2>\n<p><em>Terraform</em> creates a <a href=\"https://www.terraform.io/docs/state/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">state</a> when run to know what things are there and in which state. Storing it in your laptop is risky, as it could get lost or even leaked. In our case, the most convenient option is to store it directly in <a href=\"https://app.terraform.io/\" target=\"_blank\" rel=\"noopener noreferrer\">HashiCorp’s own service</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">terraform</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">backend<span class=\"token type variable\"> \"remote\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">organization</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"our-organization\"</span>\n\n    <span class=\"token keyword\">workspaces</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">name</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"our-workspace\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There are multiple <a href=\"https://www.terraform.io/docs/state/remote.html\" target=\"_blank\" rel=\"noopener noreferrer\">alternatives</a> to store the state remotely.</p>\n<h2>Summary</h2>\n<p>That’s all you need to do. Thanks to <code class=\"language-text\">Terraform</code>, we can provision applications and APIs using code that we can execute repeatedly. We know exactly what we have configured. We can add new use cases with little effort. You won’t need to reverse engineer what you did six months ago or write a note not to forget setting a parameter correctly. It is truly a new world.</p>","frontmatter":{"layout":"post","title":"Setting up Auth0 with Terraform","path":"/setting-up-auth0-with-terraform/","categories":["Auth0","OAuth","Infrastructure as Code","Terraform","Security"],"date":"2020/02/22","draft":false,"description":"Setting up Auth0 with Terraform ensures that your setup is repeatable, and that you can authorize your apps easily and conveniently","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/9ba2c30ca85c9e15451abd04b934756a/0a445/flow.png","srcSet":"/static/9ba2c30ca85c9e15451abd04b934756a/85d9a/flow.png 158w,\n/static/9ba2c30ca85c9e15451abd04b934756a/362ce/flow.png 317w,\n/static/9ba2c30ca85c9e15451abd04b934756a/0a445/flow.png 633w","sizes":"(min-width: 633px) 633px, 100vw"},"sources":[{"srcSet":"/static/9ba2c30ca85c9e15451abd04b934756a/067f1/flow.webp 158w,\n/static/9ba2c30ca85c9e15451abd04b934756a/8f3c6/flow.webp 317w,\n/static/9ba2c30ca85c9e15451abd04b934756a/6fa40/flow.webp 633w","type":"image/webp","sizes":"(min-width: 633px) 633px, 100vw"}]},"width":750,"height":546.2085308056872}}}}},"related":{"nodes":[{"frontmatter":{"title":"Authorization for a Kotlin Spring backend, using JSON Web Tokens","path":"/authorize-spring-backend-with-jwt-in-kotlin/","date":"2020/03/19"}},{"frontmatter":{"title":"Setting up OAuth for Grafana with Auth0","path":"/setting-up-oauth-for-grafana-with-auth0/","date":"2021/01/17"}}]},"previous":{"frontmatter":{"title":"Either Types as an alternative to throwing exceptions in Kotlin","path":"/kotlin-either-types-instead-of-exceptions/","date":"2020/01/09"}},"next":{"frontmatter":{"title":"Useful commands to work with certificates","path":"/useful-commands-to-work-with-certificates/","date":"2020/04/08"}}},"pageContext":{"related":["/authorize-spring-backend-with-jwt-in-kotlin/","/setting-up-oauth-for-grafana-with-auth0/"],"previous":"/kotlin-either-types-instead-of-exceptions/","next":"/useful-commands-to-work-with-certificates/"}},"staticQueryHashes":[],"slicesMap":{}}