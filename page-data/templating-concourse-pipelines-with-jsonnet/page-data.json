{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/templating-concourse-pipelines-with-jsonnet/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for ThoughtWorks","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"671443f2-1dd6-5b08-8d9b-c2860553d8b7","html":"<div class=\"guide clearfix\">\n<h3>Generating pipelines for Concourse using jsonnet</h3>\n<ul>\n<li><a href=\"../templating-concourse-pipelines-with-jsonnet/\"><strong>Part 1 - Introduction</strong></a></li>\n<li><a href=\"../templating-concourse-pipelines-with-jsonnet-follow-up/\">Part 2 - Follow-up</a></li>\n</ul>\n</div>\n<figure class=\"figure figure--right\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 312px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/813f454ce9cf9cf63b201506e1ab38ba/17474/logo.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 68.61702127659575%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAADa0lEQVQ4y22Tb2xTVRjGn3vbGY3xTyQTNZmJX5FPxuA3/UbKTLqMhRZMZO29pwUkzGFYQhSSjZiZCDGSzWGEbBqidAsZyTqc9J67XsbmWkFnM/64DUJXJtTqut1ht+5edl9zb7uxD57kzTl5T95f3uec5wUkDtRzQOaic5bXRVAp5RkHmApICojICcuynL1grODmrLGWL8FCXChDXhQY90Pm+wTGtz6/V3GVYFx07hlfAxGRkF96JI5kCuIXib/FNaB7jyq4wxwi4wFXSJ0FU8kVUgmyHcpvAuObHahcgq4WrkZyZhFH4tnHHYqMQ2DcC4kTAgptOBA3K8Jx85l93HTv0QgyvycwXllWINidlYvfJqKue7rRcWFioYOIqkqSX+GApF7deIDTse5fjZ4op+ZOhWLaqLWjOVKEpJLIeDMkFZWNl13jmVnXrbyB9Lzx4dUHSzQ6U6Dzf+g0OWe+eeMfA3jt8HAVdl16eCI6QURkxTXNUmMD1ngqZb21/4wphDUSGL+I+kHAtdU1krzj7rlPiKf/3d83uUBDmQLdzi9TbtF6I1+0gCf3xqsgKQ9fbRqmKxNzlg1NjAxZ7e3tVs2nP5rOWwZjF1+Sz8FefagApcZsyTuI6E81XZj6Ziw/SUSvO5K3nPwd7rB6De/9RKzrlpEcu259dla1zp3vs95tOr2M4CBVNQ1/+VF49w8nOk6NtwSCv2QPHhpdIbptmiutNuT+kvWcL5oVN3+XARzvSbxGDKlUER6kFz6Ime6Qam48eMW0c9h96a6Sp01Dgzz3jsdD1w5/TJPVXircuGk/0Wmj/LufDM+iLpqF7a1VD8oC43NrtpEUEpg6ju3RTUT0lF5YnDnZ2kqLkR4j291T/Kv3gg08ZcMWlh+5J+YM/PygCCDIIYRUByow9WWB8V2QeVhkvHpL88gT9WfTdgeVuVxuWgoE6PtIxPAHAsWuzk4b+FXZQq6SZVCWHPz/0Vtn4A2Z6Wnd5/dTbW0t1dbU0JGjR8kwjG/tydF13aXrehloF4c14P0Bx7iQuT1ubnv/fCC9auJnp6amutva2i7r8/PKsZaWWPW2bYm6urpGj8cDv98ver1ePF7up4Gm40Dj18DOM8DO48D2yPq5RSqVQkNDA3p7e+Hz+WCDkskkEokENE1Df3+/w/oPs/ZhvOQ7i1EAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"YAML and Concourse and Jsonnet\" title=\"YAML and Concourse and Jsonnet\" src=\"/static/813f454ce9cf9cf63b201506e1ab38ba/17474/logo.png\" srcset=\"/static/813f454ce9cf9cf63b201506e1ab38ba/4dcb9/logo.png 188w,\n/static/813f454ce9cf9cf63b201506e1ab38ba/17474/logo.png 312w\" sizes=\"(max-width: 312px) 100vw, 312px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>If you talk about <a href=\"https://www.thoughtworks.com/radar/techniques/templating-in-yaml\" target=\"_blank\" rel=\"noopener noreferrer\">templating in YAML</a>, it’s bound to raise some eyebrows. It’s the perfect storm. A whitespace-aware templating language combined with some shitty annotations means you’re in for a world of pain. I recently tried to abuse <a href=\"https://docs.gomplate.ca/\" target=\"_blank\" rel=\"noopener noreferrer\">gomplate</a> to generate some <em>YAML</em> files, and it was just gross.</p>\n<p>Let’s agree not to do it. It’s just not built for that. Nevertheless, at some point, <em>YAML</em> documents get really difficult to handle. Like when you are defining pipelines in <a href=\"https://concourse-ci.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Concourse</a>.</p>\n<p>That’s why I want to talk about <em>templating that generates YAML</em> instead. I’ve been using <a href=\"https://jsonnet.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Jsonnet</a> for that, and I’m quite happy with the results thus far. The code is <a href=\"https://github.com/sirech/example-concourse-pipeline\" target=\"_blank\" rel=\"noopener noreferrer\">here</a> if you want to jump straight to it.</p>\n<h2>What’s the point of templating, anyways?</h2>\n<p>In a nutshell, <em>YAML</em> is <strong>very</strong> verbose. It also happens to be the format of choice for most CI/CD tools. That means it’s pretty likely that you’ll be defining delivery pipelines using <em>YAML</em> sooner or later. I’ve written in <a href=\"https://www.thoughtworks.com/insights/blog/modernizing-your-build-pipelines\" target=\"_blank\" rel=\"noopener noreferrer\">depth</a> about high-quality pipelines. I’m all about pipelines that tell me exactly what’s wrong, without having to examine tons of log output. Let’s say a job in my pipeline failed:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/9e9c088749b3bd4672e54a436c7b0974/7d62e/failed-concourse-job.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 23.936170212765955%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAABEUlEQVQY002RTUoDQRCFcwz37iPzP11V3ZMZzSRjXBhFBTfiJrgU4h2EQFx6BkEQr+RJPp0JRhcPmmr66/dejbwZvUwVMyUUQpU4vChee+3unCp3QbkNStnP/r1TEfIsG84jcQ5XllRVoC6N+L7lcHOOm1Vo7cnLfICeTCreZ563VmnNCEVBkecEM067jqf1muOm+QOKCXXkGG+uOfh6pFhMdg68EUJgVjd8nlV8LAJTE9IkJo4i1Dkul0u22y3tdMpoH9kbVSZEqzmHr1e4eYWIQ0pHqY4uNfzLDfp8QeOESDKSOCZ4zyQEemND5KG7X/Vwp/hchg5Ndv2oCiETjh46xqv58EmaJgOwT7ffwQ/wG2OKsGRIp1NQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Failed Job\" title=\"Failed Job\" src=\"/static/9e9c088749b3bd4672e54a436c7b0974/1d69c/failed-concourse-job.png\" srcset=\"/static/9e9c088749b3bd4672e54a436c7b0974/4dcb9/failed-concourse-job.png 188w,\n/static/9e9c088749b3bd4672e54a436c7b0974/5ff7e/failed-concourse-job.png 375w,\n/static/9e9c088749b3bd4672e54a436c7b0974/1d69c/failed-concourse-job.png 750w,\n/static/9e9c088749b3bd4672e54a436c7b0974/78797/failed-concourse-job.png 1125w,\n/static/9e9c088749b3bd4672e54a436c7b0974/aa440/failed-concourse-job.png 1500w,\n/static/9e9c088749b3bd4672e54a436c7b0974/7d62e/failed-concourse-job.png 2368w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>I know the linting failed. Which part exactly? If the job is nicely split into tasks, I can spot the problem at a glance:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/daf10ba4b9c0f005784e466b7e18fa61/799f3/failed-concourse-task.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 41.48936170212767%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABLklEQVQoz53MQUrDQBTG8RxDiwhmJmmazEyaSWcmra3gzqig0I3VIuglXHg/3XkJV7rQ1gv8pS26FOzix+Pxvu9Fr9Nj3q9a3i7HfMxbFjcnG+eBxaljcfYXz2dbs7w9Yzlv+bq/IHq5G/L0MOD5cshjY5mWOdcmY6ZSZrrLTP3h564zZqtOmROdHJVMJhpfZMRCsHMQ04kFnVj+2o0Fe0mK1AblAsXAoZzH+AbtA0XtyCrLfpYR9fsVOtfUdY0pCqzWBGsZOUdTWw693wieSRMYh9XumDTNOjNyA8YhrDNG5UQjW+FKgy8NRZJsJ11NyXD1cGAr+kbT15qulGTJNpJ1VxU5UVVVKKUwxiClRAqBFPJ/pEQIQS/vEdXWUhpD8B6tFGmSkKUp3S0oVfANap0IkpXBGkUAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Failed Task\" title=\"Failed Task\" src=\"/static/daf10ba4b9c0f005784e466b7e18fa61/1d69c/failed-concourse-task.png\" srcset=\"/static/daf10ba4b9c0f005784e466b7e18fa61/4dcb9/failed-concourse-task.png 188w,\n/static/daf10ba4b9c0f005784e466b7e18fa61/5ff7e/failed-concourse-task.png 375w,\n/static/daf10ba4b9c0f005784e466b7e18fa61/1d69c/failed-concourse-task.png 750w,\n/static/daf10ba4b9c0f005784e466b7e18fa61/78797/failed-concourse-task.png 1125w,\n/static/daf10ba4b9c0f005784e466b7e18fa61/aa440/failed-concourse-task.png 1500w,\n/static/daf10ba4b9c0f005784e466b7e18fa61/799f3/failed-concourse-task.png 1642w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>I have a granular breakdown, including every task, and I can directly go to the error without an archeological investigation. The downside, though? A lot of markup. Like really, a lot. This is how this innocent linter task looks like:</p>\n<!-- linter-task -->\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> lint\n  <span class=\"token key atrule\">serial</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">plan</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">in_parallel</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">get</span><span class=\"token punctuation\">:</span> git\n      <span class=\"token key atrule\">passed</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>prepare<span class=\"token punctuation\">]</span>\n      <span class=\"token key atrule\">trigger</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">get</span><span class=\"token punctuation\">:</span> dev<span class=\"token punctuation\">-</span>container\n      <span class=\"token key atrule\">passed</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>prepare<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">in_parallel</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">task</span><span class=\"token punctuation\">:</span> lint<span class=\"token punctuation\">-</span>sh\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> dev<span class=\"token punctuation\">-</span>container\n      <span class=\"token key atrule\">params</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">&lt;&lt;</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*common-params</span>\n        <span class=\"token key atrule\">TARGET</span><span class=\"token punctuation\">:</span> sh\n      <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span> git/pipeline/tasks/linter/task.yml\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">task</span><span class=\"token punctuation\">:</span> lint<span class=\"token punctuation\">-</span>js\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> dev<span class=\"token punctuation\">-</span>container\n      <span class=\"token key atrule\">params</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">&lt;&lt;</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*common-params</span>\n        <span class=\"token key atrule\">TARGET</span><span class=\"token punctuation\">:</span> js\n      <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span> git/pipeline/tasks/linter/task.yml\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">task</span><span class=\"token punctuation\">:</span> lint<span class=\"token punctuation\">-</span>css\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> dev<span class=\"token punctuation\">-</span>container\n      <span class=\"token key atrule\">params</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">&lt;&lt;</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*common-params</span>\n        <span class=\"token key atrule\">TARGET</span><span class=\"token punctuation\">:</span> css\n      <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span> git/pipeline/tasks/linter/task.yml\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">task</span><span class=\"token punctuation\">:</span> lint<span class=\"token punctuation\">-</span>docker\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> dev<span class=\"token punctuation\">-</span>container\n      <span class=\"token key atrule\">params</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">&lt;&lt;</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*common-params</span>\n        <span class=\"token key atrule\">TARGET</span><span class=\"token punctuation\">:</span> docker\n      <span class=\"token key atrule\">file</span><span class=\"token punctuation\">:</span> git/pipeline/tasks/linter/task.yml</code></pre></div>\n<p>This task definition is using anchors and a parametrized task to reduce duplication, which is about the most you can do in <em>Concourse</em>. Still, this is way too much code. And it just gets bigger and bigger as the pipeline grows in functionality. <em>YAML</em> doesn’t really give us a way to fight duplication.</p>\n<h2>Jsonnet to the rescue</h2>\n<p><em>Jsonnet</em> is a data templating language. You define your data, and it creates one or more <em>JSON</em> documents for you. The crucial part is that it gives you functions, conditionals, variables, and other tools to build more powerful abstractions. Just what I need! After a quick <code class=\"language-text\">brew install jsonnet</code>, we can get going.</p>\n<p>As you surely know, <em>YAML</em> is a superset of <em>JSON</em>. If this tool is outputting <em>JSON</em>, we can convert it to <em>YAML</em> without loss. We are going to build a pipeline that will be lean and maintainable without any ugly hacks.</p>\n<h3>A small library of utility functions</h3>\n<p><em>Concourse</em> has a bunch of basic abstractions. You have <a href=\"https://concourse-ci.org/resources.html\" target=\"_blank\" rel=\"noopener noreferrer\">resources</a>, <a href=\"https://concourse-ci.org/jobs.html\" target=\"_blank\" rel=\"noopener noreferrer\">jobs</a>, and <a href=\"https://concourse-ci.org/tasks.html\" target=\"_blank\" rel=\"noopener noreferrer\">tasks</a>, among others. Each of those is represented by an object with some attributes. We can instantiate one by using functions that receive a configuration and emit a valid object. Here are some examples:</p>\n<!-- basic-resources -->\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  <span class=\"token function\">DockerResource</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> repository<span class=\"token punctuation\">,</span> tag <span class=\"token operator\">=</span> <span class=\"token string\">'latest'</span><span class=\"token punctuation\">,</span> allow_insecure <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> name<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'docker-image'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">source</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">repository</span><span class=\"token operator\">:</span> repository<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">tag</span><span class=\"token operator\">:</span> tag\n    <span class=\"token punctuation\">}</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token keyword\">if</span> allow_insecure then <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">insecure_registries</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>std<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>repository<span class=\"token punctuation\">,</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n\n  <span class=\"token function\">Parallel</span><span class=\"token punctuation\">(</span>tasks<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">in_parallel</span><span class=\"token operator\">:</span> tasks\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token function\">Job</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> serial <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> plan <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span><span class=\"token operator\">:</span> std<span class=\"token punctuation\">.</span><span class=\"token function\">prune</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> name<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">serial</span><span class=\"token operator\">:</span> serial<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">plan</span><span class=\"token operator\">:</span> plan\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can use them as regular functions inside a <code class=\"language-text\">.jsonnet</code> file after importing the library.</p>\n<!-- git-resource -->\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">local concourse <span class=\"token operator\">=</span> <span class=\"token keyword\">import</span> <span class=\"token string\">'concourse.libsonnet'</span><span class=\"token punctuation\">;</span>\nconcourse<span class=\"token punctuation\">.</span>GitResource<span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> <span class=\"token string\">'https://github.com/sirech/example-concourse-pipeline.git'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>The syntax somehow resembles both <em>JavaScript</em> and <em>Python</em>. It’s not quite a programming language, but you have some more toys to play with. Additionally, there is a big <a href=\"https://jsonnet.org/ref/stdlib.html\" target=\"_blank\" rel=\"noopener noreferrer\">standard library</a> to use. I’ve packaged these building blocks as a <a href=\"https://github.com/sirech/concourse-jsonnet-utils\" target=\"_blank\" rel=\"noopener noreferrer\">small library</a> that can be reused by just pulling the code.</p>\n<h3>Less YAML, more Jsonnet</h3>\n<p>Let’s say we are defining our <code class=\"language-text\">resources</code>. I have a sample project where it looks like this:</p>\n<!-- resources -->\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> git\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> git\n  <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">uri</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//github.com/sirech/example<span class=\"token punctuation\">-</span>concourse<span class=\"token punctuation\">-</span>pipeline.git\n    <span class=\"token key atrule\">branch</span><span class=\"token punctuation\">:</span> master\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dev<span class=\"token punctuation\">-</span>container\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> docker<span class=\"token punctuation\">-</span>image\n  <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> registry<span class=\"token punctuation\">:</span>5000/dev<span class=\"token punctuation\">-</span>container\n    <span class=\"token key atrule\">insecure_registries</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> registry<span class=\"token punctuation\">:</span><span class=\"token number\">5000</span>\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> serverspec<span class=\"token punctuation\">-</span>container\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> docker<span class=\"token punctuation\">-</span>image\n  <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> sirech/dind<span class=\"token punctuation\">-</span>ruby\n    <span class=\"token key atrule\">tag</span><span class=\"token punctuation\">:</span> 2.6.3</code></pre></div>\n<p>It’s not a lot of code, but you can feel that the structure is pretty repetitive. With the help of our previously defined helpers, we can do better.</p>\n<!-- jsonnet-resources -->\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">local source <span class=\"token operator\">=</span> <span class=\"token string\">'git'</span><span class=\"token punctuation\">;</span>\nlocal container <span class=\"token operator\">=</span> <span class=\"token string\">'dev-container'</span><span class=\"token punctuation\">;</span>\n\nlocal resources <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  concourse<span class=\"token punctuation\">.</span>GitResource<span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> <span class=\"token string\">'https://github.com/sirech/example-concourse-pipeline.git'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  concourse<span class=\"token punctuation\">.</span>DockerResource<span class=\"token punctuation\">(</span>container<span class=\"token punctuation\">,</span> <span class=\"token string\">'registry:5000/dev-container'</span><span class=\"token punctuation\">,</span> allow_insecure <span class=\"token operator\">=</span> true<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  concourse<span class=\"token punctuation\">.</span>DockerResource<span class=\"token punctuation\">(</span><span class=\"token string\">'serverspec-container'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sirech/dind-ruby'</span><span class=\"token punctuation\">,</span> tag <span class=\"token operator\">=</span> <span class=\"token string\">'2.6.3'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>By using the <code class=\"language-text\">GitResource</code> and <code class=\"language-text\">DockerResource</code>, we got something much more compact without losing readability.</p>\n<h3>Building your own DSL</h3>\n<p>Every pipeline is different, which means a generic abstraction is hard to find. But within a pipeline, you tend to see certain patterns emerging. We create them to make the <em>YAML</em> overdose easier to swallow, even if we are still relying on copy-paste.</p>\n<p>What if you build a small DSL to express these patterns? I mostly pass the same inputs to every job, so I have a function to fetch them in parallel:</p>\n<!-- get-resource -->\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">local Inputs<span class=\"token punctuation\">(</span>dependencies <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> concourse<span class=\"token punctuation\">.</span>Parallel<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  concourse<span class=\"token punctuation\">.</span>Get<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> dependencies <span class=\"token operator\">=</span> dependencies<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> s <span class=\"token keyword\">in</span> <span class=\"token punctuation\">[</span>source<span class=\"token punctuation\">,</span> container<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>You see that through variables, I keep this in sync with the resources I defined above. You can use <a href=\"https://www.pythonforbeginners.com/basics/list-comprehensions-in-python\" target=\"_blank\" rel=\"noopener noreferrer\">list comprehensions</a> to make the code more expressive.</p>\n<p>My <a href=\"https://concourse-ci.org/tasks.html\" target=\"_blank\" rel=\"noopener noreferrer\">tasks definitions</a> follow a defined structure, as well. They are stored in the <code class=\"language-text\">source</code>, in a defined folder. We set some baseline parameters. All that context goes into a pipeline specific way of creating tasks.</p>\n<!-- task -->\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">local Task<span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> <span class=\"token builtin\">file</span> <span class=\"token operator\">=</span> name<span class=\"token punctuation\">,</span> image <span class=\"token operator\">=</span> container<span class=\"token punctuation\">,</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  task<span class=\"token punctuation\">:</span> name<span class=\"token punctuation\">,</span>\n  image<span class=\"token punctuation\">:</span> image<span class=\"token punctuation\">,</span>\n  params<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> CI<span class=\"token punctuation\">:</span> true <span class=\"token punctuation\">}</span> <span class=\"token operator\">+</span> params<span class=\"token punctuation\">,</span>\n  <span class=\"token builtin\">file</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'%s/pipeline/tasks/%s/task.yml'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">[</span>source<span class=\"token punctuation\">,</span> <span class=\"token builtin\">file</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Step by step, we have a tailor-made set of functions that produce a smaller pipeline. It is more consistent and easier to change.</p>\n<h3>Back to the huge linter job that we started with</h3>\n<p>That <em>linter</em> job has a ton of repetition. It’s time to compose all these smaller blocks into one job definition. The structure looks like this:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 512px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/bf3ff57a63b332639ce8af182039b061/01e7c/jsonnet-job.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 64.8936170212766%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABs0lEQVQ4y3VTXXPaQAw8oB0Cjqk/QkpJO2mSpnnyBLSrY4Y3/v+f6qxHR0kmeZDvbMmr1UpKJJO7T0guZAAW5U5y7u5zM5t/4j+buydh6TEj2QOoSa4ArHSS/EbyO8lN2OrCX5f3uLcRPwIuwzFmADCeZqZEfwD8FWDO+UuJEZsSV06SNyOgu4turSCVnnMugbNIJt8q5yxZroLlEwDdJ2am77J+BDSzpZnVZpaGYUg55ysAvwFslP1wOJyZuPsaQEPyjuS9WAHYBon+DcMocyogkluSAt2aWaVkYi+m0hrAs/xRfkdyegaMLtWhwzQa8ADgIYRuh2GYqEQz6yP5CLjf78W8A/AfEMAysqo8sdiKGYA7AOr+RmMDYC3mqoikGnUfo/KW4WVTJDCAXyH6ozQKgHQ8HlMwvjazZ+l8Op0uGXaF4aIwjK6JSZtzbnLOa3f/GmMyMzP91AB4JfkSk6FxkfbdZclNAYyOKuNUjdjtdmNDqqpKwfiW5E+SP8ysla7xjzqeytq10is2pg89lLGLzIWZKrkmWQGoYiH03sS2pPR+Qz4yzZlGSrv90R7LykL8A0uSqQH3dj8mAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Diagram of a job\" title=\"Diagram of a job\" src=\"/static/bf3ff57a63b332639ce8af182039b061/01e7c/jsonnet-job.png\" srcset=\"/static/bf3ff57a63b332639ce8af182039b061/4dcb9/jsonnet-job.png 188w,\n/static/bf3ff57a63b332639ce8af182039b061/5ff7e/jsonnet-job.png 375w,\n/static/bf3ff57a63b332639ce8af182039b061/01e7c/jsonnet-job.png 512w\" sizes=\"(max-width: 512px) 100vw, 512px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>We have a <code class=\"language-text\">Job</code>, <code class=\"language-text\">Inputs</code>, and some <code class=\"language-text\">Tasks</code>. Let’s use all the functions that we defined:</p>\n<!-- full-job -->\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">concourse<span class=\"token punctuation\">.</span>Job<span class=\"token punctuation\">(</span><span class=\"token string\">'lint'</span><span class=\"token punctuation\">,</span> plan <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  Inputs<span class=\"token punctuation\">(</span><span class=\"token string\">'prepare'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  concourse<span class=\"token punctuation\">.</span>Parallel<span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">[</span>Task<span class=\"token punctuation\">(</span><span class=\"token string\">'lint-%s'</span> <span class=\"token operator\">%</span> lang<span class=\"token punctuation\">,</span> <span class=\"token string\">'linter'</span><span class=\"token punctuation\">,</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> TARGET<span class=\"token punctuation\">:</span> lang <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> lang <span class=\"token keyword\">in</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'sh'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'js'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'css'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'docker'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>I really like this one! Is it too smart for its own good? I think not! You see a clear structure. If you need to change or add something, you do it once, not multiple times. We have gone from around 30 lines of pure repetition to a tight block that still communicates clearly what it does.</p>\n<h2>How to generate a pipeline from this</h2>\n<p>I like to convert the <code class=\"language-text\">json</code> output to <em>YAML</em>, and use <code class=\"language-text\">fly set-pipeline</code> with the generated file. This is the script:</p>\n<!-- generating-pipeline -->\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function-name function\">json2yaml</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  python3 -c <span class=\"token string\">'import sys, yaml, json; print(yaml.dump(json.loads(sys.stdin.read())))'</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function-name function\">goal_generate-pipeline</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token assign-left variable\">FILES</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>jsonnet pipeline.jsonnet -J <span class=\"token punctuation\">..</span>/concourse-jsonnet-utils -m <span class=\"token builtin class-name\">.</span><span class=\"token variable\">)</span></span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">file</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$FILES</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n    json2yaml <span class=\"token operator\">&lt;</span> <span class=\"token string\">\"<span class=\"token variable\">$file</span>\"</span> <span class=\"token operator\">></span> <span class=\"token string\">\"<span class=\"token variable\">${file<span class=\"token operator\">%</span>.json}</span>.yml\"</span>\n    <span class=\"token function\">rm</span> <span class=\"token string\">\"<span class=\"token variable\">$file</span>\"</span>\n  <span class=\"token keyword\">done</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Conclusion</h2>\n<p>I had some reservations when I started with <em>Jsonnet</em>, but I’m really impressed. You can truly reduce the amount of duplication. Check <a href=\"https://github.com/sirech/example-concourse-pipeline/blob/master/pipeline.jsonnet\" target=\"_blank\" rel=\"noopener noreferrer\">this pipeline</a> to get a first taste. I’ll try to get a bigger example for a future post, where we were dealing with a huge 500+ line infrastructure pipeline that we beat into shape.</p>","frontmatter":{"layout":"post","title":"Templating Concourse pipelines with Jsonnet: An Introduction","path":"/templating-concourse-pipelines-with-jsonnet/","categories":["Concourse CI","Jsonnet","Templating"],"date":"2020/05/19","draft":false,"description":"Templating YAML pipelines using a tool like Jsonnet is a way of managing the complexity of pipelines that increase in size and complexity","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/813f454ce9cf9cf63b201506e1ab38ba/97b70/logo.png","srcSet":"/static/813f454ce9cf9cf63b201506e1ab38ba/870ca/logo.png 78w,\n/static/813f454ce9cf9cf63b201506e1ab38ba/6c937/logo.png 156w,\n/static/813f454ce9cf9cf63b201506e1ab38ba/97b70/logo.png 312w","sizes":"(min-width: 312px) 312px, 100vw"},"sources":[{"srcSet":"/static/813f454ce9cf9cf63b201506e1ab38ba/0270a/logo.webp 78w,\n/static/813f454ce9cf9cf63b201506e1ab38ba/7f093/logo.webp 156w,\n/static/813f454ce9cf9cf63b201506e1ab38ba/c9c2e/logo.webp 312w","type":"image/webp","sizes":"(min-width: 312px) 312px, 100vw"}]},"width":750,"height":514.4230769230769}}}}},"related":{"nodes":[{"frontmatter":{"title":"Checking the validity of a certificate in Concourse","path":"/check-certificate-validity-concourse/","date":"2019/02/14"}},{"frontmatter":{"title":"Templating Concourse pipelines with Jsonnet: Follow-up","path":"/templating-concourse-pipelines-with-jsonnet-follow-up/","date":"2020/06/12"}},{"frontmatter":{"title":"Diagrams as code for infrastructure as code","path":"/diagrams-as-code-for-infrastructure-as-code/","date":"2020/09/09"}}]},"previous":{"frontmatter":{"title":"Book Review: Effective TypeScript","path":"/book-review-effective-typescript/","date":"2020/04/25"}},"next":{"frontmatter":{"title":"Book Review: Securing DevOps","path":"/book-review-securing-devops/","date":"2020/05/26"}}},"pageContext":{"related":["/diagrams-as-code-for-infrastructure-as-code/","/templating-concourse-pipelines-with-jsonnet-follow-up/","/check-certificate-validity-concourse/"],"previous":"/book-review-effective-typescript/","next":"/book-review-securing-devops/"}},
    "staticQueryHashes": []}