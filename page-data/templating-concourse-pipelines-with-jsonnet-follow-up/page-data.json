{"componentChunkName":"component---src-templates-blog-post-js","path":"/templating-concourse-pipelines-with-jsonnet-follow-up/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for Meta","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"8a6e737e-e1c8-5851-aeb2-32aff7d48ccb","html":"<div class=\"guide\">\n<h3>Generating pipelines for Concourse using jsonnet</h3>\n<ul>\n<li><a href=\"../templating-concourse-pipelines-with-jsonnet/\">Part 1 - Introduction</a></li>\n<li><a href=\"../templating-concourse-pipelines-with-jsonnet-follow-up/\"><strong>Part 2 - Follow-up</strong></a></li>\n</ul>\n</div>\n<figure class=\"figure figure--right\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 501px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/00538e4fa827f56bccc7081853cadddb/55811/logo.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACFUlEQVR42mWSS0/UUBzFu/Sx0A9AIoEEgyPCPDrTe2/va9rOo4OAGZmYmIAw0biAEMT4YOkLE01QJGHhzrgYF34Cw0ITF+piwsa1fpLjv50UVBa/pG3SX+85PY4vffhaHiLp/hj+cTRRIK5rgY+RgKJrRjiScWj3CMnoBf4vSsoUX4gUSTCia3y8iSR6dYlnoURbSTisHWJiPcaltRiTK02wWEMECiI8wq24cItFaKVgtYYipo3GbsPiRSCwayvYCQVekdSZ2JzByYMlnP6xiLOfF+BeCyEiDd404A0DVteYLEzhYi6HwFpMN5vQxmI+rOJRvYpPlxXQMXhf49gKKPLU/RmM9lcx9m0FI/s34bUMdJlDUSTFEyi2GPQm6FmVTqcTseB4WpX4cjUEui30YonHAZ2w9GAO+f5duN83ML5/OxWqctKTJAFPJUlvgvMUnzAk7NRCbMUh3ukKDlQRe5phmz7gjD9s4cTPZZzq38CZr4sopZEVvIaCTyVnImtM2iHzPJikwzjGdi1Aa7OFoZ053FptYIP6dwrLNQy/7WBkbx6jr9vwZi38gDokKeMMZddFuewOIpPYLZXSHxNFESwtIt9bwoVf91B8coVOL+AoT8DkGUxhgGJZd+JwJn9Hzrq01iCSFmMfFjD8ex3nn5NQ009Jh03RMv4fdbK/RJJtMRu275OUes7diXHu5Szy3RqklvgDqzdv87ZzfacAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"YAML and Concourse and Jsonnet\" title=\"\" src=\"/static/00538e4fa827f56bccc7081853cadddb/55811/logo.png\" srcset=\"/static/00538e4fa827f56bccc7081853cadddb/4dcb9/logo.png 188w,\n/static/00538e4fa827f56bccc7081853cadddb/5ff7e/logo.png 375w,\n/static/00538e4fa827f56bccc7081853cadddb/55811/logo.png 501w\" sizes=\"(max-width: 501px) 100vw, 501px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>Around a month ago, I began experimenting with <a href=\"https://jsonnet.org/\" target=\"_blank\" rel=\"noopener noreferrer\">jsonnet</a> to generate pipelines for <a href=\"https://concourse-ci.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Concourse</a> programmatically. Since then, I’ve used it to build <a href=\"https://www.thoughtworks.com/radar/techniques/pipelines-for-infrastructure-as-code\" target=\"_blank\" rel=\"noopener noreferrer\">infrastructure pipelines</a>. We provision infrastructure in AWS using <a href=\"https://www.terraform.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform</a>. Before, the process was mostly manual. As we added more and more teams to our platform, that approach was becoming untenable. I want to expand on that first article and talk about what I’ve learned in the process.</p>\n<h2>Project-specific resources</h2>\n<p>I wrote a small <a href=\"https://github.com/sirech/concourse-jsonnet-utils\" target=\"_blank\" rel=\"noopener noreferrer\">library of generic helper functions</a> while developing our pipelines. We have built custom resources on top of them that are specific to our use case. Thanks to the <code class=\"language-text\">+:</code> operator, we can override what we need while benefitting from sane defaults.</p>\n<p>We have <code class=\"language-text\">git</code> and <code class=\"language-text\">docker</code> resources adapted to include credentials:</p>\n<!-- basic-resources-extended -->\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  <span class=\"token function\">GitResource</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> repository<span class=\"token punctuation\">,</span> paths<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span><span class=\"token operator\">:</span> concourse<span class=\"token punctuation\">.</span><span class=\"token function\">GitResource</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> <span class=\"token string\">'%s/%s.git'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">[</span>git<span class=\"token punctuation\">,</span> repository<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    source<span class=\"token operator\">+</span><span class=\"token operator\">:</span> std<span class=\"token punctuation\">.</span><span class=\"token function\">prune</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">private_key</span><span class=\"token operator\">:</span> <span class=\"token string\">'((%s-deploy-key-%s))'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">[</span>product<span class=\"token punctuation\">,</span> repository<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">paths</span><span class=\"token operator\">:</span> paths<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token function\">DockerResource</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> repository<span class=\"token punctuation\">,</span> tag<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span><span class=\"token operator\">:</span> concourse<span class=\"token punctuation\">.</span><span class=\"token function\">DockerResource</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name<span class=\"token punctuation\">,</span> repository<span class=\"token punctuation\">,</span> tag<span class=\"token operator\">=</span>tag</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    source<span class=\"token operator\">+</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">aws_access_key_id</span><span class=\"token operator\">:</span> <span class=\"token string\">'((aws-access-key-id))'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">aws_secret_access_key</span><span class=\"token operator\">:</span> <span class=\"token string\">'((aws-secret-access-key))'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>We realized that all of our jobs were declaring the same inputs, so we built a resource for that as well.</p>\n<!-- basic-resources-extended-inputs -->\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  <span class=\"token function\">Inputs</span><span class=\"token punctuation\">(</span>dependencies<span class=\"token punctuation\">,</span> trigger<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    concourse<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'source-code'</span><span class=\"token punctuation\">,</span> dependencies<span class=\"token operator\">=</span>dependencies<span class=\"token punctuation\">,</span> trigger<span class=\"token operator\">=</span>trigger<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span>concourse<span class=\"token punctuation\">.</span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> trigger<span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> source <span class=\"token keyword\">in</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'dev-tools'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'terraform-tools'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'container'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Helper functions</h2>\n<p>Whenever you try to reuse code with plain YAML, you end up hitting a wall. Even if you use <a href=\"https://confluence.atlassian.com/bitbucket/yaml-anchors-960154027.html\" target=\"_blank\" rel=\"noopener noreferrer\">anchors</a>, they cannot be parameterized easily.</p>\n<p>With <code class=\"language-text\">jsonnet</code>, we can address that limitation by building simple functions to check conditions based on the environment.</p>\n<!-- helper-functions -->\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">local config <span class=\"token operator\">=</span> std<span class=\"token punctuation\">.</span><span class=\"token function\">extVar</span><span class=\"token punctuation\">(</span><span class=\"token string\">'CONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">environments</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>env <span class=\"token keyword\">for</span> env <span class=\"token keyword\">in</span> std<span class=\"token punctuation\">.</span><span class=\"token function\">objectFields</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>clusters<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token function\">isProdEnvironment</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span><span class=\"token operator\">:</span> config<span class=\"token punctuation\">.</span>accounts<span class=\"token punctuation\">[</span>env<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">'product-prod'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">isNonProdEnvironment</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span><span class=\"token operator\">:</span> <span class=\"token operator\">!</span>self<span class=\"token punctuation\">.</span><span class=\"token function\">isProdEnvironment</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token literal-property property\">nonProdEnvironments</span><span class=\"token operator\">:</span> std<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>isNonProdEnvironment<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>environments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">prodEnvironments</span><span class=\"token operator\">:</span> std<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>isProdEnvironment<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>environments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You see that there is a <code class=\"language-text\">config</code> object that we receive from the outside, which brings me to my next point, configuring different pipelines that share the same structure.</p>\n<h2>Configuring the pipelines</h2>\n<p>Our pipelines are deploying the same infrastructure for different teams. There are some differences like the product name, the number of environments to deploy, the regions, and things like that.</p>\n<p>We have found out that this configuration is easier to keep in a separate <code class=\"language-text\">product.yaml</code> file. That way, changes in the domain are seen more clearly, and new products are quick to spin up. It looks like this:</p>\n<!-- product-yaml -->\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">product_name</span><span class=\"token punctuation\">:</span> new<span class=\"token punctuation\">-</span>product\n<span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> master\n\n<span class=\"token key atrule\">clusters</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">eu-west-1</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">prod</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">eu-west-1</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">us-east-1</span><span class=\"token punctuation\">:</span>\n\n<span class=\"token key atrule\">accounts</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"product\"</span>\n  <span class=\"token key atrule\">prod</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"product-prod\"</span></code></pre></div>\n<p><code class=\"language-text\">jsonnet</code> can receive external configuration (<code class=\"language-text\">local config = std.extVar('CONFIG')</code>), although you have to convert this file to <code class=\"language-text\">json</code> first.</p>\n<h2>Combining everything</h2>\n<p>By using all these helpers and abstractions, our actual pipeline definition is about 80 lines long. Here is a simplified version of the function that provisions a complete environment:</p>\n<!-- pipeline-definition -->\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">local EnvironmentJobs<span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n  local regions <span class=\"token operator\">=</span> std<span class=\"token punctuation\">.</span>objectFields<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>clusters<span class=\"token punctuation\">[</span>env<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  local params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> ENV<span class=\"token punctuation\">:</span> env <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  local modules <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    Job<span class=\"token punctuation\">(</span><span class=\"token string\">'cluster-services-%s'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">[</span>env<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'cluster-global-dns'</span><span class=\"token punctuation\">,</span> tasks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>TaskPerRegion<span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">,</span> regions<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> module <span class=\"token keyword\">in</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'system-services'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'monitoring'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'logging'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    Job<span class=\"token punctuation\">(</span><span class=\"token string\">'ingress-%s'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">[</span>env<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'cluster-services-%s'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">[</span>env<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> tasks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>TaskPerRegion<span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">,</span> regions<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> module <span class=\"token keyword\">in</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'private-ingress-app'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'private-ingress-dispatcher'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    Job<span class=\"token punctuation\">(</span><span class=\"token string\">'egress-%s'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">[</span>env<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'cluster-services-%s'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">[</span>env<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> tasks<span class=\"token operator\">=</span>TaskPerRegion<span class=\"token punctuation\">(</span><span class=\"token string\">'private-egress'</span><span class=\"token punctuation\">,</span> regions<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  modules <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span>\n    Job<span class=\"token punctuation\">(</span><span class=\"token string\">'smoketest-%s'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">[</span>env<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'%s'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">[</span>module<span class=\"token punctuation\">]</span> <span class=\"token keyword\">for</span> module <span class=\"token keyword\">in</span> <span class=\"token punctuation\">[</span>job<span class=\"token punctuation\">.</span>name <span class=\"token keyword\">for</span> job <span class=\"token keyword\">in</span> modules<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> tasks<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n      TaskPerRegion<span class=\"token punctuation\">(</span><span class=\"token string\">'smoketest'</span><span class=\"token punctuation\">,</span> regions<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">;</span></code></pre></div>\n<p>There is no denying that this code gets pretty complex! That is hard to avoid, as the dependencies between different jobs are complex themselves. Trying to represent all these dependencies in YAML would be orders of magnitude more verbose.</p>\n<h2>The end result</h2>\n<p>Just to give you an idea, here is the graphical representation of the full pipeline for one of the products that we provision:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/c16b81ec5b95af1847803c44bd7c9c48/1d69c/big-pipeline.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 21.27659574468085%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAo0lEQVR42l2P6w7CMAiF907Obl0LbWeMl+g0auL7P8kRmF2mP0g5h48CDcUIIokQEUmDwD6Yp5rFZy914XioWuuEkGnxldW84SHAHxI27xHdVNCdM9rnCHeX/JLRXUU/RvhThrupLvIW9MK5KRvTvor12od1w6jTeJ7YHxOGnWwaZ38rjZTIOL9nOBmim1rvlw+F7MqmmrQC6mmL9r+1tNL//AfnnYmn5wr2oQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Huge infrastructure pipeline\" title=\"\" src=\"/static/c16b81ec5b95af1847803c44bd7c9c48/1d69c/big-pipeline.png\" srcset=\"/static/c16b81ec5b95af1847803c44bd7c9c48/4dcb9/big-pipeline.png 188w,\n/static/c16b81ec5b95af1847803c44bd7c9c48/5ff7e/big-pipeline.png 375w,\n/static/c16b81ec5b95af1847803c44bd7c9c48/1d69c/big-pipeline.png 750w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>Yeah, you probably can’t even read the names of the jobs. That thing is huge! The actual YAML file has 2781 linesn if you are wondering. Why is it so large, you might ask. It is provisioning four different environments across different regions, for starters. We have tried to divide the infrastructure in smaller modules so that they are simpler to manage.</p>\n<p>The result is a lot easier to visualize that one big job. Smaller modules are a lot easier to apply and maintain, as well. Thanks to <code class=\"language-text\">jsonnet</code>, the complexity of managing the pipeline is greatly reduced. We tried for a bit to create this by hand, and it didn’t work at all.</p>\n<h2>Is it worth it?</h2>\n<p>If your pipelines share a similar structure and only some parameters differ, it is a clear yes. You are going to have a much easier time doing this.</p>\n<p>Even if there is no common structure to abstract, you can spare yourself a massive amount of YAML duplication, and reduce the accidental complexity. I would recommend exploring this option, although one has to be careful not to build something that becomes unmaintainable.</p>","frontmatter":{"layout":"post","title":"Templating Concourse pipelines with Jsonnet: Follow-up","path":"/templating-concourse-pipelines-with-jsonnet-follow-up/","categories":["Concourse CI","Jsonnet","Templating"],"date":"2020/06/12","draft":false,"description":"After building a bunch of big infrastructure pipelines for Concourse with jsonnet, I've some patterns to share to handle all that complexity","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#383838","images":{"fallback":{"src":"/static/00538e4fa827f56bccc7081853cadddb/62189/logo.png","srcSet":"/static/00538e4fa827f56bccc7081853cadddb/a0a6e/logo.png 125w,\n/static/00538e4fa827f56bccc7081853cadddb/9c121/logo.png 251w,\n/static/00538e4fa827f56bccc7081853cadddb/62189/logo.png 501w","sizes":"(min-width: 501px) 501px, 100vw"},"sources":[{"srcSet":"/static/00538e4fa827f56bccc7081853cadddb/f6072/logo.webp 125w,\n/static/00538e4fa827f56bccc7081853cadddb/7925d/logo.webp 251w,\n/static/00538e4fa827f56bccc7081853cadddb/4046c/logo.webp 501w","type":"image/webp","sizes":"(min-width: 501px) 501px, 100vw"}]},"width":750,"height":375.748502994012}}}}},"related":{"nodes":[]},"previous":{"frontmatter":{"title":"Book Review: Securing DevOps","path":"/book-review-securing-devops/","date":"2020/05/26"}},"next":{"frontmatter":{"title":"Book Review: Kotlin in Action","path":"/book-review-kotlin-in-action/","date":"2020/06/28"}}},"pageContext":{"related":[],"previous":"/book-review-securing-devops/","next":"/book-review-kotlin-in-action/"}},"staticQueryHashes":[],"slicesMap":{}}