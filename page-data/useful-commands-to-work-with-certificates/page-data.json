{"componentChunkName":"component---src-templates-blog-post-js","path":"/useful-commands-to-work-with-certificates/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for Meta","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"c6c58da8-a384-5aa3-92f5-0cf2ab4dad45","html":"<figure class=\"figure figure--right\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 336px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/c301cb5811ee88e6b667bf76fe9d8412/d99f2/https.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 44.680851063829785%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABWElEQVR42pWQzW6CQBSFeRufxldxb9rElYkuGhLTLl21XbtpY2uaVhuKCWkdQIbhR0yoUYLiggIKBaFXMOyapt9Mbs6dzMncM9ThcPD+j+/7aZpSuq6zLMsLPOIR8AELoQmawD72+SFUPidvkCiKDMOYpkkJgrDdbrMsC+Mw+4s0B8RqtSKEUOJUDNyA+WToNzpO4uF8aHs2WRNsY8d3vNALvoNdtIvjeDabLRYLsBVmVVUpQRQiL6rd1SoXFWKTzmun/lg/ezhvv7Rphm48NVqjFmuwS3OJZQxjuq4LZsuyTubQCy+5q+p11fqyRvNRD/du0U1f7dfv683nZve9O5AHEpI0XYO0xfwnM/RF5iLMKVt21LZvlx+x3++jKArDsDQrikJBbo7jZCJPpSnGWJIlCUtF1RRNlmUQcA5XSQ5oeHM8HhuGQcFPbH5hDWzWpS4r4DhOkiQ/RMzXPBVnZBIAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"https\" title=\"\" src=\"/static/c301cb5811ee88e6b667bf76fe9d8412/d99f2/https.png\" srcset=\"/static/c301cb5811ee88e6b667bf76fe9d8412/4dcb9/https.png 188w,\n/static/c301cb5811ee88e6b667bf76fe9d8412/d99f2/https.png 336w\" sizes=\"(max-width: 336px) 100vw, 336px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>We seem to have switched to <em>https</em> finally. That means we use certificates all the time, often without paying them much attention. How do you <em>see</em> the content of a certificate? Convert it to a different format? There are a bunch of useful commands that are hard to remember unless you use them frequently (or, conveniently, find a post about the topic). I want to share some of them, focusing on doing things from the command line. Maybe you have seen <a href=\"https://www.sslshopper.com/article-most-common-openssl-commands.html\" target=\"_blank\" rel=\"noopener noreferrer\">this wonderful article about OpenSSL commands already</a>. I hope I can provide a bit more context.</p>\n<p>As a refresher, we mostly use certificates to verify the identity of a server when using <em>https</em>. However, if you are using mTLS, the client needs to present a certificate as well. The <a href=\"https://en.wikipedia.org/wiki/X.509\" target=\"_blank\" rel=\"noopener noreferrer\">X.509</a> format is how we commonly see them in the wild.</p>\n<p>We are going to use some handy tools for this job, which can be installed with <a href=\"https://brew.sh/\" target=\"_blank\" rel=\"noopener noreferrer\">brew</a>, for example:</p>\n<ul>\n<li><a href=\"https://github.com/FiloSottile/mkcert\" target=\"_blank\" rel=\"noopener noreferrer\">mkcert</a></li>\n<li><a href=\"https://www.openssl.org/\" target=\"_blank\" rel=\"noopener noreferrer\">openssl</a></li>\n<li><code class=\"language-text\">base64</code></li>\n</ul>\n<hr>\n<h2>Creating a test certificate</h2>\n<p>To get started, we need a certificate. If you own a domain, you’ll want to use <a href=\"https://letsencrypt.org/\" target=\"_blank\" rel=\"noopener noreferrer\">LetsEncrypt</a> to generate one programmatically. For demonstration purposes, I’ll use <code class=\"language-text\">mkcert</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">mkcert -install\nmkcert example.com app1.example.com app2.example.com</code></pre></div>\n<p>The result is stored under <code class=\"language-text\">example.com+2-key.pem</code> and <code class=\"language-text\">example.com+2.pem</code></p>\n<p>This certificate is issued for three domains, using what’s called a <a href=\"https://en.wikipedia.org/wiki/Subject_Alternative_Name\" target=\"_blank\" rel=\"noopener noreferrer\">SAN</a>, which extends the <a href=\"https://support.dnsimple.com/articles/what-is-common-name/\" target=\"_blank\" rel=\"noopener noreferrer\">Common Name</a> so that you can specify multiple domains. The CN is limited to 64 characters, which can be a problem for internal certificates with a lot of subdomains (don’t ask how I learned this!).</p>\n<p>Even though it is self-signed, we can still verify it:</p>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">openssl verify -CAfile ~/Library/Application\\ Support/mkcert/rootCA.pem example.com+2.pem</code></pre></div>\n<hr>\n<h2>Reading a certificate</h2>\n<p>You can read the certificate by using:</p>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">openssl x509 -in example.com+2.pem -text -noout</code></pre></div>\n<p>which displays something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">Certificate:\n    Data:\n        Version: 3 (0x2)\n        Serial Number:\n            d7:98:98:19:27:dd:52:d0:1f:1f:07:b5:ea:85:54:eb\n    Signature Algorithm: sha256WithRSAEncryption\n        Issuer: O=mkcert development CA, OU=me@my-computer (My Name), CN=mkcert me@my-computer (My Name)\n        Validity\n            Not Before: Jun  1 00:00:00 2019 GMT\n            Not After : Apr  6 20:21:32 2030 GMT\n        Subject: O=mkcert development certificate, OU=me@my-computer (My Name)\n        Subject Public Key Info:\n            Public Key Algorithm: rsaEncryption\n                Public-Key: (2048 bit)\n                Modulus:\n                    00:b1:b7:1b:14:f9:61:79:90:be:21:bc:91:12:78: (...)\n                Exponent: 65537 (0x10001)\n        X509v3 extensions:\n            X509v3 Key Usage: critical\n                Digital Signature, Key Encipherment\n            X509v3 Extended Key Usage: \n                TLS Web Server Authentication\n            X509v3 Basic Constraints: critical\n                CA:FALSE\n            X509v3 Authority Key Identifier: \n                keyid:34:0F:21:0C:F8:7D:D5:DF:E4:15:B6:15:B9:94:C9:2B:F3:E0:24:AD\n\n            X509v3 Subject Alternative Name: \n                DNS:example.com, DNS:app1.example.com, DNS:app2.example.com\n    Signature Algorithm: sha256WithRSAEncryption\n         a8:52:3b:19:dc:74:4f:e3:6b:9c:cd:0c:59:c3:fe:e8:0b:2d: (...)</code></pre></div>\n<p>We can see there all the relevant information. The <em>X509v3 Subject Alternative Name</em> tends to be the most interesting part because you can see the domains that the certificate covers.</p>\n<h3>Encoded certificates</h3>\n<p>Usually, certificates are stored in PEM format in Base64 ASCII. You recognize them by the <code class=\"language-text\">---- BEGIN CERTIFICATE----</code> line in the beginning. That is what <code class=\"language-text\">mkcert</code> gives us, for instance.</p>\n<p>Sometimes a PEM certificate is transmitted encoded in Base64 itself. Let’s say we receive our certificate over the wire. We store it under <code class=\"language-text\">/tmp/b64-cert</code>, and it looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVlakNDQXVLZ0F3SUJBZ0lSQU5lWW1Ca24zVkxRSHg4SHRlcUZWT3N3RFFZSktvWklodmNOQVFFTEJRQXcKZ1lNeEhqQWNCZ05WQkFvVEZXMXJZMlZ5ZENCa1pYWmxiRzl3YldWdWRDQkRRVEVzTUNvR0ExVUVDd3dqYldabApjbTVoYm1SbGVrQm9hWE52YTJFZ0tFMWhjbWx2SUVabGNtNWhibVJsZWlreE16QXhCZ05WQkFNTUttMXJZMlZ5CmRDQnRabVZ5Ym1GdVpHVjZRR2hwYzI5cllTQW9UV0Z5YVc4Z1JtVnlibUZ1WkdWNktUQWVGdzB4T1RBMk1ERXcKTURBd01EQmFGdzB6TURBME1EWXlNREl4TXpKYU1GY3hKekFsQmdOVkJBb1RIbTFyWTJWeWRDQmtaWFpsYkc5dwpiV1Z1ZENCalpYSjBhV1pwWTJGMFpURXNNQ29HQTFVRUN3d2piV1psY201aGJtUmxla0JvYVhOdmEyRWdLRTFoCmNtbHZJRVpsY201aGJtUmxlaWt3Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLQW9JQkFRQ3gKdHhzVStXRjVrTDRodkpFU2VMNENTL3JET3RxbGZGN0syN1g3NERuQ0ExeHpDMlkwTkJxa1hPVWFka2VRZ1MrSgo4NVFZQlYrcWFFRGhZNVNMZm1MTGxkMmFWQnIvSG9MYVFuRDc4VXJuVHNHM1JJb2dEYlI0R25CQnJUc0ltQWk3CnRNeU1kVVZSc21EM1RYcmUxdFM4dmowL3RQNzE1UEQvRTd1Tk94M2VyYjUrQmtFY0JodElnbVU4ZUVybnpLMnEKNkV0N0tsUERwQm5mL2pySEM0ZU1URFBiRDhqeGZBRmhvZ2R0YUgrTGRxeDZ6Uk5mN2pTZXNXMTJNMW5JenpsTwpLa0IxaHBhOEZqc3Y3Ry9ONytFeHFzQzMrQjdaZHB5UWl5Zm8ydU1KL1lJQWJMN29sbnV5THF5UkZPNWNaNnp3Cjg5MG5lV1gweE5hWmE5bWo3RmNwQWdNQkFBR2pnWk13Z1pBd0RnWURWUjBQQVFIL0JBUURBZ1dnTUJNR0ExVWQKSlFRTU1Bb0dDQ3NHQVFVRkJ3TUJNQXdHQTFVZEV3RUIvd1FDTUFBd0h3WURWUjBqQkJnd0ZvQVVOQThoRFBoOQoxZC9rRmJZVnVaVEpLL1BnSkswd09nWURWUjBSQkRNd01ZSUxaWGhoYlhCc1pTNWpiMjJDRUdGd2NERXVaWGhoCmJYQnNaUzVqYjIyQ0VHRndjREl1WlhoaGJYQnNaUzVqYjIwd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dHQkFLaFMKT3huY2RFL2phNXpOREZuRC91Z0xMYlNlV0NsVjFMSnFNU3NLbE16VXZ4aVlmKzdzeDZRUmxZcGtYeWpndVFUNwppRWZMWUhQZG8zeTJMNmFIaW9tbU1FUjNmWjAyMjJWUWJhV2hjUkJmUDgzdFhnQmdqN0pUZjArUUxjVERXZG9YCnd2KzZQNHNuNmVqV2xWc3drZTBQcjhLMm9DM1NyazVibjJFVVpQSU1oQnNMZFdmczBZbkZhRTFCY2ZlWGNVV0QKU3QzckRZcjFlSW1mQ1FTQ1BkU0ZwTU5HWS81dkdtWm5lVTNxbXlhS2hLNWZRREhkWVpQYlQ5NFE4ZDBVVXRaMgpEeWdxQmFmTG5oMWxmVHRRNi9NUjdIQlNWZCtWajcwRnFCajJlaEJlTXZhUDUrQlRCTEFCbWdoK0VMVHp6VTRUCmdHMHZuSzF2OUhvd1FDaVdadDkxZDRtdFRHbldJQVVHWGpKcDBjMmVHbU5NOUN4eVM0QTJNRXRJcngwZy9ESWQKNU9rMXZodnVJOTV4cWVOZ1E4UDBrOEF0VWlYdVp4Uk53M1FubHdLRzloMDhmVGJRc04rZEh1T2lhRWNPcWY4WgoxcStxakxQMlVsbmZYaGwyN25aUVgwZ3F5ZnROUldRV3pvc0V6cGh0RVpwdGJrVzZPUExhby9DNHhVRU5lQT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</code></pre></div>\n<p>Yes, that’s a very long line. <code class=\"language-text\">openssl</code> can’t read that out of the box, so we’ve got to decode it first. Moreover, it can be that, once decoded the lines are too long, which confuses <code class=\"language-text\">openssl</code>. We’ll decode and fold that string so that we can read the certificate again:</p>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">base64 -d /tmp/b64-cert | fold -64 | openssl x509 -text -noout</code></pre></div>\n<h3>Binary certificates</h3>\n<p>Sometimes your certificate is encoded in <a href=\"https://wiki.openssl.org/index.php/DER\" target=\"_blank\" rel=\"noopener noreferrer\">DER</a>, a binary format. The <code class=\"language-text\">JVM</code> world really likes to transport certificates in this way. You’ll notice that if you inspect such a certificate, it will be mostly a bunch of special characters and gibberish. Luckily, <code class=\"language-text\">openssl</code> can convert from DER to PEM, in both directions.</p>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">openssl x509 -in example.com+2.pem -outform DER -out example.com+2.der\nopenssl x509 -inform DER -in example.com+2.der -text -noout</code></pre></div>\n<h3>Binary certificates encoded in base64url</h3>\n<p>What if you have a certificate in DER format, that has been encoded in <a href=\"https://base64.guru/standards/base64url\" target=\"_blank\" rel=\"noopener noreferrer\">base64url</a>? Your first thought might be, “That’s an oddly specific combination”. But it can actually happen. If you are implementing your own ACME server, it is part of the <a href=\"https://tools.ietf.org/html/rfc8555#section-7.1.5\" target=\"_blank\" rel=\"noopener noreferrer\">protocol to request a certificate</a>. I recently spent quite a bit of time trying to make sense of that.</p>\n<p>There is no out-of-the-box tool to decode Base64 URL, but you can use a script like <a href=\"https://raw.githubusercontent.com/Moodstocks/moodstocks-api-clients/master/bash/base64url.sh\" target=\"_blank\" rel=\"noopener noreferrer\">this one</a>. You can read this mysterious certificate by combining the script with the previous calls:</p>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">./base64url.sh decode `cat /tmp/b64url-cert | tr -d &#39;\\n&#39;` | openssl x509 -inform DER -text -noout</code></pre></div>\n<p>You will probably never run into this, but if you do, this will save you a ton of time.</p>\n<hr>\n<h2>Checking a certificate on a remote server</h2>\n<p>What if you don’t have the certificate, but want to get it from a remote server? <em>openssl</em> is up to the task.</p>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">echo -n | openssl s_client -connect google.com:443 -servername google.com | openssl x509 -text -noout</code></pre></div>\n<p>With the <code class=\"language-text\">s_client</code> command, we are requesting the certificate presented by a host on a specific port (usually 443). In this case, we are checking the certificate from <em>google.com</em>. We can pipe the output into the standard command for reading a certificate. We pipe the <code class=\"language-text\">echo -n</code> first so that it doesn’t hang.</p>\n<p>You might be wondering about the <code class=\"language-text\">-servername</code> option. That is related to <a href=\"https://en.wikipedia.org/wiki/Server_Name_Indication\" target=\"_blank\" rel=\"noopener noreferrer\">SNI</a>. If the target is serving multiple domains under the same IP address, you might want to select the one associated with a domain. I recently needed the option when testing a Kubernetes <a href=\"https://github.com/kubernetes/ingress-nginx\" target=\"_blank\" rel=\"noopener noreferrer\">nginx ingress</a> that was serving a self-signed certificate unless I specified that option.</p>\n<hr>\n<h2>We are only scratching the surface</h2>\n<p>This post was focused on reading existing certificates, but there are a ton more things that you can do with <code class=\"language-text\">openssl</code>, including writing them, extracting keys and whatnot. Not to mention <a href=\"https://en.wikipedia.org/wiki/Certificate_signing_request\" target=\"_blank\" rel=\"noopener noreferrer\">Certificate signing requests</a>. Reading is a good place to familiarize yourself with certificates, however.</p>\n<p><em>EDIT 19/06/2020:</em> Fix <code class=\"language-text\">openssl s_client</code> command</p>","frontmatter":{"layout":"post","title":"Useful commands to work with certificates","path":"/useful-commands-to-work-with-certificates/","categories":["Certificates","SSL","openssl"],"date":"2020/04/08","draft":false,"description":"A collection of commands to work with certificates for common operations","canonical":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/c301cb5811ee88e6b667bf76fe9d8412/36b0e/https.png","srcSet":"/static/c301cb5811ee88e6b667bf76fe9d8412/483aa/https.png 84w,\n/static/c301cb5811ee88e6b667bf76fe9d8412/385e9/https.png 168w,\n/static/c301cb5811ee88e6b667bf76fe9d8412/36b0e/https.png 336w","sizes":"(min-width: 336px) 336px, 100vw"},"sources":[{"srcSet":"/static/c301cb5811ee88e6b667bf76fe9d8412/b5af3/https.webp 84w,\n/static/c301cb5811ee88e6b667bf76fe9d8412/f94fe/https.webp 168w,\n/static/c301cb5811ee88e6b667bf76fe9d8412/8b935/https.webp 336w","type":"image/webp","sizes":"(min-width: 336px) 336px, 100vw"}]},"width":750,"height":334.82142857142856}}}}},"related":{"nodes":[]},"previous":{"frontmatter":{"title":"Authorization for a Kotlin Spring backend, using JSON Web Tokens","path":"/authorize-spring-backend-with-jwt-in-kotlin/","date":"2020/03/19"}},"next":{"frontmatter":{"title":"Either Types extended version","path":"/either-types-longer-form/","date":"2020/04/23"}}},"pageContext":{"related":[],"previous":"/authorize-spring-backend-with-jwt-in-kotlin/","next":"/either-types-longer-form/"}},"staticQueryHashes":[],"slicesMap":{}}