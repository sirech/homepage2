{"componentChunkName":"component---src-templates-blog-post-js","path":"/dockerizing-a-jvm-app-with-circleci/","result":{"data":{"site":{"siteMetadata":{"title":"Mario Fernandez","description":"This is the blog from Mario Fernandez, a Software Developer working for Meta","author":"Mario Fernandez","url":"https://hceris.com","twitter":"@sirech"}},"post":{"id":"10477547-01cf-50c7-b2e5-b42954d26be7","html":"<p>I had been using <a href=\"https://travis-ci.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Travis</a> for a long time for my personal projects, until the news of massive layoffs scared me into checking alternatives. I had heard good things about <a href=\"https://circleci.com/\" target=\"_blank\" rel=\"noopener noreferrer\">CircleCI</a>, so I decided to give it a try. Concretely, I wanted to build a pipeline that did the following:</p>\n<ul>\n<li>Package a <a href=\"https://spring.io/\" target=\"_blank\" rel=\"noopener noreferrer\">SpringBoot</a> application written in <a href=\"https://kotlinlang.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Kotlin</a> as a <code class=\"language-text\">jar</code>, running linters and tests before, saving the tests results.</li>\n<li>Build a <a href=\"https://www.docker.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Docker</a> image to run the app, with <a href=\"https://serverspec.org/\" target=\"_blank\" rel=\"noopener noreferrer\">ServerSpec</a> running first, and push it to a <em>Docker</em> registry.</li>\n</ul>\n<p>Following <a href=\"https://github.com/sirech/talks/raw/master/2019-04-tw-build_pipelines.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">my own thoughts about pipelines</a>, I wanted it to be fast, visual, easy to maintain and reliable build my toy app. Did it work? More after the break!</p>\n<!--more-->\n<h2>Running in circles</h2>\n<p><em>CircleCI</em> has a <a href=\"https://circleci.com/pricing/usage/\" target=\"_blank\" rel=\"noopener noreferrer\">free plan</a> that works really well for experimentation, with a seamless integration with <a href=\"https://github.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Github</a>, which makes getting started a breeze.</p>\n<p>The basics are covered in depth in <a href=\"https://circleci.com/docs/2.0/getting-started/\" target=\"_blank\" rel=\"noopener noreferrer\">their own website</a>, so I will skip that. Let’s jump straight into the details. This is the sketch of the pipeline to implement:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/0e97374ecec4f5fdc3cc32511dfb83bd/fd85b/sketch.jpg\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 69.14893617021278%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHpQmM1F//EABgQAAMBAQAAAAAAAAAAAAAAAAABAhIx/9oACAEBAAEFAnQ6N0Xzqyj/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAWEAADAAAAAAAAAAAAAAAAAAAQIEH/2gAIAQEABj8CET//xAAeEAACAQMFAAAAAAAAAAAAAAAAIREBEDFBUXGRof/aAAgBAQABPyHFHomsab0JMdheI32P/9oADAMBAAIAAwAAABD07//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABsQAQADAQEBAQAAAAAAAAAAAAEAESExYUFR/9oACAEBAAE/EEOJbvEccN+D9iy6Tw3KHQay/kDAEe2vYEaNz//Z'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Sketch\" title=\"\" src=\"/static/0e97374ecec4f5fdc3cc32511dfb83bd/acb04/sketch.jpg\" srcset=\"/static/0e97374ecec4f5fdc3cc32511dfb83bd/bc01b/sketch.jpg 188w,\n/static/0e97374ecec4f5fdc3cc32511dfb83bd/bf173/sketch.jpg 375w,\n/static/0e97374ecec4f5fdc3cc32511dfb83bd/acb04/sketch.jpg 750w,\n/static/0e97374ecec4f5fdc3cc32511dfb83bd/fd85b/sketch.jpg 1034w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>I’m going to talk about some details that I found interesting, plus the code to implement parts of the pipeline. TLDR: <a href=\"https://github.com/sirech/echo/blob/master/.circleci/config.yml\" target=\"_blank\" rel=\"noopener noreferrer\">This is the full pipeline</a>.</p>\n<h2>Using workflows</h2>\n<p>Workflows are <em>CircleCI</em>’s way of organizing dependencies between jobs. In my case that’s just a fancy way of saying that one job should execute after the other, like this screenshot shows:</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/315918ecce43a06aad2be9d7b540b891/709cb/circle-workflow.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 85.63829787234043%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAACSUlEQVR42p2Tu24TQRSGJ4KSDqgoERUNQeIVoEGIt0A8AFTcRJCQkBIJURAXtkl4AIIocCpEiHBCk4CIEyxjglfB8Xov3tvsxV7/zDmOVyZyJJOVvp2ZM/+5zeyKpeoK7qzO4+FaEffLhYx75TwerS3g8fqiYgEzX14rFv/RDHlQLuLuag5L1U8Qt0ozEE/P4+TzKxCzl5ip2WmIZxdxNncV5wo3cCp3DWeKN3E6fx1Tc9OZbsiJucsqxgXcXn4C8bGxiRff3mB+8y3y2+8zCjslFHeW8UpRZEpMYQy0//L7O6w0vkIkcYJ+N0Xsh+j3+zj2kwJJlEAEMkBL34dpWdCNNn793uWx10/RTXsTQ/oojiBMq4Ot7SrCMITv+3AcB3EcH6vIJFEVOq6Hvf02UsrU7bIxTVNu/3+hQgS90l4Ptm1D13Wuko9kTFCyUVKn04HnuqwbG5AWVBnNyeGoCiggEamL9KNYnVv/6IDjHA9XSeueSuglXegyQqw6A9lHAwZBACklX8qQKIqyOe0fRipC5TNuT9Ct1mo1pl6vMzSvVCrQNI1FdK6TIuhlmiZjqW+RRsMwGFp7njcxHDBrWYYDRlqXo235qtLAP2hZZgyPIGuZjHEYw5eD1rwDfGo1cw4QqWRRGLHOG9HRn+aPBty1m/igbUC3DNjSVTcombZj4Y/ZQsNuwfJdfG5uYaP5g3VOHLDGVWPT1NG027A9h5ML3TVRNTU4ysmRKmsYMB21JpHh2VzBT2sPWqfFOjcc6FylJw1BdurkL/ga3sxdRz3+AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Workflow\" title=\"\" src=\"/static/315918ecce43a06aad2be9d7b540b891/1d69c/circle-workflow.png\" srcset=\"/static/315918ecce43a06aad2be9d7b540b891/4dcb9/circle-workflow.png 188w,\n/static/315918ecce43a06aad2be9d7b540b891/5ff7e/circle-workflow.png 375w,\n/static/315918ecce43a06aad2be9d7b540b891/1d69c/circle-workflow.png 750w,\n/static/315918ecce43a06aad2be9d7b540b891/709cb/circle-workflow.png 1034w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<p>Looks simple, right? However, the picture does not show the whole truth. I am using a filter to restrict the <code class=\"language-text\">docker</code> job to the <code class=\"language-text\">master</code> branch. The workflow definition looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">workflows</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n  <span class=\"token key atrule\">pipeline</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> build\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">docker</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">filters</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">only</span><span class=\"token punctuation\">:</span> master\n          <span class=\"token key atrule\">requires</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> build</code></pre></div>\n<p>Why the restriction? Well, I’m using <a href=\"https://dependabot.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Dependabot</a> to automatically check for new versions of dependencies, and I want the PRs generated by the tool to run my tests, but not to generate new docker images.</p>\n<h2>The build step</h2>\n<p>I always run my jobs inside some <em>Docker</em> image. For the build I use the <em>OpenJDK</em> image provided by <em>CircleCI</em>, which is one among <a href=\"https://circleci.com/docs/2.0/circleci-images/\" target=\"_blank\" rel=\"noopener noreferrer\">the many images that they maintain</a>. These are the steps.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">docker</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> circleci/openjdk<span class=\"token punctuation\">:</span>8<span class=\"token punctuation\">-</span>jdk\n\n  <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> checkout\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> ./gradlew detekt\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> ./gradlew clean test\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> ./gradlew assemble</code></pre></div>\n<p><a href=\"https://github.com/arturbosch/detekt\" target=\"_blank\" rel=\"noopener noreferrer\">detekt</a> is <a href=\"https://www.thoughtworks.com/radar/tools/detekt\" target=\"_blank\" rel=\"noopener noreferrer\">basically a linter</a> that can run self-contained inside the pipeline. Apart from that, the unit tests are executed and if everything works, a <code class=\"language-text\">jar</code> is built.</p>\n<h3>Persistence</h3>\n<p>Unlike <a href=\"https://concourse-ci.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Concourse</a>, <em>CircleCI</em> allows you to persist artifacts between jobs, which is pretty damn convenient. In this case, I need the <code class=\"language-text\">jar</code> file that we just generated later, when I build the <em>Docker</em> image. In order to persist it, you add an extra directive to the list of steps in the <code class=\"language-text\">build</code> job:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">persist_to_workspace</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">root</span><span class=\"token punctuation\">:</span> build/libs\n    <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> echo.jar</code></pre></div>\n<h3>You’ve got to save the tests</h3>\n<p>Another nifty feature that I found is <a href=\"https://circleci.com/docs/2.0/collect-test-data/\" target=\"_blank\" rel=\"noopener noreferrer\">storing test results</a>, which appear in the dashboard and make it easier to understand what your job is doing.</p>\n<p>Both the test results, as well as the execution summary are stored as artifacts. For that there are some additional steps to add:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Save test results\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n      mkdir -p ~/junit/\n      find . -type f -regex \".*/build/test-results/.*xml\" -exec cp {} ~/junit/ \\;</span>\n    <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span> always\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">store_test_results</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> ~/junit\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">store_artifacts</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> ~/junit</code></pre></div>\n<p>All in all the build has a bunch of steps, as can be seen in this screenshot.</p>\n<figure class=\"figure\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/117bfc521c13e320f2be63327bb1732c/bb051/detailed.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 86.17021276595744%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAAB2ElEQVR42p2U2WrbQBSG/ZBJodDHaNq+R0jpRSBQaNrelF50uy4hgdS+TG4LtizJljSLlhlt1t9zJrbjQEInGfgYzaJf/1nQ6Nn4CMw+sffnEC8m7xz8vD9+i73xIZ5PjvHq6i8OrkJijpfE6+s53lzfPB9soPXo/fQMJ9Pf+BRc4MPsHF/CMb5GE5zS+iNxGpzjc3CJnwtB5ITe8ms9f48kfsQK32gembpGZCUG06IUGmWmUaSKZgVggM+oiwId6Qxdi5E0BaZVitrWSGUGqRV0kaOhw27V77C6l34YUJQlDL1vGxLUtsSsytDSRiZIUErkeY6BLvrAoyCH1lq07VowIMG+6ZCkKVKCD3g8RrCmkHcEhRPkg6qq0DQNVhSOL8YY9w5zI2jYYYs0yyCEcPaf4vCOIOdQ59rlT2uNvu+9BUsqyp2QQ2obFhRSuKIwXdc9XdC1TWUQRREWi4ULOwxDd+l/ofPgiDiPtw4NOaIcSqW2IXMefR1uCrmTQ4HGWGqbxLlLksQl2qcwD/dh2zkxzodvhTeCHBW7c4I5Cc65D0lQrXPxmB5k2B0XcRvyjNqGixJTQZbLJeI4RhAEUEp5/Rz43rbKtrawbeO+sIF7kNnd84FF/wH5PRZHJeN6qAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Detailed view\" title=\"\" src=\"/static/117bfc521c13e320f2be63327bb1732c/1d69c/detailed.png\" srcset=\"/static/117bfc521c13e320f2be63327bb1732c/4dcb9/detailed.png 188w,\n/static/117bfc521c13e320f2be63327bb1732c/5ff7e/detailed.png 375w,\n/static/117bfc521c13e320f2be63327bb1732c/1d69c/detailed.png 750w,\n/static/117bfc521c13e320f2be63327bb1732c/78797/detailed.png 1125w,\n/static/117bfc521c13e320f2be63327bb1732c/bb051/detailed.png 1212w\" sizes=\"(max-width: 750px) 100vw, 750px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n</figure>\n<h2>Docker step</h2>\n<h3>The image itself</h3>\n<p>So if I want to dockerize our app I <em>kind</em> of need a <em>Dockerfile</em> (duh!). This image runs the <code class=\"language-text\">jar</code> that was built on the previous job:</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> openjdk:8-jre-alpine3.9</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 4000</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apk add --update --no-cache dumb-init <span class=\"token operator\">\\</span>\n  &amp;&amp; rm -rf /var/cache/apk/*</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> build/libs/echo.jar .</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> adduser -D runner</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> runner</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [<span class=\"token string\">\"/usr/bin/dumb-init\"</span>, <span class=\"token string\">\"--\"</span>]</span>\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"java\"</span>, <span class=\"token string\">\"-jar\"</span>, <span class=\"token string\">\"echo.jar\"</span>]</span></code></pre></div>\n<p>Nothing out of the ordinary. <a href=\"https://blog.docker.com/2019/07/intro-guide-to-dockerfile-best-practices/\" target=\"_blank\" rel=\"noopener noreferrer\">Here is a recent post</a> about improving the quality of your <em>Docker</em> images.</p>\n<h3>Running ServerSpec</h3>\n<p>I am a big fan of testing containers with <a href=\"https://serverspec.org/\" target=\"_blank\" rel=\"noopener noreferrer\">ServerSpec</a>, as <a href=\"../testing-containers-serverspec-and-localstack/\">I’ve written before</a> and spoken about <a href=\"https://github.com/sirech/talks/blob/master/2019-01-tw-tdd_containers.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">multiple times</a>.</p>\n<p>Running these tests in a CI tends to be painful because of the infamous <a href=\"https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/\" target=\"_blank\" rel=\"noopener noreferrer\">docker in docker</a> problem. I was expecting yet another round of pain when trying to set them up for <em>CircleCI</em>.</p>\n<p>Not so much! Surprisingly, it went quite swiftly. Maybe I’m just used to it by now, who knows. How to do it, though?</p>\n<p>I’ve set up a new job for this. I created and uploaded my own <a href=\"https://hub.docker.com/r/sirech/dind-ruby/tags\" target=\"_blank\" rel=\"noopener noreferrer\">dind with ruby image</a> so that I have access to newer <code class=\"language-text\">ruby</code> versions. A simplified version of it looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">\n<span class=\"token key atrule\">docker</span><span class=\"token punctuation\">:</span>\n\n  <span class=\"token key atrule\">docker</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> sirech/dind<span class=\"token punctuation\">-</span>ruby<span class=\"token punctuation\">:</span>2.6.3\n\n  <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n\n    <span class=\"token punctuation\">-</span> checkout\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">attach_workspace</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">at</span><span class=\"token punctuation\">:</span> build/libs\n    <span class=\"token punctuation\">-</span> setup_remote_docker\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> docker build . <span class=\"token punctuation\">-</span>t echo\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> ServerSpec Tests\n        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          bundle install\n          bundle exec rspec spec</span></code></pre></div>\n<p>Thanks to the <a href=\"https://circleci.com/docs/2.0/building-docker-images/\" target=\"_blank\" rel=\"noopener noreferrer\">setup_remote_docker</a> directive, regular <code class=\"language-text\">docker</code> commands are available for this job. After installing the dependencies, the <a href=\"https://github.com/sirech/echo/blob/master/spec/container_spec.rb\" target=\"_blank\" rel=\"noopener noreferrer\">tests</a> can run inside the pipeline.</p>\n<p>The <code class=\"language-text\">jar</code> that was generated in the previous job is available by using the <code class=\"language-text\">attach_workspace</code> directive.</p>\n<h3>Building the image</h3>\n<p>Once the container tests have passed, it’s time to build the image and publish it to some registry. That will be our final artifact that can be used for deployment. Deployment can happen in the same pipeline or in a separate one, it doesn’t really matter.</p>\n<p>Starting from the same job as before, it’s time to log in to whatever registry we should hold the image. Then we build the image with the right tag, and push it:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Publish docker image\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n      echo $DOCKER_PASSWORD | docker login -u $DOCKER_USER $DOCKER_REGISTRY --password-stdin\n      docker build . --tag $DOCKER_REGISTRY/echo\n      docker push $DOCKER_REGISTRY/echo</span></code></pre></div>\n<p>You see that I’m not versioning the image. Don’t do this for a serious application. You can attach the <code class=\"language-text\">git</code> commit by using the <code class=\"language-text\">CIRCLE_SHA1</code> variable, which is one of the many <a href=\"https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables\" target=\"_blank\" rel=\"noopener noreferrer\">built-in</a> variables that are available out of the box.</p>\n<h2>Caching</h2>\n<p>Isolation is great at keeping our builds reliable. It is often at odds with performance, though. I don’t want to cache the whole workspace like in the old, dark <em>Jenkins</em> days, but avoiding downloading the dependencies every time is quite convenient and keeps the pipeline fast, just the way I like it.</p>\n<p>In <em>CircleCI</em>, you do that by saving a particular folder based on a key. For instance, if I want to cache the <code class=\"language-text\">ruby</code> dependencies that I use for the container tests, I use a block like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">restore_cache</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> bundle<span class=\"token punctuation\">-</span>2<span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> checksum \"Gemfile.lock\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> bundle check <span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span> bundle install <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>without ops development\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">save_cache</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> bundle<span class=\"token punctuation\">-</span>2<span class=\"token punctuation\">-</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> checksum \"Gemfile.lock\" <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> vendor/bundle</code></pre></div>\n<p>All the steps inside the same job after this will have them available, and they will be cached until there is a change to the <code class=\"language-text\">Gemfile.lock</code> file.</p>\n<h2>Defining variables</h2>\n<p>I have been using variables throughout my pipeline to encode certain values, like my <em>Docker</em> credentials. <a href=\"https://circleci.com/docs/2.0/env-vars/\" target=\"_blank\" rel=\"noopener noreferrer\">They are managed through the UI</a>, which frankly is not ideal. I would prefer a more programmatic solution, to be honest. Needless to say, putting secrets in the <code class=\"language-text\">config.yml</code> directly is out of the question, so this will have to do.</p>\n<p>If you want to manage a set of variables for multiple projects, one option could be <a href=\"https://circleci.com/docs/2.0/contexts/\" target=\"_blank\" rel=\"noopener noreferrer\">using contexts</a>.</p>\n<h2>How does it all look together?</h2>\n<p>That wasn’t that bad after all. I find <em>CircleCI</em> quite intuitive, and for hobby projects their standard account is more than enough. In fact, the pipelines run very quickly. In the beginning I was waiting a bit to check on them, and they had been finished for a while by the time I had a look.</p>\n<p>The whole pipeline is in <a href=\"https://github.com/sirech/echo/blob/master/.circleci/config.yml\" target=\"_blank\" rel=\"noopener noreferrer\">github</a>. That should be a good start to build your own app. In fact, the pipeline does not stop at the <em>Docker</em> stage, but has a deployment step based on a custom script.</p>","frontmatter":{"layout":"post","title":"Dockerizing a JVM app with CircleCI","path":"/dockerizing-a-jvm-app-with-circleci/","categories":["Docker","CircleCI","JVM","ServerSpec"],"date":"2019/07/15","draft":false,"description":"Build a pipeline with CircleCI to dockerize a JVM app step by step. Includes linting, tests, creating and pushing the image","canonical":null,"image":null}},"related":{"nodes":[]},"previous":{"frontmatter":{"title":"Fail a test in Jest if an unexpected network request happens","path":"/jest-fail-test-if-unexpected-network-request-happens/","date":"2019/12/08"}},"next":{"frontmatter":{"title":"How to split the deployment of your front end and back end with the help of Consumer Driven Contract Testing","path":"/split-frontend-backend-deployment-with-cdcs/","date":"2019/11/12"}}},"pageContext":{"related":[],"previous":"/jest-fail-test-if-unexpected-network-request-happens/","next":"/split-frontend-backend-deployment-with-cdcs/"}},"staticQueryHashes":[],"slicesMap":{}}