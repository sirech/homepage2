dist: trusty
language: node_js
node_js:
- 10
cache:
  yarn: true
  directories:
  - node_modules
stages:
- lint
- test
- security
- build
- name: deploy
  if: branch = master AND type IN (push)
- name: healthcheck
  if: branch = master AND type IN (push)
jobs:
  include:
  - stage: Lint
    script: npm run linter:js
  - script: npm run linter:text
  - script: npm run linter:css
  - stage: Test
    script: npm test -- --coverage
    after_script: cat coverage/lcov.info | node_modules/.bin/coveralls
  - stage: security
    script: npm run audit
  - stage: Build
    before_script:
    - openssl aes-256-cbc -K $encrypted_109e9b48b55f_key -iv $encrypted_109e9b48b55f_iv
      -in deploy_rsa.enc -out deploy_rsa -d
    - chmod 600 deploy_rsa
    script: |
      SITE_URL=$SITE_URL npm run build
      find public -regextype posix-basic -regex '.*\.\(js\|css\)\(.map\)\?$' -print0 | xargs --null -I@ sh -c "gzip -c @ > @.gz"
      scp -i deploy_rsa -r public $DEPLOY_USER@$DEPLOY_HOST:/tmp/homepage2-${TRAVIS_BUILD_NUMBER}
  - stage: Deploy
    before_deploy:
    - openssl aes-256-cbc -K $encrypted_109e9b48b55f_key -iv $encrypted_109e9b48b55f_iv
      -in deploy_rsa.enc -out deploy_rsa -d
    - chmod 600 deploy_rsa
    script: skip
    deploy:
      provider: script
      skip_cleanup: true
      script: ssh -i deploy_rsa $DEPLOY_USER@$DEPLOY_HOST "sh ${DEPLOY_PATH}/bin/promote /tmp/homepage2-${TRAVIS_BUILD_NUMBER} /srv/main"
  - stage: healthcheck
    script: curl --connect-timeout 60 -s -f -o /dev/null "${SITE_URL}"
env:
  global:
  - secure: iV+70zGlALP+h+VYy/ZOaN25UJM7jNloxoJjQXnH9JZYvwXtyninH4grS8cSHkBU/oqtlNoADRvlqvI4Zw8YxdEtLVA4FdOROSU6AwVIOOQlWfI/saHAfCdy6SF6Y02sMEpBu15cmELBn4Np/2bQUrgZIFv1RCJ3q+hxlWmjOsTrsg4QZ2AZub7m2X2I5pjU8yNDYXIWPQV4f2fd0zvvm3xcuEXS0goNOKte4GqP2YjUTXck1sS0bM0H07BAhUftiqTSSRAocNoFOalPPcBKn7g4KIdrk/071mr1mspQlTSbxJdKHr/0/YeaBlZOewY7x42Jru9MweaAcfiZgZzdjBaZJPNOBDrbSXa8Wbo0ep/Phax2y38kDiu6AvWIra5xnRyk7rqwYnmwtjdRcxoA/smXzqW70VOht7jQslUdS99d1Jr3N4xtA2R3k4fW2JzpB0A98vQiohJ1aA3jMw0IfxgUu934ShrziuzGxnUvXvJWMsHRKjo+KMfOJb7okkBshBfO4SHrY7kJAhc79aTaDntKBqX27fPlF8zLzG8NUQkpjlU5Hgl2KWsxmYBJ5sOGQsgMfLNpKxq0wlpnTMueKFqsvfe0rAcA01biK256MBaLs/Y/4JFuonlopcraoSP8p2UFwfSz7vUur9lnwfVFe/c3stdIVrJnope5ZE/bX0U=
  - secure: fzplWeBJCZL/wPPBJMY0xUavD4e3Vymk8guRWSGoZOoEqOnHP7vAvdeq70Z8GCHEfGTFp0OFdxERFq+DYBrtSdd+cPqFSDGioqvFrz3tqi+o2IDeBJIbqvi9G8PrvNYiRVse5pYfYtNSLGSd2dzV/viCpV6THSFC+HfKE4j3U60Z6BIbIPb52H8XRSHxysjvQW07dbreoPMiajxAdDtQ6uCnsixN3SxVhrWKn/AwBOawebhuxPNqQp2nu0P2T5oQylL1auoUMgwmEKzJaPWLq0LZtureOylybgB99K1ScQeS/mfbk/2zmS4mtvioQUOAyR7JYu83UZF6f4aV2IZNDhmpDP7puR1H4ScakXJ+aN+Gd6PB56hXln5mAA53aVsNzErmUufGTh3S/CaecpexaFi2HQb5ZLhJ7ciLDcty7SZNW8aRF7owgBONiHL2lC2dQ3sgxewATj3XI+B25l1/wgFG6cjRDt4hE5+dNhlHS8f+FZGkmv+ZxQCIiY31WNMCvg9W3VvH6n0Vb3gPUqRS0Jelw6KhqCZmh45pTblAiDHOjdCuZoA85cM7HwW6FlfyBtxFfRW25neh9ZJB29B1IXd+JNQk5JBFycJ0nGmDT5SIYVKimv70QX5Q4HQ85dtnY+unzn47VRcYapmFv27neAUfYgAGdEdpADxZ8z6wq1Q=
  - secure: odf8woDh71Tiyza+eFZvbzu5qUKC+C+jY7HFVdfVMUyNZxgs91V3tdF54HAWnbpWzu9QLgmCGuCuH90t0LJiNbTjeKPYLorpAhH39Xi8lIA2QLZXr+P9CbN9XDJkjFZQi+iBybzqt3dpdSA8ma7TVQctlVVvoW1MHDO7XRxNZ7DNfVVEZW7vJ4dyBoe/5HscDv4o0sqE1ZXrauIQMGvj9on54vgL4FRjtGOR1QIrj+kDQq7lsjGC/j+sPYVK8QM88KNoams7sOSeiUrxxrz+gWu/TMK8zThNDLfjgADcu1dP/LgKnLkw1AknVR/aSVq8o5r8CD3V3bIv1KuaSOINIqBxfkh3hnAuV235ybR2Bebq3aMFcJtmWrbzyTkFCb3Ixa0/eJtUGrFnmKCz48zyLZb7eG+eVeZjA3lpcVoES90pawrxQ+2z3koZHZ+Cbgud58nLie5OW8yCnDDwEHaOIkgsjJjuhdoMbWEyccqz7JJOmfYF1p/yIFyP4awlA2d+Q4U/OLPRwcQx8r7TLxlg68cOfQGNzHkOxzN9C1zqfJ1lJ8y+a9LxGXQWmgnV3wnYfEg9vXkZ94dmA9/ZaOsMis94a9NVHf6CMOXpoAqTg6AeXvooyYsglBWgrA9+X6z9tGRJ1R170xqfiSh4yemkKRkUwwtj+kIFFiUvrWU61Ik=
  - secure: agmDqo33LsNKJOAPaM55xSKW8AZLk01aEZ2wGW4sxeUtxNoagQooqAG1RtvDRG+6HqKlEHxO6rsOj+zTp1kxtzXKDXzCuq8PO1uwBozbFiO/Udj+tEAnHvrxuB1xOBbrvB+i8hSG9YRHr6zdxSsI1PHmV+jFOtWc70J2887jjcHULByNoXFvJoR6aJZUASKI7cvIuuP6Y39DC7QGwjqnCN7bf9KjKI81TqVw6ZKxWmyNg4sSFB+dwEavm7idqeBfZKbIH/yP2W0+DAIIVAZFIwEmOsu1fck5A4bwWoUD//KELjI8cPs48X9C+vXqsgFwTmrNTbEwuTIOAOMCO8tCDJvG2kyGWF5TzUDFYktr+ZjIW1tY7peCfdnz01cq8sF4My/c5kM0Yw/oVGX7f0YoJ8c91F3Pfn70i1vLOZ3atzPDFzP0BB9oF/hL3zd6BHg4voEZx+XV/ZKNijfyZGpruBQ6w0AspihgAoLjskD/5LDfjfV12AQfNhnWAwMY9YUSolllXaHpZtgWD5KGcLr579Pgh3l55fzTVvUbQwRRYQQs+uyaoxFuSOeUIyUEtLksjPgxXR3wmh3FJQCC2gBxhQYLUwFMieI0w0aPCvf2Ck95hN1Z092XD5aAvRI/iWFF1VzyCZUV6+LStgl8n/uzNaa4/Y/osMr/mh7BHkKsaeQ=
  - secure: uz+M2J/WNKN/52Z3YXlXo128/C0l9P2ApwHyIiJfARw38a7izX3fD4WTEA9fM2oSMLpCmc4aWXkINr/cfZSPV10W/zu1nKkOG+jEKn5E0gN38lzGX6uzUFfWpidT/bQPFmkWruc6DkIm63vVPRzYkQnTQMs6m+C1azMAlmtxGWaFPumrsAAQX1gFMQe3jPZY6bAZlq9n4ZGRHcG4iFIh8jK6yTmsdqGHidiwdKNgHzx8s3Vv8hlM05rAYhmvsJ1MnSqJSEhQ7tiaGNVX+f+nFTJ6oWd5vA9wkkhm0GZ7iBMpbo5DnNJTRZWLkTn1ZfSuUPXWZi7NPqlIdm+DlqoerBRm/+ED7NCiITWKqPSpcM7GqRxj5TBiLt/z23TiqlGONZdR/0kbPBVMH2Hgub343eqNgHNdJWstcZKb11uYazMswmLi/3A9p7jYf2I6rbUqjLlozOxaHDUNOtSlZUHYkyzH8OfUoRoZ4b1kxAlkCHaNGGth3GkQfaKXNnzk8oTu4jGXiSsCoTs5XM8efPK1Ng+jDFbIBo1qhT9y18E8Ov10S5zvpx3327+8t2O33OeW9lWwyo7L4WcuWBtQRQHf2e3v3aHx8/I1YRy/QYoxikUXWdxrqvGt+uGYztAGfAlLsgUZI8Tans8TimdSCyEbcgPBE4AYzdWEWDaplvrxaMo=
  - secure: WudEU4C2JQsXeKUrPcr/aKFvm2kmnEAXaVRZhYukBxtrEN8o+S5XpSRcHKon1azDeHfrkO/GjPgHy+Oi8Du66gTsQuoO7j8i7qWdL53Rk/fjRap9P24S13Fgdr1JbT8muCm8yxalmMLVFt/3m5ZEcchYLkpdBXddnSwgmG7D9ZijTdzUz4fQXVUYSnZQ4PzcpQr1Pq/LTn0NYY0BtnnAZf9T+VlkliO8mrYMlzSZ8FGm+akDspQlIAZQv1RIdUq08NDcRXZ6/cLdFCTU6ADdawzSgWFfW2KqDhWoC8TZqmPwMh/HhzN5CWFt/SHAq4KaGBXw2mFmHZum8JkN2fxhqWXXg6idyY+ohhT946ztQmVp2XMReNxbCHGvtehljzpXVK6srRjln+qy7ep89HgUP22jsEinFiDn49KBamjfL7tUJkJv05Y7etA0gRfONC92HVz9tYlYRMhYOvGgcS21KKQYEUB0mXlMGVdT4X0URTToaICg+YXMFPoqC4VXLBO8l4AntXfiqrdHt8v43xAsmxCR32FxFRsnGdJLmIJ3kAH1+J1DIZyV4ab9rchHab7pa9fuMWF1wyt0HdEWlcxAo9TEkkMxdazTa7Tku2hyx1lhkPXVgC+NnFw44GEgY5LQq8DpKj+rQdz3FEkXgk4g0lwV9x0qV3EiBik4UOhPrg0=
  - secure: nGLTPPtSo0ZxuclhN2k4mkzFrmA3i9C/lPTGo7mQhGOSDxruBj3bHMiqNohmhl+vyuRJF80v/GBehhdsqdW9FVGvnFSIBwhDFpiPE/NoWt+luqIn+s7Ep5FRxg7AUX8gGlBeVzgsu7qH9XU85LUHbGBZ9kitn639TDJJykh/rQRRMkgMGJPdYzcTHEiUSaTUh39w6pdPvvtTrqjfDOwqyejfGHtS4aW4OWxgOSSPLvR0sQugeJntB+kRLNEJ7WY3xNydkL2cPuLSDaBY/o64g5B1GkcBEmEg78HGmNK0il1SNRghu0+GNNVxY23mLIqfh//lpHuK0eIbILZre1Qr8GsYdh+ti9gAQ/ARve8DPgaasKJF8b5Js7xAin9SgowjUYqPERS9lINkhonOLTESAvnAhRGmxYgdVuxcgtbBoVw7t3RZHDw3qQMms66MSXbfZ56VJtDMfzGu7dxl+mYsChlLHoQ4gJcQy0RKOgh+0a3Ot9mfgliRwC9Nj0r/+0OdmFN8+qcq2i67OLD9fcMXP6tGAjh8LLqNktdILUadcYv6j+R9XeIqVQYfWQ/TJZaXljE8CKJtjJw3b8j5nZ10AnNEUAjdS/QuWNvrRUWT11xD1/7l+aqOdfszuadEmNcUhVq+Jk3wNN6uPewaPLTp6nDlHOCQ2t7tvS9VXxwUUqM=
  - secure: PtVg1o4B0xWhR9FkGQl9QZ1hvkcS+3VWxrI2h+sype9cHBIoHgjw8Q/XivZf0Qt+Ec91nJ5MQhjduYoZeJWj9wVk39iBsko9/Aq4s51+HVJkagfQIEGzDu+TQi5+jlMk/ykciY5mvHTjsz1Z/kIxIn9+PKHfV4NqNWgcm/04g9a4Vtf5CPjNqFmabDh1wMfHTafnrGhmwPV98ct7DllJX+MZxm4O0i1JG+W1aUIen2JlPNprWyJdpH6NOSBwC8iELqpTPjmrKPdvgOJr22W53bfOBQ81+qy0XemQw2IJIbZct8evVMx7RUlaRX6kprzpk4EpRBvxPkiULKuGlcVDD4ajtUWYqrLup3WC+rVkD10tzN/XBfd5Ic23UN+otr2RI3zDcpHTyUc/QPHqGN1CKhGWhYVIYcLs3jbp1ymA80aZkwomzPca8U4MtI5in5saWY6WuOGqnXecqGnIcuA0LCY4XO8Wy4DZ43qjU9ylwVNhBbiW0XQoeBrzRgcT03Z/oo1MS9S2Yx2xAq8niqaqtmTgukFpFIJgpJo8STQHgNwWwudyKOACTA2iFly7fnq4a4BFwwPdD2VujPQRfCJUny34YSMDirtBizPB/c+Ann5xoF141DkG+l018rvvkSsyq4W+InqjAooAzjBKAU5M78uHaECRkCUaDQPccpJuOyU=
addons:
  ssh_known_hosts:
    secure: B7KEFSFjTBeCmvMu0gMr4EiNEPQvuJGoRdJ16FiuxWDj4+ymUJtYOXt6+GlPiPi02gja4pZOAzQAmbdekOyEdbuohaxYR2TDm2CrMBJrUwt5JVxp6O8Clj26lN7QcT2VA30PJO/JQQq5RP3dR8Xdjhj1FG8BfttLNVCu8pBZnVelGzii1VpCH/w980ZZc+e6NUEJanIzbiTtyd65q4InjdUyARUTrf3p73y670NCcq/2w72pGvO17MX4NmZcBU4yOmQ3kCpaG0z3qr/+rX5C45+x5Pg1wK1hWnuR7uYq63RyNusbURzxTrxktYIqSfeNygrtE4Y+LDiku4fZRbkVjlYeq4zaG8iNw0bffk/c++WPozdjJRRoZz1mtjkxlxuU5z5r7omp9trNfsE1x0qmJTXaqbiwNt4i2mOnnQAJBZUJ9Wx79EMdBfYLuAAOdQxseDita6wuqM0eMas3WhvunqpBIbzA/W0xaYVHclYnOwUqLA9eFr4fp+whSBsSi2OhokgTBrLrhLRwDDQeWuPGt/cM205SldD1XttRj4Kkop765AuoVfG9/BkQ5I2yGlkpDH9tWK0P6L17iOK9oHfCcbnvbP6t4S01Yu2vh72PiFjvLBYYBPUdDPM4XkCumI+pfsg/Gxl1oAnB98iCeilD10/kmm8J3hyyLH05/OtElnY=
